<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Call Leaderboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --primary:#5b4df2;
    --ring: rgba(91,77,242,.15);
    --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; padding:24px;
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }
  .wrap{max-width:1220px; margin:0 auto;}
  h1{font-size:28px; margin:0 0 8px; font-weight:800;}
  .sub{color:var(--muted); margin-bottom:18px}

  .panel{background:var(--card); border:1px solid var(--border);
         border-radius:16px; padding:18px 18px 8px; box-shadow:0 2px 8px rgba(0,0,0,0.04);}

  .controls{display:grid; grid-template-columns: repeat(5, minmax(0,1fr)) 180px 120px; gap:10px; align-items:center;}
  .controls select, .controls input[type="text"]{
    width:100%; height:42px; padding:0 12px; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
    outline:none; font-size:14px;
  }
  .switch{display:flex; align-items:center; gap:8px; justify-content:flex-end;}
  .btn{height:42px; background:var(--primary); color:#fff; border:none; border-radius:12px; font-weight:700; cursor:pointer; padding:0 18px;}
  .btn:focus{outline:3px solid var(--ring)}

  .cards{display:grid; grid-template-columns:repeat(6, minmax(0,1fr)); gap:10px; margin-top:12px;}
  .card{background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px 16px}
  .card .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em}
  .card .value{font-size:28px; font-weight:800; margin-top:6px}

  table{width:100%; border-collapse:collapse; margin-top:14px}
  th,td{padding:14px 12px; border-top:1px solid var(--border); font-size:14px}
  th{color:var(--muted); font-weight:700; text-align:left}
  tbody tr:hover{background:#fafafa}

  /* loader */
  .overlay{position:fixed; inset:0; background:rgba(255,255,255,.68); backdrop-filter:saturate(180%) blur(2px);
           display:none; align-items:center; justify-content:center; z-index:50}
  .modal{background:#fff; border:1px solid var(--border); border-radius:16px; padding:24px 28px; box-shadow:0 10px 30px rgba(0,0,0,.10); text-align:center; width:380px}
  .spinner{width:54px;height:54px;border-radius:50%;border:6px solid #e5e7eb;border-top-color:var(--primary);margin:4px auto 12px; animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .toast{position:fixed; right:18px; bottom:18px; background:#111827; color:#fff; padding:12px 14px; border-radius:10px; display:none; z-index:60}
</style>
</head>
<body>
<div class="wrap">
  <h1>Call Leaderboard</h1>
  <div class="sub">Per-user call time (mm:ss), dials & outcomes — powered by Dialpad Stats and cached per day for speed.</div>

  <div class="panel">
    <div class="controls">
      <select id="range">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="thisweek">This week</option>
        <option value="last7">Last 7 days</option>
      </select>

      <select id="metric">
        <option value="duration">Total Duration</option>
        <option value="dials">Dials</option>
        <option value="outbound">Outbound</option>
        <option value="answered">Answered</option>
        <option value="missed">Missed</option>
        <option value="avg">Avg Duration</option>
      </select>

      <select id="order">
        <option value="desc">Desc</option>
        <option value="asc">Asc</option>
      </select>

      <input id="filter" type="text" placeholder="Filter by user email or name" />

      <div class="switch">
        <label><input type="checkbox" id="force" /> Force refresh</label>
      </div>

      <button class="btn" id="loadBtn">Load</button>
    </div>

    <div class="cards">
      <div class="card"><div class="label">Total calls</div><div class="value" id="kTotal">—</div></div>
      <div class="card"><div class="label">Inbound</div><div class="value" id="kIn">—</div></div>
      <div class="card"><div class="label">Outbound</div><div class="value" id="kOut">—</div></div>
      <div class="card"><div class="label">Answered</div><div class="value" id="kAns">—</div></div>
      <div class="card"><div class="label">Missed</div><div class="value" id="kMiss">—</div></div>
      <div class="card"><div class="label">Avg duration</div><div class="value" id="kAvg">—</div></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Dials</th>
          <th>Inbound</th>
          <th>Outbound</th>
          <th>Answered</th>
          <th>Missed</th>
          <th>Total (mm:ss)</th>
          <th>Avg (mm:ss)</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="8" style="color:var(--muted)">Click <b>Load</b> to fetch data.</td></tr>
      </tbody>
    </table>
    <div id="footNote" style="color:var(--muted); font-size:12px; margin-top:10px">Ready.</div>
  </div>
</div>

<!-- Loader + toast -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="spinner"></div>
    <div id="overlayText" style="font-weight:700; margin-top:6px">Loading…</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
  // ======= Configure your worker origin here =======
  const WORKER_BASE = 'https://ve-dialpad-proxy.nick-north.workers.dev';
  // ================================================

  const $ = (id) => document.getElementById(id);
  const rowsEl = $('rows');

  function showLoader(text){ $('overlayText').textContent = text || 'Loading…'; $('overlay').style.display='flex'; }
  function hideLoader(){ $('overlay').style.display='none'; }
  function toast(msg){
    const el = $('toast'); el.textContent = msg; el.style.display='block';
    setTimeout(()=> el.style.display='none', 3500);
  }
  const fmtMMSS = (sec) => {
    sec = Math.max(0, Math.round(sec||0));
    const m = Math.floor(sec/60), s = sec%60;
    return `${m}:${s.toString().padStart(2,'0')}`;
  };

  function rangeToFromTo(r) {
    const now = new Date(); // local
    const toDate = new Date(now); toDate.setHours(0,0,0,0); // we’ll offset inside worker by tz
    const fromDate = new Date(toDate);

    if (r==='today') { /* from today to today */ }
    else if (r==='yesterday') { fromDate.setDate(fromDate.getDate()-1); toDate.setDate(toDate.getDate()-1); }
    else if (r==='thisweek') {
      // Monday as week start
      const day = fromDate.getDay(); // 0 Sun..6 Sat
      const diff = (day === 0 ? -6 : 1 - day); // to Monday
      fromDate.setDate(fromDate.getDate()+diff);
    } else if (r==='last7') {
      fromDate.setDate(fromDate.getDate()-6);
    }
    const fromISO = fromDate.toISOString().slice(0,10);
    const toISO   = toDate.toISOString().slice(0,10);
    return { fromISO, toISO };
  }

  async function fetchLeaderboard() {
    const range = $('range').value;
    const { fromISO, toISO } = rangeToFromTo(range);
    const cap   = 120;
    const force = $('force').checked;
    const tz    = -new Date().getTimezoneOffset(); // minutes EAST of UTC

    const url = `${WORKER_BASE}/stats-leaderboard?from=${fromISO}&to=${toISO}&cap=${cap}${force?'&force=true':''}&tz=${tz}`;

    showLoader(`Loading ${fromISO} → ${toISO}…`);
    try {
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`Worker ${res.status}: ${text || res.statusText}`);
      }
      const data = await res.json();
      hideLoader();
      render(data);
    } catch(e) {
      hideLoader();
      console.error(e);
      toast(`Failed to load: ${e.message}`);
    }
  }

  function render(data) {
    const totals = data.totals || {};
    const rows = (data.rows || []).slice();

    // filter
    const q = ($('filter').value || '').trim().toLowerCase();
    const filtered = q ? rows.filter(r => (r.user||'').toLowerCase().includes(q)) : rows;

    // sort
    const by = $('metric').value;  // duration|dials|outbound|answered|missed|avg
    const order = $('order').value; // asc|desc
    filtered.sort((a,b) => {
      const av = by==='duration' ? (a.duration||0) :
                 by==='avg'      ? (a.avg||0) :
                                    (a[by]||0);
      const bv = by==='duration' ? (b.duration||0) :
                 by==='avg'      ? (b.avg||0) :
                                    (b[by]||0);
      return order==='asc' ? av-bv : bv-av;
    });

    // fill cards
    $('kTotal').textContent = (totals.dials ?? 0);
    $('kIn').textContent    = (totals.inbound ?? 0);
    $('kOut').textContent   = (totals.outbound ?? 0);
    $('kAns').textContent   = (totals.answered ?? 0);
    $('kMiss').textContent  = (totals.missed ?? 0);
    const avg = (totals.answered ? (totals.sumDur || 0)/totals.answered : 0);
    $('kAvg').textContent   = fmtMMSS(avg);

    // rows
    if (!filtered.length) {
      rowsEl.innerHTML = `<tr><td colspan="8" style="color:var(--muted)">No results.</td></tr>`;
      return;
    }
    rowsEl.innerHTML = filtered.map(r => `
      <tr>
        <td>${escapeHtml(r.user || '')}</td>
        <td>${r.dials||0}</td>
        <td>${r.inbound||0}</td>
        <td>${r.outbound||0}</td>
        <td>${r.answered||0}</td>
        <td>${r.missed||0}</td>
        <td>${fmtMMSS(r.duration||0)}</td>
        <td>${fmtMMSS(r.avg||0)}</td>
      </tr>
    `).join('');

    const days = dayDiff(data.range?.from, data.range?.to) + 1;
    $('footNote').textContent = `Loaded ${days} day(s). Cached on the worker for speed.`;
  }

  function dayDiff(a,b){
    if(!a||!b) return 0;
    const A = new Date(a+"T00:00:00Z").getTime();
    const B = new Date(b+"T00:00:00Z").getTime();
    return Math.round((B-A)/(24*3600*1000));
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

  // events
  $('loadBtn').addEventListener('click', fetchLeaderboard);
  $('filter').addEventListener('input', ()=> fetchLeaderboard()); // live re-render after fetch
  // initial
  fetchLeaderboard();
</script>
</body>
</html>










