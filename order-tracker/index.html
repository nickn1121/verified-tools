<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Verified — Order Tracker</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
:root{--brand:#6f57e9;--ink:#1f2432;--muted:#6d7486;--bg:#f6f7fb;--card:#fff;--line:#e9e9ef;--green:#12a274;--shadow:0 12px 30px rgba(23,20,68,.08),0 1px 0 rgba(0,0,0,.04)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font:15px/1.56 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
.wrap{max-width:1600px;margin:26px auto;padding:0 16px}
header{display:flex;gap:16px;align-items:center;padding:18px;border:1px solid var(--line);border-radius:20px;background:#fff;box-shadow:var(--shadow)}
header img{height:44px}h1{margin:0;font-size:26px;font-weight:800}.sub{color:var(--muted)}
.toolbar{position:sticky;top:8px;z-index:3;background:var(--bg);display:grid;grid-template-columns:1fr 200px 180px 180px auto auto;gap:12px;margin:18px 0}
.input,.select,.btn,textarea{height:40px;border:1px solid #d9daf0;border-radius:12px;background:#fff;padding:0 12px;font:inherit;outline:none;transition:.15s}
.input,textarea{box-shadow:inset 0 0 0 1px rgba(0,0,0,0)}.input:focus,textarea:focus,.select:focus{border-color:#cfc9ff;box-shadow:0 0 0 3px #efeaff, inset 0 0 0 1px rgba(0,0,0,0)}
.input{width:100%}textarea{padding:12px;resize:vertical;min-height:84px}.select{appearance:none;padding-right:28px}
.btn{background:#f6f4ff;color:#3d35d1;border-color:#ece8ff;font-weight:700;cursor:pointer}.btn:hover{background:#eee8ff}.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}.btn.ghost{background:#fff;color:#1f2432}.mini{height:32px}.smini{height:28px;padding:0 10px;border-radius:999px}
.table-card{border:1px solid var(--line);border-radius:18px;background:#fff;overflow:hidden;box-shadow:var(--shadow)}
.table-wrap{overflow:auto}table{width:100%;border-collapse:collapse;min-width:1320px}
thead th{position:sticky;top:0;background:#fafaff;border-bottom:1px solid var(--line);text-align:left;font-size:13px;color:#4a4f64;padding:12px}
tbody td{border-bottom:1px solid var(--line);padding:12px;vertical-align:top}tbody tr:hover{background:#fcfbff}
.mono{font-variant-numeric:tabular-nums}.muted{color:var(--muted)}
.chip{display:inline-block;border-radius:999px;padding:3px 10px;border:1px solid #eee;background:#fafafa;font-size:12px;color:#5d6480}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6f2ec;padding:3px 10px;border-radius:999px;background:#f0fbf7;color:var(--green);font-weight:800}
.ie{display:inline-flex;align-items:center;gap:6px}.ie button{border:0;background:transparent;color:#6d6fe5;cursor:pointer;padding:0 6px;border-radius:6px}.ie button:hover{background:#f0efff}.ie select{display:none;height:30px;border-radius:10px}.ie.editing select{display:inline-block}.ie.editing .chip{display:none}
.actions{display:flex;gap:8px;flex-wrap:wrap}.link{color:#362dc7;text-decoration:none}.link:hover{text-decoration:underline}
dialog{border:0;padding:0;margin:0 auto;max-width:1500px;width:98vw}dialog::backdrop{background:rgba(17,17,33,.35)}
.modal{display:flex;flex-direction:column;max-height:92vh;border-radius:20px;overflow:hidden;background:#fff;box-shadow:var(--shadow)}
.modal header{position:sticky;top:0;z-index:2;border-bottom:1px solid var(--line);border-radius:20px 20px 0 0;background:#fff}
.modal .head{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}.content{padding:16px;overflow:auto;max-height:calc(92vh - 56px)}
.grid2,.grid3{display:grid;gap:12px}.grid2{grid-template-columns:1fr 1fr}.grid3{grid-template-columns:1fr 1fr 1fr}
.section{margin:16px 0 8px;font-weight:900;color:#262b3a}.note{font-size:12px;color:var(--muted);margin-bottom:6px}
.tbl{width:100%;border-collapse:collapse;table-layout:fixed}.tbl th,.tbl td{border:1px solid #ececf3;padding:10px;text-align:left;white-space:nowrap}
.hscroll{overflow:auto;border:1px solid #ececf3;border-radius:12px;background:#fff}.right{display:flex;gap:10px;justify-content:flex-end;margin:12px 0 2px}
.summary{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}.card{border:1px solid var(--line);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
.card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafaff;font-size:15px}.card .pad{padding:12px}
.kv{display:grid;grid-template-columns:170px 1fr;gap:8px 14px}
.chips{display:flex;gap:10px;flex-wrap:wrap}.chipbtn{height:36px;padding:0 14px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:800}.chipbtn.active{background:var(--brand);border-color:var(--brand);color:#fff}
.badge-miss{display:inline-block;padding:2px 8px;border-radius:8px;background:#ffe9e9;color:#b21a1a;font-size:12px;margin-left:8px}.hint{color:#6b6ea0;font-size:12px}
#genFrame{position:absolute;left:-100000px;top:-100000px;width:0;height:0;visibility:hidden;border:0}
.note-item{padding:10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px;background:#fafafa}
.note-head{font-size:13px;margin-bottom:3px;display:flex;justify-content:space-between;color:var(--muted)}.note-head b{color:#1f2432}
.bordered{border:1px solid #d9daf0;border-radius:12px;padding:8px}
dialog[open]{display:block}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://ijzroisggstqkfhpjndq.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
// add auth headers for any direct fetch to your supabase URL
(function(){const f=fetch.bind(window);window.fetch=(i,init={})=>{const u=typeof i==='string'?i:i?.url||'';if(u.startsWith(SUPABASE_URL)){const h=new Headers(init.headers||{});if(!h.has('apikey'))h.set('apikey',SUPABASE_ANON_KEY);if(!h.has('Authorization'))h.set('Authorization','Bearer '+SUPABASE_ANON_KEY);init={...init,headers:h};}return f(i,init);};})();
</script>
</head>
<body>

<script>
// dialog helpers (robust)
(function(){const supported=!!window.HTMLDialogElement&&!!HTMLDialogElement.prototype.showModal;window.showDlg=id=>{const el=document.getElementById(id);if(!el)return;if(supported){try{el.showModal();}catch(e){el.setAttribute('open','');el.style.display='block';}}else{el.setAttribute('open','');el.style.display='block';document.documentElement.style.overflow='hidden';}};window.closeDlg=id=>{const el=document.getElementById(id);if(!el)return;if(supported){try{el.close();}catch(e){el.removeAttribute('open');el.style.display='none';}}else{el.removeAttribute('open');el.style.display='none';document.documentElement.style.overflow='';}};})();
</script>

<div class="wrap">
  <header>
    <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified"/>
    <div>
      <h1>Order Tracker</h1>
      <div class="sub">Generate docs, track shipments (partial), save files, and log staff updates.</div>
    </div>
  </header>

  <div class="toolbar">
    <input id="q" class="input" placeholder="Search customer, part, order id…"/>
    <select id="fltSales" class="select"><option value="">All salespeople</option></select>
    <select id="fltStatus" class="select"><option value="">All status</option><option>Open</option><option>Closed</option><option>Problem</option></select>
    <select id="fltPriority" class="select"><option value="">All priorities</option><option>High</option><option selected>Normal</option><option>Low</option></select>
    <button id="btnNew" class="btn" type="button">+ New Order</button>
    <button class="btn ghost" id="btnCsv">Export CSV</button>
  </div>

  <div class="table-card">
    <div class="table-wrap">
      <table id="tbl">
        <thead>
        <tr>
          <th>View</th><th>Customer</th><th>Part(s)</th><th>Sales</th>
          <th>Total Qty</th><th>Avg Unit</th><th>Sell</th><th>GP</th>
          <th>Priority</th><th>Status</th><th>Order Date</th><th>Requested by</th>
          <th>Age</th><th>Tests</th><th>Vendor</th><th>Lead (d)</th>
          <th>Incoterm</th><th>Terms</th><th>Docs</th><th>Shipped</th><th>Invoiced</th><th>Files</th><th>Actions</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit/Create -->
<dialog id="dlg"><div class="modal">
  <header><div class="head"><strong id="dlgTitle">New Order</strong><button class="btn ghost mini" type="button" onclick="closeDlg('dlg')">✕</button></div></header>
  <div class="content">
    <input type="hidden" id="orderId"/>
    <div class="grid3">
      <div><div class="note">Salesperson</div><select id="salesperson" class="select mini"></select></div>
      <div><div class="note">Customer</div><input id="customer" class="input mini"/></div>
      <div><div class="note">Priority</div><select id="priority" class="select mini"><option>High</option><option selected>Normal</option><option>Low</option></select></div>

      <div><div class="note">Status</div><select id="status" class="select mini"><option>Open</option><option>Closed</option><option>Problem</option></select></div>
      <div><div class="note">Order Date</div><input id="order_date" type="date" class="input mini"/></div>
      <div><div class="note">Requested by</div><input id="requested_by" type="date" class="input mini"/></div>

      <div><div class="note">Terms</div><select id="payment_terms" class="select mini"><option>Net 5</option><option>Net 10</option><option>Net 15</option><option>Net 20</option><option>Net 30</option><option>Net 40</option><option>Net 50</option><option>Net 60</option><option>Net 90</option></select></div>
      <div><div class="note">Payment Method</div><select id="payment_method" class="select mini"><option>Bank Transfer</option><option>Credit Card</option><option>PayPal</option><option>Other</option></select></div>
      <div><div class="note">Incoterm</div><select id="incoterm" class="select mini"><option>DAP</option><option>DDP</option><option>EXW</option><option>CIP</option><option>FOB</option><option>Other</option></select></div>

      <div><div class="note">Invoice Date</div><input id="invoice_date" type="date" class="input mini"/></div>
      <div><div class="note">Due Date</div><input id="due_date" type="date" class="input mini"/></div>
      <div><div class="note">Currency</div><select id="currency" class="select mini"><option value="USD">$ USD</option><option value="GBP">£ GBP</option><option value="EUR" selected>€ EUR</option></select></div>
    </div>

    <div class="section">Addresses</div>
    <div class="grid2">
      <div><div class="note">Bill To (billing)</div><textarea id="bill_to" class="input bordered" rows="5" placeholder="Customer billing name&#10;Address line 1&#10;City, State ZIP&#10;Country"></textarea></div>
      <div><div class="note">Ship To (shipping)</div><textarea id="ship_to" class="input bordered" rows="5" placeholder="Customer shipping name&#10;Address line 1&#10;City, State ZIP&#10;Country"></textarea></div>
    </div>

    <div class="section">Tests & Files</div>
    <div class="grid3">
      <div><div class="note">Tests</div><input id="tests" class="input mini" placeholder="EVI, Electrical…"/></div>
      <div><div class="note">Test Center</div><select id="test_center" class="select mini"><option>GETs HK</option><option>GETs Shenzhen</option><option>GETs US</option><option>White Horse US</option><option>White Horse China</option><option>White Horse EU</option><option>Other</option></select></div>
      <div><div class="note">Supplier Lead Time (days)</div><input id="supplier_lead_time" type="number" class="input mini mono" placeholder="e.g. 21"/></div>
      <div><div class="note">PO (file)</div><input id="file_po" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/></div>
      <div><div class="note">Test Report (file)</div><input id="file_test" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/></div>
      <div><div class="note">Vendor</div><input id="vendor" class="input mini"/></div>
    </div>

    <div class="section">Items</div>
    <div class="hscroll">
      <table class="tbl">
        <thead><tr><th>Part</th><th>Date Codes</th><th>Qty</th><th>Shipped Qty</th><th>Unit Sell</th><th>Unit Cost</th><th></th></tr></thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>
    <div class="right"><button class="btn mini" type="button" onclick="addItemRow()">+ Add item</button></div>

    <div class="section">Shipments / Legs</div>
    <div class="hscroll">
      <table class="tbl">
        <thead><tr><th>Kind</th><th>Date</th><th>Qty</th><th>From</th><th>To</th><th>Method</th><th>Ref</th><th>Courier</th><th>Tracking</th><th>Cost</th><th></th></tr></thead>
        <tbody id="shipBody"></tbody>
      </table>
    </div>
    <div class="right"><button class="btn mini" type="button" onclick="addShipRow()">+ Add</button></div>

    <div class="grid3" style="margin-top:12px">
      <div><div class="note">Extra shipping cost</div><input id="shipping_cost_extra" type="number" step="0.01" class="input mini mono" placeholder="0.00"/></div>
      <div><div class="note">Test cost</div><input id="test_cost" type="number" step="0.01" class="input mini mono" placeholder="0.00"/></div>
      <div><div class="note">Header notes</div><input id="notes" class="input mini" placeholder="Visible notes…"/></div>
    </div>

    <div class="section">Staff Updates</div>
    <div class="bordered">
      <div id="editNotesList" class="muted" style="margin-bottom:8px">No notes yet</div>
      <div class="actions">
        <select id="editNoteAuthor" class="select mini"></select>
        <input id="editNoteBody" class="input mini" placeholder="Post an update…"/>
        <button class="btn mini" type="button" onclick="addNoteFromEdit()">Add</button>
      </div>
    </div>

    <div class="right" style="margin-top:10px">
      <button id="btnDelete" class="btn ghost" type="button">Delete</button>
      <button id="btnSave" class="btn primary" type="button">Save</button>
    </div>
  </div>
</div></dialog>

<!-- View -->
<dialog id="viewDlg"><div class="modal">
  <header><div class="head"><strong>Order Summary</strong><button class="btn ghost mini" type="button" onclick="closeDlg('viewDlg')">✕</button></div></header>
  <div class="content"><div id="viewBody" class="summary"></div></div>
</div></dialog>

<!-- Generator (kept; no changes needed now) -->
<dialog id="genDlg"><div class="modal">
  <header><div class="head"><strong>Generate Document</strong><button class="btn ghost mini" type="button" onclick="closeDlg('genDlg')">✕</button></div></header>
  <div class="content">
    <div id="stepForm" style="padding:16px">
      <div class="note" style="margin-bottom:8px">Document type</div>
      <div class="chips" id="docTypeChips"></div>
      <div id="missingWrap" style="margin-top:16px"></div>
      <div id="extraWrap" style="margin-top:10px"></div>
      <div class="right"><button class="btn ghost mini" type="button" onclick="closeDlg('genDlg')">Cancel</button><button class="btn primary mini" id="genGo">Generate…</button></div>
      <div class="hint" id="genStatus" style="margin-top:8px"></div>
    </div>
    <iframe id="genFrame" title="Generator"></iframe>
  </div>
</div></dialog>

<!-- Toast -->
<div id="toast" style="position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:.2s"></div>

<script>
const $=id=>document.getElementById(id);
const SALESTEAM=['Nick N','Dan C','Emir B','Nick K','Jake B'];
const todayStr=()=>new Date().toISOString().slice(0,10);
const curSym=c=>({USD:'$',GBP:'£',EUR:'€'})[c||'USD']||'$';
const fmt=n=>(n==null||isNaN(n))?'-':Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtInt=n=>(n==null||isNaN(n))?'-':Number(n).toLocaleString();
const esc=s=>(s??'').toString().replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const age=d=>d?(Math.max(0,Math.floor((Date.now()-new Date(d))/86400000))+' d'):'-';
function setToast(msg,d=false){const t=$('toast');t.textContent=msg;t.style.background=d?'#b21a1a':'#111';t.style.opacity='1';setTimeout(()=>t.style.opacity='0',1500);}

/* ===== Supabase data layer ===== */
const supa={
  state:{orders:[]},

  async load(){
    const {data:orders,error}=await supabase.from('orders').select('*').order('order_date',{ascending:false,nullsFirst:true}).order('created_at',{ascending:false});
    if(error){console.error(error);this.state.orders=[];return;}
    this.state.orders=await Promise.all((orders||[]).map(async r=>{
      const [itemsRes,legsRes,inbRes,outRes,filesRes,notesRes]=await Promise.all([
        supabase.from('order_items').select('*').eq('order_id',r.id),
        supabase.from('ship_legs').select('*').eq('order_id',r.id),
        supabase.from('shipments_inbound').select('*').eq('order_id',r.id),
        supabase.from('shipments_outbound').select('*').eq('order_id',r.id),
        supabase.from('order_files').select('id,kind,path,created_at').eq('order_id',r.id).order('created_at',{ascending:true}),
        supabase.from('order_notes').select('*').eq('order_id',r.id).order('created_at',{ascending:true})
      ]);
      const items=(itemsRes.data||[]).map(i=>({part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,qty_shipped:i.qty_shipped||0,unit_sell:i.unit_sell,unit_cost:i.unit_cost}));
      const legs=(legsRes.data||[]).map(l=>({kind:'Leg',date:'',qty:'',from:l.from_loc,to:l.to_loc,method:l.method,ref:l.ref,courier:'',tracking:'',cost:l.cost}));
      const inbound=(inbRes.data||[]).map(s=>({kind:'Inbound',date:s.ship_date,qty:s.qty,courier:s.courier,tracking:s.tracking}));
      const outbound=(outRes.data||[]).map(s=>({kind:'Outbound',date:s.ship_date,qty:s.qty,courier:s.courier,tracking:s.tracking}));
      const filesMap=(filesRes.data||[]).reduce((a,f)=>{a[f.kind]=f.path;return a;},{}); // { po, test_report, so_pdf, ... }
      const genList=(filesRes.data||[]).filter(f=>/_pdf$/.test(f.kind)).map(f=>({kind:f.kind,path:f.path,created_at:f.created_at}));
      return {...r,items,shipments:[...legs,...inbound,...outbound],files:filesMap,staff_notes:notesRes.data||[],generated_docs:genList};
    }));
  },

  async save(header,uploads){
    const {items,shipments,...orderData}=header;
    const {data:up,error:e0}=await supabase.from('orders').upsert(orderData).select().single();
    if(e0)throw e0; const order_id=up.id;

    await supabase.from('order_items').delete().eq('order_id',order_id);
    await supabase.from('ship_legs').delete().eq('order_id',order_id);
    await supabase.from('shipments_inbound').delete().eq('order_id',order_id);
    await supabase.from('shipments_outbound').delete().eq('order_id',order_id);

    if(items?.length){
      await supabase.from('order_items').insert(items.map(i=>({order_id,part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,qty_shipped:i.qty_shipped||0,unit_sell:i.unit_sell,unit_cost:i.unit_cost})));
    }
    const legs=(shipments||[]).filter(s=>s.kind==='Leg');
    const inbound=(shipments||[]).filter(s=>s.kind==='Inbound');
    const outbound=(shipments||[]).filter(s=>s.kind==='Outbound');
    if(legs.length)await supabase.from('ship_legs').insert(legs.map(l=>({order_id,from_loc:l.from,to_loc:l.to,method:l.method,ref:l.ref,cost:Number(l.cost||0)})));
    if(inbound.length)await supabase.from('shipments_inbound').insert(inbound.map(s=>({order_id,ship_date:s.date||null,qty:+(s.qty||0),courier:s.courier||null,tracking:s.tracking||null})));
    if(outbound.length)await supabase.from('shipments_outbound').insert(outbound.map(s=>({order_id,ship_date:s.date||null,qty:+(s.qty||0),courier:s.courier||null,tracking:s.tracking||null})));

    if(uploads?.po)await this.upload(order_id,'po',uploads.po);
    if(uploads?.test_report)await this.upload(order_id,'test_report',uploads.test_report);
  },

  async upload(orderId,kind,file){
    const safe=file.name.replace(/[^a-z0-9._-]+/gi,'_');
    const path=`orders/${orderId}/${kind}/${Date.now()}_${safe}`;
    const {error:upErr}=await supabase.storage.from('order-files').upload(path,file,{upsert:true,contentType:file.type||'application/octet-stream',cacheControl:'3600'});
    if(upErr)throw upErr;
    const {error:insErr}=await supabase.from('order_files').insert({order_id:orderId,kind,path});
    if(insErr)throw insErr;
  },

  async uploadGenerated(orderId,docType,file){
    const safe=(file.name||`${docType}.pdf`).replace(/[^a-z0-9._-]+/gi,'_');
    const path=`generated/${orderId}/${docType}/${Date.now()}_${safe}`;
    const {error}=await supabase.storage.from('order-files').upload(path,file,{upsert:true,contentType:'application/pdf'});
    if(error)throw error;
    await supabase.from('order_files').insert({order_id:orderId,kind:`${docType}_pdf`,path});
  },

  async quickUpdate(id,field,value){
    const {error}=await supabase.from('orders').update({[field]:value}).eq('id',id);
    if(error)throw error;
  },

  async addNote(order_id,author,body){
    const {error}=await supabase.from('order_notes').insert({order_id,author,body});
    if(error)throw error;
  },

  async del(id){await supabase.from('orders').delete().eq('id',id);},

  rt(){
    supabase.channel('tracker')
      .on('postgres_changes',{event:'*',schema:'public',table:'orders'},async()=>{await supa.load();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'order_notes'},async()=>{await supa.load();renderOpenViewIfSame();})
      .on('postgres_changes',{event:'*',schema:'public',table:'order_files'},async()=>{await supa.load();renderOpenViewIfSame();render();})
      .subscribe();
  }
};

/* ===== totals ===== */
function totals(o){
  const revenue=(o.items||[]).reduce((s,i)=>s+(+i.qty||0)*(+i.unit_sell||0),0);
  const qty=(o.items||[]).reduce((s,i)=>s+(+i.qty||0),0);
  const shipped=(o.items||[]).reduce((s,i)=>s+(+i.qty_shipped||0),0);
  const itemCost=(o.items||[]).reduce((s,i)=>s+(+i.qty||0)*(+i.unit_cost||0),0);
  const legCost=(o.shipments||[]).filter(s=>s.kind==='Leg').reduce((s,l)=>s+(+l.cost||0),0);
  const shipCost=legCost+(+o.shipping_cost_extra||0);
  const testCost=+o.test_cost||0;
  const cost=itemCost+shipCost+testCost;
  const gp=revenue-cost; const gpPct=revenue?(gp/revenue*100):0; const avgUnit=qty?revenue/qty:0; const shippedPct=qty?(shipped/qty*100):0;
  return {revenue,qty,shipped,shippedPct,avgUnit,itemCost,shipCost,testCost,cost,gp,gpPct};
}

/* ===== render table ===== */
function inlineSelect(o,field,options){
  const w=document.createElement('div');w.className='ie';
  const chip=document.createElement('span');chip.className='chip';chip.textContent=o[field]||'-';
  const btn=document.createElement('button');btn.textContent='✎';
  const sel=document.createElement('select');options.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;sel.appendChild(op);});sel.value=o[field]||options[0];
  const start=()=>{w.classList.add('editing');sel.focus();};btn.onclick=start;chip.onclick=start;chip.style.cursor='pointer';
  sel.onchange=async()=>{try{await supa.quickUpdate(o.id,field,sel.value);chip.textContent=sel.value;setToast('Saved');}catch(e){setToast('Save failed',true);}finally{w.classList.remove('editing');}};
  sel.onblur=()=>w.classList.remove('editing');
  w.append(chip,btn,sel);return w;
}

function render(){
  const q=$('q').value.toLowerCase(),s1=$('fltSales').value,s2=$('fltStatus').value,s3=$('fltPriority').value;
  const rows=supa.state.orders.filter(o=>{
    const txt=[o.customer,o.salesperson,o.id,o.bill_to,o.ship_to,...(o.items||[]).map(i=>i.part_number)].join(' ').toLowerCase();
    if(q && !txt.includes(q))return false;if(s1&&o.salesperson!==s1)return false;if(s2&&(o.status||'')!==s2)return false;if(s3&&(o.priority||'')!==s3)return false;return true;
  });
  const tb=$('tbody');tb.innerHTML='';
  if(!rows.length){tb.innerHTML='<tr><td colspan="23" class="muted" style="text-align:center;padding:40px">No orders</td></tr>';return;}

  rows.forEach(o=>{
    const t=totals(o),sym=curSym(o.currency);const tr=document.createElement('tr');

    let td=document.createElement('td');const vb=document.createElement('button');vb.className='btn smini';vb.textContent='View';vb.onclick=()=>openViewById(o.id);td.appendChild(vb);tr.appendChild(td);

    [esc(o.customer||'-'),
     esc((o.items||[]).map(i=>i.part_number).join(', ')||'-'),
     esc(o.salesperson||'-'),
     `<span class="mono">${fmtInt(t.qty)}</span>`,
     `<span class="mono">${sym}${fmt(t.avgUnit)}</span>`,
     `<span class="mono">${sym}${fmt(t.revenue)}</span>`,
     `<span class="pill">${sym}${fmt(t.gp)}</span> <span class="muted mono">(${fmt(t.gpPct)}%)</span>`,
     `<span class="chip">${esc(o.priority||'-')}</span>`
    ].forEach(html=>{const td=document.createElement('td');td.innerHTML=html;tr.appendChild(td);});

    td=document.createElement('td');td.appendChild(inlineSelect(o,'status',['Open','Closed','Problem']));tr.appendChild(td);
    [o.order_date||'-',o.requested_by||'-',age(o.order_date),o.tests||'-',o.vendor||'-',String(o.supplier_lead_time ?? '-')].forEach(v=>{const td=document.createElement('td');td.textContent=v;tr.appendChild(td);});
    td=document.createElement('td');td.textContent=o.incoterm||'-';tr.appendChild(td);
    td=document.createElement('td');td.appendChild(inlineSelect(o,'payment_terms',['Net 5','Net 10','Net 15','Net 20','Net 30','Net 40','Net 50','Net 60','Net 90']));tr.appendChild(td);

    td=document.createElement('td'); // generated docs tags
    const tagKinds=['so','invoice','pt','ci','rma'];
    const tagLinks=tagKinds.filter(k=>o.files?.[`${k}_pdf`]).map(k=>`<a href="#" class="link" onclick="openSigned('${o.id}','${o.files[`${k}_pdf`]}');return false;">${k.toUpperCase()}</a>`).join(' · ');
    td.innerHTML=tagLinks||'<span class="muted">None</span>';tr.appendChild(td);

    const mk=f=>{const c=document.createElement('input');c.type='checkbox';c.checked=!!o[f];c.onchange=async()=>{const prev=o[f];o[f]=c.checked;try{await supa.quickUpdate(o.id,f,c.checked);setToast('Saved');}catch(e){o[f]=prev;c.checked=prev;setToast('Save failed',true);}};return c;};
    td=document.createElement('td');td.appendChild(mk('is_shipped'));tr.appendChild(td);
    td=document.createElement('td');td.appendChild(mk('is_invoiced'));tr.appendChild(td);

    // FILES: clickable, signed on demand (robust)
    const hasPO=!!o.files?.po,hasTR=!!o.files?.test_report;
    td=document.createElement('td');
    td.innerHTML=[hasPO?`<a href="#" class="link" onclick="openSigned('${o.id}','${o.files.po}');return false;">PO</a>`:'',hasTR?`<a href="#" class="link" onclick="openSigned('${o.id}','${o.files.test_report}');return false;">Test</a>`:''].filter(Boolean).join(' · ')||'<span class="muted">-</span>';
    tr.appendChild(td);

    td=document.createElement('td');td.className='actions';td.innerHTML=`<button class="btn mini ghost" onclick="openModalById('${o.id}')">Edit</button><button class="btn mini ghost" onclick="cloneById('${o.id}')">Clone</button><button class="btn mini ghost" onclick="delById('${o.id}')">Delete</button>`;tr.appendChild(td);

    tb.appendChild(tr);
  });
}

/* ===== edit form ===== */
function addItemRow(v={part_number:'',date_codes:'',qty:'',qty_shipped:'',unit_sell:'',unit_cost:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="input mini" value="${esc(v.part_number)}"/></td>
  <td><input class="input mini" value="${esc(v.date_codes||'')}"/></td>
  <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
  <td><input type="number" step="1" class="input mini mono" value="${v.qty_shipped||0}"/></td>
  <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_sell||''}"/></td>
  <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_cost||''}"/></td>
  <td class="right"><button class="btn mini ghost" type="button" onclick="this.closest('tr').remove()">−</button></td>`;
  $('itemsBody').appendChild(tr);
}
function itemsFromDOM(){return[...$('itemsBody').querySelectorAll('tr')].map(tr=>{const [pn,dc,qty,qs,us,uc]=[...tr.querySelectorAll('input')].map(i=>i.value.trim());if(!pn)return null;return{part_number:pn,date_codes:dc,qty:+qty||0,qty_shipped:+qs||0,unit_sell:+us||0,unit_cost:+uc||0};}).filter(Boolean);}
function addShipRow(v={kind:'Leg',date:'',qty:'',from:'',to:'',method:'',ref:'',courier:'',tracking:'',cost:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><select class="select mini"><option ${v.kind==='Leg'?'selected':''}>Leg</option><option ${v.kind==='Inbound'?'selected':''}>Inbound</option><option ${v.kind==='Outbound'?'selected':''}>Outbound</option></select></td>
  <td><input type="date" class="input mini" value="${v.date||''}"/></td>
  <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
  <td><input class="input mini" value="${esc(v.from||'')}"/></td>
  <td><input class="input mini" value="${esc(v.to||'')}"/></td>
  <td><input class="input mini" value="${esc(v.method||'')}"/></td>
  <td><input class="input mini" value="${esc(v.ref||'')}"/></td>
  <td><input class="input mini" value="${esc(v.courier||'')}"/></td>
  <td><input class="input mini" value="${esc(v.tracking||'')}"/></td>
  <td><input type="number" step="0.01" class="input mini mono" value="${v.cost||''}"/></td>
  <td class="right"><button class="btn mini ghost" type="button" onclick="this.closest('tr').remove()">−</button></td>`;
  $('shipBody').appendChild(tr);
}
function shipsFromDOM(){return[...$('shipBody').querySelectorAll('tr')].map(tr=>{const kind=tr.querySelector('select').value;const [date,qty,from,to,method,ref,courier,tracking,cost]=[...tr.querySelectorAll('input')].map(i=>i.value.trim());if(!kind&&!date&&!qty&&!from&&!to&&!method&&!ref&&!courier&&!tracking&&!cost){return null;}return{kind,date,qty:+qty||0,from,to,method,ref,courier,tracking,cost:+cost||0};}).filter(Boolean);}

/* ===== open/clone/delete ===== */
function openModalById(id){openModal(supa.state.orders.find(x=>x.id===id));}
function openModal(o){
  window.openModal=openModal;
  $('dlgTitle').textContent=o?'Edit Order':'New Order';
  $('orderId').value=o?.id||'';
  $('salesperson').innerHTML=SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  $('editNoteAuthor').innerHTML=SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  ['status','salesperson','customer','priority','order_date','requested_by','payment_terms','payment_method','incoterm','invoice_date','due_date','currency','tests','test_center','supplier_lead_time','vendor','shipping_cost_extra','test_cost','notes','bill_to','ship_to'].forEach(id=>{$(id).value=o?.[id]??'';});
  $('itemsBody').innerHTML='';(o?.items||[]).forEach(addItemRow);$('shipBody').innerHTML='';(o?.shipments||[]).forEach(addShipRow);
  const list=(o?.staff_notes||[]).map(n=>`<div class="note-item"><div class="note-head"><b>${esc(n.author)}</b><span>${new Date(n.created_at).toLocaleString()}</span></div><div>${esc(n.body)}</div></div>`).join('')||'No notes yet';$('editNotesList').innerHTML=list;

  $('btnSave').onclick=async()=>{const orderData={id:$('orderId').value||undefined,status:$('status').value,salesperson:$('salesperson').value,customer:$('customer').value,priority:$('priority').value,order_date:$('order_date').value||null,requested_by:$('requested_by').value||null,payment_terms:$('payment_terms').value,payment_method:$('payment_method').value,incoterm:$('incoterm').value,invoice_date:$('invoice_date').value||null,due_date:$('due_date').value||null,currency:$('currency').value,tests:$('tests').value,test_center:$('test_center').value,supplier_lead_time:$('supplier_lead_time').value||null,vendor:$('vendor').value,shipping_cost_extra:parseFloat($('shipping_cost_extra').value)||0,test_cost:parseFloat($('test_cost').value)||0,notes:$('notes').value,bill_to:$('bill_to').value,ship_to:$('ship_to').value,items:itemsFromDOM(),shipments:shipsFromDOM()};const uploads={po:$('file_po').files[0]??null,test_report:$('file_test').files[0]??null};try{await supa.save(orderData,uploads);closeDlg('dlg');await supa.load();render();setToast('Saved');}catch(e){console.error(e);alert('Save failed: '+(e.message||e));}};
  $('btnDelete').onclick=async()=>{if(!o?.id){closeDlg('dlg');return;}if(!confirm('Delete this order?'))return;await supa.del(o.id);await supa.load();render();closeDlg('dlg');};

  showDlg('dlg');
}
async function cloneById(id){const o=supa.state.orders.find(x=>x.id===id);if(!o)return;const c=structuredClone(o);delete c.id;delete c.files;delete c.generated_docs;delete c.staff_notes;c.status='Open';c.order_date=todayStr();c.invoice_date=null;c.due_date=null;c.is_shipped=false;c.is_invoiced=false;c.shipments=[];await supa.save(c,{});await supa.load();render();}
async function delById(id){if(!confirm('Delete this order?'))return;await supa.del(id);await supa.load();render();}

/* ===== view ===== */
let OPEN_VIEW_ID=null;
function openViewById(id){const o=supa.state.orders.find(x=>x.id===id);if(o)openView(o);}
function renderOpenViewIfSame(){if(!OPEN_VIEW_ID)return;const o=supa.state.orders.find(x=>x.id===OPEN_VIEW_ID);if(o)openView(o,true);}
function openView(o,keep=false){
  OPEN_VIEW_ID=o.id;const t=totals(o),sym=curSym(o.currency);
  const parts=(o.items||[]).map(i=>`<tr><td>${esc(i.part_number)}</td><td>${esc(i.date_codes||'')}</td><td class="mono">${fmtInt(i.qty)}</td><td class="mono">${fmtInt(i.qty_shipped||0)}</td><td class="mono">${sym}${fmt(i.unit_sell)}</td><td class="mono">${sym}${fmt(i.unit_cost)}</td></tr>`).join('');
  const ships=(o.shipments||[]).map(s=>`<tr><td>${s.kind}</td><td class="mono">${esc(s.date||'')}</td><td class="mono">${fmtInt(s.qty||'')}</td><td>${esc(s.from||'')}</td><td>${esc(s.to||'')}</td><td>${esc(s.method||'')}</td><td>${esc(s.ref||'')}</td><td>${esc(s.courier||'')}</td><td>${esc(s.tracking||'')}</td><td class="mono">${s.cost? sym+fmt(s.cost):''}</td></tr>`).join('');
  const notesList=(o.staff_notes||[]).map(n=>`<div class="note-item"><div class="note-head"><b>${esc(n.author)}</b><span>${new Date(n.created_at).toLocaleString()}</span></div><div>${esc(n.body)}</div></div>`).join('')||'<div class="muted">No notes</div>';
  const genRows=(o.generated_docs||[]).slice().sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).map(g=>`<tr><td>${g.kind.replace('_pdf','').toUpperCase()}</td><td class="mono">${new Date(g.created_at).toLocaleString()}</td><td><button class="btn smini" onclick="openSigned('${o.id}','${g.path}')">View</button></td></tr>`).join('')||'<tr><td colspan="3" class="muted">No generated documents yet</td></tr>';

  $('viewBody').innerHTML=`
    <div class="card" style="grid-column:1/-1"><h3>Generate</h3><div class="pad">
      <button class="btn smini" onclick="openGenById('${o.id}','so')">OC</button>
      <button class="btn smini" onclick="openGenById('${o.id}','invoice')">INV</button>
      <button class="btn smini" onclick="openGenById('${o.id}','pt')">PT</button>
      <button class="btn smini" onclick="openGenById('${o.id}','ci')">CI</button>
      <button class="btn smini" onclick="openGenById('${o.id}','rma')">RMA</button>
    </div></div>

    <div class="card"><h3>Order Details</h3><div class="pad"><div class="kv">
      <div>Status</div><div>${esc(o.status||'-')}</div>
      <div>Customer</div><div>${esc(o.customer||'-')}</div>
      <div>Salesperson</div><div>${esc(o.salesperson||'-')}</div>
      <div>Priority</div><div>${esc(o.priority||'-')}</div>
      <div>Order Date</div><div>${esc(o.order_date||'-')}</div>
      <div>Requested by</div><div>${esc(o.requested_by||'-')}</div>
      <div>Vendor</div><div>${esc(o.vendor||'-')}</div>
      <div>Supplier Lead</div><div>${o.supplier_lead_time ?? '-'} days</div>
      <div>Incoterm</div><div>${esc(o.incoterm||'-')}</div>
      <div>Terms</div><div>${esc(o.payment_terms||'-')}</div>
      <div>Currency</div><div>${esc(o.currency||'-')}</div>
      <div>Tests</div><div>${esc(o.tests||'-')}</div>
      <div>Header Notes</div><div>${esc(o.notes||'-')}</div>
      <div>Shipped</div><div class="mono">${fmtInt(t.shipped)} / ${fmtInt(t.qty)} <span class="muted">(${fmt(t.shippedPct)}%)</span></div>
    </div></div></div>

    <div class="card"><h3>Addresses</h3><div class="pad"><div class="grid2">
      <div><div class="note">Bill To</div><pre style="white-space:pre-wrap;margin:0">${esc(o.bill_to||'-')}</pre></div>
      <div><div class="note">Ship To</div><pre style="white-space:pre-wrap;margin:0">${esc(o.ship_to||'-')}</pre></div>
    </div></div></div>

    <div class="card" style="grid-column:1/-1"><h3>Line Items</h3><div class="pad"><div class="hscroll">
      <table class="tbl" style="min-width:980px"><thead><tr><th>Part</th><th>Date Codes</th><th>Qty</th><th>Shipped Qty</th><th>Unit Sell</th><th>Unit Cost</th></tr></thead><tbody>${parts || '<tr><td colspan="6" class="muted">No items</td></tr>'}</tbody></table>
    </div></div></div>

    <div class="card" style="grid-column:1/-1"><h3>Shipments</h3><div class="pad"><div class="hscroll">
      <table class="tbl" style="min-width:1100px"><thead><tr><th>Kind</th><th>Date</th><th>Qty</th><th>From</th><th>To</th><th>Method</th><th>Ref</th><th>Courier</th><th>Tracking</th><th>Cost</th></tr></thead><tbody>${ships || '<tr><td colspan="10" class="muted">No shipments</td></tr>'}</tbody></table>
    </div></div></div>

    <div class="card"><h3>Totals</h3><div class="pad"><div class="kv">
      <div>Total Qty</div><div class="mono">${fmtInt(t.qty)}</div>
      <div>Sell</div><div class="mono">${sym}${fmt(t.revenue)}</div>
      <div>Item Cost</div><div class="mono">${sym}${fmt(t.itemCost)}</div>
      <div>Shipping Cost</div><div class="mono">${sym}${fmt(t.shipCost)}</div>
      <div>Test Cost</div><div class="mono">${sym}${fmt(t.testCost)}</div>
      <div>Total Cost</div><div class="mono">${sym}${fmt(t.cost)}</div>
      <div>GP</div><div><span class="pill">${sym}${fmt(t.gp)}</span> <span class="muted mono">(${fmt(t.gpPct)}%)</span></div>
      <div>Files</div>
      <div>${
        [ o.files?.po ? `<a class="link" href="#" onclick="openSigned('${o.id}','${o.files.po}');return false;">PO</a>` : '',
          o.files?.test_report ? `<a class="link" href="#" onclick="openSigned('${o.id}','${o.files.test_report}');return false;">Test</a>` : ''
        ].filter(Boolean).join(' · ') || '-'
      }</div>
    </div></div></div>

    <div class="card" style="grid-column:1/-1"><h3>Staff Notes</h3><div class="pad">
      <div id="notesList">${notesList}</div>
      <div class="actions" style="margin-top:10px">
        <select id="noteAuthor" class="select mini">${SALESTEAM.map(n=>`<option>${n}</option>`).join('')}</select>
        <input id="noteBody" class="input mini" placeholder="Write a note…"/>
        <button class="btn mini" onclick="addNote('${o.id}')">Add</button>
      </div>
    </div></div>

    <div class="card" style="grid-column:1/-1"><h3>Documents</h3><div class="pad"><div class="hscroll">
      <table class="tbl" style="min-width:560px"><thead><tr><th>Type</th><th>Created</th><th>Open</th></tr></thead><tbody>${genRows}</tbody></table>
    </div></div></div>
  `;
  if(!keep)showDlg('viewDlg');
  bindDocUploaders(o.id);
}
async function addNote(order_id){const author=$('noteAuthor').value;const body=$('noteBody').value.trim();if(!body)return;try{await supa.addNote(order_id,author,body);$('noteBody').value='';await supa.load();renderOpenViewIfSame();setToast('Note added');}catch(e){setToast('Failed to add note',true);}}
function bindDocUploaders(orderId){const po=$('qUpPO'),tr=$('qUpTR');if(po)po.onchange=e=>quickUploadFile(orderId,'po',e.target.files[0]);if(tr)tr.onchange=e=>quickUploadFile(orderId,'test_report',e.target.files[0]);}
async function openSigned(orderId,path){const {data:signed,error}=await supabase.storage.from('order-files').createSignedUrl(path,3600);if(error||!signed?.signedUrl){console.error('Signed URL error',error,path);alert('Could not open file.');return;}window.open(signed.signedUrl,'_blank');}

/* ===== quick uploads ===== */
async function quickUploadFile(orderId,kind,file){if(!file)return;try{setToast('Uploading '+kind+' …');await supa.upload(orderId,kind,file);await supa.load();renderOpenViewIfSame();render();setToast('Uploaded');}catch(e){console.error(e);setToast('Upload failed',true);}}

/* ===== generator (kept) ===== */
const PREFIX=location.pathname.includes('/order-tracker/')?'../':'';
const DOC_ROUTES={so:PREFIX+'so-confirmation/index.html',invoice:PREFIX+'so-confirmation/index.html#invoice',pt:PREFIX+'commercial-invoice/index.html#pt',ci:PREFIX+'commercial-invoice/index.html',rma:PREFIX+'rma/index.html'};
let GEN_CTX=null;
function openGenById(id,type){const o=supa.state.orders.find(x=>x.id===id);if(!o)return;GEN_CTX={order:o,type};$('docTypeChips').innerHTML=['so','invoice','pt','ci','rma'].map(k=>`<button class="chipbtn ${k===type?'active':''}" onclick="selectDocType('${k}')">${k==='so'?'Order Confirmation':k==='pt'?'Picking Ticket':k==='ci'?'Commercial Invoice':k.toUpperCase()}</button>`).join('');$('missingWrap').innerHTML='';$('genStatus').textContent='';$('genGo').onclick=()=>generateDoc(o,GEN_CTX.type);showDlg('genDlg');}
function selectDocType(k){GEN_CTX.type=k;[...document.querySelectorAll('#docTypeChips .chipbtn')].forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase().includes(k==='so'?'order':k)));}

window.addEventListener('message',async ev=>{if(!ev?.data||ev.data?.source!=='VE_DOC_GENERATOR')return;const msg=ev.data;if(msg.type==='ready'){GEN_CTX?.port?.postMessage({type:'payload',source:'VE_ORDER_TRACKER',order:GEN_CTX.order,docType:GEN_CTX.type});}else if(msg.type==='generated'){clearTimeout(GEN_CTX.timeout);$('genStatus').textContent='Uploading…';const b64=msg.base64;const fname=msg.filename||`${GEN_CTX.type}.pdf`;const bin=atob(b64);const u8=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);const blob=new Blob([u8],{type:'application/pdf'});try{await supa.uploadGenerated(GEN_CTX.order.id,GEN_CTX.type,new File([blob],fname,{type:'application/pdf'}));$('genStatus').textContent='Saved to Supabase ✓';await supa.load();renderOpenViewIfSame();render();}catch(e){console.error(e);$('genStatus').textContent='Upload failed';}}else if(msg.type==='error'){clearTimeout(GEN_CTX.timeout);$('genStatus').textContent='Generator error';}});
async function generateDoc(order,type){$('genStatus').textContent='Opening generator…';const route=DOC_ROUTES[type];const frame=$('genFrame');frame.src=route;const channel=new MessageChannel();GEN_CTX=GEN_CTX||{};GEN_CTX.port=channel.port1;frame.onload=()=>{$('genStatus').textContent='Preparing…';frame.contentWindow.postMessage({type:'init',source:'VE_ORDER_TRACKER'},'*',[channel.port2]);};GEN_CTX.timeout=setTimeout(()=>{$('genStatus').textContent='Generator timed out. Open doc page directly to debug.';},25000);}

/* ===== editor note adder ===== */
async function addNoteFromEdit(){const id=$('orderId').value;const body=$('editNoteBody').value.trim();if(!id||!body)return;const author=$('editNoteAuthor').value;try{await supa.addNote(id,author,body);$('editNoteBody').value='';await supa.load();const o=supa.state.orders.find(x=>x.id===id);const list=(o?.staff_notes||[]).map(n=>`<div class="note-item"><div class="note-head"><b>${esc(n.author)}</b><span>${new Date(n.created_at).toLocaleString()}</span></div><div>${esc(n.body)}</div></div>`).join('')||'No notes yet';$('editNotesList').innerHTML=list;setToast('Note added');}catch(e){setToast('Failed to add note',true);}}

/* ===== filters init & csv ===== */
function initFilters(){ $('fltSales').innerHTML='<option value="">All salespeople</option>'+SALESTEAM.map(n=>`<option>${n}</option>`).join(''); $('btnCsv').onclick=exportCsv; $('q').oninput=render; $('fltSales').onchange=render; $('fltStatus').onchange=render; $('fltPriority').onchange=render; $('btnNew').onclick=()=>openModal(null);}
function exportCsv(){const header=['id','customer','salesperson','status','priority','order_date','requested_by','currency','incoterm','payment_terms','vendor','total_qty','sell','gp','gp_pct','tests','notes'];const rows=supa.state.orders.map(o=>{const t=totals(o);return [o.id,o.customer||'',o.salesperson||'',o.status||'',o.priority||'',o.order_date||'',o.requested_by||'',o.currency||'',o.incoterm||'',o.payment_terms||'',o.vendor||'',t.qty,t.revenue.toFixed(2),t.gp.toFixed(2),t.gpPct.toFixed(2),o.tests||'',(o.notes||'').replace(/\n/g,' ')].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');});const csv=[header.join(','),...rows].join('\n');const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='orders.csv';a.click();}

/* ===== boot ===== */
window.onload=async()=>{try{initFilters();await supa.load();render();supa.rt();}catch(e){console.error('Init error',e);}};
</script>
</body>
</html>
