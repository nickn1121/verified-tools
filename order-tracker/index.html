<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Order Tracker — Verified Electronics</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
<script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>
<style>
:root{
  --brand:#673ab7; --ink:#1e1e1e; --muted:#677085;
  --bg:#f6f7fb; --card:#fff; --line:#e9e9ef; --line-strong:#d9d9e6;
  --pill:#efeafd; --pill-b:#e3ddfb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg);overflow-x:hidden}
.wrap{max-width:1160px;margin:24px auto;padding:0 16px}

header{
  display:flex;align-items:center;gap:14px;
  background:radial-gradient(1200px 260px at 160px -60px, rgba(103,58,183,.18), transparent 60%),linear-gradient(180deg,#fff,#fafaff);
  border:1px solid var(--line); padding:22px 18px; border-radius:18px; box-shadow:0 4px 24px rgba(0,0,0,.04);
}
header img{height:40px}
h1{font-size:28px;margin:0;font-weight:800}
.sub{color:var(--muted);margin-top:2px}

.toolbar{display:grid;grid-template-columns:1.6fr .9fr auto .9fr auto auto;gap:10px;margin:16px 0}
@media (max-width:1100px){ .toolbar{grid-template-columns:1fr 1fr 1fr} }
@media (max-width:720px){ .toolbar{grid-template-columns:1fr} }
.input,.select{width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;outline:none}
.input:focus,.select:focus{border-color:#c9c5ef;box-shadow:0 0 0 3px #ebe9ff}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn:hover{background:#fafafa}
.btn-primary{background:var(--pill);border-color:var(--pill-b);color:#3a2db1}
.btn-primary:hover{background:#eae4ff}
.btn-danger{border-color:#ffd6dc;background:#ffeff1;color:#a63a49}

.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 30px rgba(103,58,183,.06),0 1px 0 rgba(0,0,0,.02)}

/* table */
.table-wrap{border-radius:16px;overflow-x:auto}
.table{width:100%;min-width:1900px;border-collapse:separate;border-spacing:0}
.table thead th{
  background:#fbfbfe;color:#3b3f55;font-weight:700;padding:12px;border-bottom:1px solid var(--line);
  position:sticky;top:0;white-space:nowrap;
}
.table tbody td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top;white-space:nowrap}
.sep{border-right:2px solid var(--line-strong)}
.table thead th.sep{border-right:2px solid var(--line-strong)}

.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e8e8f5;background:#fbfbff;color:#5a46b6}
.b-pri{background:#f2f9f5;border-color:#d8efe3;color:#0d7e5b}
.b-warn{background:#fff7ec;border-color:#ffe3bf;color:#8a6119}
.b-dim{background:#f3f4f6;border-color:#e5e7eb;color:#6b7280}
.cell-edit{display:inline-flex;align-items:center;gap:6px}
.icon-btn{border:none;background:transparent;padding:2px 4px;border-radius:6px;cursor:pointer}
.icon-btn:hover{background:#f2f2ff}
.inline-select{padding:6px 8px;border:1px solid var(--line);border-radius:8px;outline:none}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
.gp-pos{color:#0d7e5b;font-weight:800}
.gp-neg{color:#a63a49;font-weight:800}
.small{font-size:12px;color:#6b7280}

/* Modal base */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
.modal{width:min(980px,100%);max-height:92vh;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 70px rgba(0,0,0,.18);display:flex;flex-direction:column;overflow:hidden}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line);border-radius:16px 16px 0 0;background:linear-gradient(180deg,#fff,#fbf9ff)}
.modal .body{padding:16px;overflow:auto}
.modal .footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;background:#fff;border-radius:0 0 16px 16px}
.section{border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
.section h4{margin:0 0 10px;font-size:13px;letter-spacing:.4px;font-weight:800;color:#382e8c}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){ .grid{grid-template-columns:1fr} }
.hint{font-size:12px;color:var(--muted)}

/* mini tables */
.mini-table{width:100%;border-collapse:separate;border-spacing:0}
.mini-table th,.mini-table td{padding:8px;border-bottom:1px solid var(--line)}
.mini-table thead th{background:#fbfbfe;font-weight:700;color:#3b3f55}
.mini-actions{display:flex;gap:8px}

/* View modal */
.kv{display:grid;grid-template-columns:220px 1fr;gap:8px;margin:6px 0}
.kv label{color:#48506a;font-weight:700}
.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified Electronics">
    <div style="flex:1">
      <h1>Order Tracker</h1>
      <div class="sub">Multi-part orders with date codes, priority, requested-by date, tests, multi-leg shipping costs, partial shipments, files & GP.</div>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <input id="searchInput" class="input" placeholder="Search: customer, part number, order ref..."/>
    <div style="display:flex;gap:8px">
      <select id="salesFilter" class="select"><option value="">All salespeople</option></select>
      <button id="manageSalesBtn" class="btn" title="Manage salespeople">⋯</button>
    </div>
    <select id="statusFilter" class="select">
      <option value="">All status</option>
      <option>New</option><option>PO Raised</option><option>Ordered</option>
      <option>Awaiting Test</option><option>At Test House</option>
      <option>Awaiting Vendor Dispatch</option><option>In Transit</option>
      <option>At Reshipper</option><option>With Us</option>
      <option>Delivered to Customer</option><option>On Hold</option>
      <option>Closed</option><option>Cancelled</option>
    </select>
    <select id="priorityFilter" class="select">
      <option value="">All priorities</option>
      <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
    </select>
    <button id="addOrderBtn" class="btn btn-primary">+ New Order</button>
    <button id="exportBtn" class="btn">Export CSV</button>
  </div>

  <!-- Table -->
  <div class="card table-wrap">
    <table class="table">
      <colgroup>
        <col style="width:180px"><!-- Customer -->
        <col style="width:260px"><!-- Part(s) -->
        <col style="width:120px"><!-- Sales -->
        <col style="width:90px"><!-- Qty -->
        <col style="width:120px"><!-- Sell (total) -->
        <col style="width:150px"><!-- GP -->
        <col style="width:150px"><!-- Status -->
        <col style="width:120px"><!-- Order Date -->
        <col style="width:130px"><!-- Requested -->
        <col style="width:90px"><!-- Age -->
        <col style="width:160px"><!-- Tests -->
        <col style="width:120px"><!-- Vendor -->
        <col style="width:110px"><!-- Incoterm -->
        <col style="width:120px"><!-- Terms -->
        <col style="width:140px"><!-- Pay -->
        <col style="width:120px"><!-- Ship -->
        <col style="width:120px"><!-- Invoice -->
        <col style="width:120px"><!-- Due -->
        <col style="width:260px"><!-- Ship Path -->
        <col style="width:140px"><!-- Files -->
        <col style="width:220px"><!-- Actions -->
      </colgroup>
      <thead>
        <tr>
          <th>Customer</th>
          <th class="sep">Part(s)</th>
          <th>Sales</th>
          <th>Total Qty</th>
          <th>Sell</th>
          <th class="sep">GP</th>
          <th>Status</th>
          <th>Order Date</th>
          <th>Requested by</th>
          <th class="sep">Age</th>
          <th>Tests</th>
          <th>Vendor</th>
          <th>Incoterm</th>
          <th class="sep">Terms</th>
          <th>Pay</th>
          <th class="sep">Ship</th>
          <th>Invoice</th>
          <th class="sep">Due</th>
          <th>Ship Path</th>
          <th class="sep">Files</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>
</div>

<!-- ORDER modal -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h3 id="modalTitle" style="margin:0;font-size:18px;font-weight:800">New Order</h3>
      <button id="closeModal" class="btn">✕</button>
    </header>
    <div class="body">
      <input type="hidden" id="orderId"/>

      <!-- SALES -->
      <div class="section">
        <h4>SALES — what Sales enters</h4>
        <div class="grid">
          <div><label>Salesperson</label><select id="salesperson" class="select"></select><div class="hint">Use “⋯” to manage this list.</div></div>
          <div><label>Customer</label><input id="customer" class="input" required></div>

          <div><label>Currency</label>
            <select id="currency" class="select">
              <option value="USD" selected>$ — USD</option>
              <option value="GBP">£ — GBP</option>
              <option value="EUR">€ — EUR</option>
            </select>
          </div>
          <div><label>Priority</label><select id="priority" class="select"><option>Normal</option><option>High</option><option>Critical</option><option>Low</option></select></div>

          <div>
            <label>Status</label>
            <select id="status" class="select">
              <option>New</option><option>PO Raised</option><option>Ordered</option>
              <option>Awaiting Test</option><option>At Test House</option>
              <option>Awaiting Vendor Dispatch</option><option>In Transit</option>
              <option>At Reshipper</option><option>With Us</option>
              <option>Delivered to Customer</option><option>On Hold</option>
              <option>Closed</option><option>Cancelled</option>
              <option value="__other">Other…</option>
            </select>
            <div id="status_other" class="hint" style="display:none"><input class="input" placeholder="Enter custom status"></div>
          </div>
          <div><label>Order Date</label><input id="order_date" type="date" class="input"></div>
          <div><label>Requested by</label><input id="requested_by" type="date" class="input"></div>
        </div>

        <!-- Line items -->
        <div class="section" style="margin-top:10px">
          <h4>Line Items (Part, Date Code, Qty, Unit Sell, Unit Cost)</h4>
          <table class="mini-table">
            <thead>
              <tr>
                <th style="width:240px">Part Number</th>
                <th style="width:160px">Date Code(s)</th>
                <th style="width:120px">Qty</th>
                <th style="width:150px">Unit Sell</th>
                <th style="width:150px">Unit Cost</th>
                <th style="width:120px"></th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
          <div class="mini-actions" style="margin-top:8px">
            <button type="button" id="addItemBtn" class="btn">+ Add item</button>
            <div class="hint">If the same part arrives in multiple DCs, add a line per DC.</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Customer PO (for open orders)</label>
          <input id="file_po" type="file" accept=".pdf,.doc,.docx,.rtf,.txt,image/*" class="input">
          <div id="po_note" class="hint" style="margin-top:6px"></div>
        </div>
      </div>

      <!-- PURCHASING -->
      <div class="section">
        <h4>PURCHASING — what Purchasing updates</h4>
        <div class="grid">
          <div><label>Vendor</label><input id="vendor" class="input"></div>
          <div><label>Tracking (vendor/reshipper)</label><input id="tracking" class="input"></div>

          <div><label>Test Cost</label><input id="test_cost" type="number" step="0.01" min="0" class="input"></div>
          <div><label>Other Shipping Cost</label><input id="shipping_cost_extra" type="number" step="0.01" min="0" class="input"></div>

          <!-- Financial preview -->
          <div class="section" style="grid-column:1/-1">
            <h4>Financials (auto)</h4>
            <div class="kv"><label>Revenue</label><div id="fin_revenue">$0</div></div>
            <div class="kv"><label>Total Cost</label><div id="fin_cost">$0</div></div>
            <div class="kv"><label>Gross Profit</label><div id="fin_gp" class="gp-pos">$0 (0%)</div></div>
            <div class="hint">Total shipping = sum of leg costs + other shipping cost.</div>
          </div>

          <!-- Inbound shipments -->
          <div style="grid-column:1/-1">
            <div class="section" style="margin:0">
              <h4>Inbound Shipments (Supplier/Reshipper → Us)</h4>
              <table class="mini-table">
                <thead><tr><th style="width:160px">Date</th><th style="width:140px">Qty</th><th style="width:220px">Courier</th><th>Tracking</th><th style="width:120px"></th></tr></thead>
                <tbody id="inboundShipmentsBody"></tbody>
              </table>
              <div class="mini-actions" style="margin-top:8px">
                <button type="button" id="addInboundShipmentBtn" class="btn">+ Add inbound</button>
              </div>
            </div>
          </div>

          <!-- Ship path with per-leg cost -->
          <div style="grid-column:1/-1">
            <div class="section" style="margin:0">
              <h4>Ship Path (From → To, Method, Ref, <span class="mono">Cost</span>)</h4>
              <table class="mini-table">
                <thead><tr><th>From</th><th>To</th><th>Method</th><th>Ref</th><th style="width:160px">Cost</th><th style="width:120px"></th></tr></thead>
                <tbody id="shipLegs"></tbody>
              </table>
              <div class="mini-actions" style="margin-top:8px">
                <button type="button" id="addLegBtn" class="btn">+ Add leg</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- WAREHOUSE -->
      <div class="section">
        <h4>WAREHOUSE — shipping from our warehouse</h4>
        <div class="grid">
          <div>
            <label>Warehouse</label>
            <select id="wh_location" class="select">
              <option>UK Warehouse</option><option>HK Warehouse</option>
              <option>US Warehouse</option><option>CN Warehouse</option>
              <option value="__other">Other…</option>
            </select>
            <div id="wh_location_other" class="hint" style="display:none"><input class="input" placeholder="Enter warehouse"></div>
          </div>
          <div>
            <label>Courier</label>
            <select id="wh_courier" class="select">
              <option>DHL</option><option>FedEx</option><option>UPS</option><option>TNT</option><option>DPD</option><option>Royal Mail</option>
              <option value="__other">Other…</option>
            </select>
            <div id="wh_courier_other" class="hint" style="display:none"><input class="input" placeholder="Enter courier"></div>
          </div>
          <div><label>Tracking No.</label><input id="wh_tracking" class="input" placeholder="e.g. 1234567890"></div>

          <!-- Outbound shipments -->
          <div style="grid-column:1/-1">
            <div class="section" style="margin:0">
              <h4>Outbound Shipments (Us/Reshipper → Customer)</h4>
              <table class="mini-table">
                <thead><tr><th style="width:160px">Date</th><th style="width:140px">Qty</th><th style="width:220px">Courier</th><th>Tracking</th><th style="width:120px"></th></tr></thead>
                <tbody id="outboundShipmentsBody"></tbody>
              </table>
              <div class="mini-actions" style="margin-top:8px">
                <button type="button" id="addOutboundShipmentBtn" class="btn">+ Add outbound</button>
                <div class="hint">Invoice = latest **outbound** shipment date. Due = invoice date + Payment Terms.</div>
              </div>
            </div>
          </div>

          <div style="grid-column:1/-1">
            <label>Test Report (for closed orders)</label>
            <input id="file_test" type="file" accept=".pdf,.doc,.docx,.rtf,.txt,image/*" class="input">
            <div id="test_note" class="hint" style="margin-top:6px"></div>
          </div>

          <div style="grid-column:1/-1">
            <label>Notes</label>
            <textarea id="notes" rows="3" class="input"></textarea>
          </div>
        </div>
      </div>

      <div class="footer">
        <button id="deleteBtn" class="btn btn-danger" style="display:none">Delete</button>
        <span style="flex:1"></span>
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="saveBtn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- VIEW modal -->
<div id="viewOverlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
    <header>
      <h3 id="viewTitle" style="margin:0;font-size:18px;font-weight:800">Order</h3>
      <button id="closeView" class="btn">✕</button>
    </header>
    <div class="body" id="viewBody"></div>
    <div class="footer"><button id="closeView2" class="btn btn-primary">Close</button></div>
  </div>
</div>

<!-- Manage Salespeople -->
<div id="salesOverlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="salesTitle" style="max-width:560px">
    <header><h3 id="salesTitle" style="margin:0;font-size:18px;font-weight:800">Manage Salespeople</h3><button id="closeSales" class="btn">✕</button></header>
    <div class="body">
      <div class="hint" style="margin-bottom:10px">Add/remove names. Changes apply to filter and the order form.</div>
      <div id="salesList"></div>
      <div style="display:flex;gap:8px;margin-top:10px"><input id="newSalesName" class="input" placeholder="Add name (e.g. Alice S)"><button id="addSalesNameBtn" class="btn btn-primary">Add</button></div>
    </div>
  </div>
</div>

<datalist id="couriers">
  <option value="DHL"><option value="FedEx"><option value="UPS">
  <option value="TNT"><option value="DPD"><option value="Royal Mail">
</datalist>

<script>
/* ============ helpers & storage ============ */
const LS_ORDERS='ve.orders', LS_SALES='ve.salespeople';
const DEFAULT_SALES=["Nick N","Dan C","Emir B","Nick K","Jake B"];
const TERM_DAYS={ "Net 5":5,"Net 10":10,"Net 15":15,"Net 20":20,"Net 30":30,"Net 40":40,"Net 50":50,"Net 60":60,"Net 90":90 };
const CURR_SYMBOL={ USD:'$', GBP:'£', EUR:'€' };
window._sessionFiles = window._sessionFiles || {}; // { [orderId]: { poUrl?, testUrl? } }

const $=id=>document.getElementById(id);
const uuid=()=> 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});
const shortRef=id=>id.replace(/-/g,'').slice(0,8).toUpperCase();
const safe=s=>(s||'').replace(/[^a-z0-9._-]+/gi,'_');
function addDays(dateStr,days){ if(!dateStr) return ''; const d=new Date(dateStr+'T00:00:00'); d.setDate(d.getDate()+(days||0)); return d.toISOString().slice(0,10); }
const fmtDays=(dateStr)=>{ if(!dateStr) return '-'; const n=dayjs().diff(dayjs(dateStr),'day'); return isNaN(n)?'-':`${n} day${n===1?'':'s'}`; };

function getOrders(){ try{const v=JSON.parse(localStorage.getItem(LS_ORDERS)||'[]'); return Array.isArray(v)?v:[];}catch{return[];} }
function setOrders(v){ localStorage.setItem(LS_ORDERS,JSON.stringify(v)); }
function getSalespeople(){ try{const v=JSON.parse(localStorage.getItem(LS_SALES)||'[]'); if(Array.isArray(v)&&v.length) return v;}catch{} localStorage.setItem(LS_SALES,JSON.stringify(DEFAULT_SALES)); return [...DEFAULT_SALES]; }
function setSalespeople(v){ localStorage.setItem(LS_SALES,JSON.stringify(v)); refreshSalesControls(); }

/* money format with thousands separators; default 0 decimals for table; 2 in modals */
const nf=(dec=0)=> new Intl.NumberFormat(undefined,{minimumFractionDigits:dec,maximumFractionDigits:dec});
function money(n,curr,dec=0){ const sym=CURR_SYMBOL[curr||'USD']||'$'; return sym + nf(dec).format(Number(n)||0); }

/* ===== UI basics ===== */
const ordersBody=$('ordersBody');
const salesFilter=$('salesFilter'), statusFilter=$('statusFilter'), priorityFilter=$('priorityFilter'), searchInput=$('searchInput');
function refreshSalesControls(){
  const list=getSalespeople();
  salesFilter.innerHTML='<option value="">All salespeople</option>'+list.map(n=>`<option>${n}</option>`).join('');
  $('salesperson').innerHTML=list.map(n=>`<option>${n}</option>`).join('');
}

/* ===== Other… select helpers ===== */
function wireOther(selectId,wrapId){
  const sel=$(selectId), wrap=$(wrapId), input=wrap.querySelector('input');
  const toggle=()=>{ wrap.style.display = sel.value==='__other' ? 'block':'none'; if(sel.value!=='__other') input.value=''; };
  sel.addEventListener('change',toggle); toggle();
}
function readChoice(selectId,wrapId){
  const sel=$(selectId), wrap=$(wrapId), input=wrap.querySelector('input');
  return sel.value==='__other' ? input.value.trim() : sel.value;
}
function setChoice(selectId,wrapId,value,allowed){
  const sel=$(selectId), wrap=$(wrapId), input=wrap.querySelector('input');
  if(allowed.includes(value)){ sel.value=value; wrap.style.display='none'; input.value=''; }
  else { sel.value='__other'; wrap.style.display='block'; input.value=value||''; }
}

/* ===== Tests group ===== */
function testsToArray(){
  const boxes=[...document.querySelectorAll('input[name="test_req"]')];
  let out=boxes.filter(b=>b.checked).map(b=>b.value);
  const otherSelected = boxes.find(b=>b.id==='t_other')?.checked;
  if(otherSelected){
    const extra=$('test_other_input')?.value?.trim();
    if(extra) out.push('Other: '+extra);
  }
  const none = boxes.find(b=>b.id==='t_none')?.checked;
  if(none) out=['No test'];
  return out;
}
function setTests(arr){
  const set=new Set(arr||[]);
  const boxes=[...document.querySelectorAll('input[name="test_req"]')];
  boxes.forEach(b=>b.checked=false);
  boxes.forEach(b=>{
    if(b.value==='Other'){
      const otherVal=(arr||[]).find(v=>/^Other:\s*/i.test(v));
      b.checked=set.has('Other')||!!otherVal;
      document.getElementById('test_other_input').value = otherVal?otherVal.replace(/^Other:\s*/i,''):'';
      document.getElementById('test_other_wrap').style.display=b.checked?'block':'none';
    } else { b.checked=set.has(b.value); }
  });
}
function wireTests(){
  const none=$('t_none'), other=$('t_other');
  document.querySelectorAll('input[name="test_req"]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      if(cb===none && none.checked){
        document.querySelectorAll('input[name="test_req"]').forEach(b=>{ if(b!==none) b.checked=false; });
        $('test_other_wrap').style.display='none'; $('test_other_input').value='';
      }else{
        if(none.checked && cb!==none) none.checked=false;
        $('test_other_wrap').style.display = other.checked ? 'block' : 'none';
        if(!other.checked) $('test_other_input').value='';
      }
    });
  });
}

/* ===== Items (multi-part) ===== */
function addItemRow(part='',dc='',qty='',sell='',cost=''){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="input" placeholder="e.g. LE25S20FD-AH" value="${part||''}"></td>
    <td><input class="input" placeholder="e.g. 2329, 2412" value="${dc||''}"></td>
    <td><input type="number" min="0" class="input" value="${qty||''}"></td>
    <td><input type="number" min="0" step="0.01" class="input" value="${sell||''}"></td>
    <td><input type="number" min="0" step="0.01" class="input" value="${cost||''}"></td>
    <td><button class="btn btn-danger" type="button">Remove</button></td>`;
  tr.querySelector('button').onclick=()=>{ tr.remove(); updateFinPreview(); };
  // live preview updates
  tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',updateFinPreview));
  $('itemsBody').appendChild(tr);
}
function itemsFromDOM(){
  return [...$('itemsBody').querySelectorAll('tr')].map(tr=>{
    const [p,dc,q,s,c]=tr.querySelectorAll('input');
    return {
      part_number:p.value.trim(),
      date_codes:dc.value.trim(),
      qty: q.value===''?null:Number(q.value),
      unit_sell: s.value===''?null:Number(s.value),
      unit_cost: c.value===''?null:Number(c.value)
    };
  }).filter(x=>x.part_number || x.qty!=null || x.unit_sell!=null || x.unit_cost!=null || x.date_codes);
}
function sumQty(items){ return (items||[]).reduce((a,l)=>a+(Number(l.qty)||0),0); }

/* ===== Ship legs (with per-leg cost) ===== */
function addShipLeg(from='',to='',method='',ref='',cost=''){
  const row=document.createElement('tr');
  row.innerHTML=`
    <td><input class="input" placeholder="From" value="${from||''}"></td>
    <td><input class="input" placeholder="To" value="${to||''}"></td>
    <td><input class="input" placeholder="Method (e.g. DHL)" value="${method||''}"></td>
    <td><input class="input" placeholder="Ref" value="${ref||''}"></td>
    <td><input class="input" type="number" step="0.01" min="0" placeholder="0.00" value="${cost!==''?cost:''}"></td>
    <td><button type="button" class="btn btn-danger">Remove</button></td>`;
  row.querySelector('button').onclick=()=>{ row.remove(); updateFinPreview(); };
  row.querySelectorAll('input').forEach(i=>i.addEventListener('input',updateFinPreview));
  $('shipLegs').appendChild(row);
}
function legsFromDOM(){
  return [...$('shipLegs').querySelectorAll('tr')].map(tr=>{
    const [from,to,method,ref,cost]=tr.querySelectorAll('input');
    return { from:from.value.trim(), to:to.value.trim(), method:method.value.trim(), ref:ref.value.trim(),
      cost: cost.value===''?null:Number(cost.value) };
  }).filter(l=>l.from||l.to||l.method||l.ref||l.cost!=null);
}
function legCostSum(legs){ return (Array.isArray(legs)?legs:[]).reduce((a,l)=>a+(Number(l.cost)||0),0); }

/* ===== Shipments ===== */
function addShipmentRowTo(tbodyId,date='',qty='',courier='',tracking=''){
  const tbody=$(tbodyId);
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="date" class="input" style="padding:8px" value="${date||''}"></td>
    <td><input type="number" min="0" class="input" style="padding:8px" value="${qty||''}"></td>
    <td><input class="input" style="padding:8px" list="couriers" placeholder="DHL, FedEx…" value="${courier||''}"></td>
    <td><input class="input" style="padding:8px" placeholder="Tracking number" value="${tracking||''}"></td>
    <td><button type="button" class="btn btn-danger">Remove</button></td>`;
  tr.querySelector('button').onclick=()=>tr.remove();
  tbody.appendChild(tr);
}
function getShipmentRows(tbodyId){
  return [...$(tbodyId).querySelectorAll('tr')].map(tr=>{
    const [d,q,c,t]=tr.querySelectorAll('input');
    return {date:d.value||null, qty: q.value===''?null:Number(q.value), courier:c.value.trim()||null, tracking:t.value.trim()||null};
  }).filter(s=>s.date || s.qty || s.courier || s.tracking);
}

/* ===== Financials ===== */
function toNum(v){ const n=Number(v); return isFinite(n)?n:0; }
function computeFinancials(o){
  const items=o.items||[];
  const rev = items.reduce((a,l)=>a + (toNum(l.qty)*toNum(l.unit_sell)), 0);
  const itemsCost = items.reduce((a,l)=>a + (toNum(l.qty)*toNum(l.unit_cost)), 0);
  const legsTotal = legCostSum(o.ship_path || []);
  const extra = toNum(o.shipping_cost_extra ?? o.shipping_cost); // compat
  const totalCost = itemsCost + toNum(o.test_cost) + legsTotal + extra;
  const gp = rev - totalCost;
  const gpPct = rev>0 ? (gp/rev*100) : 0;
  return {rev,totalCost,gp,gpPct,legsTotal,extra};
}
function updateFinPreview(){
  const rec = {
    currency: $('currency').value,
    items: itemsFromDOM(),
    test_cost: $('test_cost').value,
    shipping_cost_extra: $('shipping_cost_extra').value,
    ship_path: legsFromDOM()
  };
  const F=computeFinancials(rec);
  $('fin_revenue').textContent = money(F.rev, rec.currency, 0);
  $('fin_cost').textContent = money(F.totalCost, rec.currency, 0);
  const el=$('fin_gp');
  el.textContent = `${F.gp>=0?'+':''}${money(F.gp, rec.currency, 0)} (${isFinite(F.gpPct)?Math.round(F.gpPct):0}%)`;
  el.className = F.gp>=0 ? 'gp-pos' : 'gp-neg';
}

/* ===== Modal open/close/populate ===== */
function openModal(order){
  $('overlay').style.display='flex';
  $('modalTitle').textContent=order?`Edit Order — ${shortRef(order.id)}`:'New Order';
  $('deleteBtn').style.display=order?'inline-block':'none';
  $('orderId').value='';

  // reset groups
  $('itemsBody').innerHTML=''; addItemRow();
  $('shipLegs').innerHTML=''; addShipLeg();
  $('inboundShipmentsBody').innerHTML=''; addShipmentRowTo('inboundShipmentsBody');
  $('outboundShipmentsBody').innerHTML=''; addShipmentRowTo('outboundShipmentsBody');

  $('po_note').textContent=''; $('test_note').textContent='';
  $('order_date').valueAsDate=new Date();
  $('payment_terms').value='Net 30'; $('status').value='New'; $('priority').value='Normal';
  $('shipping_cost_extra').value=''; $('test_cost').value='';
  $('vendor').value=''; $('tracking').value='';
  $('wh_location').value='UK Warehouse'; $('wh_courier').value='DHL'; $('wh_tracking').value='';
  $('currency').value='USD'; $('customer').value='';

  ['status_other','wh_location_other','wh_courier_other'].forEach(id=>$(id).style.display='none');
  setTests([]);

  if(order){
    $('orderId').value=order.id;
    $('salesperson').value=order.salesperson||getSalespeople()[0];
    $('customer').value=order.customer||'';
    $('currency').value=order.currency||'USD';
    $('priority').value=order.priority||'Normal';
    setChoice('status','status_other', order.status||'New',
      ["New","PO Raised","Ordered","Awaiting Test","At Test House","Awaiting Vendor Dispatch","In Transit","At Reshipper","With Us","Delivered to Customer","On Hold","Closed","Cancelled"]
    );
    $('order_date').value=order.order_date||'';
    $('requested_by').value=order.requested_by||'';
    $('vendor').value=order.vendor||'';
    $('tracking').value=order.tracking||'';
    $('test_cost').value=order.test_cost??'';
    $('shipping_cost_extra').value=(order.shipping_cost_extra ?? order.shipping_cost) ?? '';

    // items (fallback to legacy single fields)
    const items = Array.isArray(order.items) && order.items.length
      ? order.items
      : [{
          part_number: order.part_number||'',
          date_codes: '',
          qty: order.quantity??null,
          unit_sell: order.sell_price??null,
          unit_cost: order.unit_cost??null
        }];
    $('itemsBody').innerHTML=''; items.forEach(i=>addItemRow(i.part_number,i.date_codes,i.qty??'',i.unit_sell??'',i.unit_cost??''));

    // legs
    const legs=Array.isArray(order.ship_path)?order.ship_path:[];
    $('shipLegs').innerHTML=''; if(!legs.length) addShipLeg(); else legs.forEach(l=>addShipLeg(l.from,l.to,l.method,l.ref,l.cost??''));

    // shipments
    const inbound=Array.isArray(order.inbound_shipments)?order.inbound_shipments:[];
    $('inboundShipmentsBody').innerHTML=''; if(!inbound.length) addShipmentRowTo('inboundShipmentsBody'); else inbound.forEach(s=>addShipmentRowTo('inboundShipmentsBody',s.date||'', s.qty??'', s.courier||'', s.tracking||''));
    const outbound=Array.isArray(order.outbound_shipments)?order.outbound_shipments:(Array.isArray(order.shipments)?order.shipments:[]);
    $('outboundShipmentsBody').innerHTML=''; if(!outbound.length) addShipmentRowTo('outboundShipmentsBody'); else outbound.forEach(s=>addShipmentRowTo('outboundShipmentsBody',s.date||'', s.qty??'', s.courier||'', s.tracking||''));

    // files notes
    if(order.files?.po) $('po_note').textContent=`Existing: ${order.files.po}`;
    if(order.files?.test_report) $('test_note').textContent=`Existing: ${order.files.test_report}`;

    setTests(order.tests||[]);
    setChoice('wh_location','wh_location_other', order.wh_location||'UK Warehouse', ['UK Warehouse','HK Warehouse','US Warehouse','CN Warehouse']);
    setChoice('wh_courier','wh_courier_other', order.wh_courier||'DHL', ['DHL','FedEx','UPS','TNT','DPD','Royal Mail']);
    $('wh_tracking').value=order.wh_tracking||'';
  }
  updateFinPreview();
}
function closeModal(){ $('overlay').style.display='none'; }

/* ===== Derived helpers for table ===== */
function latestShipmentDate(shipments){ const dates=(shipments||[]).map(s=>s.date).filter(Boolean).sort(); return dates.length?dates[dates.length-1]:''; }
function shippedQty(shipments){ return (shipments||[]).reduce((a,s)=>a+(Number(s.qty)||0),0); }
function shipText(legs){ return (Array.isArray(legs)?legs:[]).map(l=>`${l.from||'?'}→${l.to||'?'}`).join(' • '); }
function badgeStatus(s){ const done=['Closed','Delivered to Customer','Cancelled']; const warn=['On Hold','Awaiting Vendor Dispatch','Awaiting Test','At Test House']; const cls=done.includes(s)?'b-dim':warn.includes(s)?'b-warn':'b-pri'; return `<span class="badge ${cls}">${s}</span>`; }

/* ===== Render main table ===== */
function render(){
  const data=getOrders().sort((a,b)=> (b.order_date||'').localeCompare(a.order_date||''));
  const q=(searchInput.value||'').toLowerCase();
  const rows=data.filter(r=>{
    if(salesFilter.value && r.salesperson!==salesFilter.value) return false;
    if(statusFilter.value && r.status!==statusFilter.value) return false;
    if(priorityFilter.value && r.priority!==priorityFilter.value) return false;
    if(!q) return true;
    const itemParts=(r.items||[]).map(i=>i.part_number).join(' ');
    const blob=`${shortRef(r.id)} ${r.customer} ${itemParts} ${r.salesperson}`.toLowerCase();
    return blob.includes(q);
  });

  if(!rows.length){ ordersBody.innerHTML=`<tr><td colspan="21" style="padding:16px;color:var(--muted);text-align:center">No orders yet.</td></tr>`; return; }

  ordersBody.innerHTML=rows.map(r=>{
    const files=r.files||{}; const urls=(window._sessionFiles[r.id]||{});
    const fileBits=[];
    if(files.po) fileBits.push(urls.poUrl?`<a href="${urls.poUrl}" target="_blank" rel="noopener">PO</a>`:'PO');
    if(files.test_report) fileBits.push(urls.testUrl?`<a href="${urls.testUrl}" target="_blank" rel="noopener">Report</a>`:'Report');
    const filesTxt=fileBits.join(' · ') || '';

    const legsTxt=shipText(r.ship_path);
    const outbound=Array.isArray(r.outbound_shipments)?r.outbound_shipments:(Array.isArray(r.shipments)?r.shipments:[]);
    const invDate=latestShipmentDate(outbound);
    const due=invDate?addDays(invDate,(TERM_DAYS[r.payment_terms]||0)):'';
    const shipped=shippedQty(outbound);

    const items = Array.isArray(r.items) && r.items.length
      ? r.items
      : [{ part_number:r.part_number||'', date_codes:'', qty:r.quantity??null, unit_sell:r.sell_price??null, unit_cost:r.unit_cost??null }];

    const F=computeFinancials({ items, test_cost:r.test_cost, shipping_cost_extra:(r.shipping_cost_extra ?? r.shipping_cost), ship_path:r.ship_path, currency:r.currency });
    const gpClass = F.gp>=0 ? 'gp-pos' : 'gp-neg';
    const totalQty = sumQty(items);
    const first = items[0]?.part_number || '';
    const more = items.length>1 ? ` +${items.length-1} more` : '';
    const partsCell = `<span title="${items.map(i=>i.part_number+(i.date_codes?` (DC: ${i.date_codes})`:'')).join(' | ')}">${first}${more}</span>`;

    return `<tr>
      <td>${r.customer||''}</td>
      <td class="sep mono">${partsCell}</td>
      <td>${r.salesperson||''}</td>
      <td>${totalQty||0}</td>
      <td>${money(F.rev, r.currency||'USD', 0)}</td>
      <td class="sep ${gpClass}">${F.gp>=0?'+':''}${money(F.gp, r.currency||'USD', 0)} <span class="small">(${isFinite(F.gpPct)?Math.round(F.gpPct):0}%)</span></td>
      <td><span class="cell-edit">${badgeStatus(r.status||'New')} <button class="icon-btn edit-btn" title="Edit status" data-field="status" data-id="${r.id}">✎</button></span></td>
      <td>${r.order_date||''}</td>
      <td>${r.requested_by||''}</td>
      <td class="sep">${fmtDays(r.order_date)}</td>
      <td>${(r.tests||[]).join(' · ')}</td>
      <td>${r.vendor||''}</td>
      <td><span class="cell-edit">${r.incoterm||''} <button class="icon-btn edit-btn" title="Edit incoterm" data-field="incoterm" data-id="${r.id}">✎</button></span></td>
      <td class="sep"><span class="cell-edit">${r.payment_terms||''} <button class="icon-btn edit-btn" title="Edit terms" data-field="payment_terms" data-id="${r.id}">✎</button></span></td>
      <td><span class="cell-edit">${r.payment_method||''} <button class="icon-btn edit-btn" title="Edit payment method" data-field="payment_method" data-id="${r.id}">✎</button></span></td>
      <td class="sep">${(totalQty!=null)?`${shipped} / ${totalQty}`:shipped}</td>
      <td>${invDate}</td>
      <td class="sep">${due}</td>
      <td>${legsTxt}</td>
      <td class="sep">${filesTxt}</td>
      <td>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" data-view="${r.id}">View</button>
          <button class="btn" data-edit="${r.id}">Edit</button>
          <button class="btn btn-danger" data-del="${r.id}">Delete</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  [...ordersBody.querySelectorAll('[data-edit]')].forEach(b=>b.addEventListener('click',()=>{ const row=getOrders().find(x=>x.id===b.dataset.edit); openModal(row); }));
  [...ordersBody.querySelectorAll('[data-view]')].forEach(b=>b.addEventListener('click',()=>{ const row=getOrders().find(x=>x.id===b.dataset.view); openView(row); }));
  [...ordersBody.querySelectorAll('[data-del]')].forEach(b=>b.addEventListener('click',()=>{
    const id=b.dataset.del;
    if(confirm('Delete this order?')){
      setOrders(getOrders().filter(x=>x.id!==id));
      delete window._sessionFiles[id];
      render();
    }
  }));
}

/* ===== Inline editing (status/terms/method/incoterm) ===== */
const OPTIONS={
  payment_terms:["Net 5","Net 10","Net 15","Net 20","Net 30","Net 40","Net 50","Net 60","Net 90"],
  status:["New","PO Raised","Ordered","Awaiting Test","At Test House","Awaiting Vendor Dispatch","In Transit","At Reshipper","With Us","Delivered to Customer","On Hold","Closed","Cancelled"],
  incoterm:["DAP","EXW","FCA","FOB","CFR","CIF","CPT","CIP","DPU","DDP"],
  payment_method:["Bank Transfer","Credit Card","PayPal","Other"]
};
ordersBody.addEventListener('click',(e)=>{
  const btn=e.target.closest('.edit-btn'); if(!btn) return;
  const field=btn.dataset.field, id=btn.dataset.id, cell=btn.closest('td');
  openSelectEditor(cell,id,field);
});
function openSelectEditor(cell,id,field){
  const orders=getOrders(); const row=orders.find(r=>r.id===id); if(!row) return;
  const current=row[field]||''; const opts=OPTIONS[field]||[];
  const sel=document.createElement('select'); sel.className='inline-select';
  sel.innerHTML=opts.map(o=>`<option ${o===current?'selected':''}>${o}</option>`).join('')+`<option value="__other">Other…</option>`;
  const save=(val)=>{ if(val==='__other'){ const c=prompt('Enter custom value:', current||''); if(c===null){ render(); return; } updateField(id,field,c.trim()); } else { updateField(id,field,val); } };
  sel.addEventListener('change',()=>save(sel.value));
  cell.innerHTML=''; cell.appendChild(sel); sel.focus();
}
function updateField(id,field,value){ const orders=getOrders(); const i=orders.findIndex(r=>r.id===id); if(i<0) return; orders[i][field]=value; setOrders(orders); render(); }

/* ===== Save / Delete ===== */
$('saveBtn').addEventListener('click',(e)=>{
  e.preventDefault();
  const cust=$('customer').value.trim(); if(!cust){ alert('Please fill Customer'); return; }
  const items=itemsFromDOM(); if(!items.length || !items[0].part_number){ alert('Please add at least one line item (part).'); return; }

  const id=$('orderId').value || uuid();

  const legs=legsFromDOM();
  const inbound=getShipmentRows('inboundShipmentsBody');
  const outbound=getShipmentRows('outboundShipmentsBody');

  const files={};
  const po=$('file_po').files[0]; if(po){ files.po=safe(po.name); const url=URL.createObjectURL(po); (window._sessionFiles[id] ||= {}).poUrl=url; }
  const tr=$('file_test').files[0]; if(tr){ files.test_report=safe(tr.name); const url=URL.createObjectURL(tr); (window._sessionFiles[id] ||= {}).testUrl=url; }

  const rec={
    id,
    salesperson:$('salesperson').value,
    customer:cust,
    currency:$('currency').value,
    priority:$('priority').value,
    status:readChoice('status','status_other'),
    order_date:$('order_date').value || null,
    requested_by:$('requested_by').value || null,
    vendor:$('vendor').value.trim() || null,
    tracking:$('tracking').value.trim() || null,

    items,                                // <-- multi-part lines
    tests:testsToArray(),

    ship_path:legs,                        // each leg may have cost
    inbound_shipments:inbound,
    outbound_shipments:outbound,

    test_cost: $('test_cost').value===''?null:Number($('test_cost').value),
    shipping_cost_extra: $('shipping_cost_extra').value===''?null:Number($('shipping_cost_extra').value),

    files,
    notes:$('notes').value.trim() || null,
    wh_location:readChoice('wh_location','wh_location_other'),
    wh_courier:readChoice('wh_courier','wh_courier_other'),
    wh_tracking:$('wh_tracking').value.trim() || null
  };

  const all=getOrders(); const i=all.findIndex(x=>x.id===id);
  if(i>=0) all[i]=rec; else all.unshift(rec);
  setOrders(all);
  closeModal(); render();
});
$('deleteBtn').addEventListener('click',()=>{
  const id=$('orderId').value; if(!id) return;
  if(!confirm('Delete this order?')) return;
  setOrders(getOrders().filter(x=>x.id!==id)); delete window._sessionFiles[id]; closeModal(); render();
});

/* ===== View modal ===== */
function openView(r){
  const items = Array.isArray(r.items) && r.items.length
    ? r.items
    : [{ part_number:r.part_number||'', date_codes:'', qty:r.quantity??null, unit_sell:r.sell_price??null, unit_cost:r.unit_cost??null }];

  const F=computeFinancials({ items, test_cost:r.test_cost, shipping_cost_extra:(r.shipping_cost_extra ?? r.shipping_cost), ship_path:r.ship_path, currency:r.currency });
  const outbound=Array.isArray(r.outbound_shipments)?r.outbound_shipments:(Array.isArray(r.shipments)?r.shipments:[]);
  const inbound=r.inbound_shipments||[];
  const inv=latestShipmentDate(outbound);
  const due=inv?addDays(inv,(TERM_DAYS[r.payment_terms]||0)):'';
  const shipped=shippedQty(outbound);
  const legs = r.ship_path||[];
  const sym=CURR_SYMBOL[r.currency||'USD']||'$';

  const itemsTbl = items.map(l=>`
    <tr><td class="mono">${l.part_number||''}</td>
        <td>${l.date_codes||'-'}</td>
        <td>${l.qty??'-'}</td>
        <td>${l.unit_sell!=null?money(l.unit_sell,r.currency,2):'-'}</td>
        <td>${l.unit_cost!=null?money(l.unit_cost,r.currency,2):'-'}</td></tr>`).join('');

  const legsTbl = legs.map(l=>`
    <tr><td>${l.from||''} → ${l.to||''}</td><td>${l.method||''}</td><td>${l.ref||''}</td><td>${l.cost!=null?money(l.cost,r.currency,2):'-'}</td></tr>`).join('');

  const outTbl = outbound.map(s=>`<tr><td>${s.date||''}</td><td>${s.qty??''}</td><td>${s.courier||''}</td><td>${s.tracking||''}</td></tr>`).join('') || '<tr><td colspan="4" class="muted">No outbound shipments</td></tr>';
  const inTbl = inbound.map(s=>`<tr><td>${s.date||''}</td><td>${s.qty??''}</td><td>${s.courier||''}</td><td>${s.tracking||''}</td></tr>`).join('') || '<tr><td colspan="4" class="muted">No inbound shipments</td></tr>';

  const files=r.files||{}; const urls=(window._sessionFiles[r.id]||{}); 
  const fileBits=[];
  if(files.po) fileBits.push(urls.poUrl?`<a href="${urls.poUrl}" target="_blank" rel="noopener">PO</a>`:'PO');
  if(files.test_report) fileBits.push(urls.testUrl?`<a href="${urls.testUrl}" target="_blank" rel="noopener">Report</a>`:'Report');
  const filesTxt=fileBits.join(' · ')||'-';

  $('viewTitle').textContent=`Order ${shortRef(r.id)} — ${r.customer||''}`;
  $('viewBody').innerHTML = `
    <div class="section"><h4>Overview</h4>
      <div class="kv"><label>Salesperson</label><div>${r.salesperson||''}</div></div>
      <div class="kv"><label>Status</label><div>${r.status||''}</div></div>
      <div class="kv"><label>Priority</label><div>${r.priority||''}</div></div>
      <div class="kv"><label>Order Date</label><div>${r.order_date||'-'}</div></div>
      <div class="kv"><label>Requested by</label><div>${r.requested_by||'-'}</div></div>
      <div class="kv"><label>Age</label><div>${fmtDays(r.order_date)}</div></div>
    </div>

    <div class="section"><h4>Line Items</h4>
      <table class="mini-table">
        <thead><tr><th>Part</th><th>Date Code(s)</th><th>Qty</th><th>Unit Sell</th><th>Unit Cost</th></tr></thead>
        <tbody>${itemsTbl}</tbody>
      </table>
      <div class="kv"><label>Total Qty</label><div>${sumQty(items)}</div></div>
    </div>

    <div class="section"><h4>Financials</h4>
      <div class="kv"><label>Revenue</label><div>${money(F.rev,r.currency,2)}</div></div>
      <div class="kv"><label>Total Cost</label><div>${money(F.totalCost,r.currency,2)}</div></div>
      <div class="kv"><label>GP</label><div>${F.gp>=0?'+':''}${money(F.gp,r.currency,2)} (${isFinite(F.gpPct)?Math.round(F.gpPct):0}%)</div></div>
    </div>

    <div class="section"><h4>Ship Path (costs)</h4>
      <table class="mini-table">
        <thead><tr><th>Leg</th><th>Method</th><th>Ref</th><th>Cost</th></tr></thead>
        <tbody>${legsTbl || '<tr><td colspan="4" class="muted">No legs</td></tr>'}</tbody>
      </table>
      <div class="kv"><label>Other Shipping Cost</label><div>${r.shipping_cost_extra!=null?money(r.shipping_cost_extra,r.currency,2):'-'}</div></div>
    </div>

    <div class="section"><h4>Inbound Shipments</h4>
      <table class="mini-table"><thead><tr><th>Date</th><th>Qty</th><th>Courier</th><th>Tracking</th></tr></thead><tbody>${inTbl}</tbody></table>
    </div>

    <div class="section"><h4>Outbound Shipments</h4>
      <table class="mini-table"><thead><tr><th>Date</th><th>Qty</th><th>Courier</th><th>Tracking</th></tr></thead><tbody>${outTbl}</tbody></table>
      <div class="kv"><label>Latest Invoice</label><div>${inv||'-'}</div></div>
      <div class="kv"><label>Due</label><div>${due||'-'}</div></div>
      <div class="kv"><label>Shipped Out</label><div>${shipped} / ${sumQty(items)}</div></div>
    </div>

    <div class="section"><h4>Path & Files</h4>
      <div class="kv"><label>Warehouse</label><div>${r.wh_location||'-'}</div></div>
      <div class="kv"><label>Warehouse Courier</label><div>${r.wh_courier||'-'}</div></div>
      <div class="kv"><label>Warehouse Tracking</label><div>${r.wh_tracking||'-'}</div></div>
      <div class="kv"><label>Files</label><div>${filesTxt}</div></div>
    </div>

    <div class="section"><h4>Notes</h4><div class="muted">${(r.notes||'').replace(/\n/g,'<br>')||'—'}</div></div>
  `;
  $('viewOverlay').style.display='flex';
}
$('closeView').onclick=()=>$('viewOverlay').style.display='none';
$('closeView2').onclick=()=>$('viewOverlay').style.display='none';

/* ===== Sales manager ===== */
function renderSalesMgr(){
  const list=getSalespeople(), box=$('salesList'); box.innerHTML='';
  list.forEach((name,i)=>{
    const row=document.createElement('div');
    row.style='display:flex;gap:8px;align-items:center;margin:6px 0';
    row.innerHTML=`<input class="input" value="${name}"><button class="btn btn-danger">Remove</button>`;
    const inp=row.querySelector('input');
    row.querySelector('button').onclick=()=>{ const l=getSalespeople().filter((_,idx)=>idx!==i); setSalespeople(l); renderSalesMgr(); };
    inp.onchange=()=>{ const l=getSalespeople(); l[i]=inp.value.trim()||l[i]; setSalespeople(l); renderSalesMgr(); };
    box.appendChild(row);
  });
}
$('manageSalesBtn').onclick=()=>{ $('salesOverlay').style.display='flex'; renderSalesMgr(); };
$('closeSales').onclick=()=>{ $('salesOverlay').style.display='none'; };

/* ===== Export CSV ===== */
$('exportBtn').onclick=()=>{
  const rows=getOrders();
  const headers=["Ref","Salesperson","Customer","Currency","Priority","Status","Order Date","Requested by","Items (pn|dc|qty|sell|cost; …)","Total Qty","Revenue","Total Cost","GP","GP %","Vendor","Tracking","Incoterm","Payment Terms","Payment Method","Ship Legs (from→to:method:ref:cost; …)","Other Shipping","Inbound Shipments","Outbound Shipments","Last Invoice","Due","Warehouse","WH Courier","WH Tracking","Notes"];
  const csv=[headers.join(',')];
  rows.forEach(r=>{
    const items = Array.isArray(r.items)&&r.items.length ? r.items : [{part_number:r.part_number||'',date_codes:'',qty:r.quantity??'',unit_sell:r.sell_price??'',unit_cost:r.unit_cost??''}];
    const legs=r.ship_path||[];
    const outbound=Array.isArray(r.outbound_shipments)?r.outbound_shipments:(Array.isArray(r.shipments)?r.shipments:[]);
    const inbound=r.inbound_shipments||[];
    const inv=latestShipmentDate(outbound);
    const due=inv?addDays(inv,(TERM_DAYS[r.payment_terms]||0)):'';
    const F=computeFinancials({items, test_cost:r.test_cost, shipping_cost_extra:(r.shipping_cost_extra ?? r.shipping_cost), ship_path:legs, currency:r.currency });
    const itemsStr=items.map(i=>`${i.part_number}|${i.date_codes}|${i.qty??''}|${i.unit_sell??''}|${i.unit_cost??''}`).join(' ; ');
    const legsStr=legs.map(l=>`${l.from||''}→${l.to||''}:${l.method||''}:${l.ref||''}:${l.cost??''}`).join(' ; ');
    const inStr=inbound.map(s=>`${s.date||''} ${s.qty??''} ${s.courier||''} ${s.tracking||''}`.trim()).join(' | ');
    const outStr=outbound.map(s=>`${s.date||''} ${s.qty??''} ${s.courier||''} ${s.tracking||''}`.trim()).join(' | ');
    const line=[shortRef(r.id),r.salesperson||'',r.customer||'',r.currency||'USD',r.priority||'',r.status||'',r.order_date||'',r.requested_by||'',itemsStr,sumQty(items),F.rev.toFixed(2),F.totalCost.toFixed(2),F.gp.toFixed(2),(isFinite(F.gpPct)?Math.round(F.gpPct):0)+'%',r.vendor||'',r.tracking||'',r.incoterm||'',r.payment_terms||'',r.payment_method||'',legsStr,(r.shipping_cost_extra ?? r.shipping_cost)??'',inStr,outStr,inv,due,r.wh_location||'',r.wh_courier||'',r.wh_tracking||'',(r.notes||'').replace(/[\n\r]+/g,' ')];
    csv.push(line.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(','));
  });
  const blob=new Blob([csv.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='orders.csv'; a.click(); URL.revokeObjectURL(url);
};

/* ===== Wire up ===== */
['input','change'].forEach(evt=>{
  [searchInput,salesFilter,statusFilter,priorityFilter].forEach(el=>el.addEventListener(evt,render));
});
$('addOrderBtn').onclick=()=>openModal(null);
$('closeModal').onclick=closeModal;
$('cancelBtn').onclick=closeModal;

$('addItemBtn').onclick=()=>{ addItemRow(); };
$('addLegBtn').onclick=()=>addShipLeg();
$('addInboundShipmentBtn').onclick=()=>addShipmentRowTo('inboundShipmentsBody');
$('addOutboundShipmentBtn').onclick=()=>addShipmentRowTo('outboundShipmentsBody');

wireOther('status','status_other');
wireOther('wh_location','wh_location_other');
wireOther('wh_courier','wh_courier_other');

/* update preview when costs change */
['test_cost','shipping_cost_extra','currency'].forEach(id=>$(id).addEventListener('input',updateFinPreview));

function init(){ setSalespeople(getSalespeople()); refreshSalesControls(); render(); wireTests(); }
init();
</script>
</body>
</html>









