<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Order Tracker — Verified</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>

<style>
:root{
  --brand:#6f57e9; --ink:#1f2432; --muted:#6d7486; --bg:#f6f7fb; --card:#fff; --line:#e9e9ef;
  --green:#12a274; --purple:#3b2eca; --shadow:0 12px 30px rgba(23,20,68,.08),0 1px 0 rgba(0,0,0,.04)
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:15px/1.56 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;color:var(--ink);background:var(--bg)}
.wrap{max-width:1600px;margin:26px auto;padding:0 16px}
header{display:flex;gap:16px;align-items:center;padding:18px;border:1px solid var(--line);border-radius:20px;background:#fff;box-shadow:var(--shadow)}
header img{height:44px}
h1{margin:0;font-size:26px;font-weight:800}
.sub{color:var(--muted)}
.toolbar{position:sticky;top:8px;z-index:3;background:var(--bg);display:grid;grid-template-columns:1fr 200px 180px 180px auto auto;gap:12px;margin:18px 0}
.input,.select,.btn,textarea{height:40px;border:1px solid var(--line);border-radius:12px;background:#fff;padding:0 12px;font:inherit}
.input{width:100%}
textarea{padding:12px;resize:vertical}
.select{appearance:none;padding-right:28px}
.btn{background:#f6f4ff;color:#3d35d1;border-color:#ece8ff;font-weight:700;cursor:pointer}
.btn:hover{background:#eee8ff}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.mini{height:32px}
.smini{height:28px;padding:0 10px;border-radius:999px}

.table-card{border:1px solid var(--line);border-radius:18px;background:#fff;overflow:hidden;box-shadow:var(--shadow)}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;min-width:1320px}
thead th{position:sticky;top:0;background:#fafaff;border-bottom:1px solid var(--line);text-align:left;font-size:13px;color:#4a4f64;padding:12px}
tbody td{border-bottom:1px solid var(--line);padding:12px;vertical-align:top}
tbody tr:hover{background:#fcfbff}

.mono{font-variant-numeric:tabular-nums}
.muted{color:var(--muted)}
.chip{display:inline-block;border-radius:999px;padding:3px 10px;border:1px solid #eee;background:#fafafa;font-size:12px;color:#5d6480}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6f2ec;padding:3px 10px;border-radius:999px;background:#f0fbf7;color:var(--green);font-weight:800}

.ie{display:inline-flex;align-items:center;gap:6px}
.ie button{border:0;background:transparent;color:#6d6fe5;cursor:pointer;padding:0 6px;border-radius:6px}
.ie button:hover{background:#f0efff}
.ie select{display:none;height:30px;border-radius:10px}
.ie.editing select{display:inline-block}.ie.editing .chip{display:none}

.actions{display:flex;gap:8px;flex-wrap:wrap}
.link{color:#362dc7;text-decoration:none}
.link:hover{text-decoration:underline}

dialog{border:0;padding:0;margin:0 auto;max-width:1500px;width:98vw}
dialog::backdrop{background:rgba(17,17,33,.35)}
.modal{display:flex;flex-direction:column;max-height:92vh;border-radius:20px;overflow:hidden;background:#fff;box-shadow:var(--shadow)}
.modal header{position:sticky;top:0;z-index:2;border-bottom:1px solid var(--line);border-radius:20px 20px 0 0;background:#fff}
.modal .head{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.content{padding:16px;overflow:auto;max-height:calc(92vh - 56px)}

.grid2,.grid3{gap:12px}
.grid2{display:grid;grid-template-columns:1fr 1fr}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr}

.section{margin:16px 0 8px;font-weight:900;color:#262b3a}
.note{font-size:12px;color:var(--muted);margin-bottom:6px}

.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
.tbl th,.tbl td{border:1px solid #ececf3;padding:10px;text-align:left;white-space:nowrap}

.hscroll{overflow:auto;border:1px solid #ececf3;border-radius:12px;background:#fff}
.right{display:flex;gap:10px;justify-content:flex-end;margin:12px 0 2px}

.summary{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
.card{border:1px solid var(--line);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
.card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafaff;font-size:15px}
.card .pad{padding:12px}
.kv{display:grid;grid-template-columns:170px 1fr;gap:8px 14px}

.chips{display:flex;gap:10px;flex-wrap:wrap}
.chipbtn{height:36px;padding:0 14px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:800}
.chipbtn.active{background:var(--brand);border-color:var(--brand);color:#fff}
.badge-miss{display:inline-block;padding:2px 8px;border-radius:8px;background:#ffe9e9;color:#b21a1a;font-size:12px;margin-left:8px}

.grid-auto{display:grid;grid-template-columns:repeat(3,minmax(240px,1fr));gap:12px}
.input.small{height:34px}
.hint{color:#6b6ea0;font-size:12px}

#genFrame{position:absolute;left:-100000px;top:-100000px;width:0;height:0;visibility:hidden;border:0}

textarea.input{min-height:84px}
.note-item{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;margin-bottom:10px}
.note-head{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:#6b7290}

.docbtn{border:1px solid #e8e8f6;background:#fff;border-radius:999px;height:28px;padding:0 10px;cursor:pointer}
.docbtn:hover{background:#f5f4ff}
.doctag{display:inline-block;padding:2px 8px;border:1px solid #e6e6f3;border-radius:999px;background:#fafaff;margin-right:6px}

@media (max-width:1200px){.summary{grid-template-columns:1fr}}
@media (max-width:900px){.grid3{grid-template-columns:1fr 1fr}}
@media (max-width:680px){.grid2,.grid3{grid-template-columns:1fr}}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ====== CONFIG (rotate keys later) ====== */
const SUPABASE_URL='https://ijzroisggstqkfhpjndq.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* Ensure anon headers on Supabase fetches */
(function(){const f=fetch.bind(window);window.fetch=(i,init={})=>{const u=typeof i==='string'?i:i?.url||'';if(u.startsWith(SUPABASE_URL)){const h=new Headers(init.headers||{});if(!h.has('apikey'))h.set('apikey',SUPABASE_ANON_KEY);if(!h.has('Authorization'))h.set('Authorization','Bearer '+SUPABASE_ANON_KEY);init={...init,headers:h}}return f(i,init)}})();
</script>
</head>

<body>
<div class="wrap">
  <header>
    <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified">
    <div><h1>Order Tracker</h1><div class="sub">Click a doc button → only missing bits pop up → PDF downloads & saves to Supabase.</div></div>
  </header>

  <div class="toolbar">
    <input id="q" class="input" placeholder="Search customer, part, order id…"/>
    <select id="fltSales" class="select"><option value="">All salespeople</option></select>
    <select id="fltStatus" class="select"><option value="">All status</option><option>Open</option><option>Closed</option><option>Problem</option></select>
    <select id="fltPriority" class="select"><option value="">All priorities</option><option>High</option><option selected>Normal</option><option>Low</option></select>
    <button class="btn" onclick="openModal(null)">+ New Order</button>
    <button class="btn ghost" id="btnCsv">Export CSV</button>
  </div>

  <div class="table-card">
    <div class="table-wrap">
      <table id="tbl">
        <thead><tr>
          <th>View</th><th>Customer</th><th>Part(s)</th><th>Sales</th>
          <th>Total Qty</th><th>Avg Unit $</th><th>Sell</th><th>GP</th>
          <th>Priority</th><th>Status</th><th>Order Date</th><th>Requested by</th>
          <th>Age</th><th>Tests</th><th>Vendor</th><th>Lead (d)</th><th>Incoterm</th><th>Terms</th>
          <th>Docs</th><th>Shipped</th><th>Invoiced</th><th>Files</th><th>Actions</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- EDIT / CREATE -->
<dialog id="dlg"><div class="modal">
  <header><div class="head"><strong id="dlgTitle">New Order</strong><button class="btn ghost mini" onclick="$('dlg').close()">✕</button></div></header>
  <div class="content">
    <input type="hidden" id="orderId"/>
    <div class="grid3">
      <div><div class="note">Salesperson</div><select id="salesperson" class="select mini"></select></div>
      <div><div class="note">Customer</div><input id="customer" class="input mini"/></div>
      <div><div class="note">Priority</div><select id="priority" class="select mini"><option>High</option><option selected>Normal</option><option>Low</option></select></div>

      <div><div class="note">Status</div><select id="status" class="select mini"><option>Open</option><option>Closed</option><option>Problem</option></select></div>
      <div><div class="note">Order Date</div><input id="order_date" type="date" class="input mini"/></div>
      <div><div class="note">Requested by</div><input id="requested_by" type="date" class="input mini"/></div>

      <div><div class="note">Terms</div><select id="payment_terms" class="select mini"><option>Net 5</option><option>Net 10</option><option>Net 15</option><option>Net 20</option><option>Net 30</option><option>Net 40</option><option>Net 50</option><option>Net 60</option><option>Net 90</option></select></div>
      <div><div class="note">Payment Method</div><select id="payment_method" class="select mini"><option>Bank Transfer</option><option>Credit Card</option><option>PayPal</option><option>Other</option></select></div>
      <div><div class="note">Incoterm</div><select id="incoterm" class="select mini"><option>DAP</option><option>DDP</option><option>EXW</option><option>CIP</option><option>FOB</option><option>Other</option></select></div>

      <div><div class="note">Invoice Date</div><input id="invoice_date" type="date" class="input mini"/></div>
      <div><div class="note">Due Date</div><input id="due_date" type="date" class="input mini"/></div>
      <div><div class="note">Currency</div><select id="currency" class="select mini"><option value="USD" selected>USD</option><option value="GBP">GBP</option><option value="EUR">EUR</option></select></div>
    </div>

    <div class="section">Addresses</div>
    <div class="grid2">
      <div><div class="note">Bill To (billing)</div><textarea id="bill_to" class="input" rows="5" placeholder="Customer billing name&#10;Address line 1&#10;Address line 2&#10;City, State ZIP&#10;Country"></textarea></div>
      <div><div class="note">Ship To (shipping)</div><textarea id="ship_to" class="input" rows="5" placeholder="Customer shipping name&#10;Address line 1&#10;Address line 2&#10;City, State ZIP&#10;Country"></textarea></div>
    </div>

    <div class="section">Tests & Files</div>
    <div class="grid3">
      <div><div class="note">Tests</div><input id="tests" class="input mini" placeholder="EVI, Electrical…"/></div>
      <div><div class="note">Test Center</div><select id="test_center" class="select mini"><option>GETs HK</option><option>GETs Shenzhen</option><option>GETs US</option><option>White Horse US</option><option>White Horse China</option><option>White Horse EU</option><option>Other</option></select></div>
      <div><div class="note">Supplier Lead Time (days)</div><input id="supplier_lead_time" type="number" class="input mini mono" placeholder="e.g. 21"/></div>
      <div><div class="note">PO (file)</div><input id="file_po" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/></div>
      <div><div class="note">Test Report (file)</div><input id="file_test" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/></div>
      <div><div class="note">Vendor</div><input id="vendor" class="input mini"/></div>
    </div>

    <div class="section">Items</div>
    <div class="hscroll"><table class="tbl"><thead><tr><th>Part</th><th>Date Codes</th><th>Qty</th><th>Unit Sell</th><th>Unit Cost</th><th></th></tr></thead><tbody id="itemsBody"></tbody></table></div>
    <div class="right"><button class="btn mini" onclick="addItemRow()">+ Add item</button></div>

    <div class="section">Shipments / Legs</div>
    <div class="hscroll"><table class="tbl"><thead><tr><th>Kind</th><th>Date</th><th>Qty</th><th>From</th><th>To</th><th>Method</th><th>Ref</th><th>Courier</th><th>Tracking</th><th>Cost</th><th></th></tr></thead><tbody id="shipBody"></tbody></table></div>
    <div class="right"><button class="btn mini" onclick="addShipRow()">+ Add</button></div>

    <div class="grid3" style="margin-top:12px">
      <div><div class="note">Extra shipping cost</div><input id="shipping_cost_extra" type="number" step="0.01" class="input mini mono" placeholder="0.00"/></div>
      <div><div class="note">Test cost</div><input id="test_cost" type="number" step="0.01" class="input mini mono" placeholder="0.00"/></div>
      <div><div class="note">Header notes</div><input id="notes" class="input mini" placeholder="Visible notes…"/></div>
    </div>

    <div class="right" style="margin-top:10px">
      <button class="btn ghost" id="btnDelete">Delete</button>
      <button class="btn primary" id="btnSave">Save</button>
    </div>
  </div>
</div></dialog>

<!-- SUMMARY -->
<dialog id="viewDlg"><div class="modal">
  <header><div class="head"><strong>Order Summary</strong><button class="btn ghost mini" onclick="$('viewDlg').close()">✕</button></div></header>
  <div class="content"><div id="viewBody" class="summary"></div></div>
</div></dialog>

<!-- GENERATE -->
<dialog id="genDlg"><div class="modal">
  <header><div class="head"><strong>Generate Document</strong><button class="btn ghost mini" onclick="$('genDlg').close()">✕</button></div></header>
  <div class="content">
    <div id="stepForm" style="padding:16px">
      <div class="note" style="margin-bottom:8px">Document type</div>
      <div class="chips" id="docTypeChips"></div>
      <div id="missingWrap" style="margin-top:16px"></div>
      <div id="extraWrap" style="margin-top:10px"></div>
      <div id="hsWrap" style="margin-top:12px"></div>
      <div class="right">
        <button class="btn ghost mini" onclick="$('genDlg').close()">Cancel</button>
        <button class="btn primary mini" id="genGo">Generate…</button>
      </div>
    </div>
    <iframe id="genFrame" title="Generator"></iframe>
  </div>
</div></dialog>

<!-- Tiny toast -->
<div id="toast" style="position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:.2s"></div>

<script>
/* ================== helpers ================== */
const $=id=>document.getElementById(id);
const SALESTEAM=['Nick N','Dan C','Emir B','Nick K','Jake B'];
const curSym=c=>({USD:'$',GBP:'£',EUR:'€'})[c||'USD']||'$';
const fmt=n=>(n==null||isNaN(n))?'-':Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtInt=n=>(n==null||isNaN(n))?'-':Number(n).toLocaleString();
const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* toasts */
function setToast(msg, danger){const t=$('toast'); if(!t) return; t.textContent=msg; t.style.background=danger?'#b21a1a':'#111'; t.style.opacity='1';}
function clearToast(){const t=$('toast'); if(t) t.style.opacity='0';}

/* =============== Supabase data layer =============== */
const supa={
  state:{orders:[]},
  async load(){
    const {data:orders}=await supabase.from('orders').select('*').order('order_date',{ascending:false,nullsFirst:true}).order('created_at',{ascending:false});
    this.state.orders=await Promise.all((orders||[]).map(async r=>{
      const [itemsRes,legsRes,inbRes,outRes,filesRes,notesRes]=await Promise.all([
        supabase.from('order_items').select('*').eq('order_id',r.id),
        supabase.from('ship_legs').select('*').eq('order_id',r.id),
        supabase.from('shipments_inbound').select('*').eq('order_id',r.id),
        supabase.from('shipments_outbound').select('*').eq('order_id',r.id),
        supabase.from('order_files').select('id,kind,path,created_at').eq('order_id',r.id).order('created_at',{ascending:true}),
        supabase.from('order_notes').select('*').eq('order_id',r.id).order('created_at',{ascending:true}),
      ]);

      const items=(itemsRes.data||[]).map(i=>({part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,unit_sell:i.unit_sell,unit_cost:i.unit_cost}));
      const legs=(legsRes.data||[]).map(l=>({kind:'Leg',date:'',qty:'',from:l.from_loc,to:l.to_loc,method:l.method,ref:l.ref,cost:l.cost}));
      const inbound=(inbRes.data||[]).map(s=>({kind:'Inbound',date:s.ship_date,qty:s.qty,courier:s.courier,tracking:s.tracking}));
      const outbound=(outRes.data||[]).map(s=>({kind:'Outbound',date:s.ship_date,qty:s.qty,courier:s.courier,tracking:s.tracking}));

      const filesMap=(filesRes.data||[]).reduce((a,f)=>{a[f.kind]=f.path;return a;},{});
      const genList=(filesRes.data||[]).filter(f=>/_pdf$/.test(f.kind)).map(f=>({kind:f.kind,path:f.path,created_at:f.created_at}));

      // signed links for PO/Test for quick access
      let poUrl=null,testUrl=null;
      if(filesMap.po){const {data:s}=await supabase.storage.from('order-files').createSignedUrl(filesMap.po,3600);poUrl=s?.signedUrl||null;}
      if(filesMap.test_report){const {data:s}=await supabase.storage.from('order-files').createSignedUrl(filesMap.test_report,3600);testUrl=s?.signedUrl||null;}
      window._sessionFiles ||= {}; window._sessionFiles[r.id]={poUrl,testUrl};

      return { ...r, items, shipments:[...legs,...inbound,...outbound], files:filesMap, staff_notes:notesRes.data||[], generated_docs:genList };
    }));
  },
  async save(header,uploads){
    const {data:up,error}=await supabase.from('orders').upsert(header).select().single(); if(error) throw error;
    const order_id=up.id;
    await supabase.from('order_items').delete().eq('order_id',order_id);
    await supabase.from('ship_legs').delete().eq('order_id',order_id);
    await supabase.from('shipments_inbound').delete().eq('order_id',order_id);
    await supabase.from('shipments_outbound').delete().eq('order_id',order_id);

    if(header.items?.length){ await supabase.from('order_items').insert(header.items.map(i=>({order_id,part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,unit_sell:i.unit_sell,unit_cost:i.unit_cost}))); }

    const legs=header.shipments?.filter(s=>s.kind==='Leg')||[];
    const inbound=header.shipments?.filter(s=>s.kind==='Inbound')||[];
    const outbound=header.shipments?.filter(s=>s.kind==='Outbound')||[];
    if(legs.length){ await supabase.from('ship_legs').insert(legs.map(l=>({order_id,from_loc:l.from,to_loc:l.to,method:l.method,ref:l.ref,cost:Number(l.cost||0)}))); }
    if(inbound.length){ await supabase.from('shipments_inbound').insert(inbound.map(s=>({order_id,ship_date:s.date||null,qty:Number(s.qty||0),courier:s.courier||null,tracking:s.tracking||null}))); }
    if(outbound.length){ await supabase.from('shipments_outbound').insert(outbound.map(s=>({order_id,ship_date:s.date||null,qty:Number(s.qty||0),courier:s.courier||null,tracking:s.tracking||null}))); }

    if(uploads?.po) await this.upload(order_id,'po',uploads.po);
    if(uploads?.test_report) await this.upload(order_id,'test_report',uploads.test_report);
  },
  // hardened upload (contentType + immediate session links)
  async upload(orderId, kind, file){
    if (!file) throw new Error('No file');
    const clean=file.name.replace(/[^\w.-]+/g,'_');
    const path=`orders/${orderId}/${kind}/${Date.now()}_${clean}`;

    const {error:upErr}=await supabase.storage.from('order-files')
      .upload(path,file,{upsert:true,contentType:file.type||'application/octet-stream',cacheControl:'3600'});
    if(upErr) throw upErr;

    const {error:insErr}=await supabase.from('order_files').insert({order_id:orderId,kind,path});
    if(insErr) throw insErr;

    if(kind==='po'||kind==='test_report'){
      const {data:signed}=await supabase.storage.from('order-files').createSignedUrl(path,3600);
      window._sessionFiles ||= {}; window._sessionFiles[orderId] ||= {};
      window._sessionFiles[orderId][kind==='po'?'poUrl':'testUrl']=signed?.signedUrl||null;
    }
    return path;
  },
  async uploadGenerated(orderId,docType,file){
    const path=`generated/${orderId}/${docType}/${Date.now()}_${file.name.replace(/[^a-z0-9._-]+/gi,'_')}`;
    const {error}=await supabase.storage.from('order-files').upload(path,file,{upsert:true,contentType:'application/pdf'});
    if(error) throw error;
    await supabase.from('order_files').insert({order_id:orderId,kind:`${docType}_pdf`,path});
  },
  async quickUpdate(id, field, value){ await supabase.from('orders').update({[field]:value}).eq('id',id); },
  async addNote(order_id, author, body){ await supabase.from('order_notes').insert({order_id,author,body}); },
  async del(id){ await supabase.from('orders').delete().eq('id',id); },
  rt(){ supabase.channel('rt')
      .on('postgres_changes',{event:'*',schema:'public',table:'orders'},async()=>{await supa.load(); render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'order_notes'},async()=>{await supa.load(); renderOpenViewIfSame();})
      .on('postgres_changes',{event:'*',schema:'public',table:'order_files'},async()=>{await supa.load(); renderOpenViewIfSame(); render();})
      .subscribe(); }
};

/* =============== totals & formatting =============== */
function totals(o){
  const revenue=(o.items||[]).reduce((s,i)=>s+(+i.qty||0)*(+i.unit_sell||0),0);
  const qty=(o.items||[]).reduce((s,i)=>s+(+i.qty||0),0);
  const itemCost=(o.items||[]).reduce((s,i)=>s+(+i.qty||0)*(+i.unit_cost||0),0);
  const legCost=(o.shipments||[]).filter(s=>s.kind==='Leg').reduce((s,l)=>s+(+l.cost||0),0);
  const shipCost=legCost+(+o.shipping_cost_extra||0), testCost=(+o.test_cost||0), cost=itemCost+shipCost+testCost;
  const gp=revenue-cost, gpPct=revenue?gp/revenue*100:0, avgUnit=qty?revenue/qty:0;
  return {revenue,qty,avgUnit,itemCost,shipCost,testCost,cost,gp,gpPct};
}
const age=d=>d?(Math.max(0,Math.floor((Date.now()-new Date(d))/86400000))+' d'):'-';

/* ================= table render ================= */
function inlineSelect(o,field,options){
  const w=document.createElement('div');w.className='ie';
  const chip=document.createElement('span');chip.className='chip';chip.textContent=o[field]||'-';
  const btn=document.createElement('button');btn.textContent='✎';
  const sel=document.createElement('select');options.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;sel.appendChild(op)}); sel.value=o[field]||options[0];
  const edit=()=>{w.classList.add('editing');sel.focus()};btn.onclick=edit;chip.onclick=edit;
  sel.onchange=async()=>{await supa.quickUpdate(o.id,field,sel.value);chip.textContent=sel.value;w.classList.remove('editing');};
  sel.onblur=()=>w.classList.remove('editing'); w.append(chip,btn,sel); return w;
}
async function openGenerated(orderId, shortType){
  const kind = `${shortType}_pdf`;
  const { data, error } = await supabase
    .from('order_files').select('path').eq('order_id',orderId).eq('kind',kind)
    .order('created_at',{ascending:false}).limit(1).maybeSingle();
  if (error || !data) return alert('No PDF found for '+shortType.toUpperCase());
  const { data:signed, error:e2 } = await supabase.storage.from('order-files').createSignedUrl(data.path, 3600);
  if (e2 || !signed?.signedUrl) return alert('Could not create a signed URL.');
  window.open(signed.signedUrl,'_blank');
}
function render(){
  const q=$('q').value.toLowerCase(), s1=$('fltSales').value, s2=$('fltStatus').value, s3=$('fltPriority').value;
  const rows=supa.state.orders.filter(o=>{
    const txt=[o.customer,o.salesperson,o.id,o.bill_to,o.ship_to,...(o.items||[]).map(i=>i.part_number)].join(' ').toLowerCase();
    if(q && !txt.includes(q)) return false; if(s1 && o.salesperson!==s1) return false; if(s2 && (o.status||'')!==s2) return false; if(s3 && (o.priority||'')!==s3) return false; return true;
  });
  const tb=$('tbody'); tb.innerHTML='';
  if(!rows.length){tb.innerHTML='<tr><td colspan="23" class="muted" style="text-align:center;padding:40px">No orders</td></tr>';return;}
  rows.forEach(o=>{
    const t=totals(o), sym=curSym(o.currency);
    const parts=o.items?.length?o.items[0].part_number+(o.items.length>1?` +${o.items.length-1} more`: ''):'-';
    const tr=document.createElement('tr'), cell=html=>{const td=document.createElement('td');td.innerHTML=html;return td};

    tr.appendChild(cell(`<button class="btn mini ghost" onclick="openViewById('${o.id}')">View</button>`));
    tr.appendChild(cell(esc(o.customer||'-'))); tr.appendChild(cell(esc(parts))); tr.appendChild(cell(esc(o.salesperson||'-')));
    tr.appendChild(cell(`<span class="mono">${fmtInt(t.qty)}</span>`));
    tr.appendChild(cell(`<span class="mono">${sym}${fmt(t.avgUnit)}</span>`));
    tr.appendChild(cell(`<span class="mono">${sym}${fmt(t.revenue)}</span>`));
    tr.appendChild(cell(`<span class="pill">${sym}${fmt(t.gp)}</span> <span class="muted mono">(${fmt(t.gpPct)}%)</span>`));
    tr.appendChild(cell(`<span class="chip">${esc(o.priority||'-')}</span>`));
    const tdS=document.createElement('td'); tdS.appendChild(inlineSelect(o,'status',['Open','Closed','Problem'])); tr.appendChild(tdS);
    tr.appendChild(cell(esc(o.order_date||'-'))); tr.appendChild(cell(esc(o.requested_by||'-'))); tr.appendChild(cell(esc(age(o.order_date))));
    tr.appendChild(cell(esc(o.tests||'-'))); tr.appendChild(cell(esc(o.vendor||'-'))); tr.appendChild(cell(esc((o.supplier_lead_time??'')||'-'))); tr.appendChild(cell(esc(o.incoterm||'-')));
    const tdT=document.createElement('td'); tdT.appendChild(inlineSelect(o,'payment_terms',['Net 5','Net 10','Net 15','Net 20','Net 30','Net 40','Net 50','Net 60','Net 90'])); tr.appendChild(tdT);

    const tdD=document.createElement('td'); tdD.style.minWidth='320px';
    [['so','OC'],['invoice','INV'],['pt','PT'],['ci','CI'],['rma','RMA']].forEach(([k,l])=>{const b=document.createElement('button');b.className='docbtn smini';b.textContent=l;b.onclick=()=>openGen(o,k);tdD.appendChild(b);});
    const tagKinds=['so','invoice','pt','ci','rma'];
    const tagLinks=tagKinds.filter(k=>o.files?.[`${k}_pdf`]).map(k=>`<a href="#" class="doctag" onclick="openGenerated('${o.id}','${k}');return false;">${k.toUpperCase()}</a>`).join(' ');
    if(tagLinks){const d=document.createElement('div');d.style.marginTop='6px';d.innerHTML=tagLinks;tdD.appendChild(d);}
    tr.appendChild(tdD);

    const mk=f=>{const c=document.createElement('input');c.type='checkbox';c.checked=!!o[f];c.onchange=()=>supa.quickUpdate(o.id,f,c.checked);return c}
    tr.appendChild(cell('').appendChild(mk('is_shipped'))||tr.lastChild);
    tr.appendChild(cell('').appendChild(mk('is_invoiced'))||tr.lastChild);

    const po=window._sessionFiles?.[o.id]?.poUrl, test=window._sessionFiles?.[o.id]?.testUrl;
    tr.appendChild(cell([po?`<a class="link" target="_blank" href="${po}">PO</a>`:'',test?`<a class="link" target="_blank" href="${test}">Test</a>`:''].filter(Boolean).join(' · ')||''));

    const tdA=document.createElement('td'); tdA.className='actions';
    tdA.innerHTML=`<button class="btn mini ghost" onclick="openModalById('${o.id}')">Edit</button>
                   <button class="btn mini ghost" onclick="cloneById('${o.id}')">Clone</button>
                   <button class="btn mini ghost" onclick="delById('${o.id}')">Delete</button>`;
    tr.appendChild(tdA);
    tb.appendChild(tr);
  });
}

/* =============== edit form helpers =============== */
function addItemRow(v={part_number:'',date_codes:'',qty:'',unit_sell:'',unit_cost:''}){
  const tr=document.createElement('tr'); tr.innerHTML=
  `<td><input class="input mini" value="${esc(v.part_number)}"/></td>
   <td><input class="input mini" value="${esc(v.date_codes||'')}"/></td>
   <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
   <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_sell||''}"/></td>
   <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_cost||''}"/></td>
   <td class="right"><button class="btn mini ghost" onclick="this.closest('tr').remove()">−</button></td>`;
  $('itemsBody').appendChild(tr);
}
function itemsFromDOM(){return [...$('itemsBody').querySelectorAll('tr')].map(tr=>{const [pn,dc,qty,us,uc]=[...tr.querySelectorAll('input')].map(i=>i.value.trim()); if(!pn) return null; return {part_number:pn,date_codes:dc,qty:+qty||0,unit_sell:+us||0,unit_cost:+uc||0};}).filter(Boolean)}
function addShipRow(v={kind:'Leg',date:'',qty:'',from:'',to:'',method:'',ref:'',courier:'',tracking:'',cost:''}){
  const tr=document.createElement('tr'); tr.innerHTML=
  `<td><select class="select mini"><option ${v.kind==='Leg'?'selected':''}>Leg</option><option ${v.kind==='Inbound'?'selected':''}>Inbound</option><option ${v.kind==='Outbound'?'selected':''}>Outbound</option></select></td>
   <td><input type="date" class="input mini" value="${v.date||''}"/></td>
   <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
   <td><input class="input mini" value="${esc(v.from||'')}"/></td>
   <td><input class="input mini" value="${esc(v.to||'')}"/></td>
   <td><input class="input mini" value="${esc(v.method||'')}"/></td>
   <td><input class="input mini" value="${esc(v.ref||'')}"/></td>
   <td><input class="input mini" value="${esc(v.courier||'')}"/></td>
   <td><input class="input mini" value="${esc(v.tracking||'')}"/></td>
   <td><input type="number" step="0.01" class="input mini mono" value="${v.cost||''}"/></td>
   <td class="right"><button class="btn mini ghost" onclick="this.closest('tr').remove()">−</button></td>`;
  $('shipBody').appendChild(tr);
}
function shipsFromDOM(){return [...$('shipBody').querySelectorAll('tr')].map(tr=>{
  const sel=tr.querySelector('select').value; const [date,qty,from,to,method,ref,courier,tracking,cost]=[...tr.querySelectorAll('input')].map(i=>i.value.trim());
  if(!sel && !date && !qty && !from && !to && !method && !ref && !courier && !tracking && !cost) return null;
  return {kind:sel,date,qty:+qty||0,from,to,method,ref,courier,tracking,cost:+cost||0};
}).filter(Boolean)}

/* =============== open/clone/delete =============== */
function openModalById(id){openModal(supa.state.orders.find(x=>x.id===id))}
function openModal(o){
  $('dlgTitle').textContent=o?'Edit Order':'New Order';
  $('orderId').value=o?.id||'';
  $('salesperson').innerHTML=SALESTEAM.map(n=>`<option>${n}</option>`).join(''); $('salesperson').value=o?.salesperson||SALESTEAM[0];
  ['customer','priority','status','order_date','requested_by','payment_terms','payment_method','incoterm','invoice_date','due_date','currency','tests','test_center','supplier_lead_time','vendor','shipping_cost_extra','test_cost','notes','bill_to','ship_to'].forEach(id=>{$(id).value=o?.[id]??''});
  $('itemsBody').innerHTML=''; (o?.items||[]).forEach(addItemRow);
  $('shipBody').innerHTML=''; (o?.shipments||[]).forEach(addShipRow);

  $('btnSave').onclick=async()=>{
    const rec={
      id:$('orderId').value||undefined,
      salesperson:$('salesperson').value,customer:$('customer').value,priority:$('priority').value,status:$('status').value,
      order_date:$('order_date').value||null,requested_by:$('requested_by').value||null,
      payment_terms:$('payment_terms').value,payment_method:$('payment_method').value,
      invoice_date:$('invoice_date').value||null,due_date:$('due_date').value||null,currency:$('currency').value,
      tests:$('tests').value,test_center:$('test_center').value,vendor:$('vendor').value,incoterm:$('incoterm').value,
      supplier_lead_time:$('supplier_lead_time').value?+$('supplier_lead_time').value:null,
      bill_to:$('bill_to').value, ship_to:$('ship_to').value,
      shipping_cost_extra:+($('shipping_cost_extra').value||0), test_cost:+($('test_cost').value||0),
      notes:$('notes').value,
      items:itemsFromDOM(), shipments:shipsFromDOM()
    };
    const uploads={}; if($('file_po').files[0]) uploads.po=$('file_po').files[0]; if($('file_test').files[0]) uploads.test_report=$('file_test').files[0];
    await supa.save(rec,uploads); await supa.load(); render(); $('dlg').close();
  };
  $('btnDelete').onclick=async()=>{ if(!o?.id) return $('dlg').close(); if(!confirm('Delete this order?'))return; await supa.del(o.id); await supa.load(); render(); $('dlg').close(); };
  $('dlg').showModal();
}
async function cloneById(id){ const o=supa.state.orders.find(x=>x.id===id); const c=structuredClone(o); delete c.id; c.status='Open'; c.order_date=new Date().toISOString().slice(0,10); await supa.save(c,{}); await supa.load(); render(); }
async function delById(id){ if(!confirm('Delete this order?'))return; await supa.del(id); await supa.load(); render(); }

/* =============== view + notes + attachments + docs =============== */
let OPEN_VIEW_ID=null;
function openViewById(id){const o=supa.state.orders.find(x=>x.id===id); if(o) openView(o)}
function renderOpenViewIfSame(){ if(!OPEN_VIEW_ID) return; const o=supa.state.orders.find(x=>x.id===OPEN_VIEW_ID); if(o) openView(o,true); }
function openView(o,keep){
  OPEN_VIEW_ID=o.id;
  const t=totals(o), sym=curSym(o.currency), files=window._sessionFiles?.[o.id]||{};
  const parts=(o.items||[]).map(i=>`<tr><td>${esc(i.part_number)}</td><td>${esc(i.date_codes||'')}</td><td class="mono">${fmtInt(i.qty)}</td><td class="mono">${sym}${fmt(i.unit_sell)}</td><td class="mono">${sym}${fmt(i.unit_cost)}</td></tr>`).join('');
  const ships=(o.shipments||[]).map(s=>`<tr><td>${s.kind}</td><td class="mono">${esc(s.date||'')}</td><td class="mono">${fmtInt(s.qty||'')}</td><td>${esc(s.from||'')}</td><td>${esc(s.to||'')}</td><td>${esc(s.method||'')}</td><td>${esc(s.ref||'')}</td><td>${esc(s.courier||'')}</td><td>${esc(s.tracking||'')}</td><td class="mono">${s.cost? sym+fmt(s.cost):''}</td></tr>`).join('');
  const notes=(o.staff_notes||[]).map(n=>`<div class="note-item"><div class="note-head"><b>${esc(n.author)}</b><span>${new Date(n.created_at).toLocaleString()}</span></div><div>${esc(n.body)}</div></div>`).join('');
  const genRows=(o.generated_docs||[]).slice().sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
     .map(g=>`<tr><td>${g.kind.replace('_pdf','').toUpperCase()}</td><td class="mono">${new Date(g.created_at).toLocaleString()}</td><td><button class="docbtn smini" onclick="openSigned('${o.id}','${g.path}')">View</button></td></tr>`).join('') || '<tr><td colspan="3" class="muted">No generated documents yet</td></tr>';

  const poLink = files.poUrl ? `<a class="link" target="_blank" href="${files.poUrl}">PO</a>` : '';
  const trLink = files.testUrl ? `<a class="link" target="_blank" href="${files.testUrl}">Test</a>` : '';
  const filesRow = [poLink, trLink].filter(Boolean).join(' · ') || '-';

  $('viewBody').innerHTML=`
    <div class="card" style="grid-column:1 / -1"><h3>Generate</h3><div class="pad">
      <button class="docbtn smini" onclick="openGenById('${o.id}','so')">OC</button>
      <button class="docbtn smini" onclick="openGenById('${o.id}','invoice')">INV</button>
      <button class="docbtn smini" onclick="openGenById('${o.id}','pt')">PT</button>
      <button class="docbtn smini" onclick="openGenById('${o.id}','ci')">CI</button>
      <button class="docbtn smini" onclick="openGenById('${o.id}','rma')">RMA</button>
    </div></div>

    <div class="card"><h3>Order Details</h3><div class="pad"><div class="kv">
      <div>Status</div><div>${esc(o.status||'-')}</div>
      <div>Customer</div><div>${esc(o.customer||'-')}</div>
      <div>Salesperson</div><div>${esc(o.salesperson||'-')}</div>
      <div>Priority</div><div>${esc(o.priority||'-')}</div>
      <div>Order Date</div><div>${esc(o.order_date||'-')}</div>
      <div>Requested by</div><div>${esc(o.requested_by||'-')}</div>
      <div>Vendor</div><div>${esc(o.vendor||'-')}</div>
      <div>Supplier Lead</div><div>${o.supplier_lead_time??'-'} days</div>
      <div>Incoterm</div><div>${esc(o.incoterm||'-')}</div>
      <div>Terms</div><div>${esc(o.payment_terms||'-')}</div>
      <div>Currency</div><div>${esc(o.currency||'-')}</div>
      <div>Tests</div><div>${esc(o.tests||'-')}</div>
      <div>Notes</div><div>${esc(o.notes||'-')}</div>
    </div></div>

    <div class="card"><h3>Addresses</h3><div class="pad"><div class="grid2">
      <div><div class="note">Bill To</div><pre style="white-space:pre-wrap;margin:0">${esc(o.bill_to||'-')}</pre></div>
      <div><div class="note">Ship To</div><pre style="white-space:pre-wrap;margin:0">${esc(o.ship_to||'-')}</pre></div>
    </div></div></div>

    <div class="card"><h3>Totals</h3><div class="pad"><div class="kv">
      <div>Total Qty</div><div class="mono">${fmtInt(t.qty)}</div>
      <div>Sell</div><div class="mono">${sym}${fmt(t.revenue)}</div>
      <div>Item Cost</div><div class="mono">${sym}${fmt(t.itemCost)}</div>
      <div>Shipping Cost</div><div class="mono">${sym}${fmt(t.shipCost)}</div>
      <div>Test Cost</div><div class="mono">${sym}${fmt(t.testCost)}</div>
      <div>Total Cost</div><div class="mono">${sym}${fmt(t.cost)}</div>
      <div>GP</div><div><span class="pill">${sym}${fmt(t.gp)}</span> <span class="muted mono">(${fmt(t.gpPct)}%)</span></div>
      <div>Files</div><div>${filesRow}</div>
    </div></div>

    <div class="card" style="grid-column:1 / -1"><h3>Line Items</h3><div class="pad"><div class="hscroll">
      <table class="tbl" style="min-width:900px"><thead><tr><th>Part</th><th>Date Codes</th><th>Qty</th><th>Unit Sell</th><th>Unit Cost</th></tr></thead><tbody>${parts||'<tr><td colspan="5" class="muted">No items</td></tr>'}</tbody></table>
    </div></div></div>

    <div class="card" style="grid-column:1 / -1"><h3>Shipments</h3><div class="pad"><div class="hscroll">
      <table class="tbl" style="min-width:1100px"><thead><tr><th>Kind</th><th>Date</th><th>Qty</th><th>From</th><th>To</th><th>Method</th><th>Ref</th><th>Courier</th><th>Tracking</th><th>Cost</th></tr></thead><tbody>${ships||'<tr><td colspan="10" class="muted">No shipments</td></tr>'}</tbody></table>
    </div></div></div>

    <div class="card" style="grid-column:1 / -1"><h3>Staff Notes</h3><div class="pad">
      <div id="notesList">${notes||'<div class="muted">No notes</div>'}</div>
      <div class="actions" style="margin-top:10px">
        <select id="noteAuthor" class="select mini">${SALESTEAM.map(n=>`<option>${n}</option>`).join('')}</select>
        <input id="noteBody" class="input mini" placeholder="Write a note…"/>
        <button class="btn mini" onclick="addNote('${o.id}')">Add</button>
      </div>
    </div></div>

    <div class="card" style="grid-column:1 / -1"><h3>Attachments</h3><div class="pad">
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center">
        <div><div class="note">Customer PO</div><input id="qUpPO" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/></div>
        <div><div class="note">Test Report</div><input id="qUpTR" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/></div>
        <div class="muted" style="margin-top:24px">${filesRow}</div>
      </div>
    </div></div>

    <div class="card" style="grid-column:1 / -1"><h3>Documents</h3><div class="pad">
      <div class="hscroll">
        <table class="tbl" style="min-width:560px">
          <thead><tr><th>Type</th><th>Created</th><th>Open</th></tr></thead>
          <tbody>${genRows}</tbody>
        </table>
      </div>
    </div></div>`;
  if(!keep)$('viewDlg').showModal();
  bindDocUploaders(o.id);
}
async function addNote(order_id){const a=$('noteAuthor').value,b=$('noteBody').value.trim();if(!b)return;await supa.addNote(order_id,a,b);$('noteBody').value='';await supa.load();renderOpenViewIfSame();}

async function openSigned(orderId,path){const {data:signed,error}=await supabase.storage.from('order-files').createSignedUrl(path,3600); if(error||!signed?.signedUrl)return alert('Could not open.'); window.open(signed.signedUrl,'_blank');}
async function quickUploadFile(orderId, kind, file) {
  if (!file) return;
  try {
    setToast('Uploading '+kind+' …');
    await supa.upload(orderId, kind, file);
    setToast((kind.toUpperCase())+' uploaded');
    await supa.load();
    renderOpenViewIfSame();
    render();
  } catch (e) {
    console.error('[upload]', e);
    setToast('Upload failed: ' + (e.message || e), true);
    alert('Upload failed: ' + (e.message || e));
  } finally {
    const inp = kind === 'po' ? $('qUpPO') : $('qUpTR');
    if (inp) inp.value = '';
    setTimeout(clearToast, 1500);
  }
}
function bindDocUploaders(orderId){ const po=$('qUpPO'), tr=$('qUpTR'); if(po) po.onchange=(e)=>quickUploadFile(orderId,'po',e.target.files[0]); if(tr) tr.onchange=(e)=>quickUploadFile(orderId,'test_report',e.target.files[0]); }

/* ================= GENERATE (hidden iframe) ================= */
const DOC_ROUTES={so:'../so-confirmation/index.html',invoice:'../so-confirmation/index.html',pt:'../commercial-invoice/index.html#pt',ci:'../commercial-invoice/index.html',rma:'../rma/index.html'};
const HS_MEM=JSON.parse(localStorage.getItem('ve-hs-mem')||'{}'); const saveHs=()=>localStorage.setItem('ve-hs-mem',JSON.stringify(HS_MEM));
function openGenById(id,type){openGen(supa.state.orders.find(x=>x.id===id),type)}
function openGen(order,type='so'){
  $('genDlg').showModal(); $('genGo').disabled=false; $('genGo').textContent='Generate…';
  $('docTypeChips').innerHTML=[['so','Order Confirmation'],['invoice','Invoice'],['pt','Picking Ticket'],['ci','Commercial Invoice'],['rma','RMA']].map(([t,l])=>`<button class="chipbtn${t===type?' active':''}" data-type="${t}">${l}</button>`).join('');
  let cur=type; $('docTypeChips').onclick=e=>{const b=e.target.closest('button[data-type]'); if(!b)return; cur=b.dataset.type; [...$('docTypeChips').children].forEach(x=>x.classList.toggle('active',x===b)); renderMissingForm(order,cur);};
  renderMissingForm(order,cur);

  $('genGo').onclick=()=>{
    const overrides=getOverrides(cur,order); const payload=mkPayload(order,cur,overrides);
    try{sessionStorage.setItem('veDocData',JSON.stringify(payload));}catch(e){}
    $('genGo').disabled = true; $('genGo').textContent = 'Generating…';
    const frame=$('genFrame'); frame.src=DOC_ROUTES[cur];

    const start=performance.now();
    frame.onload=()=>injectBridgeUntilReady(frame.contentWindow, frame.contentDocument||frame.contentWindow.document, payload, start);
  };
}
function mkPayload(o,type,ov){
  const t=totals(o);
  const p={ meta:{orderId:o.id,docType:type,customer:o.customer,salesperson:o.salesperson,currency:ov.currency,incoterm:ov.incoterm,payment_terms:ov.payment_terms,from:ov.from,soldto:ov.soldto,shipto:ov.shipto,returnTo:ov.returnTo||'',vendor:o.vendor,order_date:o.order_date,requested_by:o.requested_by,notes:o.notes},
    items:(o.items||[]).map(i=>({part:i.part_number,desc:i.date_codes||'',qty:i.qty,unitSell:i.unit_sell,unitCost:i.unit_cost})),
    shipments:o.shipments||[], totals:{revenue:t.revenue,qty:t.qty}
  };
  if(type==='ci'||type==='pt'){ p.ci={freight:+ov.freight||0,insurance:+ov.insurance||0,other:+ov.other||0,items:(o.items||[]).map(i=>({part:i.part_number,units:i.qty,hs:(HS_MEM[i.part_number]||{}).hs||'',coo:(HS_MEM[i.part_number]||{}).coo||'',unitValue:i.unitSell}))}; }
  if(type==='rma'){ p.rma=ov.rma; }
  return p;
}
function renderMissingForm(order,type){
  const need=[{key:'from',label:'Seller (From)',placeholder:'Verified Electronics\nAddress…'},{key:'soldto',label:'Buyer (Bill To)',placeholder:order.bill_to||`${order.customer||''}\nBilling address`},{key:'shipto',label:'Ship To',placeholder:order.ship_to||`${order.customer||''}\nShipping address`}];
  if(type==='rma') need.push({key:'returnTo',label:'Return To',placeholder:'Verified Returns address'});
  const fixed=[{key:'currency',label:'Currency'},{key:'incoterm',label:'Incoterm'},{key:'payment_terms',label:'Payment Terms'}];
  const wrap=$('missingWrap'); wrap.innerHTML='<div class="grid-auto"></div>'; const grid=wrap.firstChild;
  [...fixed,...need].forEach(f=>{
    grid.insertAdjacentHTML('beforeend',`<div><div class="note">${f.label}</div>${f.key==='currency'
      ?`<select id="f_currency" class="select small"><option>USD</option><option>GBP</option><option>EUR</option></select>`
      :(/from|soldto|shipto|returnTo/.test(f.key)?`<textarea id="f_${f.key}" class="input" rows="4" placeholder="${esc(f.placeholder||'')}"></textarea>`:`<input id="f_${f.key}" class="input small"/>`)}</div>`);
  });
  $('f_currency').value=(order.currency||'USD').toUpperCase();
  $('f_incoterm').value=order.incoterm||''; $('f_payment_terms').value=order.payment_terms||'';
  $('f_from').value='Verified Electronics\nExporter/Warehouse address';
  $('f_soldto').value=order.bill_to || ((order.customer||'')+'\nBilling address');
  $('f_shipto').value=order.ship_to || ((order.customer||'')+'\nShipping address');

  if(type==='rma'){ $('extraWrap').innerHTML=`
    <div class="section">RMA Details</div>
    <div class="grid-auto">
      <div><div class="note">RMA Number</div><input id="f_rma_num" class="input small" value="RMA-${(order.id||'XXXX').slice(0,4)}-${new Date().toISOString().slice(0,10)}"/></div>
      <div><div class="note">Return Reason</div><select id="f_rma_reason" class="select small"><option>Failed Test</option><option>Damaged</option><option>Wrong Part</option><option>Not Needed</option><option>Other</option></select></div>
      <div><div class="note">Action</div><select id="f_rma_action" class="select small"><option>Replace</option><option>Refund</option><option>Credit</option><option>Repair</option></select></div>
      <div><div class="note">Contact</div><input id="f_rma_contact" class="input small"/></div>
      <div><div class="note">Email</div><input id="f_rma_email" class="input small"/></div>
      <div><div class="note">Phone</div><input id="f_rma_phone" class="input small"/></div>
    </div>`; } else {$('extraWrap').innerHTML='';}

  if(type==='ci'||type==='pt'){
    const rows=(order.items||[]).map(i=>`<tr><td>${esc(i.part_number)}</td>
      <td><input class="input small mono" id="hs_${esc(i.part_number)}" value="${esc(HS_MEM[i.part_number]?.hs||'')}" placeholder="HS Code"/></td>
      <td><input class="input small mono" id="coo_${esc(i.part_number)}" value="${esc(HS_MEM[i.part_number]?.coo||'')}" placeholder="COO"/></td></tr>`).join('');
    $('hsWrap').innerHTML=`<div class="section">HS / COO per line</div>
      <div class="hscroll"><table class="tbl" style="min-width:540px"><thead><tr><th>Part</th><th>HS</th><th>COO</th></tr></thead><tbody>${rows||'<tr><td colspan="3" class="muted">No items</td></tr>'}</tbody></table></div>
      <div class="grid3" style="margin-top:8px">
        <div><div class="note">Freight</div><input id="f_freight" class="input small mono" type="number" step="0.01" value="${+order.shipping_cost_extra||0}"/></div>
        <div><div class="note">Insurance</div><input id="f_insurance" class="input small mono" type="number" step="0.01" value="0"/></div>
        <div><div class="note">Other</div><input id="f_other" class="input small mono" type="number" step="0.01" value="0"/></div>
      </div>`;
  } else {$('hsWrap').innerHTML='';}
}
function getOverrides(type,order){
  const g=k=>(document.getElementById('f_'+k)||{}).value?.trim();
  const o={currency:$('f_currency').value,incoterm:g('incoterm')||order.incoterm||'',payment_terms:g('payment_terms')||order.payment_terms||'',from:g('from')||'',soldto:g('soldto')||'',shipto:g('shipto')||''};
  if(type==='rma'){o.returnTo=g('returnTo')||'';o.rma={number:$('f_rma_num').value||'',reason:$('f_rma_reason').value||'',action:$('f_rma_action').value||'',contact:$('f_rma_contact').value||'',email:$('f_rma_email').value||'',phone:$('f_rma_phone').value||''};}
  if(type==='ci'||type==='pt'){o.freight=+($('f_freight').value||0);o.insurance=+($('f_insurance').value||0);o.other=+($('f_other').value||0);
    (order.items||[]).forEach(i=>{const hs=($('hs_'+i.part_number)||{}).value?.trim();const coo=($('coo_'+i.part_number)||{}).value?.trim();if(hs||coo)HS_MEM[i.part_number]={hs,coo};}); saveHs();}
  return o;
}

/* =============== robust bridge injection =============== */
function injectScriptViaBlob(doc, code) {
  const blob = new Blob([code], { type: 'text/javascript' });
  const url  = doc.defaultView.URL.createObjectURL(blob);
  const s    = doc.createElement('script');
  s.src = url;
  s.onload = () => doc.defaultView.URL.revokeObjectURL(url);
  doc.documentElement.appendChild(s);
}
function injectBridgeUntilReady(win, doc, payload, startTime){
  const tryInject = () => {
    if(!doc || !win) return;
    // 1) Bridge
    injectScriptViaBlob(doc, BRIDGE_CODE);
    // 2) Auto-fill runner with payload
    injectScriptViaBlob(doc, `(${AUTO_FILL.toString()})(${JSON.stringify(payload)});`);
  };
  tryInject();

  let attempts = 0;
  const timer = setInterval(()=>{
    attempts++;
    try {
      if (win.__VE_BRIDGE_READY) { clearInterval(timer); return; }
      tryInject();
      if (performance.now() - startTime > 10000) clearInterval(timer); // stop after ~10s
    } catch(_){}
  }, 500);
}

/* Receive generated PDFs from iframe, upload & close modal */
window.addEventListener('message',async(e)=>{
  const d=e.data||{}; if(d.type!=='ve-doc-generated') return;
  try{
    let blob=d.blob||null;
    if(!blob && d.objUrl){ blob=await fetch(d.objUrl).then(r=>r.blob()); }
    if(!blob && d.dataUrl){ blob=await fetch(d.dataUrl).then(r=>r.blob()); }
    if(!blob) throw new Error('No blob captured from generator');

    const fn=d.filename||`${(d.docType||'document').toUpperCase()}-${Date.now()}.pdf`;
    // local download (safety)
    try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fn; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000); }catch(_){}

    const meta=JSON.parse(sessionStorage.getItem('veDocData')||'{}')?.meta||{};
    const orderId=meta.orderId;
    if(orderId){
      const file = new File([blob], fn, { type:'application/pdf' });
      await supa.uploadGenerated(orderId, d.docType||meta.docType||'doc', file);
      await supa.load(); render(); renderOpenViewIfSame();
    }
    if ($('genDlg')?.open) $('genDlg').close();
  }catch(err){
    console.error(err); alert('Downloaded PDF, but upload failed.');
  }finally{
    if ($('genGo')) { $('genGo').disabled=false; $('genGo').textContent='Generate…'; }
  }
});

/* Bridge code injected into the generator iframe */
const BRIDGE_CODE = `
(function(){
  if (window.__VE_BRIDGE_READY) return; window.__VE_BRIDGE_READY = true;

  const getMeta=()=>{try{return JSON.parse(sessionStorage.getItem('veDocData')||'{}').meta||{}}catch(e){return{}}};
  const infer=()=>{const m=getMeta();if(m.docType)return m.docType;const p=(location.pathname+location.hash).toLowerCase();
    if(p.includes('/rma'))return'rma'; if(p.includes('/commercial-invoice')&&p.includes('#pt'))return'pt';
    if(p.includes('/commercial-invoice'))return'ci'; if(p.includes('/so-confirmation')&&p.includes('invoice'))return'invoice';
    if(p.includes('/so-confirmation'))return'so'; return'doc';};
  const name=(t)=>{const id=getMeta().orderId||'ORDER';const d=new Date().toISOString().slice(0,10);return (t||'document').toUpperCase()+"-"+id+"-"+d+".pdf"};
  const post=(pl)=>{try{parent.postMessage(pl,'*')}catch(e){}};

  const VE={ emitPdfFromBlob(b,f,dt){post({type:'ve-doc-generated',docType:dt||infer(),filename:f||name(dt),blob:b})},
             emitPdfFromDataUrl(u,f,dt){post({type:'ve-doc-generated',docType:dt||infer(),filename:f||name(dt),dataUrl:u})},
             emitPdfFromObjectUrl(u,f,dt){post({type:'ve-doc-generated',docType:dt||infer(),filename:f||name(dt),objUrl:u})},
             emitPdfBytes(bytes,f,dt){const u8=bytes instanceof Uint8Array?bytes:new Uint8Array(bytes);const b=new Blob([u8],{type:'application/pdf'});VE.emitPdfFromBlob(b,f,dt)} };
  window.VE=VE; window.VE_SEND_PDF=function(p){if(p.blob)return VE.emitPdfFromBlob(p.blob,p.filename,p.docType); if(p.objUrl)return VE.emitPdfFromObjectUrl(p.objUrl,p.filename,p.docType); if(p.dataUrl)return VE.emitPdfFromDataUrl(p.dataUrl,p.filename,p.docType);};

  /* jsPDF hooks */
  try{
    const jspdfNS=window.jspdf||window.jsPDF;
    const Proto=jspdfNS?.jsPDF?.prototype||jspdfNS?.API||window.jsPDF?.API;
    if(Proto){
      const origSave=Proto.save;
      if(typeof origSave==='function'){
        Proto.save=function(fn){
          try{const b=this.output('blob'); VE.emitPdfFromBlob(b,fn);}catch(e){
            try{const u=this.output('datauristring'); VE.emitPdfFromDataUrl(u,fn);}catch(_){} }
          return origSave.apply(this,arguments);
        };
      }
      const origOut=Proto.output;
      if(typeof origOut==='function'){
        Proto.output=function(type){
          const r=origOut.apply(this,arguments);
          if(String(type||'').toLowerCase()==='save'){
            try{const b=this.output('blob'); VE.emitPdfFromBlob(b);}catch(_){}
          }
          return r;
        };
      }
    }
  }catch(e){}

  /* FileSaver / saveAs */
  try{
    const prev = window.saveAs;
    window.saveAs = function(blob, filename){ try{ VE.emitPdfFromBlob(blob, filename||name()); }catch(_){ } return prev?prev.apply(this,arguments):undefined; };
  }catch(_){}

  /* URL.createObjectURL + anchor click */
  (function(){
    let lastPdfUrl=null;
    const origCreate=URL.createObjectURL;
    if(typeof origCreate==='function'){
      URL.createObjectURL=function(obj){
        const url=origCreate.apply(this,arguments);
        try{ const t=(obj&&obj.type)||''; if(/pdf/i.test(t)) lastPdfUrl=url; }catch(_){}
        return url;
      };
    }
    const OrigA=HTMLAnchorElement.prototype.click;
    HTMLAnchorElement.prototype.click=function(){
      try{
        let href=this.getAttribute('href')||'';
        const dl=this.getAttribute('download')||'';
        if((!href||href==='') && lastPdfUrl) href=lastPdfUrl;
        if(href && (href.startsWith('blob:') || href.startsWith('data:application/pdf'))){
          post({type:'ve-doc-generated',docType:infer(),filename:dl||name(),objUrl:href});
        }
      }catch(_){}
      return OrigA.apply(this,arguments);
    };
  })();

  /* window.open(blob) */
  (function(){
    const origOpen = window.open;
    window.open = function(url, ...rest){
      try{
        if(typeof url==='string' && (url.startsWith('blob:') || url.startsWith('data:application/pdf'))){
          post({type:'ve-doc-generated',docType:infer(),filename:name(),objUrl:url});
        }
      }catch(_){}
      return origOpen ? origOpen.apply(this,[url, ...rest]) : null;
    };
  })();

  /* IE/Edge legacy */
  try{
    navigator.msSaveOrOpenBlob = function(blob, filename){ VE.emitPdfFromBlob(blob, filename||name()); };
  }catch(_){}
})();
`;

/* Auto-fill script that runs inside generator after the bridge */
function AUTO_FILL(payload){
  function q(sa){try{return document.querySelector(sa)}catch(e){return null}}
  function text(el){return (el?.textContent||'').trim().toLowerCase()}
  function has(el,txt){return el && text(el).includes((txt||'').toLowerCase())}
  function byLabel(txt){
    for(const lab of document.querySelectorAll('label')){
      if(has(lab,txt)){ const id=lab.getAttribute('for'); if(id){ const el=document.getElementById(id); if(el) return el; }
        let p=lab.parentElement; for(let i=0;i<3 && p;i++,p=p.parentElement){ const el=p.querySelector('input,textarea,select'); if(el) return el; }
      }
    }
    let el=q(\`input[placeholder*="\${txt}"],textarea[placeholder*="\${txt}"]\`)||q(\`input[title*="\${txt}"],textarea[title*="\${txt}"]\`); if(el) return el;
    for(const sel of document.querySelectorAll('select')){const prev=sel.previousElementSibling; if(prev && has(prev,txt)) return sel;}
    return null;
  }
  function setVal(el,val){ if(!el) return; if(el.tagName==='SELECT'){ const opts=[...el.options]; const hit=opts.find(o=>o.textContent.trim().toLowerCase()===(val||'').toLowerCase())||opts.find(o=>o.value.toLowerCase()===(val||'').toLowerCase()); if(hit){ el.value=hit.value; el.dispatchEvent(new Event('change',{bubbles:true})); } }
    else { el.value=val; el.dispatchEvent(new Event('input',{bubbles:true})); } }

  const typeMap={so:'Sales Order Confirmation',invoice:'Invoice',ci:'Commercial Invoice',pt:'Picking Ticket',rma:'RMA'};
  setVal(byLabel('DOCUMENT TYPE')||byLabel('Document type')||q('select'), typeMap[payload.meta.docType]||typeMap.so);
  setVal(byLabel('CURRENCY')||byLabel('Currency'), payload.meta.currency||'USD');
  if(payload.ci && payload.ci.freight!=null){ setVal(byLabel('SHIPPING')||byLabel('Shipping'), String(payload.ci.freight)); }

  const sellerLines=(payload.meta.from||'').split('\\n');
  setVal(byLabel('Seller Name')||byLabel('Company name'), sellerLines.shift()||'Verified Electronics');
  setVal(byLabel('Address')||byLabel('Address lines'), sellerLines.join('\\n'));

  setVal(byLabel('Buyer / Company')||byLabel('Customer Company')||byLabel('Company'), payload.meta.customer||'');
  setVal(byLabel('Bill To'), payload.meta.soldto||'');
  setVal(byLabel('Ship To'), payload.meta.shipto||'');

  setVal(byLabel('Salesperson')||byLabel('Name'), payload.meta.salesperson||'');
  setVal(byLabel('Delivery Terms')||byLabel('Incoterms'), payload.meta.incoterm||'');
  setVal(byLabel('Payment Terms'), payload.meta.payment_terms||'');

  const num=byLabel('Number')||byLabel('Order Number'); if(num){ num.value=((payload.meta.docType==='invoice'?'INV-':'SO-')+(payload.meta.orderId||'')); num.dispatchEvent(new Event('input',{bubbles:true})); }

  function addLine(){ const btn=[...document.querySelectorAll('button')].find(b=>/add (line|item)/i.test(b.textContent)); if(btn) btn.click(); }
  function fillLast(it){
    const rows=[...document.querySelectorAll('table, .items, .lines')]; let container=rows.find(r=>/qty/i.test(r.textContent||''))||document.body;
    const sel=(s)=>container.querySelector(s);
    const part=sel('tr:last-child input[placeholder*="Part"], input[name*="part"]')||container.querySelector('tr:last-child input')||null;
    const desc=sel('tr:last-child textarea, input[placeholder*="Desc"]')||null;
    const qty =sel('tr:last-child input[placeholder*="Qty"], input[name*="qty"]')||null;
    const unit=sel('tr:last-child input[placeholder*="Unit"], input[placeholder*="Price"], input[name*="unit"]')||null;
    if(part){part.value=it.part;part.dispatchEvent(new Event('input',{bubbles:true}))}
    if(desc){desc.value=it.desc||'';desc.dispatchEvent(new Event('input',{bubbles:true}))}
    if(qty){qty.value=it.qty;qty.dispatchEvent(new Event('input',{bubbles:true}))}
    if(unit){unit.value=it.unitSell;unit.dispatchEvent(new Event('input',{bubbles:true}))}
  }
  (payload.items||[]).forEach(it=>{addLine();fillLast(it)});

  if(payload.meta.docType==='rma' && payload.rma){
    setVal(byLabel('Return To'), payload.meta.returnTo||'');
    setVal(byLabel('Return Reason'), payload.rma.reason||'');
    setVal(byLabel('Action'), payload.rma.action||'');
    setVal(byLabel('Contact'), payload.rma.contact||'');
    setVal(byLabel('Email'), payload.rma.email||'');
    setVal(byLabel('Phone'), payload.rma.phone||'');
    const rnum=byLabel('RMA Number')||byLabel('Number'); if(rnum) setVal(rnum, payload.rma.number||'');
  }

  setTimeout(()=>{ const gen=[...document.querySelectorAll('button')].find(b=>/generate pdf/i.test(b.textContent)); if(gen) gen.click(); },700);
}

/* ================= CSV ================= */
$('btnCsv').onclick=()=>{
  const head=[...document.querySelectorAll('#tbl thead th')].map(x=>x.innerText);
  const rows=[...document.querySelectorAll('#tbody tr')].map(tr=>[...tr.children].map(td=>td.innerText.replace(/\s+/g,' ').trim()));
  const csv=[head,...rows].map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='orders.csv'; a.click();
};

/* ================= boot ================= */
document.addEventListener('DOMContentLoaded',async()=>{
  $('fltSales').innerHTML='<option value="">All salespeople</option>'+SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  $('q').oninput=()=>render(); ['fltSales','fltStatus','fltPriority'].forEach(id=>$(id).oninput=render);
  await supa.load(); supa.rt(); render();
});
</script>
</body>
</html>
