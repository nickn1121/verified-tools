<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Excess Part Number Checker ‚Äî Verified Electronics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff;--ink:#1f2937;--muted:#6b7280;--line:#e5e7eb;--panel:#f9fafb;
      --brand:#6d28d9;--brand2:#9333ea;--ok:#10b981;--warn:#f59e0b;--err:#ef4444
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1080px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:4px 0 18px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{height:54px}
    h1{margin:0;font-size:24px;font-weight:800;letter-spacing:.2px}
    a.btn,button.btn{appearance:none}
    .btn{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border:0;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#f43f5e)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 28px rgba(17,24,39,.06);padding:18px}
    .stat{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;font-size:12px}
    .tabs{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:12px;background:#fff;border:1px solid var(--line);cursor:pointer;font-weight:600}
    .tab.active{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border:0}
    .section{display:none;margin-top:12px}.section.active{display:block}
    label strong{display:block;margin:6px 0}
    textarea{width:100%;min-height:140px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);resize:vertical}
    input[type="text"],input[type="date"],input[type="number"],select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink)}
    input[type="file"]{width:100%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
    .hint{font-size:12px;color:var(--muted)}
    .rows{margin-top:14px}.row{background:var(--panel);border:1px solid var(--line);padding:10px 12px;border-radius:12px;margin:8px 0}
    .row.flex{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .minitable{width:100%;border-collapse:collapse;margin-top:6px;font-size:13px}
    .minitable th,.minitable td{padding:6px 8px;border-top:1px solid var(--line)}
    .minitable th{color:var(--muted);text-align:left}.minitable td.qty{text-align:right;font-variant-numeric:tabular-nums}
    .progress{position:relative;height:10px;border-radius:999px;background:#eee;overflow:hidden;border:1px solid var(--line);margin-top:8px}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .2s ease}
    .vendor-pill{display:flex;align-items:center;gap:10px;justify-content:space-between}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img class="logo" src="../assets/Logo_color_white_background (1).png?v=v8" alt="Verified Electronics"/>
      <h1>Excess Part Number Checker</h1>
    </div>
    <a href="/" class="btn ghost">‚Üê Back to Tools</a>
  </header>

  <div class="card">
    <div class="stat">
      <div class="title">üìä Live Excess Inventory</div>
      <div class="chips">
        <span class="chip">Total Part Numbers: <strong id="stat-total">‚Äî</strong></span>
        <span class="chip">Unique Vendors: <strong id="stat-vendors">‚Äî</strong></span>
        <span class="chip">Uploads (Vendor √ó Date): <strong id="stat-batches">‚Äî</strong></span>
      </div>
      <button id="btn-export-vendors" class="btn ghost" style="margin-top:8px">Export Vendors CSV</button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="tab-search">Search</button>
      <button class="tab" data-tab="tab-upload">Upload</button>
      <button class="tab" data-tab="tab-remove">Remove</button>
      <button class="tab" data-tab="tab-leader">Leaderboard</button>
      <button class="tab" data-tab="tab-vendors">Vendors</button>
      <button class="tab" data-tab="tab-log">Excess log</button>
    </div>

    <!-- SEARCH -->
    <section id="tab-search" class="section active">
      <div class="hint" style="border:1px dashed var(--line);border-radius:12px;padding:10px;margin-bottom:10px">
        Paste one part per line, or upload a CSV with a <span class="mono">Part Number</span> column.
        Matching is exact (case-insensitive) while tolerating punctuation & common package suffixes (TR/NOPB/RGWT).
        Letter/number order must be identical (no fuzzy reordering).
      </div>
      <label><strong>Paste part numbers (one per line)</strong></label>
      <textarea id="input-parts" class="mono" placeholder="e.g.
LM358DR
STM32F103C8T6
20-101-1068"></textarea>
      <div class="controls">
        <div>
          <input type="file" id="file-search" accept=".csv"/>
          <div class="hint">CSV must contain a column named <code>Part Number</code> (MPN/PN also accepted).</div>
        </div>
        <button id="btn-search" class="btn">üîç Check Excess</button>
        <button id="btn-export-results" class="btn ghost" disabled>Export results CSV</button>
      </div>
      <div id="search-results" class="rows"></div>
    </section>

    <!-- UPLOAD -->
    <section id="tab-upload" class="section">
      <div class="hint" style="border:1px dashed var(--line);border-radius:12px;padding:10px;margin-bottom:10px">
        Option A ‚Äî CSV with headers: <span class="mono">Part Number, Quantity, Vendor</span> (Vendor optional).<br/>
        Option B ‚Äî Paste rows below using: <span class="mono">Part Number, Quantity, Vendor</span>. One row per line.<br/>
        If Vendor is missing, the <b>Fallback Vendor</b> will be used.
      </div>
      <div class="grid">
        <div>
          <label><strong>CSV file (Part Number, Quantity, Vendor)</strong></label>
          <input type="file" id="file-upload" accept=".csv"/>
          <div class="hint">Required: <span class="mono">Part Number/MPN</span>, <span class="mono">Quantity/Qty</span>. Optional: <span class="mono">Vendor/Supplier</span>.</div>
        </div>
        <div>
          <label><strong>Fallback Vendor (if Vendor column/field is missing)</strong></label>
          <input type="text" id="fallback-vendor" placeholder="e.g. ACME Components"/>
        </div>
      </div>
      <label style="margin-top:10px"><strong>Or paste rows</strong></label>
      <textarea id="paste-upload" class="mono" placeholder="TEST123, 100, DemoVendor&#10;LM358DR, 250&#10;STM32F103C8T6, 50, ST"></textarea>
      <div class="grid" style="margin-top:10px">
        <div>
          <label><strong>Uploaded by</strong></label>
          <div style="display:flex;gap:10px;align-items:center">
            <select id="uploaded-by">
              <option value="">‚Äî Select Staff ‚Äî</option>
              <option value="Nick N">Nick N</option>
              <option value="Nick K">Nick K</option>
              <option value="Jake B">Jake B</option>
              <option value="Dan C">Dan C</option>
              <option value="Emir B">Emir B</option>
              <option value="Other">Other‚Ä¶</option>
            </select>
            <input type="text" id="other-staff" placeholder="Enter staff name" style="display:none;width:50%"/>
          </div>
          <div class="hint">Choose a name. If ‚ÄúOther‚Ä¶‚Äù, enter a new staff member.</div>
        </div>
        <div></div>
      </div>
      <div class="controls">
        <button id="btn-upload" class="btn">‚¨ÜÔ∏è Upload Excess</button>
        <span id="upload-status" class="hint mono"></span>
      </div>
      <div id="upload-progress-wrap" style="display:none;margin-top:8px;border:1px dashed var(--line);border-radius:12px;padding:10px">
        <div class="title" id="up-stage">Preparing‚Ä¶</div>
        <div class="hint"><span id="up-detail">‚Äì</span></div>
        <div class="progress"><div class="progress-bar" id="up-bar" style="width:0%"></div></div>
      </div>
    </section>

    <!-- REMOVE -->
    <section id="tab-remove" class="section">
      <div class="hint" style="border:1px dashed var(--line);border-radius:12px;padding:10px;margin-bottom:10px">
        Choose a prior upload (Vendor √ó Date) below, then click <b>Remove</b>.<br/>
        You can also delete directly from the Vendors list using each vendor‚Äôs <b>Delete</b> button.
      </div>
      <div class="grid">
        <div>
          <label><strong>Pick an upload (Vendor √ó Date)</strong></label>
          <select id="rm-batch"></select>
          <div class="hint" id="rm-batch-info"></div>
        </div>
        <div>
          <label><strong>‚Ä¶or enter manually</strong></label>
          <div class="grid">
            <input type="text" id="rm-vendor" placeholder="Vendor"/>
            <input type="date" id="rm-date"/>
          </div>
          <div class="hint">Manual inputs are only used if no item is selected above.</div>
        </div>
      </div>
      <div class="controls">
        <button id="btn-remove" class="btn">üóëÔ∏è Remove Selected Upload</button>
        <span class="hint" id="remove-status"></span>
      </div>
      <div class="rows" id="upload-list"></div>
    </section>

    <!-- LEADERBOARD -->
    <section id="tab-leader" class="section">
      <div class="rows">
        <table style="width:100%;border-collapse:separate;border-spacing:0 8px">
          <thead><tr><th>#</th><th>Employee</th><th>Lists</th></tr></thead>
          <tbody id="leader-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- VENDORS -->
    <section id="tab-vendors" class="section">
      <div class="hint" style="border:1px dashed var(--line);border-radius:12px;padding:10px;margin-bottom:10px">
        Pick a vendor to see their parts and quantities. Use the Delete button to remove all parts for that vendor.
      </div>
      <div class="grid">
        <div>
          <label><strong>Search vendors</strong></label>
          <input type="text" id="vendor-search" placeholder="Type to filter (leave empty to show all)"/>
          <div class="hint">Showing <span id="vendor-count">0</span> vendors</div>
          <div id="vendor-list" class="rows" style="max-height:480px;overflow:auto"></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="title" id="vendor-title">‚Äî</div>
              <div class="hint" id="vendor-stats">Select a vendor</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="btn-export-page" class="btn ghost" disabled>Export page CSV</button>
              <button id="btn-export-all" class="btn" disabled>Export full CSV</button>
            </div>
          </div>
          <div class="rows" id="vendor-parts"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <span class="hint" id="vendor-page-hint"></span>
            <div style="display:flex;gap:8px">
              <button id="vp-prev" class="btn ghost" disabled>‚Üê Prev</button>
              <button id="vp-next" class="btn ghost" disabled>Next ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EXCESS LOG -->
    <section id="tab-log" class="section">
      <div class="hint" style="border:1px dashed var(--line);border-radius:12px;padding:10px;margin-bottom:10px">
        Recent upload activity (last 20 rows) from <span class="mono">public.excess_log</span>.
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <button id="log-refresh" class="btn ghost">Refresh</button>
        <span class="hint">Most recent first</span>
      </div>
      <div id="log-list" class="rows"></div>
    </section>
  </div>

  <footer style="margin:26px 2px 10px;color:var(--muted);font-size:12px;text-align:center">¬© <span id="year"></span> Verified Electronics</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js?v=v8"></script>
<script type="module">
  const APP_VERSION = "v8";
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL  = "https://ijzroisggstqkfhpjndq.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  const $ = id => document.getElementById(id);
  $("year").textContent = new Date().getFullYear();

  // helpers
  const norm = s=>String(s??"").trim();
  const lower=s=>norm(s).toLowerCase();
  const dedupUpper = arr => [...new Set(arr.map(s=>s.trim()).filter(Boolean).map(s=>s.toUpperCase()))];
  const CANON = s => String(s||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
  const trimPkg = c => c.replace(/[A-Z]{1,6}$/,"");
  const equalPN = (a,b)=>{const A=CANON(a),B=CANON(b);return !!A&&(A===B||trimPkg(A)===trimPkg(B));};
  const extractToken = line => (String(line||"").trim().toUpperCase().split(/[,\s;]+/)[0]||"");
  const anchorPattern = raw => {const c=CANON(raw);return c.length>=4? "%"+c.slice(0,4)+"%" : "%"+c+"%";};
  function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))}
  const todayUTC = ()=> new Date().toISOString().slice(0,10);
  const num = v => { const s=String(v??"").replace(/[^\d.-]/g,""); const n=Number(s); return Number.isFinite(n)?n:null; };

  // tabs
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      b.classList.add("active");
      document.getElementById(b.dataset.tab).classList.add("active");
      if (b.dataset.tab === "tab-log") loadExcessLog();
      if (b.dataset.tab === "tab-leader") loadLeaderboard();
      if (b.dataset.tab === "tab-vendors") VendorView.renderVendorList($("vendor-search").value.trim());
    });
  });

  // ---------- RELIABLE FULL VENDOR SCAN (keyset pagination) ----------
  async function scanAllVendors(prefix="") {
    const uniq = new Set();
    let lastId = 0;
    const PAGE = 1000;
    while (true) {
      const { data, error } = await supabase
        .from("excess_parts")
        .select("id,vendor")
        .not("vendor","is",null)
        .gt("id", lastId)
        .order("id", { ascending: true })
        .limit(PAGE);

      if (error) throw error;
      if (!data || !data.length) break;

      for (const r of data) {
        const v = (r.vendor || "").trim();
        if (!v) continue;
        if (prefix && !v.toLowerCase().startsWith(prefix.toLowerCase())) continue;
        uniq.add(v);
        if (r.id > lastId) lastId = r.id;
      }
      if (data.length < PAGE) break;
    }
    return [...uniq].sort((a,b)=>a.localeCompare(b));
  }

  async function safeCountUploads(){
    try{
      const head = await supabase.from("excess_log").select("*",{count:"exact",head:true});
      if (typeof head.count === "number") return head.count;
    }catch{}
    try{
      const head = await supabase.from("excess_uploads").select("*",{count:"exact",head:true});
      if (typeof head.count === "number") return head.count;
    }catch{}
    try{
      const head = await supabase.from("excess_batches").select("*",{count:"exact",head:true});
      if (typeof head.count === "number") return head.count;
    }catch{}
    return 0;
  }

  async function loadStats(){
    const head = await supabase.from("excess_parts").select("*",{count:"exact",head:true});
    $("stat-total").textContent = (head.count||0).toLocaleString();

    const vendors = await scanAllVendors("");
    $("stat-vendors").textContent = vendors.length.toLocaleString();

    $("stat-batches").textContent = (await safeCountUploads()).toLocaleString();
  }

  $("btn-export-vendors").onclick = async ()=>{
    const list = await scanAllVendors("");
    if (!list.length) { alert("No vendors found."); return; }
    const csv = "Vendor\n"+list.map(v=>`"${v.replace(/"/g,'""')}"`).join("\n");
    const url = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    const a=document.createElement("a"); a.href=url; a.download="vendors.csv"; a.click(); URL.revokeObjectURL(url);
  };

  // CSV parse
  const HDR_PART=["Part Number","MPN","PN","Part","PartNumber","Item","MPN/Part Number"];
  const HDR_QTY=["Quantity","Qty","Q'ty","Qta","Quantit√†","On Hand","Stock"];
  const HDR_VEND=["Vendor","Supplier","Seller","Company","Vendor Name","Supplier Name"];
  const findHeader=(headers,cands)=>{const H=headers.map(h=>({raw:h,key:lower(h)})), want=cands.map(lower); const hit=H.find(h=>want.includes(h.key)); return hit?hit.raw:null;};
  const streamParseCSV=(file,onChunk)=>new Promise((resolve,reject)=>{
    let headers=null,total=0;
    Papa.parse(file,{worker:true,header:true,skipEmptyLines:true,chunkSize:1024*1024,
      chunk:(res)=>{headers=headers||(res.meta.fields||[]); const rows=res.data||[]; total+=rows.length; onChunk?.(rows,total);},
      error:reject, complete:()=>resolve({headers:headers||[],totalRows:total})});
  });

  // upload
  function showOtherStaff(){ $("other-staff").style.display = $("uploaded-by").value==="Other"?"block":"none"; }
  $("uploaded-by").addEventListener("change", showOtherStaff);

  async function doInserts(rows, chunk=1500){
    for(let i=0;i<rows.length;i+=chunk){
      const slice=rows.slice(i,i+chunk);
      const { error } = await supabase.from("excess_parts").insert(slice);
      if (error) throw new Error(error.message);
      const pct=Math.round(((i+slice.length)/rows.length)*100);
      $("up-bar").style.width=pct+"%";
      $("up-detail").textContent = `Inserted ${i + slice.length} of ${rows.length}`;
    }
  }

  async function tryInsertSummary(payload){
    try{ const { error } = await supabase.from("excess_uploads").insert(payload);
      if (!error) return true;
    }catch{}
    try{ const { error } = await supabase.from("excess_batches").insert(payload);
      if (!error) return true;
    }catch{}
    return false;
  }
  async function tryInsertLog(payload){
    try{ const { error } = await supabase.from("excess_log").insert(payload);
      if (!error) return true;
    }catch{}
    return false;
  }
  function getUploader(){ const sel=$("uploaded-by").value; if (sel==="Other") return $("other-staff").value.trim(); return sel || ""; }
  function resetUploadBtn(){ $("btn-upload").disabled=false; $("btn-upload").textContent="‚¨ÜÔ∏è Upload Excess"; }

  $("btn-upload").onclick = async ()=>{
    const fallbackVendor=$("fallback-vendor").value.trim();
    const uploader=getUploader();
    const pasted=$("paste-upload").value.trim();
    const file=$("file-upload").files?.[0];

    if (!file && !pasted){ alert("Attach a CSV or paste rows first."); return; }
    if (!uploader){ alert("Please choose who uploaded the list."); return; }

    $("btn-upload").disabled=true; $("btn-upload").textContent="‚è≥ Uploading‚Ä¶";
    $("upload-status").textContent=""; $("upload-progress-wrap").style.display="block";
    $("up-stage").textContent="Parsing data‚Ä¶"; $("up-detail").textContent="Reading file/paste"; $("up-bar").style.width="5%";

    const rows=[]; const batch_id=uuidv4();

    if (file){
      const collected=[]; await streamParseCSV(file, chunk=>collected.push(...chunk));
      if (!collected.length){ alert("CSV is empty."); resetUploadBtn(); return; }
      const headers=Object.keys(collected[0]||{}); const hPart=findHeader(headers,HDR_PART); const hQty=findHeader(headers,HDR_QTY); const hVend=findHeader(headers,HDR_VEND);
      if (!hPart || !hQty){ alert("CSV must have Part Number and Quantity columns."); resetUploadBtn(); return; }
      for (const r of collected){
        const pn=norm(r[hPart]); const q=num(r[hQty]); let vendor=norm(hVend? r[hVend]:"") || fallbackVendor;
        if (!pn || q===null) continue; rows.push({ part_number:pn, quantity:q, vendor, batch_id });
      }
    } else {
      pasted.split("\n").map(s=>s.trim()).filter(Boolean).forEach(line=>{
        const bits=line.split(",").map(s=>s.trim());
        const pn=bits[0]||""; const q=num(bits[1]); let vendor=(bits[2]||"").trim() || fallbackVendor;
        if (!pn || q===null) return; rows.push({ part_number:pn, quantity:q, vendor, batch_id });
      });
    }

    if (!rows.length){ alert("Nothing to upload after parsing ‚Äî check your columns."); resetUploadBtn(); return; }

    $("up-stage").textContent="Inserting parts‚Ä¶"; $("up-detail").textContent=`0 of ${rows.length}`; $("up-bar").style.width="10%";

    try{
      await doInserts(rows,1500);

      const created_on_utc=todayUTC();
      const fileName=$("file-upload")?.files?.[0]?.name || null;
      const vendors=[...new Set(rows.map(r=>r.vendor || fallbackVendor || "(unknown)"))];
      for (const v of vendors){
        const vr=rows.filter(r=>(r.vendor || fallbackVendor || "(unknown)")===v);
        const payload={
          vendor:v,
          rows_count:vr.length,
          total_qty: vr.reduce((a,b)=>a+(Number(b.quantity)||0),0),
          uploaded_by:uploader||null,
          created_on_utc,
          batch_id
        };
        await tryInsertSummary(payload);
        await tryInsertLog({ ...payload, file_name:fileName, source:"web", status:"success", error:null });
      }

      $("up-stage").textContent="Done!";
      $("up-detail").textContent=`Inserted ${rows.length.toLocaleString()} rows.`; $("up-bar").style.width="100%";
      $("upload-status").innerHTML=`<span class="ok">Upload complete.</span>`;
      await loadStats(); await refreshUploadsUI(); await loadExcessLog();
    }catch(e){
      console.error(e);
      $("upload-status").innerHTML=`<span class="err">Upload failed: ${e.message}</span>`;
      try {
        const fileName=$("file-upload")?.files?.[0]?.name || null;
        await tryInsertLog({
          vendor:fallbackVendor || "(unknown)",
          rows_count:0,
          total_qty:0,
          uploaded_by:getUploader() || null,
          created_on_utc: todayUTC(),
          batch_id: uuidv4(),
          file_name:fileName,
          source:"web",
          status:"failed",
          error:e.message
        });
      } catch {}
    } finally { resetUploadBtn(); }
  };

  // search
  let __lastSearchRows__=[];
  $("btn-search").onclick = async ()=>{
    const pasted=$("input-parts").value.split("\n").map(s=>s.trim()).filter(Boolean);
    let parts=dedupUpper(pasted);
    const file=$("file-search").files?.[0];
    if (file){
      const collected=[]; await streamParseCSV(file,chunk=>collected.push(...chunk));
      const headers=Object.keys(collected[0]||{}); const hPart=findHeader(headers,HDR_PART);
      if (!hPart){ alert("CSV needs a Part Number/MPN column"); return; }
      parts=dedupUpper([...parts, ...collected.map(r=>r[hPart])]);
    }
    if (!parts.length){ alert("Add some part numbers first."); return; }

    $("btn-search").disabled=true; $("btn-search").textContent="‚è≥ Searching‚Ä¶"; $("btn-export-results").disabled=true;
    const box=$("search-results"); box.innerHTML=""; __lastSearchRows__=[];

    for (const rawLine of parts){
      const token=extractToken(rawLine); const canonQ=CANON(token); if (!canonQ) continue;
      const like=anchorPattern(token);
      const { data, error } = await supabase.from("excess_parts").select("part_number,vendor,quantity,created_at").ilike("part_number", like).limit(5000);
      if (error){ console.error(error); continue; }
      const hits=(data||[]).filter(r=> equalPN(r.part_number, token));
      if (!hits.length) continue;

      const groups=hits.reduce((m,r)=>{ const k=r.part_number.toUpperCase(); (m[k]??=[]).push(r); return m; },{});
      Object.keys(groups).sort().forEach(pn=>{
        const rows=groups[pn]; const byVendor={}; let total=0;
        rows.forEach(r=>{ const v=r.vendor||"(unknown)"; const q=Number(r.quantity)||0; byVendor[v]=(byVendor[v]||0)+q; total+=q; __lastSearchRows__.push({part_number:pn,vendor:v,quantity:q}); });
        const vendorsHtml=Object.entries(byVendor).sort((a,b)=>b[1]-a[1]).map(([v,q])=>`<tr><td>${v}</td><td class="qty">${q.toLocaleString()}</td></tr>`).join("");
        const el=document.createElement("div"); el.className="row";
        el.innerHTML=`<div><strong>${pn}</strong></div>
          <table class="minitable"><thead><tr><th>Vendor</th><th class="qty">Quantity</th></tr></thead>
          <tbody>${vendorsHtml}</tbody><tfoot><tr><th>Total</th><th class="qty">${total.toLocaleString()}</th></tr></tfoot></table>`;
        box.appendChild(el);
      });
    }
    if (!__lastSearchRows__.length) box.innerHTML=`<div class="row">No matching parts found.</div>`; else $("btn-export-results").disabled=false;
    $("btn-search").disabled=false; $("btn-search").textContent="üîç Check Excess";
  };
  $("btn-export-results").onclick=()=>{
    const rows=__lastSearchRows__; if(!rows?.length){ alert("Nothing to export yet."); return; }
    const header="Part Number,Vendor,Quantity";
    const body=rows.map(r=>[`"${(r.part_number||"").replace(/"/g,'""')}"`,`"${(r.vendor||"").replace(/"/g,'""')}"`,String(Number(r.quantity||0))].join(",")).join("\n");
    const url=URL.createObjectURL(new Blob([header+"\n"+body],{type:"text/csv"}));
    const a=document.createElement("a"); a.href=url; a.download="excess_search_results.csv"; a.click(); URL.revokeObjectURL(url);
  };

  // RPC helpers for delete
  async function rpcDeleteByBatch(batch_id) {
    const { data, error } = await supabase.rpc("excess_delete_by_batch", { in_batch: batch_id });
    if (error) throw new Error(error.message);
    return Number(data || 0);
  }
  async function rpcDeleteByVendorDate(vendor, date) {
    const { data, error } = await supabase.rpc("excess_delete_by_vendor_date", { in_vendor: vendor, in_date: date });
    if (error) throw new Error(error.message);
    return Number(data || 0);
  }

  async function handleDeleteUpload(meta) {
    const v = meta.vendor || "(unknown)";
    const d = meta.date || "‚Äî";
    const msg = `Delete ALL parts for:\n\nVendor: ${v}\nDate:   ${d}\n\nThis cannot be undone. Continue?`;
    if (!confirm(msg)) return;

    let removed = 0;
    try {
      if (meta.batch_id) removed = await rpcDeleteByBatch(meta.batch_id);
      else removed = await rpcDeleteByVendorDate(v, d);
    } catch (e) {
      alert(`Delete failed: ${e.message}`);
      return;
    }

    try {
      if (meta.batch_id) {
        await supabase.from("excess_log").update({ status: "deleted" }).eq("batch_id", meta.batch_id);
      } else {
        await supabase.from("excess_log").update({ status: "deleted" }).eq("vendor", v).eq("created_on_utc", d);
      }
    } catch (_) {}

    alert(`Deleted ${removed.toLocaleString()} rows for ${v} on ${d}.`);
    await loadStats(); await refreshUploadsUI(); await loadExcessLog(); await VendorView.renderVendorList($("vendor-search").value.trim());
  }

  // remove tab list + button
  async function refreshUploadsUI(){
    const list = $("upload-list");
    list.innerHTML = "";
    const sel = $("rm-batch");
    sel.innerHTML = "";

    let data = null;
    try {
      const r = await supabase
        .from("excess_uploads")
        .select("vendor, created_on_utc, rows_count, total_qty, batch_id")
        .order("created_on_utc", { ascending: false })
        .limit(1000);
      data = r.data || [];
    } catch {
      data = null;
    }

    if (!data) {
      list.innerHTML = `<div class="row">Upload summaries are not being recorded. You can still remove by Vendor + Date using the big button.</div>`;
      sel.appendChild(new Option("‚Äî No upload summaries ‚Äî",""));
      return;
    }
    if (!data.length) {
      list.innerHTML = `<div class="row">No uploads yet.</div>`;
      sel.appendChild(new Option("‚Äî Select an upload ‚Äî",""));
      return;
    }

    sel.appendChild(new Option("‚Äî Select an upload ‚Äî",""));
    data.forEach(r=>{
      const payload = {
        vendor: r.vendor,
        date:   r.created_on_utc,
        rows_count: r.rows_count,
        total_qty:  r.total_qty,
        batch_id:   r.batch_id || null
      };
      const label = `${payload.date} (${payload.rows_count.toLocaleString()} rows, ${Number(payload.total_qty||0).toLocaleString()} qty)` + (payload.batch_id ? ` ‚Äî batch ${payload.batch_id}` : ``);
      sel.appendChild(new Option(label, JSON.stringify(payload)));

      const el = document.createElement("div");
      el.className = "row";
      el.innerHTML = `
        <div class="vendor-pill">
          <div>
            <div><strong>${payload.vendor}</strong> ‚Äî ${payload.date}</div>
            <div class="hint">Rows: <b>${payload.rows_count.toLocaleString()}</b> ‚Ä¢ Total Qty: <b>${Number(payload.total_qty||0).toLocaleString()}</b></div>
            ${payload.batch_id ? `<div class="hint mono">Batch: ${payload.batch_id}</div>` : ``}
          </div>
          <div>
            <button class="btn danger" style="padding:8px 12px" data-del='${JSON.stringify(payload)}'>Delete</button>
          </div>
        </div>
      `;
      el.querySelector("button[data-del]")?.addEventListener("click", (e)=>{
        const meta = JSON.parse(e.currentTarget.getAttribute("data-del"));
        handleDeleteUpload(meta);
      });
      list.appendChild(el);
    });

    sel.onchange = () => {
      if (!sel.value) { $("rm-batch-info").textContent = ""; return; }
      const v = JSON.parse(sel.value);
      $("rm-batch-info").textContent =
        `Selected: ${v.vendor} on ${v.date} ‚Äî ${v.rows_count.toLocaleString()} rows (${Number(v.total_qty||0).toLocaleString()} qty)` +
        (v.batch_id ? ` ‚Äî batch ${v.batch_id}` : ``);
      $("rm-vendor").value = v.vendor;
      $("rm-date").value   = v.date;
    };
  }

  $("btn-remove").onclick = async ()=>{
    const sel = $("rm-batch").value;
    let meta = null;

    if (sel) {
      meta = JSON.parse(sel);
    } else {
      const vendor=$("rm-vendor").value.trim();
      const date=$("rm-date").value;
      if (!vendor || !date) {
        $("remove-status").innerHTML = `<span class="err">Select an upload or fill Vendor + Date.</span>`;
        return;
      }
      meta = { vendor, date, batch_id: null, rows_count: 0, total_qty: 0 };
    }

    $("btn-remove").disabled = true;
    $("btn-remove").textContent = "‚è≥ Removing‚Ä¶";
    $("remove-status").textContent = "";

    try {
      await handleDeleteUpload(meta);
    } finally {
      $("btn-remove").disabled = false;
      $("btn-remove").textContent = "üóëÔ∏è Remove Selected Upload";
    }
  };

  // vendors tab
  const VendorView={selected:null,page:1,pageSize:200,totalRows:0,totalQty:0,currentPageRows:[],
    vendorItem(v){
      const el=document.createElement("div"); el.className="row flex";
      el.innerHTML = `<div style="cursor:pointer;flex:1">${v}</div>
        <button class="btn danger" style="padding:8px 12px">Delete</button>`;
      el.querySelector("div").onclick=()=>this.selectVendor(v);
      el.querySelector("button").onclick=async ()=>{
        // fall back to vendor-date delete using today's date if summary unknown
        const meta={ vendor:v, date: todayUTC(), batch_id:null, rows_count:0, total_qty:0 };
        await handleDeleteUpload(meta);
      };
      return el;
    },
    async renderVendorList(prefix=""){ const box=$("vendor-list"); box.innerHTML=`<div class="row">Loading vendors‚Ä¶</div>`;
      try{
        const vs=await scanAllVendors(prefix);
        $("vendor-count").textContent=vs.length.toLocaleString();
        box.innerHTML="";
        if (!vs.length){ box.innerHTML=`<div class="row">No vendors found.</div>`; return; }
        vs.forEach(v=>box.appendChild(this.vendorItem(v)));
      }catch(e){ box.innerHTML=`<div class="row err">${e.message}</div>`; } },
    async selectVendor(v){ this.selected=v; this.page=1; $("vendor-title").textContent=v; $("btn-export-all").disabled=false; await this.refreshVendorStats(); await this.loadPage(); },
    async refreshVendorStats(){ const { count }=await supabase.from("excess_parts").select("*",{count:"exact",head:true}).eq("vendor",this.selected);
      this.totalRows=count||0; let totalQty=0,PAGE=10000,pages=Math.ceil((this.totalRows||0)/PAGE);
      for(let p=0;p<pages;p++){ const {data}=await supabase.from("excess_parts").select("quantity").eq("vendor",this.selected).range(p*PAGE,Math.min((p+1)*PAGE-1,(this.totalRows||1)-1)); (data||[]).forEach(r=> totalQty+=(Number(r.quantity)||0)); }
      this.totalQty=totalQty; $("vendor-stats").innerHTML=`Rows: <b>${(this.totalRows||0).toLocaleString()}</b> ‚Ä¢ Total Qty: <b>${(this.totalQty||0).toLocaleString()}</b>`; },
    async loadPage(){ const from=(this.page-1)*this.pageSize,to=from+this.pageSize-1;
      const {data,error,count}=await supabase.from("excess_parts").select("part_number,quantity,created_at",{count:"exact"}).eq("vendor",this.selected).order("part_number",{ascending:true}).range(from,to);
      const box=$("vendor-parts"); if(error){ box.innerHTML=`<div class="row err">${error.message}</div>`; return; }
      this.currentPageRows=data||[]; if(typeof count==="number") this.totalRows=count;
      box.innerHTML=this.currentPageRows.length? "" : `<div class="row">No parts for this vendor.</div>`;
      this.currentPageRows.forEach(r=>{ const el=document.createElement("div"); el.className="row";
        el.innerHTML=`<div><strong>${(r.part_number||"").toUpperCase()}</strong></div><div class="hint">Qty: <b>${Number(r.quantity||0).toLocaleString()}</b> ‚Ä¢ Added: ${new Date(r.created_at).toISOString().split("T")[0]}</div>`; box.appendChild(el); });
      const pages=Math.max(1,Math.ceil((this.totalRows||0)/this.pageSize)); $("vendor-page-hint").textContent=`Page ${this.page} of ${pages} ‚Äî showing ${this.currentPageRows.length.toLocaleString()} of ${this.totalRows.toLocaleString()} rows`;
      $("vp-prev").disabled=(this.page<=1); $("vp-next").disabled=(this.page>=pages); $("btn-export-page").disabled=this.currentPageRows.length===0; },
    async exportCurrentPage(){ const rows=this.currentPageRows; if(!rows.length) return;
      const csv=[["Vendor","Part Number","Quantity","Created At"].join(","), ...rows.map(r=>[`"${(this.selected||"").replace(/"/g,'""')}"`,`"${(r.part_number||"").replace(/"/g,'""')}"`,String(Number(r.quantity||0)),`"${r.created_at}"`].join(","))].join("\n");
      const url=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); const a=document.createElement("a"); a.href=url; a.download=`vendor_${this.selected}_page_${this.page}.csv`; a.click(); URL.revokeObjectURL(url); },
    async exportAll(){ const header=["Vendor","Part Number","Quantity","Created At"].join(","),PAGE=this.pageSize;
      let csv=[header]; const pages=Math.max(1,Math.ceil((this.totalRows||0)/PAGE));
      for(let p=1;p<=pages;p++){ const from=(p-1)*PAGE,to=from+PAGE-1;
        const {data,error}=await supabase.from("excess_parts").select("part_number,quantity,created_at").eq("vendor",this.selected).order("part_number",{ascending:true}).range(from,to);
        if(error){ alert(`Export failed on page ${p}: ${error.message}`); return; }
        (data||[]).forEach(r=>{ csv.push([`"${(this.selected||"").replace(/"/g,'""')}"`,`"${(r.part_number||"").replace(/"/g,'""')}"`,String(Number(r.quantity||0)),`"${r.created_at}"`].join(",")); });
        $("vendor-page-hint").textContent=`Exporting‚Ä¶ ${p}/${pages}`;
      }
      const url=URL.createObjectURL(new Blob([csv.join("\n")],{type:"text/csv"})); const a=document.createElement("a"); a.href=url; a.download=`vendor_${this.selected}_ALL.csv`; a.click(); URL.revokeObjectURL(url); }
  };
  $("vendor-search").addEventListener("input",e=>VendorView.renderVendorList(e.target.value.trim()));
  $("vp-prev").onclick=async ()=>{ if (VendorView.page>1){ VendorView.page--; await VendorView.loadPage(); } };
  $("vp-next").onclick=async ()=>{ VendorView.page++; await VendorView.loadPage(); };
  $("btn-export-page").onclick=()=>VendorView.exportCurrentPage();
  $("btn-export-all").onclick=()=>VendorView.exportAll();

  // log tab with delete
  async function loadExcessLog(limit=20){
    const box=$("log-list");
    box.innerHTML=`<div class="row">Loading‚Ä¶</div>`;
    try{
      const { data, error } = await supabase
        .from("excess_log")
        .select("created_at, created_on_utc, vendor, uploaded_by, rows_count, total_qty, batch_id, file_name, status, error")
        .order("created_at",{ascending:false})
        .limit(limit);
      if (error) throw error;
      if (!data?.length){ box.innerHTML=`<div class="row">No entries yet.</div>`; return; }
      box.innerHTML="";
      data.forEach(r=>{
        const d = new Date(r.created_at).toLocaleString();
        const err = r.error ? `<div class="err mono" style="margin-top:6px">${r.error}</div>` : "";
        const el=document.createElement("div"); el.className="row";
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div><strong>${r.vendor}</strong> ‚Ä¢ ${r.status}</div>
              <div class="hint">By: ${r.uploaded_by || "‚Äî"} ‚Ä¢ Batch: <span class="mono">${r.batch_id || "‚Äî"}</span></div>
              <div class="hint">Rows: <b>${(r.rows_count||0).toLocaleString()}</b> ‚Ä¢ Qty: <b>${Number(r.total_qty||0).toLocaleString()}</b></div>
              ${r.file_name ? `<div class="hint mono">${r.file_name}</div>` : ``}
              ${err}
            </div>
            <div>
              <div class="hint" style="text-align:right">${d} (UTC: ${r.created_on_utc})</div>
            </div>
          </div>
        `;
        box.appendChild(el);
      });
    }catch(e){
      console.error(e); box.innerHTML=`<div class="row err">Failed to load log: ${e.message}</div>`;
    }
  }
  $("log-refresh").addEventListener("click",()=>loadExcessLog());

  // leaderboard
  async function loadLeaderboard(){
    const tb=$("leader-tbody"); tb.innerHTML="";
    try{
      const { data } = await supabase
        .from("excess_uploads")
        .select("uploaded_by, batch_id")
        .order("uploaded_by", { ascending: true })
        .limit(20000);
      const map=new Map();
      (data||[]).forEach(r=>{
        const who=(r.uploaded_by||"‚Äî").trim()||"‚Äî";
        const set = map.get(who) || new Set();
        set.add(r.batch_id);
        map.set(who,set);
      });
      const rows=[...map.entries()].map(([who,set])=>({who,lists:set.size})).sort((a,b)=>b.lists-a.lists);
      rows.forEach((r,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${r.who}</td><td>${r.lists.toLocaleString()}</td>`;
        tb.appendChild(tr);
      });
      if (!rows.length) tb.innerHTML=`<tr><td colspan="3">No data yet.</td></tr>`;
    }catch(e){
      tb.innerHTML=`<tr><td colspan="3" class="err">${e.message}</td></tr>`;
    }
  }

  // init
  loadStats(); refreshUploadsUI(); VendorView.renderVendorList(""); loadLeaderboard();
</script>
</body>
</html>




