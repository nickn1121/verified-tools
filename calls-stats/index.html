<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Call Leaderboard — Verified Electronics</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0f13;
    --card:#141622;
    --muted:#959bb5;
    --text:#e6e9f8;
    --purple:#6d5efc;
    --purple-2:#9a8bff;
    --green:#27c093;
    --red:#ff6b6b;
    --ring:#2a2f45;
    --ring-fill:#7b6dff;
    --chip:#1d2031;
    --row:#161a28;
    --row-alt:#131724;
    --accent:#2c3052;
    --shadow: 0 8px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 800px at 80% -150px, #2b2f51 0%, #161829 45%, var(--bg) 80%),
              linear-gradient(180deg,#101221,#0e0f13);
    color:var(--text); font: 14px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  .wrap{max-width:1100px; margin:auto; padding:28px 16px 80px}
  .title{font-size:28px; font-weight:800; letter-spacing:.3px}
  .sub{color:var(--muted); margin-top:6px}
  .panel{margin-top:18px; background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px}

  .toolbar{display:grid; gap:12px; grid-template-columns: 140px 180px 1fr auto}
  .toolbar .row{display:flex; gap:10px; align-items:center}
  select, input[type="date"], input[type="text"]{
    background:#0e1120; border:1px solid #242846; color:var(--text);
    border-radius:10px; padding:10px 12px; outline:none; width:100%;
  }
  .chip{background:var(--chip); color:#cbd1f6; border-radius:999px; padding:.35rem .7rem; font-weight:600; font-size:12px}
  .btn{
    background:linear-gradient(180deg,var(--purple) 0%, var(--purple-2) 100%);
    color:white; font-weight:700; border:0; border-radius:12px; padding:10px 18px; cursor:pointer;
    box-shadow:0 8px 20px rgba(109,94,252,.35);
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .cards{display:grid; gap:12px; grid-template-columns: repeat(6, minmax(0,1fr)); margin-top:14px}
  .card{background:#101327; border:1px solid #212646; border-radius:14px; padding:12px 12px 14px; text-align:left}
  .card h4{color:var(--muted); margin:0 0 6px 0; font-weight:600}
  .card .val{font-size:24px; font-weight:800}

  .table{margin-top:16px; overflow:auto; border-radius:12px; border:1px solid #212646}
  table{width:100%; border-collapse:collapse; background:#0f1324}
  thead th{
    position:sticky; top:0; background:#0f1324; z-index:1; font-weight:700;
    color:#bfc5ef; font-size:12px; letter-spacing:.3px; text-transform:uppercase;
    padding:12px; border-bottom:1px solid #23284b; text-align:left;
    white-space:nowrap;
  }
  tbody td{padding:12px; border-bottom:1px solid #171b2d}
  tbody tr:nth-child(even) td{background:#0e1220}
  .num{text-align:right}
  .mono{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .tag{display:inline-block; padding:.2rem .5rem; border-radius:8px; background:#1a1d31; color:#cbd1f6; font-weight:700; font-size:12px}

  /* overlay */
  .overlay{
    position:fixed; inset:0; background:rgba(10,12,22,.65); backdrop-filter:blur(4px);
    display:none; align-items:center; justify-content:center; z-index:10;
  }
  .overlay.show{display:flex}
  .modal{
    background:#0e1120; border:1px solid #262a4d; box-shadow:0 18px 55px rgba(0,0,0,.6);
    border-radius:18px; padding:26px 28px; width:380px; text-align:center;
  }
  .ring{
    width:72px; height:72px; border-radius:50%;
    background:
      conic-gradient(var(--ring-fill) calc(var(--pct)*1%), #2a2f45 0),
      radial-gradient(farthest-side, #0e1120 65%, transparent 66% 100%),
      linear-gradient(var(--ring),var(--ring));
    margin:0 auto 16px;
  }
  .big{font-weight:800; font-size:18px}
  .small{color:#aab1d8; margin-top:6px}
  .right{ text-align:right }
  .rowline{display:flex; gap:10px; align-items:center}
  .right .chip{margin-left:auto}

  .note{margin-top:10px; color:#aab1d8; font-size:13px}
  .hint{color:#aab1d8; font-size:12px}
  .error{color:#ff9b9b}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Call Leaderboard</div>
    <div class="sub">Per-user call time (mm:ss), dials & outcomes — powered by Dialpad Stats + cached per day for speed.</div>

    <div class="panel">
      <div class="toolbar">
        <div class="row">
          <select id="range">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="thisweek" selected>This week</option>
            <option value="last7">Last 7 days</option>
            <option value="thismonth">This month</option>
            <option value="custom">Custom…</option>
          </select>
          <span class="hint">Range</span>
        </div>

        <div class="row" id="customDates" style="display:none">
          <input type="date" id="fromDate">
          <input type="date" id="toDate">
        </div>

        <div class="row">
          <select id="sortBy">
            <option value="duration">Total Duration</option>
            <option value="avg">Avg Duration</option>
            <option value="dials">Dials</option>
            <option value="answered">Answered</option>
            <option value="missed">Missed</option>
            <option value="inbound">Inbound</option>
            <option value="outbound">Outbound</option>
          </select>
          <select id="sortDir">
            <option value="desc" selected>Desc</option>
            <option value="asc">Asc</option>
          </select>
        </div>

        <div class="row">
          <input type="text" id="filter" placeholder="Filter by user (email or name)" />
        </div>

        <div class="row right">
          <label class="rowline"><input type="checkbox" id="force"> <span class="hint">Force refresh</span></label>
          <button class="btn" id="load">Load</button>
        </div>
      </div>

      <div class="cards">
        <div class="card"><h4>Total calls</h4><div class="val mono" id="k-dials">—</div></div>
        <div class="card"><h4>Inbound</h4><div class="val mono" id="k-in">—</div></div>
        <div class="card"><h4>Outbound</h4><div class="val mono" id="k-out">—</div></div>
        <div class="card"><h4>Answered</h4><div class="val mono" id="k-ans">—</div></div>
        <div class="card"><h4>Missed</h4><div class="val mono" id="k-miss">—</div></div>
        <div class="card"><h4>Avg duration</h4><div class="val mono" id="k-avg">—</div></div>
      </div>

      <div class="table">
        <table id="tbl">
          <thead>
            <tr>
              <th>User</th>
              <th class="num">Dials</th>
              <th class="num">Inbound</th>
              <th class="num">Outbound</th>
              <th class="num">Answered</th>
              <th class="num">Missed</th>
              <th class="num">Total (mm:ss)</th>
              <th class="num">Avg (mm:ss)</th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="8" class="muted" style="padding:22px">Click <b>Load</b> to fetch data.</td></tr></tbody>
        </table>
      </div>

      <div class="note" id="status">Ready.</div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <div class="ring" id="ring" style="--pct:0"></div>
      <div class="big" id="progressLabel">Preparing…</div>
      <div class="small" id="progressSub">Dialpad stats will be cached as we go.</div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const WORKER_BASE = "https://ve-dialpad-proxy.nick-north.workers.dev"; // your Worker origin
/* ==================== */

const el = (id)=>document.getElementById(id);
const fmtInt = (n)=>Number(n).toLocaleString();
function fmtSecToClock(total){
  total = Math.round(total||0);
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  if (h>0) return `${h}h ${String(m).padStart(2,"0")}m`;
  return `${String(m).padStart(1,"0")}m ${String(s).padStart(2,"0")}s`;
}
function fmtSecShort(total){
  total = Math.round(total||0);
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  return (h>0) ? `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`
               : `${m}:${String(s).padStart(2,"0")}`;
}

function startOfWeek(d){ // Mon-Sun
  const x = new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x;
}
function endOfWeek(d){
  const s = startOfWeek(d); const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e;
}
function dayISO(d){ return new Date(d).toISOString().slice(0,10); }
function daysBetween(from,to){
  const out=[]; const cur=new Date(from); cur.setHours(0,0,0,0);
  const end=new Date(to); end.setHours(0,0,0,0);
  while(cur<=end){ out.push(dayISO(cur)); cur.setDate(cur.getDate()+1); }
  return out;
}
function mergeAggs(dayAggs){
  const totals = { dials:0,inbound:0,outbound:0,answered:0,missed:0,sumDur:0 };
  const map = new Map();
  for (const a of dayAggs){
    const t=a.totals||{};
    totals.dials += t.dials||0;
    totals.inbound += t.inbound||0;
    totals.outbound += t.outbound||0;
    totals.answered += t.answered||0;
    totals.missed += t.missed||0;
    totals.sumDur += t.sumDur||0;

    for (const r of a.rows||[]){
      if (!map.has(r.user)) map.set(r.user, { user:r.user, dials:0,inbound:0,outbound:0,answered:0,missed:0,duration:0,avg:0 });
      const s = map.get(r.user);
      s.dials += r.dials||0;
      s.inbound += r.inbound||0;
      s.outbound += r.outbound||0;
      s.answered += r.answered||0;
      s.missed += r.missed||0;
      s.duration += r.duration||0;
    }
  }
  const rows = [...map.values()].map(s => ({ ...s, avg: s.answered ? (s.duration / s.answered) : 0 }));
  return { totals, rows };
}

function setCards(totals){
  el("k-dials").textContent = fmtInt(totals.dials);
  el("k-in").textContent = fmtInt(totals.inbound);
  el("k-out").textContent = fmtInt(totals.outbound);
  el("k-ans").textContent = fmtInt(totals.answered);
  el("k-miss").textContent = fmtInt(totals.missed);
  const avg = totals.answered ? (totals.sumDur / totals.answered) : 0;
  el("k-avg").textContent = fmtSecShort(avg);
}

function renderTable(rows){
  const f = el("filter").value.trim().toLowerCase();
  const by = el("sortBy").value;
  const dir = el("sortDir").value;

  let data = rows.slice();
  if (f) data = data.filter(x => (x.user||"").toLowerCase().includes(f));

  const keyMap = {
    duration: r => r.duration,
    avg: r => r.avg,
    dials: r => r.dials,
    answered: r => r.answered,
    missed: r => r.missed,
    inbound: r => r.inbound,
    outbound: r => r.outbound,
  };
  const key = keyMap[by] || keyMap.duration;
  data.sort((a,b) => {
    const A=key(a)||0, B=key(b)||0;
    return (dir==="asc") ? (A-B) : (B-A);
  });

  const tb = el("tbody");
  tb.innerHTML = "";
  for (const r of data){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><div>${r.user||"—"}</div></td>
      <td class="num mono">${fmtInt(r.dials||0)}</td>
      <td class="num mono">${fmtInt(r.inbound||0)}</td>
      <td class="num mono">${fmtInt(r.outbound||0)}</td>
      <td class="num mono">${fmtInt(r.answered||0)}</td>
      <td class="num mono">${fmtInt(r.missed||0)}</td>
      <td class="num mono">${fmtSecShort(r.duration||0)}</td>
      <td class="num mono">${fmtSecShort(r.avg||0)}</td>
    `;
    tb.appendChild(tr);
  }
  if (!data.length){
    tb.innerHTML = `<tr><td colspan="8" class="muted" style="padding:22px">No rows for this filter.</td></tr>`;
  }
}

function showOverlay(pct, label, sub){
  el("overlay").classList.add("show");
  el("ring").style.setProperty("--pct", pct);
  el("progressLabel").textContent = label || "";
  el("progressSub").textContent = sub || "";
}
function hideOverlay(){ el("overlay").classList.remove("show"); }

async function fetchDay(dayISO, force){
  const u = new URL(WORKER_BASE + "/stats-leaderboard");
  u.searchParams.set("from", dayISO);
  u.searchParams.set("to", dayISO);
  if (force) u.searchParams.set("force","true");
  const r = await fetch(u.toString(), { mode:"cors" });
  if (!r.ok){
    const txt = await r.text().catch(()=>r.statusText);
    throw new Error(`HTTP ${r.status}: ${txt}`);
  }
  return r.json();
}

async function loadRange(){
  try{
    el("status").textContent = "Fetching…";
    const force = el("force").checked;

    // Determine range -> list of days
    const now = new Date();
    let from, to;
    switch(el("range").value){
      case "today": from = to = new Date(now); break;
      case "yesterday": { const y=new Date(now); y.setDate(y.getDate()-1); from=to=y; break; }
      case "thisweek": from = startOfWeek(now); to = endOfWeek(now); break;
      case "last7": { to=new Date(now); from=new Date(now); from.setDate(from.getDate()-6); break; }
      case "thismonth": { from=new Date(now.getFullYear(), now.getMonth(), 1);
                           to=new Date(now.getFullYear(), now.getMonth()+1, 0); break; }
      case "custom": {
        const f = el("fromDate").value, t = el("toDate").value;
        if(!f || !t) throw new Error("Choose custom From/To dates");
        from = new Date(f); to = new Date(t); break;
      }
    }
    const days = daysBetween(from,to);
    if (!days.length) throw new Error("No days in range");

    // Progress UI
    let done = 0;
    showOverlay(0, "Preparing…", "Dialpad stats will load per-day");
    const all = [];
    for (const d of days){
      showOverlay(Math.round((done/days.length)*100), `Loading ${d}`, `day ${done+1} of ${days.length}`);
      const j = await fetchDay(d, force);
      all.push(j);
      done++;
    }
    showOverlay(100, "Finalizing…", "Merging results");

    // Merge + render
    const merged = mergeAggs(all);
    setCards(merged.totals);
    renderTable(merged.rows);
    hideOverlay();
    el("status").textContent = `Loaded ${days.length} day(s). Cached on the worker for speed.`;
  } catch(err){
    hideOverlay();
    el("status").innerHTML = `<span class="error">Error: ${err.message || err}</span>`;
    console.error(err);
  }
}

// UI wiring
el("range").addEventListener("change", ()=>{
  const isCustom = el("range").value === "custom";
  el("customDates").style.display = isCustom ? "" : "none";
});
el("load").addEventListener("click", loadRange);
el("filter").addEventListener("input", ()=> {
  // re-sort/filter current rows without refetch: read from table? (skip)
  // We simply trigger a re-render using last data we stored on window.
  // To keep this sample small, rely on clicking Load again if needed.
});

</script>
</body>
</html>








