<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Order Tracker — Verified Electronics</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
  :root{
    --brand:#6f57e9; --ink:#1e2330; --muted:#6d7486;
    --bg:#f6f7fb; --card:#fff; --line:#e9e9ef;
    --green:#12a274; --purple:#3b2eca; --red:#c0392b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  .wrap{max-width:1180px;margin:22px auto;padding:0 16px}
  header{
    display:flex;align-items:center;gap:16px;padding:16px 18px;border:1px solid var(--line);
    border-radius:16px;background:radial-gradient(1100px 220px at 160px -60px, rgba(111,87,233,.15), transparent 60%), #fff;
    box-shadow:0 8px 26px rgba(111,87,233,.08), 0 1px 0 rgba(0,0,0,.04);
  }
  header img{height:42px}
  h1{font-size:26px;margin:0;font-weight:800}
  .sub{color:var(--muted);margin-top:2px}

  .toolbar{display:grid;grid-template-columns:1fr 180px 160px 160px auto auto;gap:10px;margin:16px 0}
  .input,.select,.btn{height:38px;border:1px solid var(--line);border-radius:10px;background:#fff;padding:0 12px;font:inherit}
  .input{width:100%}
  .select{appearance:none;padding-right:28px;background-image:linear-gradient(45deg, transparent 50%, #869 50%), linear-gradient(135deg, #869 50%, transparent 50%);background-position:calc(100% - 16px) calc(50% - 2px), calc(100% - 10px) calc(50% - 2px);background-size:6px 6px, 6px 6px;background-repeat:no-repeat}
  .btn{background:#f7f5ff;color:var(--purple);border-color:#ece8ff;font-weight:700;cursor:pointer}
  .btn:hover{background:#eee8ff}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{filter:brightness(.97)}
  .btn.ghost{background:#fff}

  .table-card{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:1260px}
  thead th{position:sticky;top:0;background:#fafaff;border-bottom:1px solid var(--line);text-align:left;font-size:13px;color:#4a4f64;padding:12px}
  tbody td{border-bottom:1px solid var(--line);padding:12px;vertical-align:top}
  tbody tr:hover{background:#fcfbff}
  .mono{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6f2ec;padding:3px 8px;border-radius:999px;background:#f0fbf7;color:var(--green);font-weight:700}
  .chip{display:inline-block;border-radius:999px;padding:2px 8px;border:1px solid #eee;background:#fafafa;font-size:12px;color:#5d6480}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .link{color:#362dc7;text-decoration:none}
  .link:hover{text-decoration:underline}

  /* inline edit */
  .editwrap{display:inline-flex;align-items:center;gap:6px}
  .iconbtn{border:0;background:transparent;color:#6d6fe5;cursor:pointer;padding:2px 4px;border-radius:6px}
  .iconbtn:hover{background:#f0efff}
  .inline-select{display:none;margin-left:6px}
  .inline-select .select{height:30px;padding:0 10px}
  .inline-visible{display:inline-flex}

  dialog{border:0;padding:0;margin:0 auto;max-width:1200px;width:96vw}
  dialog::backdrop{background:rgba(17,17,33,.35)}
  .modal{display:flex;flex-direction:column;max-height:90vh;border-radius:18px;overflow:hidden;background:#fff}
  .modal header{position:sticky;top:0;z-index:2;border-bottom:1px solid var(--line);border-radius:18px 18px 0 0;background:#fff}
  .modal .head{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .content{padding:16px;overflow:auto;overflow-x:auto;max-height:calc(90vh - 58px);overscroll-behavior:contain}

  .grid2,.grid3{gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr}
  .section{margin:16px 0 8px;font-weight:800;color:#262b3a}
  .row{display:flex;gap:8px;align-items:center}
  .tbl{width:100%;border-collapse:collapse;table-layout:fixed}
  .tbl th,.tbl td{border:1px solid #ececf3;padding:8px;text-align:left;white-space:nowrap}
  .tbl th{background:#fafaff}
  .mini{height:34px}
  .right{display:flex;justify-content:flex-end;gap:8px;margin:12px 0 4px}
  .note{font-size:12px;color:var(--muted)}
  input,select,textarea{min-width:0}

  .hscroll{overflow:auto;border:1px solid #ececf3;border-radius:12px;background:#fff}
  .hscroll table{min-width:1100px}
  .content{padding-bottom:80px}

  /* View dialog (summary) */
  .summary{padding:16px}
  .sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .sum-card{border:1px solid var(--line);border-radius:12px;background:#fff}
  .sum-card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafaff;font-size:15px}
  .sum-card .pad{padding:12px}

  @media (max-width:960px){
    .toolbar{grid-template-columns:1fr 1fr 1fr auto auto;gap:8px}
    .grid2,.grid3,.sum-grid{grid-template-columns:1fr}
    table{min-width:1000px}
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  /* Supabase client */
  const SUPABASE_URL = 'https://ijzroisggstqkfhpjndq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* SAFETY SHIM: add apikey headers to any legacy fetch hitting your Supabase REST */
  (function injectApiKeyForLegacyRestCalls(){
    const realFetch = window.fetch.bind(window);
    window.fetch = (input, init = {}) => {
      const url = typeof input === 'string' ? input : input?.url || '';
      if (url.startsWith(SUPABASE_URL)) {
        const h = new Headers(init.headers || {});
        if (!h.has('apikey')) h.set('apikey', SUPABASE_ANON_KEY);
        if (!h.has('Authorization')) h.set('Authorization', `Bearer ${SUPABASE_ANON_KEY}`);
        init = { ...init, headers: h };
      }
      return realFetch(input, init);
    };
  })();
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified">
      <div>
        <h1>Order Tracker</h1>
        <div class="sub">Multi-part orders with date codes, priority, requested-by date, tests, multi-leg shipping costs, partial shipments, files & GP.</div>
      </div>
    </header>

    <div class="toolbar">
      <input id="q" class="input" placeholder="Search: customer, part number, order id..."/>
      <select id="fltSales" class="select"><option value="">All salespeople</option></select>
      <select id="fltStatus" class="select"><option value="">All status</option><option>New</option><option>Open</option><option>Closed</option></select>
      <select id="fltPriority" class="select"><option value="">All priorities</option><option>High</option><option>Normal</option><option>Low</option></select>
      <button id="btnNew" class="btn" type="button" onclick="openModal(null)">+ New Order</button>
      <button id="btnCsv" class="btn ghost" type="button">Export CSV</button>
    </div>

    <div class="table-card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Part(s)</th>
              <th>Sales</th>
              <th>Total Qty</th>
              <th>Avg Unit $</th>
              <th>Sell</th>
              <th>GP</th>
              <th>Status</th>
              <th>Order Date</th>
              <th>Requested by</th>
              <th>Age</th>
              <th>Tests</th>
              <th>Vendor</th>
              <th>Incoterm</th>
              <th>Terms</th>
              <th>Files</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit / New Modal (unchanged core, still full-power form) -->
  <dialog id="dlg"> … <!-- (THE WHOLE SAME EDIT MODAL FROM YOUR MESSAGE GOES HERE UNCHANGED) --> </dialog>

  <!-- View SUMMARY Modal -->
  <dialog id="viewDlg">
    <div class="modal">
      <header><div class="head"><strong>Order Summary</strong><button class="btn ghost mini" type="button" onclick="$('viewDlg').close()">✕</button></div></header>
      <div class="summary" id="viewBody"></div>
    </div>
  </dialog>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
const SALESTEAM = ['Nick N','Dan C','Emir B','Nick K','Jake B'];
const todayStr = () => new Date().toISOString().slice(0,10);
const curSym = c => ({USD:'$',GBP:'£',EUR:'€'})[c||'USD'] || '$';
const fmt = n => (n==null||isNaN(n))?'-':Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtInt = n => (n==null||isNaN(n))?'-':Number(n).toLocaleString();

/* ---------- data layer ---------- */
const supa = {
  state:{orders:[]},
  getOrders(){return this.state.orders;},

  async loadOrders(){
    const {data:orders, error:e0} = await supabase
      .from('orders')
      .select('*')
      .order('order_date',{ascending:false,nullsFirst:true})
      .order('created_at',{ascending:false});
    if(e0){ console.error('orders load error', e0); this.state.orders=[]; return; }

    this.state.orders = await Promise.all((orders||[]).map(async r=>{
      const [itemsRes, legsRes, inbRes, outRes, filesRes] = await Promise.all([
        supabase.from('order_items').select('*').eq('order_id', r.id),
        supabase.from('ship_legs').select('*').eq('order_id', r.id),
        supabase.from('shipments_inbound').select('*').eq('order_id', r.id),
        supabase.from('shipments_outbound').select('*').eq('order_id', r.id),
        supabase.from('order_files').select('*').eq('order_id', r.id)
      ]);

      const items = (itemsRes.data||[]).map(i=>({
        part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,unit_sell:i.unit_sell,unit_cost:i.unit_cost
      }));
      const legs = (legsRes.data||[]).map(l=>({kind:'Leg',date:'',qty:'',from:l.from_loc,to:l.to_loc,method:l.method,ref:l.ref,cost:l.cost}));
      const inbound = (inbRes.data||[]).map(s=>({kind:'Inbound',date:s.ship_date,qty:s.qty,from:'',to:'',method:'',ref:'',courier:s.courier,tracking:s.tracking,cost:''}));
      const outbound = (outRes.data||[]).map(s=>({kind:'Outbound',date:s.ship_date,qty:s.qty,from:'',to:'',method:'',ref:'',courier:s.courier,tracking:s.tracking,cost:''}));
      const shipments=[...legs,...inbound,...outbound];

      const files = (filesRes.data||[]).reduce((a,f)=>{a[f.kind]=f.path;return a;}, {});
      let poUrl=null,testUrl=null;
      if(files.po){const {data:s}=await supabase.storage.from('order-files').createSignedUrl(files.po,3600);poUrl=s?.signedUrl||null;}
      if(files.test_report){const {data:s}=await supabase.storage.from('order-files').createSignedUrl(files.test_report,3600);testUrl=s?.signedUrl||null;}
      window._sessionFiles ||= {}; window._sessionFiles[r.id]={poUrl,testUrl};

      return { ...r, items, shipments, files };
    }));
  },

  async saveOrder(rec, uploads){ /* unchanged body from your working file */ },

  async uploadFile(orderId, kind, file){ /* unchanged body from your working file */ },

  async deleteOrder(id){ await supabase.from('orders').delete().eq('id',id); },

  async quickUpdate(id, field, value){
    const { error } = await supabase.from('orders').update({ [field]: value }).eq('id', id);
    if(error) throw error;
  },

  subscribeRealtime(){
    supabase.channel('orders-rt')
      .on('postgres_changes',{event:'*',schema:'public',table:'orders'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'order_items'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'ship_legs'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'shipments_inbound'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'shipments_outbound'},async()=>{await this.loadOrders();render();})
      .subscribe();
  }
};

/* ---------- UI helpers ---------- */
function button(txt,cls,click){const b=document.createElement('button');b.textContent=txt;b.className='btn mini '+(cls||'');b.type='button';b.onclick=click;return b;}

function ageDays(d){
  if(!d) return '-';
  const ms = Date.now() - new Date(d).getTime();
  const days = Math.floor(ms/86400000);
  return days<0?'-':`${days} ${days===1?'day':'days'}`;
}
function totals(o){
  const revenue=(o.items||[]).reduce((s,i)=>s+(Number(i.qty||0)*Number(i.unit_sell||0)),0);
  const qty=(o.items||[]).reduce((s,i)=>s+Number(i.qty||0),0);
  const itemCost=(o.items||[]).reduce((s,i)=>s+(Number(i.qty||0)*Number(i.unit_cost||0)),0);
  const legCost=(o.shipments||[]).filter(s=>s.kind==='Leg').reduce((s,l)=>s+Number(l.cost||0),0);
  const shipCost = legCost + Number(o.shipping_cost_extra||0);
  const testCost = Number(o.test_cost||0);
  const cost = itemCost + shipCost + testCost;
  const gp = revenue - cost;
  const gpPct = revenue ? (gp/revenue)*100 : 0;
  return {revenue,qty,cost,gp,gpPct};
}

/* ---------- inline edit widgets ---------- */
function inlineTerms(cell, order){
  const wrap = document.createElement('span');
  wrap.className='editwrap';
  const label=document.createElement('span'); label.textContent=order.payment_terms||'-';
  const icon=document.createElement('button'); icon.className='iconbtn'; icon.title='Quick edit terms'; icon.textContent='✎';

  const dropdown=document.createElement('span'); dropdown.className='inline-select';
  dropdown.innerHTML = `
    <select class="select" id="selTerms_${order.id}">
      ${[5,10,15,20,30,40,50,60,90].map(n=>`<option ${order.payment_terms===`Net ${n}`?'selected':''}>Net ${n}</option>`).join('')}
      <option value="Other">Other…</option>
    </select>`;
  const select = dropdown.querySelector('select');

  const show=()=>{ dropdown.classList.add('inline-visible'); select.focus(); };
  const hide=()=>{ dropdown.classList.remove('inline-visible'); };

  icon.onclick=show;
  select.onchange=async()=>{
    let val=select.value;
    if(val==='Other'){
      const entry = prompt('Enter payment terms (free text):', order.payment_terms||'');
      if(entry===null){ hide(); return; }
      val = entry.trim()||null;
    }
    try{
      await supa.quickUpdate(order.id, 'payment_terms', val);
      label.textContent = val||'-';
    }catch(e){ console.error(e); alert('Failed to update terms'); }
    hide();
  };
  select.onblur=()=>setTimeout(hide,150);

  wrap.append(label, icon, dropdown);
  cell.appendChild(wrap);
}

function inlineStatus(cell, order){
  const wrap=document.createElement('span'); wrap.className='editwrap';
  const chip=document.createElement('span'); chip.className='chip'; chip.textContent=order.status||'-';
  const icon=document.createElement('button'); icon.className='iconbtn'; icon.title='Quick edit status'; icon.textContent='✎';

  const dropdown=document.createElement('span'); dropdown.className='inline-select';
  dropdown.innerHTML=`<select class="select" id="selStat_${order.id}">
      ${['New','Open','Closed'].map(s=>`<option ${s===(order.status||'')?'selected':''}>${s}</option>`).join('')}
    </select>`;
  const select=dropdown.querySelector('select');

  const show=()=>{ dropdown.classList.add('inline-visible'); select.focus(); };
  const hide=()=>{ dropdown.classList.remove('inline-visible'); };

  icon.onclick=show;
  select.onchange=async()=>{
    try{
      await supa.quickUpdate(order.id,'status',select.value);
      chip.textContent=select.value;
    }catch(e){ console.error(e); alert('Failed to update status'); }
    hide();
  };
  select.onblur=()=>setTimeout(hide,150);

  wrap.append(chip, icon, dropdown);
  cell.appendChild(wrap);
}

/* ---------- View summary ---------- */
function openSummary(o){
  const {revenue,qty,cost,gp,gpPct} = totals(o);
  const sym = curSym(o.currency);
  const poUrl = window._sessionFiles?.[o.id]?.poUrl || null;
  const testUrl = window._sessionFiles?.[o.id]?.testUrl || null;

  $('viewBody').innerHTML = `
    <div class="sum-grid">
      <div class="sum-card">
        <h3>Header</h3>
        <div class="pad">
          <div><strong>Customer:</strong> ${o.customer||'-'}</div>
          <div><strong>Salesperson:</strong> ${o.salesperson||'-'}</div>
          <div><strong>Status:</strong> ${o.status||'-'} · <strong>Priority:</strong> ${o.priority||'-'}</div>
          <div><strong>Order date:</strong> ${o.order_date||'-'} · <strong>Requested by:</strong> ${o.requested_by||'-'}</div>
          <div><strong>Terms:</strong> ${o.payment_terms||'-'} · <strong>Method:</strong> ${o.payment_method||'-'}</div>
          <div><strong>Invoice:</strong> ${o.invoice_date||'-'} · <strong>Due:</strong> ${o.due_date||'-'}</div>
          <div><strong>Incoterm:</strong> ${o.incoterm||'-'} · <strong>Vendor:</strong> ${o.vendor||'-'}</div>
          <div><strong>Tests:</strong> ${o.tests||'-'} · <strong>Center:</strong> ${o.test_center||'-'}</div>
          <div><strong>Files:</strong> ${
              [poUrl?`<a class="link" target="_blank" href="${poUrl}">PO</a>`:'', testUrl?`<a class="link" target="_blank" href="${testUrl}">Test</a>`:'']
              .filter(Boolean).join(' · ') || '-'
          }</div>
        </div>
      </div>

      <div class="sum-card">
        <h3>Financials</h3>
        <div class="pad mono">
          <div><strong>Qty:</strong> ${fmtInt(qty)}</div>
          <div><strong>Revenue (sell):</strong> ${sym}${fmt(revenue)}</div>
          <div><strong>Total cost:</strong> ${sym}${fmt(cost)}</div>
          <div><strong>GP:</strong> <span class="pill">${sym}${fmt(gp)}</span> <span class="muted">(${fmt(gpPct)}%)</span></div>
        </div>
      </div>

      <div class="sum-card" style="grid-column:1 / -1">
        <h3>Line Items</h3>
        <div class="pad">
          <table class="tbl" style="table-layout:auto;min-width:800px">
            <thead><tr><th>Part</th><th>Date Codes</th><th class="mono">Qty</th><th class="mono">Unit Sell</th><th class="mono">Unit Cost</th></tr></thead>
            <tbody>
              ${(o.items||[]).map(i=>`
                <tr>
                  <td>${i.part_number||''}</td>
                  <td>${i.date_codes||''}</td>
                  <td class="mono">${fmtInt(i.qty)}</td>
                  <td class="mono">${sym}${fmt(i.unit_sell)}</td>
                  <td class="mono">${sym}${fmt(i.unit_cost)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>

      <div class="sum-card" style="grid-column:1 / -1">
        <h3>Shipments / Legs</h3>
        <div class="pad">
          <table class="tbl" style="table-layout:auto;min-width:900px">
            <thead><tr><th>Kind</th><th>Date</th><th class="mono">Qty</th><th>From</th><th>To</th><th>Method</th><th>Ref</th><th>Courier</th><th>Tracking</th><th class="mono">Cost</th></tr></thead>
            <tbody>
              ${(o.shipments||[]).map(s=>`
                <tr>
                  <td>${s.kind}</td><td>${s.date||''}</td><td class="mono">${fmtInt(s.qty)}</td>
                  <td>${s.from||''}</td><td>${s.to||''}</td><td>${s.method||''}</td><td>${s.ref||''}</td>
                  <td>${s.courier||''}</td><td>${s.tracking||''}</td><td class="mono">${sym}${fmt(s.cost)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="right">
      <button class="btn ghost" onclick="$('viewDlg').close()">Close</button>
      <button class="btn primary" onclick="$('viewDlg').close(); openModal(window._ordersById['${o.id}']);">Edit</button>
    </div>
  `;
  $('viewDlg').showModal();
}

/* ---------- Render list ---------- */
function render(){
  const q=$('q').value.toLowerCase(), sSales=$('fltSales').value, sStat=$('fltStatus').value, sPri=$('fltPriority').value;
  const rows=supa.getOrders().filter(o=>{
    const text=[o.customer,...(o.items||[]).map(i=>i.part_number),o.id].join(' ').toLowerCase();
    if(q && !text.includes(q)) return false;
    if(sSales && o.salesperson!==sSales) return false;
    if(sStat && (o.status||'')!==sStat) return false;
    if(sPri && (o.priority||'')!==sPri) return false;
    return true;
  });

  // quick map for view->edit handoff
  window._ordersById = Object.fromEntries(rows.map(r=>[r.id,r]));

  const tb=$('tbody'); tb.innerHTML='';
  rows.forEach(o=>{
    const {revenue,qty,gp,gpPct} = totals(o);
    const avgUnit = qty ? revenue/qty : 0;
    const parts = (o.items?.length? o.items[0].part_number+(o.items.length>1? ` +${o.items.length-1} more`: '') : '-');
    const poUrl = window._sessionFiles?.[o.id]?.poUrl || null;
    const testUrl = window._sessionFiles?.[o.id]?.testUrl || null;
    const sym = curSym(o.currency);

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${o.customer||'-'}</td>
      <td>${parts}</td>
      <td>${o.salesperson||'-'}</td>
      <td class="mono">${fmtInt(qty)}</td>
      <td class="mono">${sym}${fmt(avgUnit)}</td>
      <td class="mono">${sym}${fmt(revenue)}</td>
      <td><span class="pill">${sym}${fmt(gp)}</span> <span class="muted mono">(${fmt(gpPct)}%)</span></td>
      <td class="cell-status"></td>
      <td class="mono">${o.order_date||'-'}</td>
      <td class="mono">${o.requested_by||'-'}</td>
      <td class="mono">${ageDays(o.order_date)}</td>
      <td>${o.tests||'-'}</td>
      <td>${o.vendor||'-'}</td>
      <td>${o.incoterm||'-'}</td>
      <td class="cell-terms"></td>
      <td>${[poUrl?`<a class="link" target="_blank" href="${poUrl}">PO</a>`:'', testUrl?`<a class="link" target="_blank" href="${testUrl}">Test</a>`:''].filter(Boolean).join(' · ')||''}</td>
      <td class="actions"></td>`;

    inlineStatus(tr.querySelector('.cell-status'), o);
    inlineTerms(tr.querySelector('.cell-terms'), o);

    const act=tr.lastElementChild;
    act.append(
      button('View','ghost',()=>openSummary(o)),
      button('Edit','ghost',()=>openModal(o)),
      button('Delete','ghost',async()=>{ if(!confirm('Delete this order?'))return; await supa.deleteOrder(o.id); await supa.loadOrders(); render(); })
    );
    tb.appendChild(tr);
  });
}

/* ---------- The full Edit modal code (unchanged core) ---------- */
/* KEEP your existing modal block from the working file. For brevity here, 
   paste the entire <dialog id="dlg">…</dialog> section and the related functions:
   - addItemRow / itemsFromDOM
   - addShipRow / shipsFromDOM
   - openModal / collectRecord / autoDue
   - event bindings for Save / Delete / filters / CSV
   The only two new functions we added are inline editors and openSummary().
*/

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  $('salesperson')?.remove; // (modal code will set this in your pasted block)
  $('fltSales').innerHTML = `<option value="">All salespeople</option>` + SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  $('btnNew').addEventListener('click', ()=> openModal(null));
  ['q','fltSales','fltStatus','fltPriority'].forEach(id=>$(id).addEventListener('input',render));
});

async function init(){
  await supa.loadOrders(); supa.subscribeRealtime(); render();
}
init();
</script>
</body>
</html>





