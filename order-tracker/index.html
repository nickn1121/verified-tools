<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Order Tracker — Verified</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>

<!-- Supabase + jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --brand:#6f57e9; --brand-dark:#4f3dd6;
  --ink:#18202f; --muted:#6d7486; --bg:#f7f8fc; --card:#fff; --line:#e8e9f0;
  --green:#0ea568; --red:#e53e3e; --amber:#d97706; --blue:#2563eb;
  --shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
  --shadow-lg:0 10px 25px rgba(0,0,0,.1),0 4px 6px rgba(0,0,0,.05);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font:15px/1.6 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg);-webkit-font-smoothing:antialiased}
.container{max-width:1580px;margin:0 auto;padding:18px}

header{display:flex;gap:16px;align-items:center;background:#fff;border-radius:14px;padding:18px 20px;box-shadow:var(--shadow);margin-bottom:18px}
header img{height:44px;border-radius:8px}
h1{font-size:26px;font-weight:800}
.subtitle{font-size:13px;color:var(--muted)}

.toolbar{display:grid;grid-template-columns:1fr auto auto auto auto;gap:10px;margin-bottom:16px}
.toolbar .card{display:flex;gap:10px;align-items:center;background:#fff;border-radius:12px;padding:12px 12px;box-shadow:var(--shadow)}

.input,select{height:40px;border:2px solid var(--line);border-radius:10px;padding:0 12px;font:inherit;background:#fff}
.input:focus,select:focus,textarea:focus{outline:0;border-color:var(--brand);box-shadow:0 0 0 3px rgba(111,87,233,.12)}
.search{flex:1;min-width:260px}
.btn{height:40px;padding:0 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.primary:hover{background:var(--brand-dark)}
.btn.ghost{background:#f3f4f7;color:var(--ink)}
.btn.ghost:hover{background:#e9eaf0}

.table-card{background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
thead th{background:#fafafc;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.4px}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
tbody tr:hover{background:#fafbff}

.pill{display:inline-flex;align-items:center;gap:6px;background:#ecfdf5;color:#0ea568;font-weight:700;border-radius:999px;font-size:12px;padding:4px 10px}
.badge{display:inline-flex;padding:4px 9px;border-radius:7px;font-size:12px;font-weight:700}
.badge.open{background:#ecfdf5;color:#0ea568}
.badge.closed{background:#eef2f7;color:#6b7280}
.badge.problem{background:#fff7ed;color:#d97706}
.badge.high{background:#fee2e2;color:#e11d48}
.badge.normal{background:#ecfdf5;color:#0ea568}
.badge.low{background:#eff6ff;color:#2563eb}

.mono{font-variant-numeric:tabular-nums;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

dialog{border:0;border-radius:16px;max-width:1200px;width:95vw;box-shadow:var(--shadow-lg)}
dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(4px)}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid var(--line);background:#fafafc}
.modal-body{padding:18px;max-height:70vh;overflow:auto}
.modal-foot{display:flex;justify-content:flex-end;gap:10px;padding:14px 18px;border-top:1px solid var(--line);background:#fafafc}

.section{margin-top:14px}
.section h3{font-size:14px;color:var(--muted);margin:8px 0 10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px}
label small{color:var(--muted);font-weight:600;display:block;margin-bottom:4px}

.items table{width:100%;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.items th{background:#fafafc}
.items input{height:34px}

.notes{display:flex;gap:8px;margin-top:8px}
.note-row{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
.note-row small{color:var(--muted)}

.doc-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.docbtn{height:32px;padding:0 12px;border-radius:8px;border:1px solid var(--line);background:#f7f7fb;cursor:pointer}
.docbtn:hover{background:#ececff}
.toast{position:fixed;bottom:18px;right:18px;background:#18202f;color:#fff;padding:12px 14px;border-radius:10px;box-shadow:var(--shadow-lg);opacity:0;transform:translateY(12px);transition:.25s}
.toast.show{opacity:1;transform:translateY(0)}
</style>
</head>

<body>
<div class="container">

  <header>
    <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified">
    <div>
      <h1>Order Tracker</h1>
      <div class="subtitle">Click a doc button → fill any missing bits → PDF downloads & saves to Supabase.</div>
    </div>
  </header>

  <div class="toolbar">
    <div class="card" style="grid-column:1/3;gap:10px;flex:1">
      <input class="input search" id="q" placeholder="Search customer, part number, order id...">
      <select id="fsales" class="input"><option value="">All salespeople</option></select>
      <select id="fstatus" class="input">
        <option value="">All status</option><option>Open</option><option>Closed</option><option>Problem</option>
      </select>
      <select id="fprio" class="input">
        <option value="">All priorities</option><option>High</option><option>Normal</option><option>Low</option>
      </select>
    </div>
    <div class="card" style="justify-content:flex-end">
      <button class="btn primary" id="btn-new">+ New Order</button>
      <button class="btn ghost" id="btn-csv">Export CSV</button>
    </div>
  </div>

  <div class="table-card">
    <table>
      <thead>
        <tr>
          <th>View</th><th>Customer</th><th>Part(s)</th><th>Sales</th><th>Qty</th><th>Avg Unit $</th><th>Sell</th><th>GP</th>
          <th>Priority</th><th>Status</th><th>Order Date</th><th>Age</th><th>Tests</th><th>Vendor</th>
          <th>Incoterm</th><th>Terms</th><th>Shipped</th><th>Invoiced</th><th>Docs</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="20" style="text-align:center;padding:28px">Loading…</td></tr></tbody>
    </table>
  </div>

</div>

<!-- EDIT / CREATE ORDER -->
<dialog id="edit">
  <div class="modal-head">
    <strong id="ed-title">New Order</strong>
    <button class="btn ghost" onclick="document.getElementById('edit').close()">✕</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="ed-id">

    <div class="grid">
      <label><small>Customer</small><input class="input" id="ed-customer"></label>
      <label><small>Salesperson</small><select class="input" id="ed-sales"></select></label>
      <label><small>Priority</small>
        <select class="input" id="ed-pri"><option>High</option><option selected>Normal</option><option>Low</option></select>
      </label>
      <label><small>Status</small>
        <select class="input" id="ed-sta"><option selected>Open</option><option>Closed</option><option>Problem</option></select>
      </label>
      <label><small>Order Date</small><input type="date" class="input" id="ed-od"></label>
      <label><small>Requested by</small><input type="date" class="input" id="ed-rb"></label>
      <label><small>Incoterm</small><input class="input" id="ed-ico" placeholder="e.g., DAP"></label>
      <label><small>Payment Terms</small><input class="input" id="ed-terms" placeholder="e.g., Net 60"></label>
      <label><small>Vendor</small><input class="input" id="ed-vendor" placeholder="Vendor"></label>
      <label><small>Tests (comma)</small><input class="input" id="ed-tests" placeholder="EVI, Electrical"></label>
      <label><small>Supplier Lead (days)</small><input type="number" class="input" id="ed-lead" min="0"></label>
      <label><small>Currency</small>
        <select class="input" id="ed-cur"><option>USD</option><option>GBP</option><option>EUR</option></select>
      </label>
    </div>

    <div class="grid">
      <label><small>Bill To (billing address)</small><textarea class="input" id="ed-bill" rows="3" placeholder="Billing address"></textarea></label>
      <label><small>Ship To (shipping address)</small><textarea class="input" id="ed-ship" rows="3" placeholder="Shipping address"></textarea></label>
    </div>

    <div class="section items">
      <h3>Items</h3>
      <table id="ed-items">
        <thead><tr><th>Part</th><th>Date Codes</th><th style="width:90px">Qty</th><th style="width:110px">Unit Sell</th><th style="width:110px">Unit Cost</th><th style="width:40px"></th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn ghost" id="btn-add-item">+ Add Item</button></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn ghost" id="btn-del">Delete</button>
    <button class="btn ghost" onclick="document.getElementById('edit').close()">Cancel</button>
    <button class="btn primary" id="btn-save">Save</button>
  </div>
</dialog>

<!-- VIEW ORDER / NOTES / ATTACHMENTS / GENERATED DOCS -->
<dialog id="view">
  <div class="modal-head">
    <strong>Order Details</strong>
    <button class="btn ghost" onclick="document.getElementById('view').close()">✕</button>
  </div>
  <div class="modal-body" id="view-body">
    <!-- filled by JS -->
  </div>
</dialog>

<!-- GENERATE DOC -->
<dialog id="gen">
  <div class="modal-head">
    <strong>Generate Document</strong>
    <button class="btn ghost" onclick="document.getElementById('gen').close()">✕</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="gen-id">
    <div class="doc-toolbar">
      <button class="docbtn" data-d="so">Order Confirmation</button>
      <button class="docbtn" data-d="inv">Invoice</button>
      <button class="docbtn" data-d="pick">Picking Ticket</button>
      <button class="docbtn" data-d="rma">RMA</button>
    </div>

    <div class="grid" id="gen-fields">
      <!-- dynamic fields (only missing ones) are injected here -->
    </div>
    <div style="margin-top:10px">
      <label><small>Optional note for PDF</small><input class="input" id="gen-note" placeholder="e.g., Due to ship by …"></label>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn ghost" onclick="document.getElementById('gen').close()">Cancel</button>
    <button class="btn primary" id="btn-gen-run">Generate PDF & Save</button>
  </div>
</dialog>

<div class="toast" id="toast"></div>

<script>
/* ==================== CONFIG ==================== */
const SUPABASE_URL = 'https://ijzroisggstqkfhpjndq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc';
const SALES = ['Nick N','Dan C','Emir B','Nick K','Jake B'];
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ==================== UTIL ==================== */
const $ = id => document.getElementById(id);
const fmt = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmti = n => Number(n||0).toLocaleString(undefined);
const age = d => !d ? '-' : Math.max(0, Math.floor((Date.now()-new Date(d))/86400000))+' d';
const money = c => ({USD:'$',GBP:'£',EUR:'€'})[c||'USD']||'$';
const toast = (t,err=false)=>{const e=$('toast');e.textContent=t; e.style.background=err?'#e53e3e':'#18202f';e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2500)}

/* ==================== STATE ==================== */
const state = {
  orders: [],
  filters: { q:'', sales:'', status:'', prio:'' },
  current: null,           // selected order (object)
  genType: 'so',           // so | inv | pick | rma
};

/* ==================== LOAD & RENDER ==================== */
async function loadOrders(){
  const { data, error } = await supa
    .from('orders')
    .select(`
      *,
      order_items(*),
      order_notes(*),
      order_files(id, kind, path, created_at, file_size),
      shipments_inbound(*),
      shipments_outbound(*),
      ship_legs(*)
    `)
    .order('order_date', { ascending:false, nullsFirst:true })
    .order('created_at', { ascending:false });

  if(error){ console.error(error); toast('Failed to load orders',true); return; }

  state.orders = data || [];
  renderTable();
}

function calcTotals(o){
  const items = o.order_items||[];
  const qty = items.reduce((s,i)=>s+(i.qty||0),0);
  const rev = items.reduce((s,i)=>s+(i.qty||0)*(+i.unit_sell||0),0);
  const icost = items.reduce((s,i)=>s+(i.qty||0)*(+i.unit_cost||0),0);
  const legs = (o.ship_legs||[]).reduce((s,l)=>s+(+l.cost||0),0);
  const sc = (+o.shipping_cost_extra||0) + legs;
  const tc = (+o.test_cost||0);
  const cost = icost + sc + tc;
  const gp = rev - cost;
  const avg = qty ? rev/qty : 0;
  return {qty,rev,avg,gp,gpPct: rev? (gp/rev*100) : 0}
}

function filterOrders(list){
  const f = state.filters;
  return list.filter(o=>{
    const hay = [o.customer,o.salesperson,o.id,(o.order_items||[]).map(i=>i.part_number).join(' ')].join(' ').toLowerCase();
    if(f.q && !hay.includes(f.q.toLowerCase())) return false;
    if(f.sales && o.salesperson!==f.sales) return false;
    if(f.status && o.status!==f.status) return false;
    if(f.prio && o.priority!==f.prio) return false;
    return true;
  });
}

function renderTable(){
  const tbody = $('rows');
  const rows = filterOrders(state.orders);
  if(!rows.length){ tbody.innerHTML = `<tr><td colspan="20" style="text-align:center;padding:26px;color:#6d7486">No orders found.</td></tr>`; return; }

  tbody.innerHTML = rows.map(o=>{
    const t=calcTotals(o), c=money(o.currency);
    const parts = (o.order_items?.length) ? `${o.order_items[0].part_number}${o.order_items.length>1?` +${o.order_items.length-1}`:''}` : '';
    const tests = o.tests||'-';
    const shipped = o.is_shipped? '✔️' : '';
    const invoiced = o.is_invoiced? '✔️' : '';
    return `
      <tr>
        <td><button class="btn ghost" style="height:32px;padding:0 10px" onclick='openView("${o.id}")'>View</button></td>
        <td><strong>${o.customer||''}</strong></td>
        <td>${parts}</td>
        <td>${o.salesperson||''}</td>
        <td class="mono">${fmti(t.qty)}</td>
        <td class="mono">${fmt(t.avg)}</td>
        <td class="mono">${c}${fmt(t.rev)}</td>
        <td><span class="pill">${c}${fmt(t.gp)}</span> <small class="mono" style="color:#6d7486">${fmt(t.gpPct)}%</small></td>
        <td><span class="badge ${String(o.priority||'normal').toLowerCase()}">${o.priority||'Normal'}</span></td>
        <td>
          <div class="inline" data-id="${o.id}">
            <select class="input" style="height:32px" onchange="updateStatus('${o.id}',this.value)">
              <option ${o.status==='Open'?'selected':''}>Open</option>
              <option ${o.status==='Closed'?'selected':''}>Closed</option>
              <option ${o.status==='Problem'?'selected':''}>Problem</option>
            </select>
          </div>
        </td>
        <td class="mono">${o.order_date||''}</td>
        <td class="mono">${age(o.order_date)}</td>
        <td>${tests}</td>
        <td>${o.vendor||''}</td>
        <td>${o.incoterm||''}</td>
        <td>${o.terms||''}</td>
        <td style="text-align:center">${shipped}</td>
        <td style="text-align:center">${invoiced}</td>
        <td>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="docbtn" onclick='openGen("${o.id}","so")'>OC</button>
            <button class="docbtn" onclick='openGen("${o.id}","inv")'>INV</button>
            <button class="docbtn" onclick='openGen("${o.id}","pick")'>PICK</button>
            <button class="docbtn" onclick='openGen("${o.id}","rma")'>RMA</button>
          </div>
        </td>
        <td>
          <button class="btn ghost" style="height:32px;padding:0 10px" onclick='openEdit("${o.id}")'>Edit</button>
        </td>
      </tr>
    `;
  }).join('');
}

/* ==================== INLINE STATUS ==================== */
async function updateStatus(id,val){
  const { error } = await supa.from('orders').update({status:val}).eq('id',id);
  if(error){ toast('Failed to update status',true); return; }
  const o = state.orders.find(x=>x.id===id); if(o) o.status=val;
}

/* ==================== EDIT/CREATE ==================== */
function openEdit(id){
  $('ed-title').textContent = id?'Edit Order':'New Order';
  $('ed-id').value = id||'';
  const s = $('ed-sales'); s.innerHTML = SALES.map(x=>`<option>${x}</option>`).join('');
  // populate
  const o = id? state.orders.find(x=>x.id===id) : {};
  $('ed-customer').value = o.customer||'';
  $('ed-sales').value = o.salesperson||SALES[0];
  $('ed-pri').value = o.priority||'Normal';
  $('ed-sta').value = o.status||'Open';
  $('ed-od').value = o.order_date||'';
  $('ed-rb').value = o.requested_by||'';
  $('ed-ico').value = o.incoterm||'';
  $('ed-terms').value = o.terms||'';
  $('ed-vendor').value = o.vendor||'';
  $('ed-tests').value = o.tests||'';
  $('ed-lead').value = o.supplier_lead_time||'';
  $('ed-cur').value = o.currency||'USD';
  $('ed-bill').value = o.bill_to||'';
  $('ed-ship').value = o.ship_to||'';
  const tbody = $('ed-items').querySelector('tbody'); tbody.innerHTML='';
  (o.order_items?.length?o.order_items:[{}]).forEach(addItemRow);
  $('btn-del').style.visibility = id ? 'visible':'hidden';
  $('edit').showModal();
}

function addItemRow(it={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input class="input" value="${it.part_number||''}" placeholder="Part"></td>
    <td><input class="input" value="${it.date_codes||''}" placeholder="Date codes"></td>
    <td><input type="number" class="input" value="${it.qty||''}" min="0"></td>
    <td><input type="number" class="input" value="${it.unit_sell||''}" step="0.01"></td>
    <td><input type="number" class="input" value="${it.unit_cost||''}" step="0.01"></td>
    <td><button class="btn ghost" style="height:32px;padding:0 8px" onclick="this.closest('tr').remove()">✕</button></td>`;
  $('ed-items').querySelector('tbody').appendChild(tr);
}
$('btn-add-item').onclick = ()=>addItemRow();

$('btn-save').onclick = async ()=>{
  const id=$('ed-id').value||undefined;
  const items=[...$('ed-items').querySelectorAll('tbody tr')].map(tr=>{
    const i=tr.querySelectorAll('input');
    return {
      part_number:i[0].value.trim(),
      date_codes:i[1].value.trim(),
      qty:+i[2].value||0,
      unit_sell:+i[3].value||0,
      unit_cost:+i[4].value||0
    }
  }).filter(x=>x.part_number);

  const record={
    id,
    customer:$('ed-customer').value.trim(),
    salesperson:$('ed-sales').value,
    priority:$('ed-pri').value,
    status:$('ed-sta').value,
    order_date:$('ed-od').value||null,
    requested_by:$('ed-rb').value||null,
    incoterm:$('ed-ico').value.trim()||null,
    terms:$('ed-terms').value.trim()||null,
    vendor:$('ed-vendor').value.trim()||null,
    tests:$('ed-tests').value.trim()||null,
    supplier_lead_time: $('ed-lead').value? +$('ed-lead').value : null,
    currency:$('ed-cur').value,
    bill_to:$('ed-bill').value.trim()||null,
    ship_to:$('ed-ship').value.trim()||null
  };

  const { data:up, error } = await supa.from('orders').upsert(record).select().single();
  if(error){ console.error(error); toast('Save failed',true); return; }

  // Items: replace for the order
  await supa.from('order_items').delete().eq('order_id', up.id);
  if(items.length){
    await supa.from('order_items').insert(items.map(it=>({...it,order_id:up.id})));
  }

  $('edit').close(); toast('Saved');
  await loadOrders();
}

$('btn-del').onclick = async ()=>{
  const id=$('ed-id').value; if(!id){$('edit').close();return;}
  if(!confirm('Delete this order?')) return;
  const { error }= await supa.from('orders').delete().eq('id',id);
  if(error){toast('Delete failed',true);return;}
  $('edit').close(); toast('Deleted');
  await loadOrders();
}

/* ==================== VIEW ==================== */
async function openView(id){
  const o = state.orders.find(x=>x.id===id); state.current=o;
  const t = calcTotals(o); const c=money(o.currency);
  const items = (o.order_items||[]).map(i=>`
    <tr><td>${i.part_number}</td><td>${i.date_codes||''}</td>
    <td class="mono">${fmti(i.qty)}</td>
    <td class="mono">${c}${fmt(i.unit_sell)}</td>
    <td class="mono">${c}${fmt(i.unit_cost)}</td></tr>`).join('') || `<tr><td colspan="5" style="text-align:center;color:#6d7486">No items</td></tr>`;

  const notes = (o.order_notes||[]).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))
    .map(n=>`<div class="note-row"><div>${n.body}</div><small>${n.author} — ${new Date(n.created_at).toLocaleString()}</small></div>`).join('');

  const docs = (o.order_files||[]).filter(f=>/_pdf$/.test(f.kind))
    .map(f=>`<tr><td>${kindLabel(f.kind)}</td><td>${new Date(f.created_at).toLocaleString()}</td><td class="mono">${fmti(f.file_size||0)} bytes</td>
      <td><button class="btn ghost" style="height:30px;padding:0 10px" onclick="openFile('${f.path}')">Open</button></td></tr>`).join('') || `<tr><td colspan="4" style="text-align:center;color:#6d7486">No generated documents yet</td></tr>`;

  $('view-body').innerHTML = `
    <div class="grid">
      <div class="card" style="background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px">
        <h3>Order Details</h3>
        <div class="grid">
          <div><small>Customer</small><div><strong>${o.customer||''}</strong></div></div>
          <div><small>Salesperson</small><div>${o.salesperson||''}</div></div>
          <div><small>Status</small><div><span class="badge ${String(o.status||'open').toLowerCase()}">${o.status||'Open'}</span></div></div>
          <div><small>Priority</small><div><span class="badge ${String(o.priority||'Normal').toLowerCase()}">${o.priority||'Normal'}</span></div></div>
          <div><small>Order Date</small><div>${o.order_date||''}</div></div>
          <div><small>Age</small><div>${age(o.order_date)}</div></div>
          <div><small>Incoterm</small><div>${o.incoterm||''}</div></div>
          <div><small>Terms</small><div>${o.terms||''}</div></div>
          <div><small>Vendor</small><div>${o.vendor||''}</div></div>
          <div><small>Supplier Lead</small><div>${o.supplier_lead_time?o.supplier_lead_time+' days':'-'}</div></div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div><small>Bill To</small><div>${(o.bill_to||'').replaceAll('\n','<br>')}</div></div>
          <div><small>Ship To</small><div>${(o.ship_to||'').replaceAll('\n','<br>')}</div></div>
        </div>
      </div>

      <div class="card" style="background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px">
        <h3>Totals</h3>
        <div class="grid">
          <div><small>Total Qty</small><div class="mono">${fmti(t.qty)}</div></div>
          <div><small>Revenue</small><div class="mono">${c}${fmt(t.rev)}</div></div>
          <div><small>Gross Profit</small><div class="mono">${c}${fmt(t.gp)} (${fmt(t.gpPct)}%)</div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Items</h3>
      <table class="items"><thead><tr><th>Part</th><th>Date Codes</th><th>Qty</th><th>Unit Sell</th><th>Unit Cost</th></tr></thead><tbody>${items}</tbody></table>
    </div>

    <div class="section">
      <h3>Staff Notes</h3>
      <div class="notes">
        <input class="input" id="note-author" placeholder="Your name" style="width:180px">
        <input class="input" id="note-body" placeholder="Write a note…" style="flex:1">
        <button class="btn primary" onclick="addNote()">Add</button>
      </div>
      <div id="notes-list">${notes||''}</div>
    </div>

    <div class="section">
      <h3>Attachments</h3>
      <div class="grid">
        <label><small>Customer PO</small><input type="file" class="input" id="file-po" accept=".pdf,.png,.jpg,.jpeg"></label>
        <label><small>Test Report</small><input type="file" class="input" id="file-test" accept=".pdf,.png,.jpg,.jpeg"></label>
      </div>
      <div style="margin-top:8px">
        <button class="btn ghost" onclick="uploadAttachment('po')">Upload PO</button>
        <button class="btn ghost" onclick="uploadAttachment('test_report')">Upload Test Report</button>
      </div>
    </div>

    <div class="section">
      <h3>Documents</h3>
      <table class="items">
        <thead><tr><th>Type</th><th>Created</th><th>Size</th><th>Open</th></tr></thead>
        <tbody>${docs}</tbody>
      </table>
    </div>
  `;
  $('view').showModal();
}

async function addNote(){
  const o=state.current; const author=$('note-author').value.trim()||'Staff'; const body=$('note-body').value.trim();
  if(!body){toast('Note is empty');return;}
  const { error } = await supa.from('order_notes').insert({ order_id:o.id, author, body });
  if(error){toast('Failed to add note',true);return;}
  $('note-body').value=''; toast('Note added'); await loadOrders(); openView(o.id);
}

async function uploadAttachment(kind){
  const o=state.current; const el = kind==='po' ? $('file-po') : $('file-test');
  if(!el.files.length){toast('Choose a file first');return;}
  const f = el.files[0];
  const safe = f.name.replace(/[^\w.-]+/g,'_');
  const path = `orders/${o.id}/${kind}/${Date.now()}_${safe}`;
  const { error:upErr } = await supa.storage.from('order-files').upload(path,f,{upsert:true,contentType:f.type||'application/octet-stream'});
  if(upErr){toast('Upload failed',true);return;}
  const { error } = await supa.from('order_files').insert({ order_id:o.id, kind, path, file_size:f.size, mime_type:f.type });
  if(error){toast('Save file row failed',true);return;}
  toast('Uploaded'); await loadOrders(); openView(o.id);
}

async function openFile(path){
  const { data, error } = await supa.storage.from('order-files').createSignedUrl(path, 60*30);
  if(error){toast('Could not open file',true);return;}
  window.open(data.signedUrl,'_blank');
}

function kindLabel(k){
  return ({
    so_pdf:'Order Confirmation (PDF)',
    inv_pdf:'Invoice (PDF)',
    pick_pdf:'Picking Ticket (PDF)',
    rma_pdf:'RMA (PDF)',
    po:'Customer PO',
    test_report:'Test Report'
  })[k] || k;
}

/* ==================== GENERATOR (jsPDF) ==================== */
function openGen(id, type){
  const o=state.orders.find(x=>x.id===id); state.current=o; state.genType=type;
  $('gen-id').value=id;
  // Build only the fields that might be missing for the chosen doc
  const required = {
    so: ['bill_to','ship_to','incoterm','terms'],
    inv:['bill_to','ship_to','incoterm','terms'],
    pick:['ship_to'],
    rma:['ship_to']
  }[type];

  const labels = {
    bill_to:'Bill To (billing)',
    ship_to:'Ship To (shipping)',
    incoterm:'Incoterm',
    terms:'Payment Terms'
  };

  const holder = $('gen-fields'); holder.innerHTML='';
  required.forEach(f=>{
    const val = o[f]||'';
    holder.innerHTML += `
      <label><small>${labels[f]}</small>
        ${f.includes('_to') ? `<textarea class="input" data-k="${f}" rows="3" placeholder="${labels[f]}">${val}</textarea>`
                            : `<input class="input" data-k="${f}" value="${val}" placeholder="${labels[f]}">`}
      </label>`;
  });

  // mark chosen tab
  [...document.querySelectorAll('#gen .docbtn')].forEach(b=>b.style.outline = b.dataset.d===type ? '2px solid var(--brand)' : 'none');
  $('gen').showModal();
}

$('gen').addEventListener('click',e=>{
  const btn=e.target.closest('.docbtn'); if(!btn) return;
  openGen($('gen-id').value, btn.dataset.d);
});

$('btn-gen-run').onclick = async ()=>{
  const id=$('gen-id').value; const o=state.orders.find(x=>x.id===id);
  // apply any edits from the modal to the order (and persist)
  const edits={}; document.querySelectorAll('#gen-fields [data-k]').forEach(el=>{ edits[el.dataset.k]=el.value });
  if(Object.keys(edits).length){
    await supa.from('orders').update(edits).eq('id',id);
    Object.assign(o,edits);
  }

  // Generate PDF
  const blob = generatePDF(state.genType, o, $('gen-note').value.trim());

  // Save to storage + DB row
  const kind = ({so:'so_pdf',inv:'inv_pdf',pick:'pick_pdf',rma:'rma_pdf'})[state.genType];
  const fileName = `${kind}_${new Date().toISOString().replaceAll(':','-')}.pdf`;
  const path = `orders/${o.id}/generated/${fileName}`;
  const { error:upErr } = await supa.storage.from('order-files').upload(path, blob, { upsert:true, contentType:'application/pdf' });
  if(upErr){ console.error(upErr); toast('Upload PDF failed',true); return; }
  await supa.from('order_files').insert({ order_id:o.id, kind, path, file_size:blob.size, mime_type:'application/pdf' });

  // Also download to PC
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);

  $('gen').close(); toast('PDF generated & saved');
  await loadOrders(); openView(o.id);
};

function generatePDF(type, o, note=''){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt' });
  const c = money(o.currency);
  const t = calcTotals(o);
  const title = ({
    so:'Sales Order Confirmation',
    inv:'Invoice',
    pick:'Picking Ticket',
    rma:'RMA'
  })[type];

  let y=40;
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text(`Verified Electronics — ${title}`, 40, y); y+=22;
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  if(o.order_date){ doc.text(`Order Date: ${o.order_date}`, 40, y); y+=14; }
  doc.text(`Customer: ${o.customer||''}`, 40, y); y+=14;
  doc.text(`Salesperson: ${o.salesperson||''}`, 40, y); y+=14;
  doc.text(`Status: ${o.status||'Open'}  •  Priority: ${o.priority||'Normal'}`, 40, y); y+=20;

  // Addresses
  const bill = (o.bill_to||'').split('\n'); const ship=(o.ship_to||'').split('\n');
  doc.setFont('helvetica','bold'); doc.text('Bill To',40,y); doc.text('Ship To',300,y); y+=14;
  doc.setFont('helvetica','normal');
  bill.forEach(l=>{doc.text(l,40,y); y+=12}); y-=12*bill.length; // reset y to start of ship block
  const y0 = y;
  ship.forEach((l,i)=>{doc.text(l,300,y0+i*12)});

  y = Math.max(y0 + ship.length*12, y0 + bill.length*12) + 16;

  // Order meta
  if(o.incoterm || o.terms){
    doc.setFont('helvetica','bold'); doc.text('Terms',40,y); y+=14; doc.setFont('helvetica','normal');
    if(o.incoterm) doc.text(`Incoterm: ${o.incoterm}`,40,y), y+=12;
    if(o.terms)    doc.text(`Payment: ${o.terms}`,40,y), y+=12;
    y+=6;
  }

  // Items
  doc.setFont('helvetica','bold'); doc.text('Items',40,y); y+=14; doc.setFont('helvetica','normal');
  const items = o.order_items||[];
  const cols = [{k:'part_number',w:180,l:'Part'},
                {k:'date_codes',w:120,l:'Date'},
                {k:'qty',w:60,l:'Qty',r:true},
                {k:'unit_sell',w:80,l:'Sell',r:true}];
  // header
  let x=40; doc.setFillColor(245,246,250); doc.rect(40,y-10,520,18,'F'); 
  cols.forEach(cn=>{ doc.text(cn.l, x+(cn.r?cn.w-4:4), y, {align: cn.r?'right':'left'}); x+=cn.w; }); y+=14;

  items.forEach(it=>{
    let x=40;
    cols.forEach(cn=>{
      const v = cn.k==='qty' ? String(it.qty||0)
              : cn.k==='unit_sell' ? c+fmt(it.unit_sell||0)
              : (it[cn.k]||'');
      doc.text(v, x+(cn.r?cn.w-4:4), y, {align:cn.r?'right':'left'});
      x+=cn.w;
    });
    y+=14;
    if(y>760){ doc.addPage(); y=40; }
  });

  y+=10; doc.setDrawColor(230,231,238); doc.line(40,y,560,y); y+=14;

  // totals / note
  doc.text(`Total Qty: ${t.qty}`,40,y); y+=12;
  doc.text(`Revenue: ${c}${fmt(t.rev)}   Gross Profit: ${c}${fmt(t.gp)} (${fmt(t.gpPct)}%)`,40,y); y+=14;
  if(note){ doc.text('Note:',40,y); y+=12; doc.text(note,40,y); }

  return doc.output('blob');
}

/* ==================== EVENTS & INIT ==================== */
$('btn-new').onclick = ()=>openEdit();
$('btn-csv').onclick = ()=>{
  const rows = filterOrders(state.orders);
  const csv = [
    ['Customer','Parts','Sales','Qty','Revenue','GP','Priority','Status','Order Date','Age'],
    ...rows.map(o=>{
      const t=calcTotals(o);
      const parts=(o.order_items?.length)?`${o.order_items[0].part_number}${o.order_items.length>1?` +${o.order_items.length-1}`:''}`:'';
      return [o.customer||'',parts,o.salesperson||'',t.qty,t.rev,t.gp,o.priority||'',o.status||'',o.order_date||'',age(o.order_date)];
    })
  ].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a=document.createElement('a'); a.href=url; a.download='orders.csv'; a.click(); URL.revokeObjectURL(url);
};

$('q').oninput = e=>{ state.filters.q=e.target.value; renderTable(); };
$('fsales').onchange = e=>{ state.filters.sales=e.target.value; renderTable(); };
$('fstatus').onchange = e=>{ state.filters.status=e.target.value; renderTable(); };
$('fprio').onchange   = e=>{ state.filters.prio=e.target.value; renderTable(); };

// fill sales dropdowns
$('fsales').innerHTML += SALES.map(s=>`<option>${s}</option>`).join('');

loadOrders();
</script>
</body>
</html>






