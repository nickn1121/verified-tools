<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Verified ‚Äî Simple Document Signer</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Dancing+Script:wght@700&family=Great+Vibes&family=Pacifico&display=swap" rel="stylesheet">
<style>
  :root{--brand:#673ab7;--ink:#1c1c1c;--muted:#667085;--line:#e9e9ef;--card:#fff;--bg:#f6f7fb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial}
  header{display:flex;gap:12px;align-items:center;padding:16px 18px;background:#fff;border-bottom:1px solid var(--line)}
  header img{height:36px} h1{margin:0;font-size:18px;font-weight:800}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px;display:grid;gap:16px;grid-template-columns:380px 1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:15px;background:linear-gradient(180deg,#fff,#fbfbff)}
  .body{padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  input[type="text"],input[type="number"],input[type="file"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:#fff;background:var(--brand);box-shadow:0 6px 16px rgba(103,58,183,.25)}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--line)}
  .muted{color:var(--muted)}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .sig-pad{border:1px dashed #d9d9ef;border-radius:10px;background:#fff}

  .pageWrap{position:relative;margin:10px auto;border-radius:10px;overflow:hidden;background:#fff;border:1px solid #e6e6f6}
  .pageCanvas{display:block}
  .stamp{position:absolute;transform:translate(-50%,-50%);border:1px solid #d9d9ef;border-radius:8px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:2px 6px;cursor:grab;user-select:none}
  .stamp img{display:block;max-width:260px;max-height:90px}
  .stamp--selected{outline:2px solid var(--brand)}
  .resize-handle{
    position:absolute; right:-10px; bottom:-10px; width:18px; height:18px;
    background:#fff; border:2px solid var(--brand); border-radius:4px; cursor:nwse-resize;
    box-shadow:0 1px 6px rgba(0,0,0,.15);
  }

  .palette{display:flex;gap:8px}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #e3ddfb;background:#f5f3ff;color:#4525b2;font-weight:700;cursor:grab;user-select:none}
  .pill:active{opacity:.9}
  .notice{font-size:12px;color:#555;margin-top:10px}
  #hiddenHtml{position:absolute;left:-99999px;top:-99999px;visibility:hidden}

  .checklist{font-size:12px;color:#666;margin-top:6px}
  .checklist span{display:inline-block;margin-right:10px}
  .ok{color:#16a34a} .no{color:#b45309}
</style>
</head>
<body>
<header>
  <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified">
  <h1>Verified ‚Äî Simple Document Signer</h1>
</header>

<div class="wrap">
  <!-- LEFT: controls -->
  <section class="card">
    <h2>1) Upload</h2>
    <div class="body">
      <label>Document (PDF or DOCX)</label>
      <input id="docFile" type="file" accept="application/pdf,.pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.docx"/>
      <div class="notice">DOCX is converted locally to PDF for signing.</div>
    </div>

    <h2>2) Create signature</h2>
    <div class="body">
      <div>
        <label>Signature type</label>
        <select id="sigMode">
          <option value="typed">Typed (auto-generated)</option>
          <option value="drawn">Drawn (mouse/touch)</option>
        </select>
      </div>

      <div id="typedBox">
        <label>Signer name</label>
        <input id="signerName" placeholder="Type your full name"/>
        <label>Style</label>
        <select id="sigStyle">
          <option value="Great Vibes">Great Vibes</option>
          <option value="Dancing Script">Dancing Script</option>
          <option value="Pacifico">Pacifico</option>
          <option value="Caveat">Caveat</option>
        </select>
        <div style="margin-top:8px">
          <canvas id="typedPreview" width="420" height="100" class="sig-pad"></canvas>
        </div>
      </div>

      <div id="drawnBox" style="display:none">
        <label>Draw your signature</label>
        <canvas id="drawPad" width="420" height="120" class="sig-pad"></canvas>
        <div class="tools">
          <button id="clearSig" class="btn ghost" type="button">Clear</button>
        </div>
      </div>

      <div class="tools" style="margin-top:8px">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px">
          Default width:
          <input id="sigWidth" type="number" min="60" max="600" value="220" style="width:84px"/>
          px
        </label>
      </div>

      <div class="notice">Drag a stamp from the palette onto a page. Reposition by dragging. Drag the <b>corner</b> to resize. Select a stamp and press <b>Delete</b> to remove. Hold <b>Ctrl/Cmd</b> and scroll to scale.</div>
    </div>

    <h2>3) Stamps</h2>
    <div class="body">
      <div class="palette">
        <div class="pill" draggable="true" data-stamp="signature">‚úçÔ∏è Signature</div>
        <div class="pill" draggable="true" data-stamp="initials">üÖò Initials</div>
        <div class="pill" draggable="true" data-stamp="date">üìÖ Date</div>
      </div>
    </div>

    <h2>4) Download</h2>
    <div class="body">
      <label><input type="checkbox" id="agree"/> I agree to sign this document electronically.</label>
      <div class="tools" style="margin-top:10px">
        <button id="finalize" class="btn" type="button" disabled>Download Signed PDF</button>
      </div>
      <div class="checklist" id="checklist"></div>
    </div>
  </section>

  <!-- RIGHT: PDF preview -->
  <section class="card">
    <h2>Preview (drag stamps here)</h2>
    <div class="body" id="preview"></div>
  </section>
</div>

<!-- hidden container used for DOCX->HTML->PDF conversion -->
<div id="hiddenHtml"></div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
const $ = s => document.querySelector(s), $$ = s => [...document.querySelectorAll(s)];

// ===== Signature sources =====
let sigPad = null;
let typedCanvas = $('#typedPreview'), typedCtx = typedCanvas.getContext('2d');

function drawTypedPreview(){
  const name = $('#signerName').value || 'Your Name';
  const style = $('#sigStyle').value;
  typedCtx.clearRect(0,0,typedCanvas.width, typedCanvas.height);
  typedCtx.fillStyle = '#222';
  typedCtx.textBaseline = 'middle';
  typedCtx.font = `64px "${style}", "Segoe Script", cursive`;
  typedCtx.fillText(name, 12, typedCanvas.height/2);
}
function getSignatureImage(){
  const mode = $('#sigMode').value;
  let canvas = (mode==='typed') ? typedCanvas : $('#drawPad');
  const targetW = Math.max(60, Math.min(600, +$('#sigWidth').value||220));
  const scale = targetW / canvas.width;
  const out = document.createElement('canvas');
  out.width = targetW;
  out.height = Math.round(canvas.height * scale);
  out.getContext('2d').drawImage(canvas, 0, 0, out.width, out.height);
  return {dataUrl: out.toDataURL('image/png'), w: out.width, h: out.height, ratio: out.width/out.height};
}
function getInitialsImage(){
  const name = ($('#signerName').value || 'Your Name').trim();
  const initials = name.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase() || 'XX';
  const style = $('#sigStyle').value;
  const canvas = document.createElement('canvas');
  canvas.width = 180; canvas.height = 70;
  const c = canvas.getContext('2d');
  c.fillStyle='#222'; c.textBaseline='middle';
  c.font = `54px "${style}", "Segoe Script", cursive`;
  c.fillText(initials, 10, canvas.height/2);
  return {dataUrl: canvas.toDataURL('image/png'), w: 180, h: 70, ratio: 180/70};
}
function getDateStampText(){ return new Date().toLocaleString(); }

$('#sigMode').addEventListener('change', ()=>{
  const typed = $('#sigMode').value==='typed';
  $('#typedBox').style.display = typed?'block':'none';
  $('#drawnBox').style.display = typed?'none':'block';
});
$('#signerName').addEventListener('input', drawTypedPreview);
$('#sigStyle').addEventListener('change', drawTypedPreview);
sigPad = new SignaturePad($('#drawPad'), { backgroundColor:'#fff', penColor:'#111' });
$('#clearSig').addEventListener('click', ()=>sigPad.clear());
drawTypedPreview();

// ===== PDF handling =====
// Keep TWO copies: one for pdf.js (render), one untouched for pdf-lib (edit)
let pdfRenderBytes = null; // Uint8Array for pdf.js
let pdfEditBytes   = null; // ArrayBuffer kept independent for pdf-lib
let pdfDocProxy = null;

let pageViews = [];   // [{wrap, canvas, viewport}]
let stamps = [];      // [{id,type,pageIndex,x,y,w,h,dataUrl,text,ratio,canW,canH}]
let idSeq = 1;

$('#docFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  resetAll();

  if (/\.(pdf)$/i.test(f.name)) {
    const buf = await f.arrayBuffer();
    pdfRenderBytes = new Uint8Array(buf);
    pdfEditBytes   = buf.slice(0);
  } else if (/\.(docx)$/i.test(f.name)) {
    const buf = await f.arrayBuffer();
    const res = await mammoth.convertToHtml({arrayBuffer:buf});
    const holder = $('#hiddenHtml');
    holder.innerHTML = `<div id="docxHtml" style="width:794px;padding:36px;background:#fff">${res.value}</div>`;
    const element = $('#docxHtml');
    const opt = {
      margin: [12,12,12,12],
      image: { type:'jpeg', quality:0.98 },
      html2canvas: { scale: 2, useCORS:true },
      jsPDF: { unit:'pt', format:'a4', orientation:'portrait' }
    };
    const pdfBlob = await html2pdf().set(opt).from(element).toPdf().get('pdf').then(pdf => pdf.output('blob'));
    const pdfBuf = await pdfBlob.arrayBuffer();
    pdfRenderBytes = new Uint8Array(pdfBuf);
    pdfEditBytes   = pdfBuf.slice(0);
    holder.innerHTML = '';
  } else {
    alert('Unsupported file type. Please upload PDF or DOCX.');
    return;
  }

  await renderPdf();
});

async function renderPdf(){
  $('#preview').innerHTML = '';
  pageViews = [];
  pdfDocProxy = await pdfjsLib.getDocument({data: pdfRenderBytes}).promise;
  for(let i=1; i<=pdfDocProxy.numPages; i++){
    const page = await pdfDocProxy.getPage(i);
    const viewport = page.getViewport({scale: 1.2});
    const wrap = document.createElement('div');
    wrap.className='pageWrap';
    const canvas = document.createElement('canvas');
    canvas.className='pageCanvas';
    canvas.width = viewport.width; canvas.height = viewport.height;
    wrap.style.width = canvas.width+'px';
    wrap.style.height = canvas.height+'px';
    const ctx = canvas.getContext('2d');
    await page.render({canvasContext: ctx, viewport}).promise;
    wrap.appendChild(canvas);
    $('#preview').appendChild(wrap);

    enableDrop(wrap, i-1);
    pageViews.push({wrap, canvas, viewport});
  }
  updateChecklist();
  toggleFinalize();
}

// ===== Drag & Drop from palette =====
function enableDrop(wrap, pageIndex){
  wrap.addEventListener('dragover', e=>{ e.preventDefault(); });
  wrap.addEventListener('drop', e=>{
    e.preventDefault();
    const type = e.dataTransfer.getData('text/plain');
    addStampAt(type, pageIndex, e.offsetX, e.offsetY);
  });
}
$$('.palette .pill').forEach(p=>{
  p.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/plain', e.target.dataset.stamp);
  });
});

function addStampAt(type, pageIndex, x, y){
  const page = pageViews[pageIndex];
  let el = document.createElement('div');
  el.className='stamp';
  el.dataset.id = String(idSeq++);
  el.dataset.page = String(pageIndex);

  let w=160, h=50, dataUrl=null, text=null, ratio=null;

  if(type==='signature'){
    const sig = getSignatureImage();
    dataUrl = sig.dataUrl; ratio = sig.ratio;
    const im = new Image(); im.src = dataUrl;
    im.onload = ()=>{
      const r = Math.min(260/im.width, 90/im.height, 1);
      w = Math.round(im.width*r); h = Math.round(im.height*r);
      build();
    };
  } else if(type==='initials'){
    const ini = getInitialsImage();
    dataUrl = ini.dataUrl; ratio = ini.ratio; w=140; h=50; build();
  } else if(type==='date'){
    text = getDateStampText(); w=140; h=28; build(true);
  }

  function build(isDate=false){
    el.style.left = x+'px'; el.style.top = y+'px';
    if(isDate){
      el.style.padding='6px 10px';
      el.style.border='1px solid #e6e6f6';
      el.style.font='600 12px system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial';
      el.textContent = text;
    } else {
      const im = new Image(); im.src = dataUrl; im.style.maxWidth='260px'; im.style.maxHeight='90px';
      el.innerHTML=''; el.appendChild(im);
    }
    const hnd = document.createElement('div'); hnd.className='resize-handle'; el.appendChild(hnd);

    page.wrap.appendChild(el);
    makeDraggable(el);
    makeResizable(el, { keepRatio: type!=='date' });

    stamps.push({ id: el.dataset.id, type, pageIndex, x, y, w, h, dataUrl, text, ratio, canW: page.canvas.width, canH: page.canvas.height });
    updateStampSize(el, w, h);
    selectStamp(el);
    updateChecklist();
    toggleFinalize();
  }
}

// --- Dragging + selecting
let dragInfo=null, selected=null;
function makeDraggable(el){
  el.addEventListener('pointerdown', e=>{
    if(e.target.classList.contains('resize-handle')) return;
    selectStamp(el);
    dragInfo = { el, startX:e.clientX, startY:e.clientY, origLeft:parseFloat(el.style.left), origTop:parseFloat(el.style.top) };
    el.setPointerCapture(e.pointerId);
  });
  el.addEventListener('pointermove', e=>{
    if(!dragInfo) return;
    const dx = e.clientX - dragInfo.startX;
    const dy = e.clientY - dragInfo.startY;
    const nx = dragInfo.origLeft + dx;
    const ny = dragInfo.origTop + dy;
    dragInfo.el.style.left = nx+'px';
    dragInfo.el.style.top = ny+'px';
  });
  el.addEventListener('pointerup', ()=>{
    if(!dragInfo) return;
    const id = el.dataset.id;
    const s = stamps.find(x=>x.id===id);
    s.x = parseFloat(el.style.left);
    s.y = parseFloat(el.style.top);
    dragInfo=null;
  });
}
function selectStamp(el){
  if(selected) selected.classList.remove('stamp--selected');
  selected = el;
  el.classList.add('stamp--selected');
}
document.addEventListener('keydown', e=>{
  if((e.key==='Delete' || e.key==='Backspace') && selected){
    const id = selected.dataset.id;
    stamps = stamps.filter(s=>s.id!==id);
    selected.remove(); selected=null;
    updateChecklist();
    toggleFinalize();
  }
});

// --- Resizing
function makeResizable(el, {keepRatio}){
  const handle = el.querySelector('.resize-handle');
  let rs=null;

  handle.addEventListener('pointerdown', e=>{
    e.stopPropagation();
    selectStamp(el);
    const id = el.dataset.id;
    const s = stamps.find(x=>x.id===id);
    rs = {
      el, startX:e.clientX, startY:e.clientY,
      startW:s.w, startH:s.h, keepRatio: keepRatio ? (s.ratio || (s.w/s.h)) : null
    };
    handle.setPointerCapture(e.pointerId);
  });

  el.addEventListener('pointermove', e=>{
    if(!rs) return;
    const dx = e.clientX - rs.startX;
    const dy = e.clientY - rs.startY;
    let newW = Math.max(40, rs.startW + dx);
    let newH = Math.max(20, rs.startH + dy);
    if(rs.keepRatio){
      newH = Math.round(newW / rs.keepRatio);
    }
    updateStampSize(rs.el, newW, newH);
  });

  document.addEventListener('pointerup', ()=>{
    rs=null;
  });

  // wheel scale (Ctrl/Cmd required)
  el.addEventListener('wheel', e=>{
    if(!(e.ctrlKey || e.metaKey)) return;
    e.preventDefault();
    const id = el.dataset.id;
    const s = stamps.find(x=>x.id===id);
    const factor = (e.deltaY<0)? 1.05 : 0.95;
    let newW = Math.max(40, Math.round(s.w * factor));
    let newH = rs && rs.keepRatio ? Math.round(newW / rs.keepRatio) : Math.max(20, Math.round(s.h * factor));
    updateStampSize(el, newW, newH);
  }, {passive:false});
}

function updateStampSize(el, w, h){
  el.style.padding = '2px 6px';
  el.style.width = w+'px';
  el.style.height = h+'px';
  const id = el.dataset.id;
  const s = stamps.find(x=>x.id===id);
  if(s){ s.w = w; s.h = h; }
}

// ===== Utilities =====
function resetAll(){
  $('#preview').innerHTML='';
  pageViews=[]; stamps=[]; pdfRenderBytes=null; pdfEditBytes=null; pdfDocProxy=null;
  updateChecklist();
  toggleFinalize();
}
function toggleFinalize(){
  const can = !!(pdfEditBytes && stamps.length && $('#agree').checked);
  $('#finalize').disabled = !can;
}
$('#agree').addEventListener('change', toggleFinalize);

function updateChecklist(){
  const okDoc = !!pdfEditBytes;
  const okStamp = stamps.length>0;
  const okAgree = $('#agree').checked;
  $('#checklist').innerHTML = `
    <span class="${okDoc?'ok':'no'}">‚Ä¢ ${okDoc?'Document loaded':'Upload a document'}</span>
    <span class="${okStamp?'ok':'no'}">‚Ä¢ ${okStamp?'Stamp placed':'Add a signature/initials/date stamp'}</span>
    <span class="${okAgree?'ok':'no'}">‚Ä¢ ${okAgree?'Consent checked':'Tick the consent box'}</span>
  `;
}

// ===== Finalize (flatten into PDF) =====
$('#finalize').addEventListener('click', async ()=>{
  if(!pdfEditBytes || !stamps.length || !$('#agree').checked) { updateChecklist(); return; }

  try{
    // clone to ensure it's never detached
    const safeBytes = pdfEditBytes.slice ? pdfEditBytes.slice(0) : new Uint8Array(pdfEditBytes);
    const pdfDoc = await PDFLib.PDFDocument.load(safeBytes);
    for(const s of stamps){
      const page = pdfDoc.getPage(s.pageIndex);
      const { width: pageW, height: pageH } = page.getSize();
      const xRatio = s.x / s.canW, yRatio = s.y / s.canH;
      const wPt = (s.w / s.canW) * pageW;
      const hPt = (s.h / s.canH) * pageH;
      const xPt = xRatio * pageW - wPt/2;
      const yPt = pageH - (yRatio * pageH) - hPt/2;

      if(s.type==='date'){
        page.drawRectangle({ x:xPt, y:yPt, width:wPt, height:hPt, borderColor:PDFLib.rgb(0.9,0.9,0.95), borderWidth:1, color: PDFLib.rgb(1,1,1) });
        page.drawText(s.text || getDateStampText(), {
          x: xPt + 6, y: yPt + Math.max(6, hPt/2 - 5), size: 10, color: PDFLib.rgb(0.18,0.18,0.18)
        });
      } else {
        const png = await pdfDoc.embedPng(s.dataUrl);
        page.drawImage(png, { x:xPt, y:yPt, width:wPt, height:hPt });
        if(s.type==='signature'){
          const name = ($('#signerName').value || '').trim();
          if(name) page.drawText(`${name}  ‚Ä¢  ${new Date().toLocaleString()}`, { x:xPt, y:yPt-10, size:8, color: PDFLib.rgb(0.22,0.22,0.22) });
        }
      }
    }

    const signedBytes = await pdfDoc.save();
    const blob = new Blob([signedBytes], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Signed.pdf';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }catch(err){
    console.error(err);
    alert('Sorry, something went wrong creating the PDF. Check the console for details.');
  }
});
</script>
</body>
</html>


