<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Order Tracker — Verified Electronics</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<style>
  :root{
    --brand:#6f57e9; --brand-ink:#4031c8;
    --ink:#1e2330; --muted:#6d7486;
    --bg:#f6f7fb; --card:#fff; --line:#e9e9ef;
    --green:#12a274; --red:#d24545; --amber:#b97a12;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  .wrap{max-width:1180px;margin:22px auto;padding:0 16px}
  header{
    display:flex;align-items:center;gap:16px;padding:16px 18px;border:1px solid var(--line);
    border-radius:16px;background:radial-gradient(1100px 220px at 160px -60px, rgba(111,87,233,.15), transparent 60%), #fff;
    box-shadow:0 8px 26px rgba(111,87,233,.08), 0 1px 0 rgba(0,0,0,.04);
  }
  header img{height:42px}
  h1{font-size:26px;margin:0;font-weight:800;letter-spacing:.1px}
  .sub{color:var(--muted);margin-top:2px}

  .toolbar{display:grid;grid-template-columns:1fr 180px 160px 160px auto auto;gap:10px;margin:16px 0}
  .input,.select,.btn{height:38px;border:1px solid var(--line);border-radius:10px;background:#fff;padding:0 12px;font:inherit}
  .input{width:100%}
  .select{appearance:none;padding-right:28px;background-image:linear-gradient(45deg, transparent 50%, #869 50%), linear-gradient(135deg, #869 50%, transparent 50%);background-position:calc(100% - 16px) calc(50% - 2px), calc(100% - 10px) calc(50% - 2px);background-size:6px 6px, 6px 6px;background-repeat:no-repeat}
  .btn{background:#f7f5ff;color:#3b2eca;border-color:#ece8ff;font-weight:700;cursor:pointer}
  .btn:hover{background:#eee8ff}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{filter:brightness(.97)}
  .btn.ghost{background:#fff}

  .table-card{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:1200px}
  thead th{position:sticky;top:0;background:#fafaff;border-bottom:1px solid var(--line);text-align:left;font-size:13px;color:#4a4f64;padding:12px}
  tbody td{border-bottom:1px solid var(--line);padding:12px;vertical-align:top}
  tbody tr:hover{background:#fcfbff}
  .muted{color:var(--muted)}
  .mono{font-variant-numeric:tabular-nums}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:3px 8px;border-radius:999px;background:#fff}
  .pill.green{border-color:#dcf3ea;background:#f0fbf7;color:var(--green);font-weight:700}
  .pill.gray{background:#f4f5f9}
  .chip{display:inline-block;border-radius:999px;padding:2px 8px;border:1px solid #eee;background:#fafafa;font-size:12px;color:#5d6480}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .link{color:#362dc7;text-decoration:none}
  .link:hover{text-decoration:underline}

  dialog{border:none;border-radius:18px;padding:0;max-width:960px;width:96%;box-shadow:0 20px 60px rgba(0,0,0,.2)}
  .modal{background:#fff;border-radius:18px;overflow:hidden}
  .modal header{border-radius:18px 18px 0 0}
  .content{padding:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .section{margin:16px 0 8px;font-weight:800;color:#262b3a}
  .row{display:flex;gap:8px;align-items:center}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid #ececf3;padding:8px;text-align:left}
  .tbl th{background:#fafaff}
  .mini{height:34px}
  .right{display:flex;justify-content:flex-end;gap:8px;margin:12px 0 4px}
  .note{font-size:12px;color:var(--muted)}
</style>

<!-- Supabase client with YOUR project credentials -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ✅ Your project credentials
  const SUPABASE_URL = 'https://ijzroisggstkqkfhpjndq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified">
      <div>
        <h1>Order Tracker</h1>
        <div class="sub">Create & track orders with priority, requested-by date, multi-part items, per-leg shipping & GP.</div>
      </div>
    </header>

    <div class="toolbar">
      <input id="q" class="input" placeholder="Search: customer, part number, order id..." />
      <select id="fltSales" class="select">
        <option value="">All salespeople</option>
      </select>
      <select id="fltStatus" class="select">
        <option value="">All status</option>
        <option>New</option><option>Open</option><option>Closed</option>
      </select>
      <select id="fltPriority" class="select">
        <option value="">All priorities</option>
        <option>High</option><option>Normal</option><option>Low</option>
      </select>
      <button id="btnNew" class="btn">+ New Order</button>
      <button id="btnCsv" class="btn ghost">Export CSV</button>
    </div>

    <div class="table-card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Ref</th>
              <th>Sales</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Qty</th>
              <th>Sell</th>
              <th>GP</th>
              <th>Status</th>
              <th>Order&nbsp;Date</th>
              <th>Req.&nbsp;By</th>
              <th>Vendor</th>
              <th>Incoterm</th>
              <th>Terms</th>
              <th>Pay</th>
              <th>Ship Path</th>
              <th>Files</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="dlg">
    <div class="modal">
      <header>
        <div style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between">
          <strong>New Order</strong>
          <button id="btnClose" class="btn ghost mini">✕</button>
        </div>
      </header>
      <div class="content">
        <input type="hidden" id="orderId" />
        <div class="section">SALES — what Sales enters</div>
        <div class="grid2">
          <div>
            <div class="note">Salesperson</div>
            <select id="salesperson" class="select mini"></select>
          </div>
          <div>
            <div class="note">Customer</div>
            <input id="customer" class="input mini" />
          </div>

          <div>
            <div class="note">Priority</div>
            <select id="priority" class="select mini">
              <option>Normal</option><option>High</option><option>Low</option>
            </select>
          </div>
          <div>
            <div class="note">Status</div>
            <select id="status" class="select mini">
              <option>New</option><option>Open</option><option>Closed</option>
            </select>
          </div>

          <div>
            <div class="note">Order Date</div>
            <input id="order_date" type="date" class="input mini" />
          </div>
          <div>
            <div class="note">Requested by</div>
            <input id="requested_by" type="date" class="input mini" />
          </div>

          <div>
            <div class="note">Currency</div>
            <select id="currency" class="select mini">
              <option value="USD">$ USD</option>
              <option value="GBP">£ GBP</option>
              <option value="EUR">€ EUR</option>
            </select>
          </div>
          <div>
            <div class="note">Vendor</div>
            <input id="vendor" class="input mini" />
          </div>

          <div>
            <div class="note">Incoterm</div>
            <div class="row">
              <select id="incoterm" class="select mini" style="flex:1">
                <option>DAP</option><option>DDP</option><option>EXW</option><option>CIP</option><option>FOB</option>
                <option value="Other">Other…</option>
              </select>
              <input id="incoterm_other" class="input mini" placeholder="If Other…" style="flex:1;display:none" />
            </div>
          </div>
          <div>
            <div class="note">Payment Terms</div>
            <div class="row">
              <select id="payment_terms" class="select mini" style="flex:1">
                <option>Net 5</option><option>Net 10</option><option>Net 15</option><option>Net 20</option>
                <option>Net 30</option><option>Net 40</option><option>Net 50</option><option>Net 60</option><option>Net 90</option>
                <option value="Other">Other…</option>
              </select>
              <input id="payment_terms_other" class="input mini" placeholder="If Other…" style="flex:1;display:none" />
            </div>
          </div>

          <div>
            <div class="note">Payment Method</div>
            <div class="row">
              <select id="payment_method" class="select mini" style="flex:1">
                <option>Bank Transfer</option><option>Credit Card</option><option>PayPal</option>
                <option value="Other">Other…</option>
              </select>
              <input id="payment_method_other" class="input mini" placeholder="If Other…" style="flex:1;display:none" />
            </div>
          </div>
          <div>
            <div class="note">Tracking (optional)</div>
            <input id="tracking" class="input mini" />
          </div>
        </div>

        <div class="section">Line Items — parts, date codes & pricing</div>
        <table class="tbl" id="itemsTbl">
          <thead><tr>
            <th style="width:22%">Part Number</th>
            <th style="width:18%">Date Codes</th>
            <th style="width:10%">Qty</th>
            <th style="width:12%">Unit Sell</th>
            <th style="width:12%">Unit Cost</th>
            <th style="width:8%"></th>
          </tr></thead>
          <tbody id="itemsBody"></tbody>
        </table>
        <div class="right"><button id="addItem" class="btn mini">+ Add item</button></div>

        <div class="section">Ship Path — per leg (From → To, Method, Ref, Cost)</div>
        <table class="tbl" id="legsTbl">
          <thead><tr>
            <th>From</th><th>To</th><th>Method</th><th>Ref</th><th style="width:12%">Cost</th><th style="width:8%"></th>
          </tr></thead>
          <tbody id="legsBody"></tbody>
        </table>
        <div class="right"><button id="addLeg" class="btn mini">+ Add leg</button></div>

        <div class="section">Inbound (vendor → us) partial shipments</div>
        <table class="tbl">
          <thead><tr><th style="width:20%">Ship Date</th><th style="width:12%">Qty</th><th>Courier</th><th>Tracking</th><th style="width:8%"></th></tr></thead>
          <tbody id="inboundShipmentsBody"></tbody>
        </table>
        <div class="right"><button id="addInbound" class="btn mini">+ Add inbound</button></div>

        <div class="section">Outbound (us → customer) partial shipments</div>
        <table class="tbl">
          <thead><tr><th style="width:20%">Ship Date</th><th style="width:12%">Qty</th><th>Courier</th><th>Tracking</th><th style="width:8%"></th></tr></thead>
          <tbody id="outboundShipmentsBody"></tbody>
        </table>
        <div class="right"><button id="addOutbound" class="btn mini">+ Add outbound</button></div>

        <div class="grid3" style="margin-top:14px">
          <div>
            <div class="note">Extra shipping cost</div>
            <input id="shipping_cost_extra" type="number" step="0.01" class="input mini mono" placeholder="0.00" />
          </div>
          <div>
            <div class="note">Test cost</div>
            <input id="test_cost" type="number" step="0.01" class="input mini mono" placeholder="0.00" />
          </div>
          <div></div>
        </div>

        <div class="section">Warehouse (for outbound)</div>
        <div class="grid3">
          <div>
            <div class="note">Warehouse Location</div>
            <div class="row">
              <select id="wh_location" class="select mini" style="flex:1">
                <option>UK</option><option>EU</option><option>HK</option><option>CN</option><option value="Other">Other…</option>
              </select>
              <input id="wh_location_other" class="input mini" placeholder="If Other…" style="flex:1;display:none" />
            </div>
          </div>
          <div>
            <div class="note">Courier</div>
            <div class="row">
              <select id="wh_courier" class="select mini" style="flex:1">
                <option>DHL</option><option>FedEx</option><option>UPS</option><option>TNT</option><option value="Other">Other…</option>
              </select>
              <input id="wh_courier_other" class="input mini" placeholder="If Other…" style="flex:1;display:none" />
            </div>
          </div>
          <div>
            <div class="note">Tracking</div>
            <input id="wh_tracking" class="input mini" />
          </div>
        </div>

        <div class="section">Attachments</div>
        <div class="grid2">
          <div>
            <div class="note">Customer PO (for open orders)</div>
            <input id="file_po" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" />
          </div>
          <div>
            <div class="note">Test Report (for closed orders)</div>
            <input id="file_test" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" />
          </div>
        </div>

        <div class="section">Notes</div>
        <textarea id="notes" class="input" style="width:100%;height:80px"></textarea>

        <div class="right">
          <button id="btnDelete" class="btn ghost">Delete</button>
          <button id="btnSave" class="btn primary">Save</button>
        </div>
      </div>
    </div>
  </dialog>

<script>
/* ========================= Helpers ========================= */
const $ = (id) => document.getElementById(id);
const curSym = (c) => ({USD:'$',GBP:'£',EUR:'€'})[c||'USD'] || '$';
const fmt = (n) => (n==null||isNaN(n)) ? '-' : Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtInt = (n)=> (n==null||isNaN(n))?'-': Number(n).toLocaleString();
const shortId = id => id?.slice(0,8)?.toUpperCase() || '';
const todayStr = () => new Date().toISOString().slice(0,10);
const readChoice = (selId, otherId) => {
  const v = $(selId).value;
  if (v==='Other'){ const t=$(otherId).value.trim(); return t||'Other'; }
  return v;
};
function rowButton(txt,cls,click){
  const b=document.createElement('button'); b.textContent=txt; b.className='btn mini '+(cls||''); b.onclick=click; return b;
}

/* =================== Supabase adapter ====================== */
const supa = {
  state:{ orders:[] },
  getOrders(){ return this.state.orders; },

  async loadOrders(){
    const { data, error } = await supabase.from('orders').select(`
      *,
      order_items(*),
      ship_legs(*),
      shipments_inbound(*),
      shipments_outbound(*),
      order_files(*)
    `).order('order_date',{ascending:false, nullsFirst:true}).order('created_at',{ascending:false});
    if(error){ console.error(error); this.state.orders=[]; return; }

    this.state.orders = await Promise.all((data||[]).map(async r=>{
      const items=(r.order_items||[]).map(i=>({part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,unit_sell:i.unit_sell,unit_cost:i.unit_cost}));
      const ship_path=(r.ship_legs||[]).map(l=>({from:l.from_loc,to:l.to_loc,method:l.method,ref:l.ref,cost:l.cost}));
      const inbound=(r.shipments_inbound||[]).map(s=>({date:s.ship_date,qty:s.qty,courier:s.courier,tracking:s.tracking}));
      const outbound=(r.shipments_outbound||[]).map(s=>({date:s.ship_date,qty:s.qty,courier:s.courier,tracking:s.tracking}));

      const filesObj=(r.order_files||[]).reduce((a,f)=>{a[f.kind]=f.path;return a;},{});
      // signed URLs
      let poUrl=null,testUrl=null;
      if(filesObj.po){ const {data:s}=await supabase.storage.from('order-files').createSignedUrl(filesObj.po,3600); poUrl=s?.signedUrl||null; }
      if(filesObj.test_report){ const {data:s}=await supabase.storage.from('order-files').createSignedUrl(filesObj.test_report,3600); testUrl=s?.signedUrl||null; }
      window._sessionFiles ||= {}; window._sessionFiles[r.id]={poUrl,testUrl};

      return {
        id:r.id, created_at:r.created_at,
        salesperson:r.salesperson, customer:r.customer, currency:r.currency||'USD',
        priority:r.priority, status:r.status,
        order_date:r.order_date, requested_by:r.requested_by,
        vendor:r.vendor, tracking:r.tracking,
        incoterm:r.incoterm, payment_terms:r.payment_terms, payment_method:r.payment_method,
        test_cost:r.test_cost, shipping_cost_extra:r.shipping_cost_extra, notes:r.notes,
        wh_location:r.wh_location, wh_courier:r.wh_courier, wh_tracking:r.wh_tracking,
        items, ship_path, inbound_shipments:inbound, outbound_shipments:outbound, files:filesObj
      };
    }));
  },

  async saveOrder(rec, uploads){
    const { data:up, error:e1 } = await supabase.from('orders').upsert({
      id:rec.id, salesperson:rec.salesperson, customer:rec.customer, currency:rec.currency,
      priority:rec.priority, status:rec.status,
      order_date:rec.order_date, requested_by:rec.requested_by,
      vendor:rec.vendor, tracking:rec.tracking,
      incoterm:rec.incoterm, payment_terms:rec.payment_terms, payment_method:rec.payment_method,
      test_cost:rec.test_cost, shipping_cost_extra:rec.shipping_cost_extra, notes:rec.notes,
      wh_location:rec.wh_location, wh_courier:rec.wh_courier, wh_tracking:rec.wh_tracking
    }).select().single();
    if(e1) throw e1;
    const order_id=up.id;

    await supabase.from('order_items').delete().eq('order_id',order_id);
    await supabase.from('ship_legs').delete().eq('order_id',order_id);
    await supabase.from('shipments_inbound').delete().eq('order_id',order_id);
    await supabase.from('shipments_outbound').delete().eq('order_id',order_id);

    if(rec.items?.length) await supabase.from('order_items').insert(rec.items.map(i=>({order_id,part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,unit_sell:i.unit_sell,unit_cost:i.unit_cost})));
    if(rec.ship_path?.length) await supabase.from('ship_legs').insert(rec.ship_path.map(l=>({order_id,from_loc:l.from,to_loc:l.to,method:l.method,ref:l.ref,cost:l.cost})));
    if(rec.inbound_shipments?.length) await supabase.from('shipments_inbound').insert(rec.inbound_shipments.map(s=>({order_id,ship_date:s.date,qty:s.qty,courier:s.courier,tracking:s.tracking})));
    if(rec.outbound_shipments?.length) await supabase.from('shipments_outbound').insert(rec.outbound_shipments.map(s=>({order_id,ship_date:s.date,qty:s.qty,courier:s.courier,tracking:s.tracking})));

    if(uploads?.po) await this.uploadFile(order_id,'po',uploads.po);
    if(uploads?.test_report) await this.uploadFile(order_id,'test_report',uploads.test_report);
  },

  async uploadFile(orderId, kind, file){
    const safe=file.name.replace(/[^a-z0-9._-]+/gi,'_');
    const path=`orders/${orderId}/${kind}/${Date.now()}_${safe}`;
    const { error } = await supabase.storage.from('order-files').upload(path,file,{ upsert:true });
    if(error) throw error;
    await supabase.from('order_files').insert({ order_id:orderId, kind, path });
    const {data:s} = await supabase.storage.from('order-files').createSignedUrl(path,3600);
    window._sessionFiles ||= {}; window._sessionFiles[orderId] ||= {};
    if(kind==='po') window._sessionFiles[orderId].poUrl=s?.signedUrl||null;
    if(kind==='test_report') window._sessionFiles[orderId].testUrl=s?.signedUrl||null;
  },

  async deleteOrder(id){ await supabase.from('orders').delete().eq('id',id); },
  async updateField(id,field,value){ await supabase.from('orders').update({[field]:value}).eq('id',id); },

  subscribeRealtime(){
    supabase.channel('orders-rt')
      .on('postgres_changes', {event:'*', schema:'public', table:'orders'}, async ()=>{ await this.loadOrders(); render(); })
      .on('postgres_changes', {event:'*', schema:'public', table:'order_items'}, async ()=>{ await this.loadOrders(); render(); })
      .on('postgres_changes', {event:'*', schema:'public', table:'ship_legs'}, async ()=>{ await this.loadOrders(); render(); })
      .on('postgres_changes', {event:'*', schema:'public', table:'shipments_inbound'}, async ()=>{ await this.loadOrders(); render(); })
      .on('postgres_changes', {event:'*', schema:'public', table:'shipments_outbound'}, async ()=>{ await this.loadOrders(); render(); })
      .subscribe();
  }
};

/* ======================= UI logic ========================= */
const SALESTEAM = ['Nick N','Dan C','Emir B','Nick K','Jake B'];

function setSalespeople(){
  $('salesperson').innerHTML = SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  $('fltSales').innerHTML = `<option value="">All salespeople</option>` + SALESTEAM.map(n=>`<option>${n}</option>`).join('');
}

function addRowItem(v={part_number:'',date_codes:'',qty:'',unit_sell:'',unit_cost:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="input mini" value="${v.part_number||''}" /></td>
    <td><input class="input mini" value="${v.date_codes||''}" /></td>
    <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
    <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_sell||''}"/></td>
    <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_cost||''}"/></td>
    <td class="right"></td>`;
  tr.lastElementChild.appendChild(rowButton('−','ghost',()=>tr.remove()));
  $('itemsBody').appendChild(tr);
}
function itemsFromDOM(){
  return [...$('itemsBody').querySelectorAll('tr')].map(tr=>{
    const [pn,dc,qty,us,uc] = [...tr.querySelectorAll('input')].map(x=>x.value.trim());
    if(!pn) return null;
    return {part_number:pn,date_codes:dc,qty:Number(qty||0),unit_sell:Number(us||0),unit_cost:Number(uc||0)};
  }).filter(Boolean);
}

function addRowLeg(v={from:'',to:'',method:'',ref:'',cost:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="input mini" value="${v.from||''}" /></td>
    <td><input class="input mini" value="${v.to||''}" /></td>
    <td><input class="input mini" value="${v.method||''}" /></td>
    <td><input class="input mini" value="${v.ref||''}" /></td>
    <td><input type="number" step="0.01" class="input mini mono" value="${v.cost||''}" /></td>
    <td class="right"></td>`;
  tr.lastElementChild.appendChild(rowButton('−','ghost',()=>tr.remove()));
  $('legsBody').appendChild(tr);
}
function legsFromDOM(){
  return [...$('legsBody').querySelectorAll('tr')].map(tr=>{
    const [f,t,m,r,c]=[...tr.querySelectorAll('input')].map(x=>x.value.trim());
    if(!f && !t && !m && !r && !c) return null;
    return {from:f,to:t,method:m,ref:r,cost:Number(c||0)};
  }).filter(Boolean);
}

function addShipmentRow(tbody, v={date:'',qty:'',courier:'',tracking:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="date" class="input mini" value="${v.date||''}" /></td>
    <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}" /></td>
    <td><input class="input mini" value="${v.courier||''}" /></td>
    <td><input class="input mini" value="${v.tracking||''}" /></td>
    <td class="right"></td>`;
  tr.lastElementChild.appendChild(rowButton('−','ghost',()=>tr.remove()));
  $(tbody).appendChild(tr);
}
function getShipmentRows(tbodyId){
  return [...$(tbodyId).querySelectorAll('tr')].map(tr=>{
    const [d,q,c,t] = [...tr.querySelectorAll('input')].map(x=>x.value.trim());
    if(!d && !q && !c && !t) return null;
    return {date:d,qty:Number(q||0),courier:c,tracking:t};
  }).filter(Boolean);
}

function calcTotals(o){
  const revenue = (o.items||[]).reduce((s,i)=>s + (Number(i.qty||0)*Number(i.unit_sell||0)),0);
  const itemCost= (o.items||[]).reduce((s,i)=>s + (Number(i.qty||0)*Number(i.unit_cost||0)),0);
  const shipCost= (o.ship_path||[]).reduce((s,l)=>s + Number(l.cost||0),0) + Number(o.shipping_cost_extra||0);
  const testCost= Number(o.test_cost||0);
  const cost = itemCost + shipCost + testCost;
  const gp = revenue - cost;
  const gpPct = revenue ? (gp/revenue)*100 : 0;
  const qty = (o.items||[]).reduce((s,i)=>s+Number(i.qty||0),0);
  const outbound = (o.outbound_shipments||[]).reduce((s,x)=>s+Number(x.qty||0),0);
  return { revenue, cost, gp, gpPct, qty, outbound };
}

function openModal(o){
  $('orderId').value = o?.id || '';
  $('salesperson').value = o?.salesperson || SALESTEAM[0];
  $('customer').value = o?.customer || '';
  $('priority').value = o?.priority || 'Normal';
  $('status').value = o?.status || 'New';
  $('order_date').value = o?.order_date || todayStr();
  $('requested_by').value = o?.requested_by || '';
  $('currency').value = o?.currency || 'USD';
  $('vendor').value = o?.vendor || '';
  $('tracking').value = o?.tracking || '';
  // incoterm/terms/pay
  $('incoterm').value = (['DAP','DDP','EXW','CIP','FOB'].includes(o?.incoterm)) ? o.incoterm : 'Other';
  $('incoterm_other').style.display = $('incoterm').value==='Other' ? '' : 'none';
  $('incoterm_other').value = ( $('incoterm').value==='Other' ? (o?.incoterm||'') : '' );

  $('payment_terms').value = (['Net 5','Net 10','Net 15','Net 20','Net 30','Net 40','Net 50','Net 60','Net 90'].includes(o?.payment_terms)) ? o.payment_terms : 'Other';
  $('payment_terms_other').style.display = $('payment_terms').value==='Other' ? '' : 'none';
  $('payment_terms_other').value = ( $('payment_terms').value==='Other' ? (o?.payment_terms||'') : '' );

  $('payment_method').value = (['Bank Transfer','Credit Card','PayPal'].includes(o?.payment_method)) ? o.payment_method : 'Other';
  $('payment_method_other').style.display = $('payment_method').value==='Other' ? '' : 'none';
  $('payment_method_other').value = ( $('payment_method').value==='Other' ? (o?.payment_method||'') : '' );

  $('shipping_cost_extra').value = o?.shipping_cost_extra ?? '';
  $('test_cost').value = o?.test_cost ?? '';
  $('wh_location').value = (['UK','EU','HK','CN'].includes(o?.wh_location)) ? o.wh_location : 'Other';
  $('wh_location_other').style.display = $('wh_location').value==='Other' ? '' : 'none';
  $('wh_location_other').value = ($('wh_location').value==='Other'? (o?.wh_location||''):'');
  $('wh_courier').value = (['DHL','FedEx','UPS','TNT'].includes(o?.wh_courier)) ? o.wh_courier : 'Other';
  $('wh_courier_other').style.display = $('wh_courier').value==='Other' ? '' : 'none';
  $('wh_courier_other').value = ($('wh_courier').value==='Other'? (o?.wh_courier||''):'');
  $('wh_tracking').value = o?.wh_tracking || '';
  $('notes').value = o?.notes || '';

  $('itemsBody').innerHTML=''; (o?.items||[{},{},]).forEach(i=>addRowItem(i));
  $('legsBody').innerHTML=''; (o?.ship_path||[]).forEach(l=>addRowLeg(l));
  $('inboundShipmentsBody').innerHTML=''; (o?.inbound_shipments||[]).forEach(s=>addShipmentRow('inboundShipmentsBody',s));
  $('outboundShipmentsBody').innerHTML=''; (o?.outbound_shipments||[]).forEach(s=>addShipmentRow('outboundShipmentsBody',s));

  $('file_po').value=''; $('file_test').value='';

  $('btnDelete').style.display = o?.id ? '' : 'none';

  $('dlg').showModal();
}
function collectRecord(){
  const id = $('orderId').value || crypto.randomUUID();
  return {
    id,
    salesperson:$('salesperson').value,
    customer:$('customer').value.trim(),
    currency:$('currency').value,
    priority:$('priority').value, status:$('status').value,
    order_date:$('order_date').value||null, requested_by:$('requested_by').value||null,
    vendor:$('vendor').value.trim()||null, tracking:$('tracking').value.trim()||null,
    incoterm:readChoice('incoterm','incoterm_other'),
    payment_terms:readChoice('payment_terms','payment_terms_other'),
    payment_method:readChoice('payment_method','payment_method_other'),
    items:itemsFromDOM(),
    ship_path:legsFromDOM(),
    inbound_shipments:getShipmentRows('inboundShipmentsBody'),
    outbound_shipments:getShipmentRows('outboundShipmentsBody'),
    shipping_cost_extra: Number($('shipping_cost_extra').value || 0),
    test_cost: Number($('test_cost').value || 0),
    wh_location:readChoice('wh_location','wh_location_other'),
    wh_courier:readChoice('wh_courier','wh_courier_other'),
    wh_tracking:$('wh_tracking').value.trim()||null,
    notes:$('notes').value.trim()||null
  };
}

function closeModal(){ $('dlg').close(); }

function render(){
  const q=$('q').value.toLowerCase();
  const sSales=$('fltSales').value; const sStat=$('fltStatus').value; const sPri=$('fltPriority').value;

  const rows = supa.getOrders().filter(o=>{
    const text = [o.customer, ...(o.items||[]).map(i=>i.part_number), o.id].join(' ').toLowerCase();
    if(q && !text.includes(q)) return false;
    if(sSales && o.salesperson!==sSales) return false;
    if(sStat && (o.status||'')!==sStat) return false;
    if(sPri && (o.priority||'')!==sPri) return false;
    return true;
  });

  const tb=$('tbody'); tb.innerHTML='';
  rows.forEach(o=>{
    const {revenue,gp,gpPct,qty,outbound} = calcTotals(o);
    const firstPart = (o.items?.[0]?.part_number)||'-';
    const more = (o.items?.length||0)>1 ? ` +${o.items.length-1} more` : '';
    const poUrl = window._sessionFiles?.[o.id]?.poUrl || null;
    const testUrl = window._sessionFiles?.[o.id]?.testUrl || null;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="mono">${shortId(o.id)}</td>
      <td>${o.salesperson||'-'}</td>
      <td>${o.customer||'-'}</td>
      <td><span>${firstPart}</span><span class="muted">${more}</span></td>
      <td class="mono">${fmtInt(qty)}</td>
      <td class="mono">${curSym(o.currency)}${fmt(revenue)}</td>
      <td><span class="pill green">${curSym(o.currency)}${fmt(gp)}</span> <span class="muted mono">(${fmt(gpPct)}%)</span></td>
      <td><span class="chip">${o.status||'-'}</span></td>
      <td class="mono">${o.order_date||'-'}</td>
      <td class="mono">${o.requested_by||'-'}</td>
      <td>${o.vendor||'-'}</td>
      <td>${o.incoterm||'-'}</td>
      <td>${o.payment_terms||'-'}</td>
      <td>${o.payment_method||'-'}</td>
      <td class="mono">${(o.ship_path||[]).map(l=>`${l.from}→${l.to}`).join(' • ')||'-'}</td>
      <td>
        ${poUrl? `<a class="link" target="_blank" href="${poUrl}">PO</a>`:''}
        ${testUrl? ` · <a class="link" target="_blank" href="${testUrl}">Test</a>`:''}
      </td>
      <td class="actions"></td>
    `;
    const act=tr.lastElementChild;
    const btnView=rowButton('View','ghost',()=>alert(summaryText(o)));
    const btnEdit=rowButton('Edit','ghost',()=>openModal(o));
    const btnDel=rowButton('Delete','ghost',async ()=>{
      if(!confirm('Delete this order?'))return;
      await supa.deleteOrder(o.id); await supa.loadOrders(); render();
    });
    act.append(btnView,btnEdit,btnDel);
    tb.appendChild(tr);
  });
}

function summaryText(o){
  const {revenue,cost,gp,gpPct,qty,outbound}=calcTotals(o);
  const parts=(o.items||[]).map(i=>`${i.part_number} (${i.date_codes||'n/a'}) x${i.qty}`).join('\n');
  const legs=(o.ship_path||[]).map(l=>`${l.from} → ${l.to} (${l.method||''}) £${fmt(l.cost)}`).join('\n');
  return `Order ${shortId(o.id)} — ${o.customer}
Sales: ${o.salesperson}   Status: ${o.status}   Priority: ${o.priority}
Order date: ${o.order_date||'-'}   Requested by: ${o.requested_by||'-'}

Items:
${parts || '—'}

Ship path:
${legs || '—'}

Totals:
Qty: ${fmtInt(qty)}
Revenue: ${curSym(o.currency)}${fmt(revenue)}
Cost: ${curSym(o.currency)}${fmt(cost)}
GP: ${curSym(o.currency)}${fmt(gp)} (${fmt(gpPct)}%)

Notes:
${o.notes||'—'}
`;
}

/* ===================== Wire up events ===================== */
$('btnNew').onclick = ()=> openModal(null);
$('btnClose').onclick = closeModal;

$('addItem').onclick = ()=> addRowItem({});
$('addLeg').onclick = ()=> addRowLeg({});
$('addInbound').onclick = ()=> addShipmentRow('inboundShipmentsBody',{});
$('addOutbound').onclick = ()=> addShipmentRow('outboundShipmentsBody',{});

['incoterm','payment_terms','payment_method','wh_location','wh_courier'].forEach(id=>{
  $(id).addEventListener('change',()=>{
    const map={
      incoterm:'incoterm_other',
      payment_terms:'payment_terms_other',
      payment_method:'payment_method_other',
      wh_location:'wh_location_other',
      wh_courier:'wh_courier_other'
    };
    const other=map[id]; if(!other) return;
    $(other).style.display = $(id).value==='Other' ? '' : 'none';
  });
});

$('btnSave').onclick = async ()=>{
  const rec = collectRecord();
  if(!rec.customer){ alert('Customer is required'); return; }
  if(!rec.items?.length){ alert('Add at least one line item'); return; }

  const uploads={};
  if($('file_po').files[0]) uploads.po = $('file_po').files[0];
  if($('file_test').files[0]) uploads.test_report = $('file_test').files[0];

  try{
    await supa.saveOrder(rec, uploads);
    await supa.loadOrders(); render(); closeModal();
  }catch(e){ console.error(e); alert('Save failed. See console.'); }
};

$('btnDelete').onclick = async ()=>{
  const id=$('orderId').value; if(!id) return;
  if(!confirm('Delete this order?')) return;
  await supa.deleteOrder(id); await supa.loadOrders(); render(); closeModal();
};

$('btnCsv').onclick = ()=>{
  const rows=[...$('tbody').querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.innerText.replace(/\s+/g,' ').trim()));
  const head=[...$('tbl thead th')].map(th=>th.innerText);
  const csv=[head,...rows].map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='orders.csv'; a.click();
};

['q','fltSales','fltStatus','fltPriority'].forEach(id=>$(id).addEventListener('input',render));

/* ======================== Init ============================ */
async function init(){
  setSalespeople();
  await supa.loadOrders();
  supa.subscribeRealtime(); // live refresh
  render();
}
init();
</script>
</body>
</html>










