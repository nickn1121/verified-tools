<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Order Tracker — Verified Electronics</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
  :root{
    --brand:#6f57e9; --ink:#1e2330; --muted:#6d7486;
    --bg:#f6f7fb; --card:#fff; --line:#e9e9ef;
    --green:#12a274; --purple:#3b2eca;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  .wrap{max-width:1180px;margin:22px auto;padding:0 16px}
  header{
    display:flex;align-items:center;gap:16px;padding:16px 18px;border:1px solid var(--line);
    border-radius:16px;background:radial-gradient(1100px 220px at 160px -60px, rgba(111,87,233,.15), transparent 60%), #fff;
    box-shadow:0 8px 26px rgba(111,87,233,.08), 0 1px 0 rgba(0,0,0,.04);
  }
  header img{height:42px}
  h1{font-size:26px;margin:0;font-weight:800}
  .sub{color:var(--muted);margin-top:2px}

  .toolbar{display:grid;grid-template-columns:1fr 180px 160px 160px auto auto;gap:10px;margin:16px 0}
  .input,.select,.btn{height:38px;border:1px solid var(--line);border-radius:10px;background:#fff;padding:0 12px;font:inherit}
  .input{width:100%}
  .select{appearance:none;padding-right:28px;background-image:linear-gradient(45deg, transparent 50%, #869 50%), linear-gradient(135deg, #869 50%, transparent 50%);background-position:calc(100% - 16px) calc(50% - 2px), calc(100% - 10px) calc(50% - 2px);background-size:6px 6px, 6px 6px;background-repeat:no-repeat}
  .btn{background:#f7f5ff;color:var(--purple);border-color:#ece8ff;font-weight:700;cursor:pointer}
  .btn:hover{background:#eee8ff}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{filter:brightness(.97)}
  .btn.ghost{background:#fff}

  .table-card{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:1200px}
  thead th{position:sticky;top:0;background:#fafaff;border-bottom:1px solid var(--line);text-align:left;font-size:13px;color:#4a4f64;padding:12px}
  tbody td{border-bottom:1px solid var(--line);padding:12px;vertical-align:top}
  tbody tr:hover{background:#fcfbff}
  .mono{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6f2ec;padding:3px 8px;border-radius:999px;background:#f0fbf7;color:var(--green);font-weight:700}
  .chip{display:inline-block;border-radius:999px;padding:2px 8px;border:1px solid #eee;background:#fafafa;font-size:12px;color:#5d6480}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .link{color:#362dc7;text-decoration:none}
  .link:hover{text-decoration:underline}

  dialog{border:0;padding:0;margin:0 auto;max-width:1200px;width:96vw}
  dialog::backdrop{background:rgba(17,17,33,.35)}
  .modal{display:flex;flex-direction:column;max-height:90vh;border-radius:18px;overflow:hidden;background:#fff}
  .modal header{position:sticky;top:0;z-index:2;border-bottom:1px solid var(--line);border-radius:18px 18px 0 0;background:#fff}
  .modal .head{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .content{padding:16px;overflow:auto;overflow-x:auto;max-height:calc(90vh - 58px);overscroll-behavior:contain}

  .grid2,.grid3{gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr}
  .section{margin:16px 0 8px;font-weight:800;color:#262b3a}
  .row{display:flex;gap:8px;align-items:center}
  .tbl{width:100%;border-collapse:collapse;table-layout:fixed}
  .tbl th,.tbl td{border:1px solid #ececf3;padding:8px;text-align:left;white-space:nowrap}
  .tbl th{background:#fafaff}
  .mini{height:34px}
  .right{display:flex;justify-content:flex-end;gap:8px;margin:12px 0 4px}
  .note{font-size:12px;color:var(--muted)}
  input,select,textarea{min-width:0}

  .hscroll{overflow:auto;border:1px solid #ececf3;border-radius:12px;background:#fff}
  .hscroll table{min-width:1100px}
  .content{padding-bottom:80px}

  @media (max-width:960px){
    .toolbar{grid-template-columns:1fr 1fr 1fr auto auto;gap:8px}
    .grid2,.grid3{grid-template-columns:1fr}
    table{min-width:1000px}
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://ijzroisggstqkfhpjndq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified">
      <div>
        <h1>Order Tracker</h1>
        <div class="sub">Multi-part orders with date codes, priority, requested-by date, tests, multi-leg shipping costs, partial shipments, files & GP.</div>
      </div>
    </header>

    <div class="toolbar">
      <input id="q" class="input" placeholder="Search: customer, part number, order id..."/>
      <select id="fltSales" class="select"><option value="">All salespeople</option></select>
      <select id="fltStatus" class="select"><option value="">All status</option><option>New</option><option>Open</option><option>Closed</option></select>
      <select id="fltPriority" class="select"><option value="">All priorities</option><option>High</option><option>Normal</option><option>Low</option></select>
      <!-- inline onclick as a safety net -->
      <button id="btnNew" class="btn" type="button" onclick="openModal(null)">+ New Order</button>
      <button id="btnCsv" class="btn ghost" type="button">Export CSV</button>
    </div>

    <div class="table-card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Part(s)</th>
              <th>Sales</th>
              <th>Total Qty</th>
              <th>Sell</th>
              <th>GP</th>
              <th>Status</th>
              <th>Order Date</th>
              <th>Requested by</th>
              <th>Age</th>
              <th>Tests</th>
              <th>Vendor</th>
              <th>Incoterm</th>
              <th>Terms</th>
              <th>Files</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <dialog id="dlg">
    <div class="modal">
      <header><div class="head"><strong id="dlgTitle">New Order</strong><button id="btnClose" class="btn ghost mini" type="button">✕</button></div></header>
      <div class="content">
        <input type="hidden" id="orderId"/>

        <div class="section">SALES — what Sales enters</div>
        <div class="grid2">
          <div><div class="note">Salesperson</div><select id="salesperson" class="select mini"></select></div>
          <div><div class="note">Customer</div><input id="customer" class="input mini"/></div>

          <div><div class="note">Priority</div><select id="priority" class="select mini"><option>Normal</option><option>High</option><option>Low</option></select></div>
          <div><div class="note">Status</div><select id="status" class="select mini"><option>New</option><option>Open</option><option>Closed</option></select></div>

          <div><div class="note">Order Date</div><input id="order_date" type="date" class="input mini"/></div>
          <div><div class="note">Requested by</div><input id="requested_by" type="date" class="input mini"/></div>

          <div>
            <div class="note">Payment Terms</div>
            <div class="row">
              <select id="payment_terms" class="select mini" style="flex:1">
                <option>Net 5</option><option>Net 10</option><option>Net 15</option><option>Net 20</option>
                <option>Net 30</option><option>Net 40</option><option>Net 50</option><option>Net 60</option><option>Net 90</option>
                <option value="Other">Other…</option>
              </select>
              <input id="payment_terms_other" class="input mini" placeholder="If Other…" style="flex:1;display:none"/>
            </div>
          </div>
          <div>
            <div class="note">Payment Method</div>
            <div class="row">
              <select id="payment_method" class="select mini" style="flex:1">
                <option>Bank Transfer</option><option>Credit Card</option><option>PayPal</option>
                <option value="Other">Other…</option>
              </select>
              <input id="payment_method_other" class="input mini" placeholder="If Other…" style="flex:1;display:none"/>
            </div>
          </div>

          <div><div class="note">Invoice Date</div><input id="invoice_date" type="date" class="input mini"/></div>
          <div><div class="note">Due Date</div><input id="due_date" type="date" class="input mini"/></div>

          <div>
            <div class="note">Currency</div>
            <select id="currency" class="select mini">
              <option value="USD" selected>USD ($)</option>
              <option value="GBP">GBP (£)</option>
              <option value="EUR">EUR (€)</option>
            </select>
          </div>
          <div></div>
        </div>

        <div class="section">Testing — requirements & center</div>
        <div class="checkline" id="testsLine">
          <label><input type="checkbox" value="No test" id="tNone">No test</label>
          <label><input type="checkbox" value="EVI">EVI</label>
          <label><input type="checkbox" value="Solderability">Solderability</label>
          <label><input type="checkbox" value="Electrical">Electrical</label>
          <label><input type="checkbox" value="Other" id="tOther">Other</label>
          <input id="tests_other" class="input mini" placeholder="Describe other test…" style="max-width:320px"/>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <div class="note">Test Center</div>
            <select id="test_center" class="select mini">
              <option>GETs HK</option><option>GETs Shenzhen</option><option>GETs US</option>
              <option>White Horse US</option><option>White Horse China</option><option>White Horse EU</option>
              <option value="Other">Other…</option>
            </select>
          </div>
          <div>
            <div class="note">Customer PO (file)</div>
            <input id="file_po" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/>
          </div>
        </div>

        <div class="section">Line Items — parts, date codes & pricing</div>
        <div class="hscroll">
          <table class="tbl" id="itemsTbl">
            <thead><tr>
              <th style="width:26%">Part Number</th>
              <th style="width:18%">Date Codes</th>
              <th style="width:10%">Qty</th>
              <th style="width:16%">Unit Sell</th>
              <th style="width:16%">Unit Cost</th>
              <th style="width:8%"></th>
            </tr></thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
        <div class="right"><button id="addItem" class="btn mini" type="button">+ Add item</button></div>

        <div class="section">PURCHASING — what Purchasing updates</div>
        <div class="grid3">
          <div>
            <div class="note">Vendor</div>
            <input id="vendor" class="input mini"/>
          </div>
          <div>
            <div class="note">Incoterm</div>
            <div class="row">
              <select id="incoterm" class="select mini" style="flex:1">
                <option>DAP</option><option>DDP</option><option>EXW</option><option>CIP</option><option>FOB</option>
                <option value="Other">Other…</option>
              </select>
              <input id="incoterm_other" class="input mini" placeholder="If Other…" style="flex:1;display:none"/>
            </div>
          </div>
          <div>
            <div class="note">Test Report (file)</div>
            <input id="file_test" type="file" class="input mini" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/>
          </div>
        </div>

        <div class="section">Shipments — legs & partials (unified)</div>
        <div class="hscroll">
          <table class="tbl" id="shipTbl">
            <thead><tr>
              <th style="width:10%">Kind</th>
              <th style="width:12%">Date</th>
              <th style="width:10%">Qty</th>
              <th style="width:15%">From</th>
              <th style="width:15%">To</th>
              <th style="width:12%">Method</th>
              <th style="width:10%">Ref</th>
              <th style="width:12%">Courier</th>
              <th style="width:16%">Tracking</th>
              <th style="width:10%">Cost</th>
              <th style="width:6%"></th>
            </tr></thead>
            <tbody id="shipBody"></tbody>
          </table>
        </div>
        <div class="right"><button id="addShip" class="btn mini" type="button">+ Add shipment/leg</button></div>

        <div class="grid3" style="margin-top:14px">
          <div>
            <div class="note">Extra shipping cost</div>
            <input id="shipping_cost_extra" type="number" step="0.01" class="input mini mono" placeholder="0.00"/>
          </div>
          <div>
            <div class="note">Test cost</div>
            <input id="test_cost" type="number" step="0.01" class="input mini mono" placeholder="0.00"/>
          </div>
          <div>
            <div class="note">Notes</div>
            <input id="notes" class="input mini"/>
          </div>
        </div>

        <div class="right">
          <button id="btnDelete" class="btn ghost" type="button">Delete</button>
          <button id="btnSave" class="btn primary" type="button">Save</button>
        </div>
      </div>
    </div>
  </dialog>

<script>
const $ = id => document.getElementById(id);
const SALESTEAM = ['Nick N','Dan C','Emir B','Nick K','Jake B'];
const todayStr = () => new Date().toISOString().slice(0,10);
const curSym = c => ({USD:'$',GBP:'£',EUR:'€'})[c||'USD'] || '$';
const fmt = n => (n==null||isNaN(n))?'-':Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtInt = n => (n==null||isNaN(n))?'-':Number(n).toLocaleString();

const supa = {
  state:{orders:[]},
  getOrders(){return this.state.orders;},

  async loadOrders(){
    const {data, error} = await supabase.from('orders').select(`
      *,
      order_items(*),
      ship_legs(*),
      shipments_inbound(*),
      shipments_outbound(*),
      order_files(*)
    `).order('order_date',{ascending:false,nullsFirst:true}).order('created_at',{ascending:false});
    if(error){console.error(error);this.state.orders=[];return;}

    this.state.orders = await Promise.all((data||[]).map(async r=>{
      const items=(r.order_items||[]).map(i=>({part_number:i.part_number,date_codes:i.date_codes,qty:i.qty,unit_sell:i.unit_sell,unit_cost:i.unit_cost}));
      const legs=(r.ship_legs||[]).map(l=>({kind:'Leg',date:'',qty:'',from:l.from_loc,to:l.to_loc,method:l.method,ref:l.ref,cost:l.cost}));
      const inbound=(r.shipments_inbound||[]).map(s=>({kind:'Inbound',date:s.ship_date,qty:s.qty,from:'',to:'',method:'',ref:'',courier:s.courier,tracking:s.tracking,cost:''}));
      const outbound=(r.shipments_outbound||[]).map(s=>({kind:'Outbound',date:s.ship_date,qty:s.qty,from:'',to:'',method:'',ref:'',courier:s.courier,tracking:s.tracking,cost:''}));
      const shipments=[...legs,...inbound,...outbound];

      const files=(r.order_files||[]).reduce((a,f)=>{a[f.kind]=f.path;return a;}, {});
      let poUrl=null,testUrl=null;
      if(files.po){const {data:s}=await supabase.storage.from('order-files').createSignedUrl(files.po,3600);poUrl=s?.signedUrl||null;}
      if(files.test_report){const {data:s}=await supabase.storage.from('order-files').createSignedUrl(files.test_report,3600);testUrl=s?.signedUrl||null;}
      window._sessionFiles ||= {}; window._sessionFiles[r.id]={poUrl,testUrl};

      return {
        id:r.id, created_at:r.created_at,
        salesperson:r.salesperson, customer:r.customer, priority:r.priority, status:r.status,
        order_date:r.order_date, requested_by:r.requested_by,
        payment_terms:r.payment_terms, payment_method:r.payment_method,
        invoice_date:r.invoice_date, due_date:r.due_date,
        currency:r.currency||'USD',
        tests:r.tests||'', test_center:r.test_center||'',
        vendor:r.vendor, incoterm:r.incoterm, notes:r.notes,
        shipping_cost_extra:r.shipping_cost_extra||0, test_cost:r.test_cost||0,
        items, shipments, files
      };
    }));
  },

  async saveOrder(rec, uploads){
    const header = {
      id:rec.id, salesperson:rec.salesperson, customer:rec.customer,
      priority:rec.priority, status:rec.status,
      order_date:rec.order_date, requested_by:rec.requested_by,
      payment_terms:rec.payment_terms, payment_method:rec.payment_method,
      invoice_date:rec.invoice_date, due_date:rec.due_date,
      currency:rec.currency,
      tests:rec.tests, test_center:rec.test_center,
      vendor:rec.vendor, incoterm:rec.incoterm,
      shipping_cost_extra:rec.shipping_cost_extra, test_cost:rec.test_cost,
      notes:rec.notes
    };
    const {data:up, error:e1} = await supabase.from('orders').upsert(header).select().single();
    if(e1) throw e1;
    const order_id=up.id;

    await supabase.from('order_items').delete().eq('order_id',order_id);
    await supabase.from('ship_legs').delete().eq('order_id',order_id);
    await supabase.from('shipments_inbound').delete().eq('order_id',order_id);
    await supabase.from('shipments_outbound').delete().eq('order_id',order_id);

    if(rec.items?.length){
      await supabase.from('order_items').insert(rec.items.map(i=>({
        order_id, part_number:i.part_number, date_codes:i.date_codes, qty:i.qty, unit_sell:i.unit_sell, unit_cost:i.unit_cost
      })));
    }
    const legs = rec.shipments?.filter(s=>s.kind==='Leg')||[];
    const inbound = rec.shipments?.filter(s=>s.kind==='Inbound')||[];
    const outbound = rec.shipments?.filter(s=>s.kind==='Outbound')||[];
    if(legs.length){
      await supabase.from('ship_legs').insert(legs.map(l=>({
        order_id, from_loc:l.from, to_loc:l.to, method:l.method, ref:l.ref, cost: Number(l.cost || 0)   /* ✅ fixed */
      })));
    }
    if(inbound.length){
      await supabase.from('shipments_inbound').insert(inbound.map(s=>({
        order_id, ship_date:s.date||null, qty:Number(s.qty||0), courier:s.courier||null, tracking:s.tracking||null
      })));
    }
    if(outbound.length){
      await supabase.from('shipments_outbound').insert(outbound.map(s=>({
        order_id, ship_date:s.date||null, qty:Number(s.qty||0), courier:s.courier||null, tracking:s.tracking||null
      })));
    }

    if(uploads?.po) await this.uploadFile(order_id,'po',uploads.po);
    if(uploads?.test_report) await this.uploadFile(order_id,'test_report',uploads.test_report);
  },

  async uploadFile(orderId, kind, file){
    const safe=file.name.replace(/[^a-z0-9._-]+/gi,'_');
    const path=`orders/${orderId}/${kind}/${Date.now()}_${safe}`;
    const {error} = await supabase.storage.from('order-files').upload(path,file,{upsert:true});
    if(error) throw error;
    await supabase.from('order_files').insert({order_id:orderId,kind,path});
    const {data:s} = await supabase.storage.from('order-files').createSignedUrl(path,3600);
    window._sessionFiles ||= {}; window._sessionFiles[orderId] ||= {};
    if(kind==='po') window._sessionFiles[orderId].poUrl=s?.signedUrl||null;
    if(kind==='test_report') window._sessionFiles[orderId].testUrl=s?.signedUrl||null;
  },

  async deleteOrder(id){ await supabase.from('orders').delete().eq('id',id); },

  subscribeRealtime(){
    supabase.channel('orders-rt')
      .on('postgres_changes',{event:'*',schema:'public',table:'orders'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'order_items'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'ship_legs'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'shipments_inbound'},async()=>{await this.loadOrders();render();})
      .on('postgres_changes',{event:'*',schema:'public',table:'shipments_outbound'},async()=>{await this.loadOrders();render();})
      .subscribe();
  }
};

function button(txt,cls,click){const b=document.createElement('button');b.textContent=txt;b.className='btn mini '+(cls||'');b.type='button';b.onclick=click;return b;}

function addItemRow(v={part_number:'',date_codes:'',qty:'',unit_sell:'',unit_cost:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="input mini" value="${v.part_number||''}"/></td>
    <td><input class="input mini" value="${v.date_codes||''}"/></td>
    <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
    <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_sell||''}"/></td>
    <td><input type="number" step="0.01" class="input mini mono" value="${v.unit_cost||''}"/></td>
    <td class="right"></td>`;
  tr.lastElementChild.appendChild(button('−','ghost',()=>tr.remove()));
  $('itemsBody').appendChild(tr);
}
function itemsFromDOM(){
  return [...$('itemsBody').querySelectorAll('tr')].map(tr=>{
    const [pn,dc,qty,us,uc]=[...tr.querySelectorAll('input')].map(x=>x.value.trim());
    if(!pn) return null;
    return {part_number:pn,date_codes:dc,qty:Number(qty||0),unit_sell:Number(us||0),unit_cost:Number(uc||0)};
  }).filter(Boolean);
}

function addShipRow(v={kind:'Leg',date:'',qty:'',from:'',to:'',method:'',ref:'',courier:'',tracking:'',cost:''}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>
      <select class="select mini">
        <option ${v.kind==='Leg'?'selected':''}>Leg</option>
        <option ${v.kind==='Inbound'?'selected':''}>Inbound</option>
        <option ${v.kind==='Outbound'?'selected':''}>Outbound</option>
      </select>
    </td>
    <td><input type="date" class="input mini" value="${v.date||''}"/></td>
    <td><input type="number" step="1" class="input mini mono" value="${v.qty||''}"/></td>
    <td><input class="input mini" value="${v.from||''}"/></td>
    <td><input class="input mini" value="${v.to||''}"/></td>
    <td><input class="input mini" value="${v.method||''}"/></td>
    <td><input class="input mini" value="${v.ref||''}"/></td>
    <td><input class="input mini" value="${v.courier||''}"/></td>
    <td><input class="input mini" value="${v.tracking||''}"/></td>
    <td><input type="number" step="0.01" class="input mini mono" value="${v.cost||''}"/></td>
    <td class="right"></td>`;
  tr.lastElementChild.appendChild(button('−','ghost',()=>tr.remove()));
  $('shipBody').appendChild(tr);
}
function shipsFromDOM(){
  return [...$('shipBody').querySelectorAll('tr')].map(tr=>{
    const [kindSel,date,qty,from,to,method,ref,courier,tracking,cost] = [
      tr.querySelector('select').value,
      ...[...tr.querySelectorAll('input')].map(x=>x.value.trim())
    ];
    if(!kindSel && !date && !qty && !from && !to && !method && !ref && !courier && !tracking && !cost) return null;
    return {kind:kindSel,date,qty:Number(qty||0),from,to,method,ref,courier,tracking,cost:Number(cost||0)};
  }).filter(Boolean);
}

function ageDays(d){
  if(!d) return '-';
  const ms = Date.now() - new Date(d).getTime();
  const days = Math.floor(ms/86400000);
  return days<0?'-':`${days} ${days===1?'day':'days'}`;
}
function calcTotals(o){
  const revenue=(o.items||[]).reduce((s,i)=>s+(Number(i.qty||0)*Number(i.unit_sell||0)),0);
  const itemCost=(o.items||[]).reduce((s,i)=>s+(Number(i.qty||0)*Number(i.unit_cost||0)),0);
  const legCost=(o.shipments||[]).filter(s=>s.kind==='Leg').reduce((s,l)=>s+Number(l.cost||0),0);
  const shipCost = legCost + Number(o.shipping_cost_extra||0);
  const testCost = Number(o.test_cost||0);
  const cost = itemCost + shipCost + testCost;
  const gp = revenue - cost;
  const gpPct = revenue ? (gp/revenue)*100 : 0;
  const qty=(o.items||[]).reduce((s,i)=>s+Number(i.qty||0),0);
  return {revenue,cost,gp,gpPct,qty};
}
function render(){
  const q=$('q').value.toLowerCase(), sSales=$('fltSales').value, sStat=$('fltStatus').value, sPri=$('fltPriority').value;
  const rows=supa.getOrders().filter(o=>{
    const text=[o.customer,...(o.items||[]).map(i=>i.part_number),o.id].join(' ').toLowerCase();
    if(q && !text.includes(q)) return false;
    if(sSales && o.salesperson!==sSales) return false;
    if(sStat && (o.status||'')!==sStat) return false;
    if(sPri && (o.priority||'')!==sPri) return false;
    return true;
  });

  const tb=$('tbody'); tb.innerHTML='';
  rows.forEach(o=>{
    const {revenue,gp,gpPct,qty} = calcTotals(o);
    const parts = (o.items?.length? o.items[0].part_number+(o.items.length>1? ` +${o.items.length-1} more`: '') : '-');
    const poUrl = window._sessionFiles?.[o.id]?.poUrl || null;
    const testUrl = window._sessionFiles?.[o.id]?.testUrl || null;
    const sym = curSym(o.currency);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${o.customer||'-'}</td>
      <td>${parts}</td>
      <td>${o.salesperson||'-'}</td>
      <td class="mono">${fmtInt(qty)}</td>
      <td class="mono">${sym}${fmt(revenue)}</td>
      <td><span class="pill">${sym}${fmt(gp)}</span> <span class="muted mono">(${fmt(gpPct)}%)</span></td>
      <td><span class="chip">${o.status||'-'}</span></td>
      <td class="mono">${o.order_date||'-'}</td>
      <td class="mono">${o.requested_by||'-'}</td>
      <td class="mono">${ageDays(o.order_date)}</td>
      <td>${o.tests||'-'}</td>
      <td>${o.vendor||'-'}</td>
      <td>${o.incoterm||'-'}</td>
      <td>${o.payment_terms||'-'}</td>
      <td>${[poUrl?`<a class="link" target="_blank" href="${poUrl}">PO</a>`:'', testUrl?`<a class="link" target="_blank" href="${testUrl}">Test</a>`:''].filter(Boolean).join(' · ')||''}</td>
      <td class="actions"></td>`;
    const act=tr.lastElementChild;
    act.append(
      button('Edit','ghost',()=>openModal(o)),
      button('Delete','ghost',async()=>{ if(!confirm('Delete this order?'))return; await supa.deleteOrder(o.id); await supa.loadOrders(); render(); })
    );
    tb.appendChild(tr);
  });
}

function openModal(o){
  $('dlgTitle').textContent = o?'Edit Order':'New Order';
  $('orderId').value = o?.id || '';
  $('salesperson').value = o?.salesperson || SALESTEAM[0];
  $('customer').value = o?.customer || '';
  $('priority').value = o?.priority || 'Normal';
  $('status').value = o?.status || 'New';
  $('order_date').value = o?.order_date || todayStr();
  $('requested_by').value = o?.requested_by || '';

  $('payment_terms').value = (['Net 5','Net 10','Net 15','Net 20','Net 30','Net 40','Net 50','Net 60','Net 90'].includes(o?.payment_terms)) ? o.payment_terms : 'Other';
  $('payment_terms_other').style.display = $('payment_terms').value==='Other' ? '' : 'none';
  $('payment_terms_other').value = $('payment_terms').value==='Other' ? (o?.payment_terms||'') : '';

  $('payment_method').value = (['Bank Transfer','Credit Card','PayPal'].includes(o?.payment_method)) ? o.payment_method : 'Other';
  $('payment_method_other').style.display = $('payment_method').value==='Other' ? '' : 'none';
  $('payment_method_other').value = $('payment_method').value==='Other' ? (o?.payment_method||'') : '';

  $('invoice_date').value = o?.invoice_date || '';
  $('due_date').value = o?.due_date || '';

  $('currency').value = o?.currency || 'USD';

  [...$('testsLine').querySelectorAll('input[type="checkbox"]')].forEach(cb=>cb.checked=false);
  $('tests_other').value='';
  if(o?.tests){
    const set=new Set(o.tests.split(',').map(s=>s.trim()).filter(Boolean));
    [...$('testsLine').querySelectorAll('input[type="checkbox"]')].forEach(cb=>cb.checked=set.has(cb.value));
    if(set.has('Other')) $('tests_other').value = (o.tests.match(/\(Other:(.*?)\)$/)?.[1] || '');
  }
  $('test_center').value = (['GETs HK','GETs Shenzhen','GETs US','White Horse US','White Horse China','White Horse EU'].includes(o?.test_center)) ? o.test_center : 'Other';

  $('vendor').value = o?.vendor || '';
  $('incoterm').value = (['DAP','DDP','EXW','CIP','FOB'].includes(o?.incoterm)) ? o.incoterm : 'Other';
  $('incoterm_other').style.display = $('incoterm').value==='Other' ? '' : 'none';
  $('incoterm_other').value = $('incoterm').value==='Other' ? (o?.incoterm||'') : '';

  $('itemsBody').innerHTML=''; (o?.items?.length?o.items:[{}]).forEach(addItemRow);
  $('shipBody').innerHTML=''; (o?.shipments||[]).forEach(addShipRow);

  $('shipping_cost_extra').value = o?.shipping_cost_extra ?? '';
  $('test_cost').value = o?.test_cost ?? '';
  $('notes').value = o?.notes || '';

  $('file_po').value=''; $('file_test').value='';
  $('btnDelete').style.display = o?.id ? '' : 'none';
  $('dlg').showModal();
}
function collectRecord(){
  const id = $('orderId').value || crypto.randomUUID();

  const checks=[...$('testsLine').querySelectorAll('input[type="checkbox"]')];
  const none = $('tNone').checked;
  checks.forEach(cb=>{ if(none && cb.value!=='No test') cb.checked=false; });
  const selected = checks.filter(cb=>cb.checked).map(cb=>cb.value);
  if($('tOther').checked){
    const extra = $('tests_other').value.trim();
    if(extra) selected[selected.indexOf('Other')] = 'Other';
  }
  let testsStr = selected.join(', ');
  if(selected.includes('Other')){
    const t = $('tests_other').value.trim();
    if(t) testsStr = testsStr.replace('Other', `Other (Other:${t})`);
  }

  const terms = $('payment_terms').value==='Other' ? $('payment_terms_other').value.trim() : $('payment_terms').value;
  const method = $('payment_method').value==='Other' ? $('payment_method_other').value.trim() : $('payment_method').value;
  const incot = $('incoterm').value==='Other' ? $('incoterm_other').value.trim() : $('incoterm').value;

  return {
    id,
    salesperson:$('salesperson').value,
    customer:$('customer').value.trim(),
    priority:$('priority').value, status:$('status').value,
    order_date:$('order_date').value||null,
    requested_by:$('requested_by').value||null,
    payment_terms:terms||null, payment_method:method||null,
    invoice_date:$('invoice_date').value||null, due_date:$('due_date').value||null,
    currency:$('currency').value||'USD',
    tests:testsStr||null, test_center:$('test_center').value,
    vendor:$('vendor').value.trim()||null, incoterm:incot||null,
    items:itemsFromDOM(),
    shipments:shipsFromDOM(),
    shipping_cost_extra:Number($('shipping_cost_extra').value||0),
    test_cost:Number($('test_cost').value||0),
    notes:$('notes').value.trim()||null
  };
}

function autoDue(){
  const inv=$('invoice_date').value, t=$('payment_terms').value, tother=$('payment_terms_other').value.trim();
  const src = t==='Other'? tother : t;
  const m = src.match(/Net\s+(\d+)/i);
  if(inv && m){ const add=Number(m[1]||0); const d=new Date(inv); d.setDate(d.getDate()+add); $('due_date').value=d.toISOString().slice(0,10); }
}
$('payment_terms').addEventListener('change',()=>{
  $('payment_terms_other').style.display = $('payment_terms').value==='Other' ? '' : 'none';
  autoDue();
});
$('payment_terms_other').addEventListener('input',autoDue);
$('invoice_date').addEventListener('change',autoDue);

$('payment_method').addEventListener('change',()=>{
  $('payment_method_other').style.display = $('payment_method').value==='Other' ? '' : 'none';
});
$('incoterm').addEventListener('change',()=>{
  $('incoterm_other').style.display = $('incoterm').value==='Other' ? '' : 'none';
});

document.addEventListener('DOMContentLoaded', ()=>{
  $('salesperson').innerHTML = SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  $('fltSales').innerHTML = `<option value="">All salespeople</option>` + SALESTEAM.map(n=>`<option>${n}</option>`).join('');
  $('btnNew').addEventListener('click', ()=> openModal(null)); // (inline onclick is also present)
});

$('addItem').onclick=()=>addItemRow({});
$('addShip').onclick=()=>addShipRow({});

$('btnClose').onclick=()=>$('dlg').close();

$('btnSave').onclick=async()=>{
  const rec=collectRecord();
  if(!rec.customer){alert('Customer is required');return;}
  if(!rec.items?.length){alert('Add at least one line item');return;}
  const uploads={};
  if($('file_po').files[0]) uploads.po = $('file_po').files[0];
  if($('file_test').files[0]) uploads.test_report = $('file_test').files[0];
  try{
    await supa.saveOrder(rec,uploads);
    await supa.loadOrders(); render(); $('dlg').close();
  }catch(e){console.error(e); alert('Save failed. See console.');}
};
$('btnDelete').onclick=async()=>{
  const id=$('orderId').value; if(!id) return;
  if(!confirm('Delete this order?'))return;
  await supa.deleteOrder(id); await supa.loadOrders(); render(); $('dlg').close();
};

['q','fltSales','fltStatus','fltPriority'].forEach(id=>$(id).addEventListener('input',render));
$('btnCsv').onclick=()=>{
  const head=[...document.querySelectorAll('#tbl thead th')].map(th=>th.innerText);
  const rows=[...document.querySelectorAll('#tbody tr')].map(tr=>[...tr.children].map(td=>td.innerText.replace(/\s+/g,' ').trim()));
  const csv=[head,...rows].map(r=>r.map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='orders.csv'; a.click();
};

async function init(){
  await supa.loadOrders(); supa.subscribeRealtime(); render();
}
init();
</script>
</body>
</html>



