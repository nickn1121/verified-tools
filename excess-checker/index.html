<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Excess Parts ‚Äî Verified Electronics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --line:#e5e7eb; --panel:#f9fafb;
      --brand:#6d28d9; --brand2:#9333ea;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1080px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:4px 0 18px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{height:54px}
    h1{margin:0;font-size:24px;font-weight:800;letter-spacing:.2px}
    .btn{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border:0;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 28px rgba(17,24,39,.06);padding:18px}
    .stat{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;font-size:12px}
    .tabs{display:flex;gap:8px;margin:8px 0}
    .tab{padding:10px 14px;border-radius:12px;background:#fff;border:1px solid var(--line);cursor:pointer;font-weight:600}
    .tab.active{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border:0}
    .section{display:none;margin-top:12px}
    .section.active{display:block}
    label strong{display:block;margin:6px 0}
    textarea{width:100%;min-height:140px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);resize:vertical}
    input[type="text"],input[type="date"],input[type="number"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink)}
    input[type="file"]{width:100%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
    .hint{font-size:12px;color:var(--muted)}
    .rows{margin-top:14px}
    .row{background:var(--panel);border:1px solid var(--line);padding:10px 12px;border-radius:12px;margin:8px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    footer{margin:26px 2px 10px;color:var(--muted);font-size:12px;text-align:center}
    select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink)}
    .subtle{border:1px dashed var(--line);background:#fff;border-radius:12px;padding:10px}
    .title{font-weight:700;margin-bottom:6px}
    .divider{height:1px;background:var(--line);margin:14px 0}
    a.link{color:#4f46e5;text-decoration:none;font-weight:600}
    .inline{display:flex;gap:10px;align-items:center}
    /* leaderboard */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    td{background:var(--panel);border:1px solid var(--line);padding:12px 10px}
    tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px;text-align:right;font-weight:700}
    .filterbar{display:flex;gap:10px;align-items:center;margin:8px 0}
    .pill{padding:7px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
    .pill.active{background:linear-gradient(90deg,var(--brand),var(--brand2));border:0;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo" src="../assets/Logo_color_white_background (1).png" alt="Verified Electronics" />
        <h1>Excess Part Number Checker</h1>
      </div>
      <a href="/" class="btn ghost">‚Üê Back to Tools</a>
    </header>

    <div class="card">
      <div class="stat">
        <div class="title">üìä Live Excess Inventory</div>
        <div class="chips">
          <span class="chip">Total Part Numbers: <strong id="stat-total">‚Äî</strong></span>
          <span class="chip">Unique Vendors: <strong id="stat-vendors">‚Äî</strong></span>
          <span class="chip">Uploads (Vendor √ó Date): <strong id="stat-batches">‚Äî</strong></span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="tab-search">Search</button>
        <button class="tab" data-tab="tab-upload">Upload</button>
        <button class="tab" data-tab="tab-remove">Remove</button>
        <button class="tab" data-tab="tab-leader">Leaderboard</button>
      </div>

      <!-- SEARCH -->
      <section id="tab-search" class="section active">
        <div class="subtle">
          <div class="title">How to search</div>
          <div class="hint">
            Paste one part number per line, or upload a CSV with a <span class="mono">Part Number</span> column.
            Matching is <b>exact (case-insensitive)</b>.
          </div>
        </div>

        <label for="input-parts"><strong>Paste part numbers (one per line)</strong></label>
        <textarea id="input-parts" class="mono" placeholder="e.g.
LM358DR
STM32F103C8T6
TPS7A4700RGWT"></textarea>

        <div class="controls">
          <div>
            <input type="file" id="file-search" accept=".csv" />
            <div class="hint">CSV must contain a column named <code>Part Number</code>.</div>
          </div>
          <button id="btn-search" class="btn">üîç Check Excess</button>
        </div>

        <div id="search-results" class="rows"></div>
      </section>

      <!-- UPLOAD -->
      <section id="tab-upload" class="section">
        <div class="subtle">
          <div class="title">How to upload</div>
          <div class="hint">
            Option A ‚Äî CSV with headers: <span class="mono">Part Number, Quantity, Vendor</span> (Vendor optional).<br/>
            Option B ‚Äî Paste rows below using: <span class="mono">Part Number, Quantity, Vendor</span>. One row per line.<br/>
            If Vendor is missing, the <b>Fallback Vendor</b> will be used.
            <br/><br/>
            üëâ <a
              class="link"
              href="data:text/csv;charset=utf-8,Part%20Number,Quantity,Vendor%0ATEST123,100,DemoVendor%0ALM358DR,250,DemoVendor%0ASTM32F103C8T6,50,ST"
              download="sample_excess.csv">Download sample CSV</a>
          </div>
        </div>

        <div class="grid">
          <div>
            <label><strong>CSV file (Part Number, Quantity, Vendor)</strong></label>
            <input type="file" id="file-upload" accept=".csv" />
            <div class="hint">Required headers: <span class="mono">Part Number</span>, <span class="mono">Quantity</span>. Optional: <span class="mono">Vendor</span>.</div>
          </div>
          <div>
            <label><strong>Fallback Vendor (if Vendor column/field is missing)</strong></label>
            <input type="text" id="fallback-vendor" placeholder="e.g. ACME Components" />
          </div>
        </div>

        <label style="margin-top:10px"><strong>Or paste rows</strong></label>
        <textarea id="paste-upload" class="mono" placeholder="Examples:
TEST123, 100, DemoVendor
LM358DR, 250
STM32F103C8T6, 50, ST"></textarea>

        <div class="grid" style="margin-top:10px">
          <div>
            <label><strong>Uploaded by</strong></label>
            <div class="inline">
              <select id="uploaded-by" onchange="window.toggleOtherStaff()">
                <option value="">‚Äî Select Staff ‚Äî</option>
                <option value="Nick N">Nick N</option>
                <option value="Nick K">Nick K</option>
                <option value="Jake B">Jake B</option>
                <option value="Dan C">Dan C</option>
                <option value="Emir B">Emir B</option>
                <option value="Other">Other‚Ä¶</option>
              </select>
              <input type="text" id="other-staff" placeholder="Enter staff name" style="display:none;width:50%" />
            </div>
            <div class="hint">Choose a name. If ‚ÄúOther‚Ä¶‚Äù, enter a new staff member.</div>
          </div>
          <div></div>
        </div>

        <div class="controls">
          <button id="btn-upload" class="btn">‚¨ÜÔ∏è Upload Excess</button>
          <span id="upload-status" class="hint mono"></span>
        </div>
      </section>

      <!-- REMOVE -->
      <section id="tab-remove" class="section">
        <div class="subtle">
          <div class="title">How removal works</div>
          <div class="hint">
            Choose a prior upload (Vendor √ó Date) from the list below, then click <b>Remove</b>.
            The list is generated from live data in <span class="mono">excess_parts</span> (view: <span class="mono">excess_uploads</span>).
          </div>
        </div>

        <div class="grid">
          <div>
            <label><strong>Pick an upload (Vendor √ó Date)</strong></label>
            <select id="rm-batch"></select>
            <div class="hint" id="rm-batch-info"></div>
          </div>
          <div>
            <label><strong>‚Ä¶or enter manually</strong></label>
            <div class="grid">
              <input type="text" id="rm-vendor" placeholder="Vendor" />
              <input type="date" id="rm-date" />
            </div>
            <div class="hint">Manual inputs are only used if no item is selected above.</div>
          </div>
        </div>

        <div class="controls">
          <button id="btn-remove" class="btn">üóëÔ∏è Remove Selected Upload</button>
          <span class="hint" id="remove-status"></span>
        </div>

        <div class="divider"></div>

        <div class="title">Recent uploads</div>
        <div id="upload-list" class="rows"></div>
      </section>

      <!-- LEADERBOARD -->
      <section id="tab-leader" class="section">
        <div class="subtle">
          <div class="title">Excess Leaderboard</div>
          <div class="hint">Counts the number of <b>uploads (lists)</b> per employee using <span class="mono">batch_id</span>. Default view is <b>this week</b>.</div>
        </div>

        <div class="filterbar">
          <span class="pill active" data-period="week">This Week</span>
          <span class="pill" data-period="month">This Month</span>
          <span class="pill" data-period="year">This Year</span>
          <span class="pill" data-period="all">All Time</span>
        </div>

        <div class="rows">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Employee</th><th>Lists</th>
              </tr>
            </thead>
            <tbody id="leader-tbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>¬© <span id="year"></span> Verified Electronics</footer>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // === Supabase (your existing values) ===
    const SUPABASE_URL  = "https://ijzroisggstqkfhpjndq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqenJvaXNnZ3N0cWtmaHBqbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzYzMjEsImV4cCI6MjA3MDA1MjMyMX0.ZqI2EiNNROR3Y7MflOeHlAY49N7b89oHA_VcEHVEwjc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
    const $ = (id)=>document.getElementById(id);
    $("year").textContent = new Date().getFullYear();

    // Tabs
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        if (btn.dataset.tab === "tab-leader") loadLeaderboard(currentPeriod);
      });
    });

    // Staff ‚ÄúOther‚Äù
    window.toggleOtherStaff = ()=>{
      const sel = $("uploaded-by").value;
      $("other-staff").style.display = (sel === "Other") ? "block" : "none";
    };
    const getUploader = ()=>{
      const sel = $("uploaded-by").value;
      if (sel === "Other") return $("other-staff").value.trim();
      return sel || "";
    };

    // ---------- Stats ----------
    async function loadStats(){
      try{
        const { count } = await supabase.from("excess_parts").select("*", { count:"exact", head:true });
        $("stat-total").textContent = (count ?? 0).toLocaleString();

        const { data: vendors } = await supabase.from("excess_parts").select("vendor").not("vendor","is",null).limit(10000);
        $("stat-vendors").textContent = vendors ? new Set(vendors.map(v=>v.vendor)).size : "‚Äî";

        // existing view counting vendor√ódate uploads
        const { count: batches } = await supabase.from("excess_uploads").select("*", { count:"exact", head:true });
        $("stat-batches").textContent = (batches ?? 0).toLocaleString();
      }catch{
        $("stat-total").textContent = "‚Äî";
        $("stat-vendors").textContent = "‚Äî";
        $("stat-batches").textContent = "‚Äî";
      }
    }

    // ---------- Upload list + dropdown (Remove tab) ----------
    async function refreshUploadsUI(){
      const list = $("upload-list");
      list.innerHTML = "";
      const sel = $("rm-batch");
      sel.innerHTML = "";

      const { data, error } = await supabase.from("excess_uploads").select("*").order("created_on_utc", { ascending:false }).limit(500);
      if (error){ list.innerHTML = `<div class="row err">Failed to load uploads: ${error.message}</div>`; return; }
      if (!data || data.length===0){ list.innerHTML = `<div class="row">No uploads found yet.</div>`; return; }

      sel.appendChild(new Option("‚Äî Select an upload ‚Äî",""));
      data.forEach(r=>{
        const label = `${r.vendor} ‚Äî ${r.created_on_utc}  (${r.rows_count} rows, ${Number(r.total_qty||0).toLocaleString()} qty)`;
        const val = JSON.stringify({ vendor: r.vendor, date: r.created_on_utc, rows: r.rows_count, qty: r.total_qty });
        sel.appendChild(new Option(label, val));
      });

      sel.addEventListener("change", ()=>{
        if (!sel.value){ $("rm-batch-info").textContent = ""; return; }
        const v = JSON.parse(sel.value);
        $("rm-batch-info").textContent = `Selected: ${v.vendor} on ${v.date} ‚Äî ${v.rows.toLocaleString()} rows (${Number(v.qty||0).toLocaleString()} qty)`;
        $("rm-vendor").value = v.vendor;
        $("rm-date").value = v.date;
      });

      data.slice(0,20).forEach(r=>{
        const el = document.createElement("div");
        el.className = "row";
        el.innerHTML = `<strong>${r.vendor}</strong> ‚Äî ${r.created_on_utc}<br>
          Rows: <b>${r.rows_count.toLocaleString()}</b>, Total Qty: <b>${Number(r.total_qty||0).toLocaleString()}</b>`;
        list.appendChild(el);
      });
    }

    // ---------- CSV helper ----------
    const parseCSV = async (file) => {
      const text = await file.text();
      const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length>0);
      const headers = lines.shift().split(",").map(h=>h.trim().replace(/^"|"$/g,""));
      const rows = lines.map(l=>{
        const cols = l.split(","); const obj = {};
        headers.forEach((h,i)=>obj[h]= (cols[i]??"").trim().replace(/^"|"$/g,""));
        return obj;
      });
      return { headers, rows };
    };
    const cleanQty = (v)=>Number(String(v??"").replace(/[^0-9-]/g,""))||0;
    const dedupUpper = (arr)=>[...new Set(arr.map(s=>s.trim()).filter(Boolean).map(s=>s.toUpperCase()))];

    // ---------- SEARCH ----------
    $("btn-search").addEventListener("click", async ()=>{
      const pasted = $("input-parts").value.split("\n");
      let parts = dedupUpper(pasted);

      const file = $("file-search").files?.[0];
      if (file){
        const { headers, rows } = await parseCSV(file);
        const col = headers.find(h => h.toLowerCase() === "part number");
        if (!col) { alert("CSV needs a 'Part Number' column"); return; }
        parts = dedupUpper([...parts, ...rows.map(r=>r[col])]);
      }

      if (parts.length === 0) { alert("Add some part numbers first."); return; }

      $("btn-search").disabled = true; $("btn-search").textContent = "‚è≥ Searching...";
      const container = $("search-results"); container.innerHTML = "";

      const queries = parts.map(p => supabase.from("excess_parts").select("*").ilike("part_number", p));
      const results = (await Promise.all(queries)).flatMap(r => (r.data ?? []));

      if (results.length === 0){
        container.innerHTML = `<div class="row">No matching parts found.</div>`;
      } else {
        const byPart = results.reduce((m,r)=>{ const k=r.part_number.toUpperCase(); (m[k]??=[]).push(r); return m; }, {});
        Object.keys(byPart).sort().forEach(k=>{
          const totalQty = byPart[k].reduce((a,b)=>a + (Number(b.quantity)||0),0);
          const vendors = [...new Set(byPart[k].map(x=>x.vendor).filter(Boolean))].join(", ");
          const el = document.createElement("div"); el.className = "row";
          el.innerHTML = `<strong>${k}</strong><br>
            ‚Ä¢ Total Qty: <strong>${totalQty.toLocaleString()}</strong><br>
            ‚Ä¢ Vendors: ${vendors || "‚Äî"}`;
          container.appendChild(el);
        });
      }

      $("btn-search").disabled = false; $("btn-search").textContent = "üîç Check Excess";
    });

    // ---------- UPLOAD (RPC) ----------
    $("btn-upload").addEventListener("click", async ()=>{
      const fallbackVendor = $("fallback-vendor").value.trim() || null;
      const uploader = getUploader();
      if (!uploader){ $("upload-status").innerHTML = `<span class="err">Please select or enter 'Uploaded by'.</span>`; return; }

      let rows = [];

      const f = $("file-upload").files?.[0];
      if (f){
        const { headers, rows: csvRows } = await parseCSV(f);
        const hPart = headers.find(h => h.toLowerCase()==="part number");
        const hQty  = headers.find(h => h.toLowerCase()==="quantity");
        const hVend = headers.find(h => h.toLowerCase()==="vendor");
        if (!hPart || !hQty){ $("upload-status").innerHTML = `<span class="err">CSV must include 'Part Number' and 'Quantity'.</span>`; return; }
        rows = rows.concat(csvRows.map(r=>({
          part_number: String(r[hPart]??"").trim().toUpperCase(),
          quantity: cleanQty(r[hQty]),
          vendor: (hVend ? (r[hVend]??"").toString().trim() : "") || fallbackVendor || null,
          uploaded_by: uploader
        })));
      }

      const pasted = $("paste-upload").value.replace(/\r/g,"").split("\n").map(l=>l.trim()).filter(Boolean);
      pasted.forEach(line=>{
        const cols = line.split(",").map(s=>s.trim());
        const pn = (cols[0]??"").toUpperCase();
        const qty = cleanQty(cols[1]??"");
        const vend = (cols[2]??"") || fallbackVendor || null;
        if (pn) rows.push({ part_number: pn, quantity: qty, vendor: vend, uploaded_by: uploader });
      });

      rows = rows.filter(r=>r.part_number && r.quantity >= 0);
      if (!rows.length){ $("upload-status").innerHTML = `<span class="err">Nothing to upload. Add a CSV and/or pasted rows.</span>`; return; }

      $("btn-upload").disabled = true; $("btn-upload").textContent = "‚è≥ Uploading...";
      $("upload-status").textContent = `Uploading ${rows.length} rows‚Ä¶`;

      const { data, error } = await supabase.rpc("excess_bulk_insert", {
        rows, default_vendor: fallbackVendor, uploader
      });

      if (error){
        $("upload-status").innerHTML = `<span class="err">Upload failed: ${error.message}</span>`;
      }else{
        $("upload-status").innerHTML = `<span class="ok">Uploaded ${rows.length.toLocaleString()} rows (batch_id: ${data}).</span>`;
        loadStats(); refreshUploadsUI(); loadLeaderboard(currentPeriod);
      }

      $("btn-upload").disabled = false; $("btn-upload").textContent = "‚¨ÜÔ∏è Upload Excess";
    });

    // ---------- REMOVE ----------
    $("btn-remove").addEventListener("click", async ()=>{
      let vendor = $("rm-vendor").value.trim();
      let date = $("rm-date").value;

      const sel = $("rm-batch").value;
      if (sel){ const v = JSON.parse(sel); vendor = v.vendor; date = v.date; }

      if (!vendor || !date){
        $("remove-status").innerHTML = `<span class="err">Select an upload or fill Vendor + Date.</span>`;
        return;
      }

      $("btn-remove").disabled = true; $("btn-remove").textContent = "‚è≥ Removing‚Ä¶";
      $("remove-status").textContent = "";

      const { data, error } = await supabase.rpc("excess_delete_by_vendor_date", {
        in_vendor: vendor, in_date: date
      });

      if (error){
        $("remove-status").innerHTML = `<span class="err">Delete failed: ${error.message}</span>`;
      } else {
        $("remove-status").innerHTML = `<span class="ok">Deleted ${Number(data||0).toLocaleString()} rows for ${vendor} on ${date}.</span>`;
        loadStats(); refreshUploadsUI(); loadLeaderboard(currentPeriod);
      }

      $("btn-remove").disabled = false; $("btn-remove").textContent = "üóëÔ∏è Remove Selected Upload";
    });

    // ---------- LEADERBOARD ----------
    const STAFF = ["Nick N","Nick K","Jake B","Dan C","Emir B"]; // show even if zero
    let currentPeriod = "week";

    function fmtDate(d){
      const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,"0"), da=String(d.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function startOfWeekUTC(d){
      const day = d.getUTCDay(); // 0..6 (Sun..Sat)
      const diff = (day===0?6:day-1); // ISO Mon=0
      const copy = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
      copy.setUTCDate(copy.getUTCDate()-diff);
      return copy;
    }
    function rangeFor(period){
      const today = new Date();
      const end = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())); // today
      let start;
      if (period==="week"){
        start = startOfWeekUTC(today);
      } else if (period==="month"){
        start = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));
      } else if (period==="year"){
        start = new Date(Date.UTC(today.getUTCFullYear(), 0, 1));
      } else { // all
        start = new Date(Date.UTC(1970,0,1));
      }
      return { from: fmtDate(start), to: fmtDate(end) };
    }

    async function loadLeaderboard(period="week"){
      currentPeriod = period;
      document.querySelectorAll(".pill").forEach(p=>{
        p.classList.toggle("active", p.dataset.period===period);
      });

      const { from, to } = rangeFor(period);
      // one row per batch (upload)
      let q = supabase.from("excess_batches").select("uploaded_by,batch_id,created_on_utc");
      if (period!=="all"){
        q = q.gte("created_on_utc", from).lte("created_on_utc", to);
      }
      const { data, error } = await q.limit(20000);
      const tbody = $("leader-tbody");
      tbody.innerHTML = "";

      if (error){ tbody.innerHTML = `<tr><td colspan="3">Failed to load: ${error.message}</td></tr>`; return; }

      // Count batches per uploader
      const counts = {};
      (data||[]).forEach(r=>{
        const name = r.uploaded_by || "(unknown)";
        counts[name] = (counts[name]||0) + 1;
      });

      // Ensure core staff always present
      STAFF.forEach(n=>{ if(!(n in counts)) counts[n]=0; });

      const rows = Object.entries(counts)
        .sort((a,b)=>b[1]-a[1])
        .map((entry,idx)=>({ rank: idx+1, name: entry[0], lists: entry[1] }));

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="3">No uploads found for this period.</td></tr>`;
        return;
      }

      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.rank}</td><td>${r.name}</td><td>${r.lists}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.querySelectorAll(".pill").forEach(p=>{
      p.addEventListener("click", ()=> loadLeaderboard(p.dataset.period));
    });

    // Init
    loadStats();
    refreshUploadsUI();
    loadLeaderboard("week");
  </script>
</body>
</html>







