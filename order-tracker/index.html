<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Tracker — Verified Electronics</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>

  <style>
    :root{
      --brand:#673ab7; --ink:#1e1e1e; --muted:#677085;
      --bg:#f6f7fb; --card:#fff; --line:#e9e9ef;
      --ok:#0ea773; --warn:#b7791f; --bad:#d1495b; --link:#3a2db1;
      --pill:#efeafd; --pill-b:#e3ddfb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .wrap{max-width:1160px;margin:24px auto;padding:0 16px}

    /* Header */
    header{
      display:flex;align-items:center;gap:14px;
      background:radial-gradient(1200px 260px at 160px -60px, rgba(103,58,183,.18), transparent 60%),linear-gradient(180deg,#fff,#fafaff);
      border:1px solid var(--line); padding:22px 18px; border-radius:18px; box-shadow:0 4px 24px rgba(0,0,0,.04);
    }
    header img{height:40px}
    h1{font-size:28px;margin:0;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:2px}

    /* Toolbar */
    .toolbar{display:grid;grid-template-columns:1.6fr .9fr .9fr .9fr auto auto;gap:10px;margin:16px 0}
    @media (max-width:1100px){ .toolbar{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width:720px){ .toolbar{grid-template-columns:1fr} }
    .input,.select{
      width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;outline:none;
    }
    .input:focus,.select:focus{border-color:#c9c5ef;box-shadow:0 0 0 3px #ebe9ff}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:hover{background:#fafafa}
    .btn-primary{background:var(--pill);border-color:var(--pill-b);color:#3a2db1}
    .btn-primary:hover{background:#eae4ff}
    .btn-danger{border-color:#ffd6dc;background:#ffeff1;color:#a63a49}
    .right{justify-self:end}

    /* Card table */
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 30px rgba(103,58,183,.06),0 1px 0 rgba(0,0,0,.02)}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table thead th{background:#fbfbfe;color:#3b3f55;font-weight:700;padding:12px;border-bottom:1px solid var(--line);position:sticky;top:0}
    .table tbody td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e8e8f5;background:#fbfbff;color:#5a46b6}
    .b-pri{background:#f2f9f5;border-color:#d8efe3;color:#0d7e5b}
    .b-warn{background:#fff7ec;border-color:#ffe3bf;color:#8a6119}
    .b-bad{background:#ffeff1;border-color:#ffd3d9;color:#a63a49}
    .b-dim{background:#f3f4f6;border-color:#e5e7eb;color:#6b7280}

    /* Modal (scroll-safe) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{width:min(980px,100%);max-height:92vh;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 70px rgba(0,0,0,.18);display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line);border-radius:16px 16px 0 0;background:linear-gradient(180deg,#fff,#fbf9ff)}
    .modal .body{padding:16px;overflow:auto}
    .modal .footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;background:#fff;border-radius:0 0 16px 16px}

    /* Section cards inside modal */
    .section{border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
    .section h4{margin:0 0 10px;font-size:13px;letter-spacing:.4px;font-weight:800;color:#382e8c}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    .inline-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hint{font-size:12px;color:var(--muted)}

    /* Tiny "other" input */
    .other-wrap{display:none}
    .other-wrap input{margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header>
      <img src="https://raw.githubusercontent.com/nickn1121/verified-excess-checker/b600d705df19191f9bd1cc2e2b80930cb37259e9/logo.png" alt="Verified Electronics">
      <div style="flex:1">
        <h1>Order Tracker</h1>
        <div class="sub">Create & track orders with priority, ETA, multi-leg shipping; filter by salesperson.</div>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
      <input id="searchInput" class="input" placeholder="Search: customer, part number, order ref..." />
      <div style="display:flex;gap:8px">
        <select id="salesFilter" class="select" title="Filter by salesperson">
          <option value="">All salespeople</option>
        </select>
        <button id="manageSalesBtn" class="btn" title="Manage salespeople">⋯</button>
      </div>
      <select id="statusFilter" class="select">
        <option value="">All status</option>
        <option>New</option><option>PO Raised</option><option>Ordered</option>
        <option>Awaiting Test</option><option>At Test House</option>
        <option>Awaiting Vendor Dispatch</option><option>In Transit</option>
        <option>At Reshipper</option><option>With Us</option>
        <option>Delivered to Customer</option><option>On Hold</option>
        <option>Closed</option><option>Cancelled</option>
      </select>
      <select id="priorityFilter" class="select">
        <option value="">All priorities</option>
        <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
      </select>
      <button id="addOrderBtn" class="btn btn-primary right">+ New Order</button>
      <button id="exportBtn" class="btn right">Export CSV</button>
    </div>

    <!-- Table -->
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Ref</th><th>Sales</th><th>Customer</th><th>Part</th><th>Qty</th>
            <th>Priority</th><th>Status</th><th>Order Date</th><th>ETA</th><th>Age</th>
            <th>Vendor</th><th>Incoterm</th><th>Terms</th><th>Pay</th>
            <th>Ship</th><th>Invoice</th><th>Due</th>
            <th>Ship Path</th><th>Files</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle" style="margin:0;font-size:18px;font-weight:800">New Order</h3>
        <button id="closeModal" class="btn">✕</button>
      </header>

      <div class="body">
        <!-- SALES SECTION -->
        <div class="section">
          <h4>SALES — what Sales enters</h4>
          <div class="grid">
            <div>
              <label>Salesperson</label>
              <select id="salesperson" class="select"></select>
              <div class="hint">Use “⋯” to manage this list.</div>
            </div>
            <div><label>Customer</label><input id="customer" class="input" required></div>

            <div><label>Part Number</label><input id="part_number" class="input" required></div>
            <div><label>Quantity</label><input id="quantity" type="number" min="1" class="input" required></div>

            <div>
              <label>Priority</label>
              <select id="priority" class="select">
                <option>Normal</option><option>High</option><option>Critical</option><option>Low</option>
              </select>
            </div>

            <div>
              <label>Status</label>
              <select id="status" class="select">
                <option>New</option><option>PO Raised</option><option>Ordered</option>
                <option>Awaiting Test</option><option>At Test House</option>
                <option>Awaiting Vendor Dispatch</option><option>In Transit</option>
                <option>At Reshipper</option><option>With Us</option>
                <option>Delivered to Customer</option><option>On Hold</option>
                <option>Closed</option><option>Cancelled</option>
                <option value="__other">Other…</option>
              </select>
              <div id="status_other" class="other-wrap"><input class="input" placeholder="Enter custom status"></div>
            </div>

            <div><label>Order Date</label><input id="order_date" type="date" class="input"></div>
            <div><label>ETA</label><input id="eta" type="date" class="input"></div>

            <div>
              <label>Incoterm</label>
              <select id="incoterm" class="select">
                <option>DAP</option><option>EXW</option><option>FCA</option><option>FOB</option>
                <option>CFR</option><option>CIF</option><option>CPT</option><option>CIP</option>
                <option>DPU</option><option>DDP</option>
                <option value="__other">Other…</option>
              </select>
              <div id="incoterm_other" class="other-wrap"><input class="input" placeholder="Enter custom incoterm"></div>
            </div>

            <div>
              <label>Payment Terms</label>
              <select id="payment_terms" class="select">
                <option>Net 5</option><option>Net 10</option><option>Net 15</option><option>Net 20</option>
                <option selected>Net 30</option><option>Net 40</option><option>Net 50</option>
                <option>Net 60</option><option>Net 90</option>
                <option value="__other">Other…</option>
              </select>
              <div id="payment_terms_other" class="other-wrap"><input class="input" placeholder="Enter custom terms (e.g., Prepaid)"></div>
            </div>

            <div>
              <label>Payment Method</label>
              <select id="payment_method" class="select">
                <option selected>Bank Transfer</option><option>Credit Card</option><option>PayPal</option><option>Other</option>
                <option value="__other">Other…</option>
              </select>
              <div id="payment_method_other" class="other-wrap"><input class="input" placeholder="Enter custom method"></div>
            </div>

            <div style="grid-column:1/-1">
              <label>Customer PO (for open orders)</label>
              <input id="file_po" type="file" accept="application/pdf" class="input">
              <div id="po_note" class="hint" style="margin-top:6px"></div>
            </div>
          </div>
        </div>

        <!-- PURCHASING SECTION -->
        <div class="section">
          <h4>PURCHASING — what Purchasing updates</h4>
          <div class="grid">
            <div><label>Vendor</label><input id="vendor" class="input"></div>
            <div><label>Tracking</label><input id="tracking" class="input"></div>

            <div><label>Ship Date</label><input id="ship_date" type="date" class="input"></div>
            <div class="inline-grid">
              <div>
                <label>Invoice Date</label>
                <input id="invoice_date" type="date" class="input" disabled>
                <div class="hint">Automatically equals Ship Date</div>
              </div>
              <div>
                <label>Due Date</label>
                <input id="due_date" type="date" class="input" disabled>
                <div class="hint">Invoice + Payment Terms</div>
              </div>
            </div>

            <div style="grid-column:1/-1">
              <label>Ship Path (From → To, Method, Ref)</label>
              <div id="shipLegs"></div>
              <div style="margin-top:8px"><button type="button" id="addLegBtn" class="btn">+ Add leg</button></div>
            </div>

            <div style="grid-column:1/-1">
              <label>Test Report (for closed orders)</label>
              <input id="file_test" type="file" accept="application/pdf" class="input">
              <div id="test_note" class="hint" style="margin-top:6px"></div>
            </div>

            <div style="grid-column:1/-1">
              <label>Notes</label>
              <textarea id="notes" rows="3" class="input"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <button id="deleteBtn" class="btn btn-danger" style="display:none">Delete</button>
        <span style="flex:1"></span>
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="saveBtn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Manage Salespeople Modal -->
  <div id="salesOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="salesTitle" style="max-width:560px">
      <header>
        <h3 id="salesTitle" style="margin:0;font-size:18px;font-weight:800">Manage Salespeople</h3>
        <button id="closeSales" class="btn">✕</button>
      </header>
      <div class="body">
        <div class="hint" style="margin-bottom:10px">Add/remove names. Changes apply to filter and the order form.</div>
        <div id="salesList"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <input id="newSalesName" class="input" placeholder="Add name (e.g. Alice S)">
          <button id="addSalesNameBtn" class="btn btn-primary">Add</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======= Local storage keys ======= */
const LS_ORDERS = 've.orders';
const LS_SALES  = 've.salespeople';

/* ======= Defaults ======= */
const DEFAULT_SALES = ["Nick N","Dan C","Emir B","Nick K","Jake B"];

/* ======= Helpers ======= */
const $ = id => document.getElementById(id);
const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
  const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
});
const shortRef = id => id.replace(/-/g,'').slice(0,8).toUpperCase();
const safeName = s => (s||'').replace(/[^a-z0-9._-]+/gi,'_');

const TERM_DAYS = { "Net 5":5,"Net 10":10,"Net 15":15,"Net 20":20,"Net 30":30,"Net 40":40,"Net 50":50,"Net 60":60,"Net 90":90 };

function addDays(dateStr, days){
  if (!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00'); d.setDate(d.getDate() + (days||0));
  return d.toISOString().slice(0,10);
}

/* ======= Salespeople store ======= */
function getSalespeople(){
  try{ const v = JSON.parse(localStorage.getItem(LS_SALES)||'[]'); if (Array.isArray(v) && v.length) return v; }catch{}
  localStorage.setItem(LS_SALES, JSON.stringify(DEFAULT_SALES));
  return [...DEFAULT_SALES];
}
function setSalespeople(arr){ localStorage.setItem(LS_SALES, JSON.stringify(arr)); refreshSalesControls(); }

/* ======= Orders store (local) ======= */
function getOrders(){
  try{ const v = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]'); return Array.isArray(v)?v:[]; }catch{ return []; }
}
function setOrders(arr){ localStorage.setItem(LS_ORDERS, JSON.stringify(arr)); }

/* ======= UI wiring ======= */
const salesFilter = $('salesFilter'), statusFilter=$('statusFilter'), priorityFilter=$('priorityFilter'), searchInput=$('searchInput');
const ordersBody = $('ordersBody');

function refreshSalesControls(){
  const list = getSalespeople();
  salesFilter.innerHTML = '<option value="">All salespeople</option>' + list.map(n=>`<option>${n}</option>`).join('');
  $('salesperson').innerHTML = list.map(n=>`<option>${n}</option>`).join('');
}

/* ======= "Other…" helpers ======= */
function getChoice(selectId, otherWrapId){
  const sel = $(selectId), wrap = $(otherWrapId);
  return sel.value === '__other' ? wrap.querySelector('input').value.trim() : sel.value;
}
function setChoice(selectId, otherWrapId, value, options){
  const sel = $(selectId), wrap=$(otherWrapId);
  if (options.includes(value)) { sel.value = value; wrap.style.display='none'; wrap.querySelector('input').value=''; }
  else { sel.value='__other'; wrap.style.display='block'; wrap.querySelector('input').value=value||''; }
}
function wireOther(selectId, otherWrapId){
  const sel = $(selectId), wrap=$(otherWrapId);
  sel.addEventListener('change', ()=>{ wrap.style.display = sel.value==='__other' ? 'block' : 'none'; if (sel.value!=='__other') wrap.querySelector('input').value=''; });
}

/* ======= Modal open/close ======= */
function openOrderModal(row){
  $('overlay').style.display = 'flex';
  $('modalTitle').textContent = row ? `Edit Order — ${shortRef(row.id)}` : 'New Order';
  $('deleteBtn').style.display = row ? 'inline-block' : 'none';

  $('order_date').valueAsDate = new Date();
  $('invoice_date').value = '';
  $('due_date').value = '';

  $('orderForm')?.reset();
  $('shipLegs').innerHTML = '';
  addShipLeg();

  // clean file notes
  $('po_note').textContent = '';
  $('test_note').textContent = '';

  // defaults
  $('payment_terms').value = 'Net 30';
  $('payment_method').value = 'Bank Transfer';
  $('incoterm').value = 'DAP';

  // reset "other" boxes hidden
  ['status_other','incoterm_other','payment_terms_other','payment_method_other'].forEach(id=>$(id).style.display='none');

  if (row){
    $('orderId').value = row.id;
    $('salesperson').value = row.salesperson||getSalespeople()[0];
    $('customer').value = row.customer||'';
    $('part_number').value = row.part_number||'';
    $('quantity').value = row.quantity||1;
    $('priority').value = row.priority||'Normal';

    setChoice('status','status_other', row.status||'New', [
      'New','PO Raised','Ordered','Awaiting Test','At Test House','Awaiting Vendor Dispatch','In Transit','At Reshipper','With Us','Delivered to Customer','On Hold','Closed','Cancelled'
    ]);
    $('order_date').value = row.order_date||'';
    $('eta').value = row.eta||'';
    $('vendor').value = row.vendor||'';
    $('tracking').value = row.tracking||'';

    setChoice('incoterm','incoterm_other', row.incoterm||'DAP',
      ['DAP','EXW','FCA','FOB','CFR','CIF','CPT','CIP','DPU','DDP']
    );
    setChoice('payment_terms','payment_terms_other', row.payment_terms||'Net 30',
      ['Net 5','Net 10','Net 15','Net 20','Net 30','Net 40','Net 50','Net 60','Net 90']
    );
    setChoice('payment_method','payment_method_other', row.payment_method||'Bank Transfer',
      ['Bank Transfer','Credit Card','PayPal','Other']
    );

    $('ship_date').value = row.ship_date || '';
    if (row.ship_date){
      $('invoice_date').value = row.ship_date;
      const td = getChoice('payment_terms','payment_terms_other');
      $('due_date').value = addDays(row.ship_date, TERM_DAYS[td]||0);
    }

    $('notes').value = row.notes||'';

    const legs = Array.isArray(row.ship_path)?row.ship_path:[];
    $('shipLegs').innerHTML = '';
    if (legs.length===0) addShipLeg(); else legs.forEach(l=>addShipLeg(l.from,l.to,l.method,l.ref));

    if (row.files?.po) $('po_note').textContent = `Existing file: ${row.files.po}`;
    if (row.files?.test_report) $('test_note').textContent = `Existing file: ${row.files.test_report}`;
  } else {
    $('orderId').value = '';
  }
}
function closeOrderModal(){ $('overlay').style.display='none'; }

/* ======= Ship legs ======= */
function addShipLeg(from='',to='',method='',ref=''){
  const wrap = document.createElement('div');
  wrap.className = 'grid';
  wrap.innerHTML = `
    <input class="input" placeholder="From" value="${from||''}">
    <input class="input" placeholder="To" value="${to||''}">
    <input class="input" placeholder="Method (e.g. DHL)" value="${method||''}">
    <div style="display:flex;gap:8px">
      <input class="input" placeholder="Ref" value="${ref||''}">
      <button type="button" class="btn" aria-label="Remove">−</button>
    </div>
  `;
  wrap.querySelector('button').onclick = ()=>wrap.remove();
  $('shipLegs').appendChild(wrap);
}

/* ======= Live invoice/due dates ======= */
function recomputeInvoiceDue(){
  const ship = $('ship_date').value;
  $('invoice_date').value = ship || '';
  const pt = getChoice('payment_terms','payment_terms_other');
  $('due_date').value = ship ? addDays(ship, TERM_DAYS[pt]||0) : '';
}

/* ======= Table helpers ======= */
function badgePriority(p){
  const cls = p==='Critical'?'b-bad':p==='High'?'b-warn':p==='Low'?'b-dim':'b-pri';
  return `<span class="badge ${cls}">${p}</span>`;
}
function badgeStatus(s){
  const done = ['Closed','Delivered to Customer','Cancelled'];
  const warn = ['On Hold','Awaiting Vendor Dispatch','Awaiting Test','At Test House'];
  const cls = done.includes(s)?'b-dim':warn.includes(s)?'b-warn':'b-pri';
  return `<span class="badge ${cls}">${s}</span>`;
}
function shipText(legs){ return (Array.isArray(legs)?legs:[]).map(l=>`${l.from||'?'}→${l.to||'?'}`).join(' • '); }

/* ======= Render ======= */
function loadAndRender(){
  const data = getOrders()
    .sort((a,b)=> (b.order_date||'').localeCompare(a.order_date||'') || (a.priority||'').localeCompare(b.priority||'') );

  const search = (searchInput.value||'').toLowerCase();
  const rows = data.filter(r=>{
    if (salesFilter.value && r.salesperson!==salesFilter.value) return false;
    if (statusFilter.value && r.status!==statusFilter.value) return false;
    if (priorityFilter.value && r.priority!==priorityFilter.value) return false;
    if (!search) return true;
    const blob = `${shortRef(r.id)} ${r.customer} ${r.part_number} ${r.salesperson}`.toLowerCase();
    return blob.includes(search);
  });

  if (!rows.length){
    ordersBody.innerHTML = `<tr><td colspan="20" style="padding:16px;color:var(--muted);text-align:center">No orders yet.</td></tr>`;
    return;
  }

  ordersBody.innerHTML = rows.map(r=>{
    const age = r.order_date ? dayjs(r.order_date).fromNow(true) : '-';
    const files = r.files||{};
    const filesTxt = [files.po?'PO':'' , files.test_report?'Report':''].filter(Boolean).join(' · ');
    const ship = r.ship_date || '';
    const invoice = ship || '';
    const due = ship ? addDays(ship, TERM_DAYS[r.payment_terms]||0) : '';
    return `<tr>
      <td class="mono">${shortRef(r.id)}</td>
      <td>${r.salesperson||''}</td>
      <td>${r.customer||''}</td>
      <td>${r.part_number||''}</td>
      <td>${r.quantity||''}</td>
      <td>${badgePriority(r.priority||'Normal')}</td>
      <td>${badgeStatus(r.status||'New')}</td>
      <td>${r.order_date||''}</td>
      <td>${r.eta||''}</td>
      <td>${age}</td>
      <td>${r.vendor||''}</td>
      <td>${r.incoterm||''}</td>
      <td>${r.payment_terms||''}</td>
      <td>${r.payment_method||''}</td>
      <td>${ship}</td>
      <td>${invoice}</td>
      <td>${due}</td>
      <td>${shipText(r.ship_path)}</td>
      <td>${filesTxt}</td>
      <td><button class="btn" data-edit="${r.id}">Edit</button></td>
    </tr>`;
  }).join('');

  [...ordersBody.querySelectorAll('[data-edit]')].forEach(b=>{
    b.onclick = ()=>{
      const row = getOrders().find(x=>x.id===b.dataset.edit);
      openOrderModal(row);
    };
  });
}

/* ======= Save / Delete ======= */
$('saveBtn').onclick = (e)=>{
  e.preventDefault();
  const id = $('orderId').value || uuid();

  const legs = [...$('shipLegs').children].map(w=>{
    const [from,to,method,ref] = w.querySelectorAll('input');
    return { from:from.value.trim(), to:to.value.trim(), method:method.value.trim(), ref:ref.value.trim() };
  }).filter(l=>l.from||l.to||l.method||l.ref);

  const filesObj = {};
  const fpo = $('file_po').files[0];     if (fpo) filesObj.po = safeName(fpo.name) + ' (pending upload)';
  const ftest = $('file_test').files[0]; if (ftest) filesObj.test_report = safeName(ftest.name) + ' (pending upload)';

  const statusVal = getChoice('status','status_other');
  const termsVal  = getChoice('payment_terms','payment_terms_other');
  const incotermVal = getChoice('incoterm','incoterm_other');
  const methodVal = getChoice('payment_method','payment_method_other');

  const rec = {
    id,
    salesperson: $('salesperson').value,
    customer: $('customer').value.trim(),
    part_number: $('part_number').value.trim(),
    quantity: Number($('quantity').value||0),
    priority: $('priority').value,
    status: statusVal,
    order_date: $('order_date').value || null,
    eta: $('eta').value || null,
    vendor: $('vendor').value.trim() || null,
    tracking: $('tracking').value.trim() || null,
    incoterm: incotermVal,
    payment_terms: termsVal,
    payment_method: methodVal,
    ship_date: $('ship_date').value || null,
    ship_path: legs,
    files: filesObj,
    notes: $('notes').value.trim() || null
  };

  const all = getOrders();
  const i = all.findIndex(x=>x.id===id);
  if (i>=0) all[i]=rec; else all.unshift(rec);
  setOrders(all);

  closeOrderModal();
  loadAndRender();
};

$('deleteBtn').onclick = ()=>{
  const id = $('orderId').value;
  if (!id) return;
  if (!confirm('Delete this order?')) return;
  const all = getOrders().filter(x=>x.id!==id);
  setOrders(all);
  closeOrderModal();
  loadAndRender();
};

/* ======= Manage Salespeople ======= */
function renderSalesMgr(){
  const box = $('salesList'); box.innerHTML='';
  getSalespeople().forEach((name, idx)=>{
    const row = document.createElement('div');
    row.style = 'display:flex;gap:8px;align-items:center;margin:6px 0';
    row.innerHTML = `
      <input class="input" value="${name}">
      <button class="btn btn-danger">Remove</button>
    `;
    const input = row.querySelector('input');
    row.querySelector('button').onclick = ()=>{
      const list = getSalespeople().filter((_,i)=>i!==idx);
      setSalespeople(list);
      renderSalesMgr();
    };
    input.onchange = ()=>{
      const list = getSalespeople(); list[idx] = input.value.trim() || list[idx];
      setSalespeople(list);
      renderSalesMgr();
    };
    box.appendChild(row);
  });
}
$('manageSalesBtn').onclick = ()=>{ $('salesOverlay').style.display='flex'; renderSalesMgr(); };
$('closeSales').onclick = ()=>{ $('salesOverlay').style.display='none'; };
$('addSalesNameBtn').onclick = ()=>{
  const v = $('newSalesName').value.trim(); if (!v) return;
  const list = getSalespeople(); if (!list.includes(v)) list.push(v);
  $('newSalesName').value = '';
  setSalespeople(list);
  renderSalesMgr();
};

/* ======= Export CSV ======= */
$('exportBtn').onclick = ()=>{
  const rows = getOrders();
  const headers = ["Ref","Salesperson","Customer","Part Number","Quantity","Priority","Status","Order Date","ETA","Vendor","Tracking","Incoterm","Payment Terms","Payment Method","Ship Date","Invoice Date","Due Date","Ship Path","Notes"];
  const csvRows = [headers.join(',')];
  rows.forEach(r=>{
    const ship = r.ship_date || ''; const invoice = ship || '';
    const due = ship ? addDays(ship, TERM_DAYS[r.payment_terms]||0) : '';
    const shipPath = shipText(r.ship_path);
    const vals = [shortRef(r.id), r.salesperson, r.customer, r.part_number, r.quantity, r.priority, r.status, r.order_date||'', r.eta||'', r.vendor||'', r.tracking||'', r.incoterm||'', r.payment_terms||'', r.payment_method||'', ship, invoice, due, shipPath, (r.notes||'').replace(/[\n\r]+/g,' ')];
    csvRows.push(vals.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(','));
  });
  const blob = new Blob([csvRows.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'orders.csv'; a.click();
  URL.revokeObjectURL(url);
};

/* ======= Wiring ======= */
['input','change'].forEach(evt=>{
  searchInput.addEventListener(evt, loadAndRender);
  salesFilter.addEventListener(evt, loadAndRender);
  statusFilter.addEventListener(evt, loadAndRender);
  priorityFilter.addEventListener(evt, loadAndRender);
});
$('addOrderBtn').onclick = ()=>openOrderModal();
$('addLegBtn').onclick = ()=>addShipLeg();
$('cancelBtn').onclick = closeOrderModal;
$('closeModal').onclick = closeOrderModal;

// Show/hide "Other…" inputs and recompute due dates
wireOther('status','status_other');
wireOther('incoterm','incoterm_other');
wireOther('payment_terms','payment_terms_other');
wireOther('payment_method','payment_method_other');
$('ship_date').addEventListener('change', recomputeInvoiceDue);
$('payment_terms').addEventListener('change', recomputeInvoiceDue);
$('payment_terms_other').querySelector('input').addEventListener('input', recomputeInvoiceDue);

/* ======= Init ======= */
refreshSalesControls();
loadAndRender();
</script>
</body>
</html>


