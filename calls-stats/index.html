<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Call Leaderboard — Verified Electronics</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f8fb;
    --panel:#ffffff;
    --panel-border:#e9edf5;
    --muted:#6e7482;
    --text:#0f1324;
    --accent:#5b34ff;
    --accent-2:#7b60ff;
    --ring-bg:#eef1f7;
    --ring-fill:#5b34ff;
    --shadow:0 10px 26px rgba(15,19,36,.06);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1000px 400px at 80% -140px,#eef0ff 0%,#f7f8ff 40%,var(--bg) 80%),
      linear-gradient(#fbfcff,var(--bg));
    color:var(--text);
    font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  .wrap{max-width:1200px;margin:auto;padding:28px 16px 80px}
  .title{font-size:30px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);margin-top:6px}

  .panel{
    margin-top:18px;background:var(--panel);border:1px solid var(--panel-border);
    border-radius:18px;box-shadow:var(--shadow);padding:16px
  }

  /* toolbar */
  .toolbar{display:grid;gap:12px;grid-template-columns:140px 170px 1fr auto}
  .toolbar .row{display:flex;gap:10px;align-items:center}
  select,input[type="date"],input[type="text"]{
    background:#fff;border:1px solid #e5e8f2;color:var(--text);
    border-radius:10px;padding:10px 12px;outline:none;width:100%
  }
  input::placeholder{color:#9aa1b8}
  .toggle{display:flex;align-items:center;gap:8px;color:#424b63;font-weight:600}
  .btn{
    background:linear-gradient(180deg,var(--accent) 0%,var(--accent-2) 100%);
    color:#fff;font-weight:800;border:0;border-radius:12px;padding:10px 18px;cursor:pointer;
    box-shadow:0 12px 24px rgba(91,52,255,.25)
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* cards */
  .cards{display:grid;gap:12px;grid-template-columns:repeat(6,minmax(0,1fr));margin-top:14px}
  .card{background:#fff;border:1px solid #edf0f7;border-radius:14px;padding:12px 12px 16px}
  .card h4{color:#8a92a6;margin:0 0 6px 0;font-weight:800;letter-spacing:.2px}
  .card .val{font-size:24px;font-weight:800}
  .mono{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .note{margin-top:10px;color:#687094;font-size:13px}
  .error{color:#d21f3c;font-weight:700}

  /* table */
  .table{margin-top:16px;overflow:auto;border-radius:12px;border:1px solid #edf0f7;background:#fff}
  table{width:100%;border-collapse:collapse}
  thead th{
    position:sticky;top:0;background:#fff;z-index:1;font-weight:800;
    color:#4e5675;font-size:12px;letter-spacing:.3px;text-transform:uppercase;
    padding:12px;border-bottom:1px solid #edf0f7;text-align:left;white-space:nowrap
  }
  tbody td{padding:12px;border-bottom:1px solid #f2f4fb}
  tbody tr:hover td{background:#fafbff}
  .num{text-align:right}

  /* overlay */
  .overlay{
    position:fixed;inset:0;background:rgba(17,19,24,.32);backdrop-filter:blur(2.5px);
    display:none;align-items:center;justify-content:center;z-index:10
  }
  .overlay.show{display:flex}
  .modal{
    background:#fff;border:1px solid #e7e9f2;box-shadow:var(--shadow);
    border-radius:18px;padding:26px 28px;width:420px;text-align:center
  }
  .ring{
    width:90px;height:90px;border-radius:50%;
    background:
      conic-gradient(var(--ring-fill) calc(var(--pct)*1%), var(--ring-bg) 0),
      radial-gradient(farthest-side,#fff 63%,transparent 65% 100%),
      linear-gradient(var(--ring-bg),var(--ring-bg));
    margin:0 auto 16px
  }
  .big{font-weight:900;font-size:18px}
  .small{color:#6b739b;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Call Leaderboard</div>
    <div class="sub">Per-user call time (mm:ss), dials & outcomes — powered by Dialpad Stats and cached per day for speed.</div>

    <div class="panel">
      <div class="toolbar">
        <div class="row">
          <select id="range">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="thisweek" selected>This week</option>
            <option value="last7">Last 7 days</option>
            <option value="thismonth">This month</option>
            <option value="custom">Custom…</option>
          </select>
          <span class="muted" style="font-weight:700">Range</span>
        </div>

        <div class="row" id="customDates" style="display:none">
          <input type="date" id="fromDate">
          <input type="date" id="toDate">
        </div>

        <div class="row">
          <select id="sortBy">
            <option value="duration">Total Duration</option>
            <option value="avg">Avg Duration</option>
            <option value="dials">Dials</option>
            <option value="answered">Answered</option>
            <option value="missed">Missed</option>
            <option value="inbound">Inbound</option>
            <option value="outbound">Outbound</option>
          </select>
          <select id="sortDir">
            <option value="desc" selected>Desc</option>
            <option value="asc">Asc</option>
          </select>
        </div>

        <div class="row">
          <input type="text" id="filter" placeholder="Filter by user email or name"/>
        </div>

        <div class="row" style="justify-content:flex-end;gap:14px">
          <label class="toggle"><input type="checkbox" id="force"> Force refresh</label>
          <button class="btn" id="load">Load</button>
        </div>
      </div>

      <div class="cards">
        <div class="card"><h4>Total calls</h4><div class="val mono" id="k-dials">—</div></div>
        <div class="card"><h4>Inbound</h4><div class="val mono" id="k-in">—</div></div>
        <div class="card"><h4>Outbound</h4><div class="val mono" id="k-out">—</div></div>
        <div class="card"><h4>Answered</h4><div class="val mono" id="k-ans">—</div></div>
        <div class="card"><h4>Missed</h4><div class="val mono" id="k-miss">—</div></div>
        <div class="card"><h4>Avg duration</h4><div class="val mono" id="k-avg">—</div></div>
      </div>

      <div class="table">
        <table id="tbl">
          <thead>
            <tr>
              <th>User</th>
              <th class="num">Dials</th>
              <th class="num">Inbound</th>
              <th class="num">Outbound</th>
              <th class="num">Answered</th>
              <th class="num">Missed</th>
              <th class="num">Total (mm:ss)</th>
              <th class="num">Avg (mm:ss)</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" class="muted" style="padding:22px">Click <b>Load</b> to fetch data.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="note" id="status">Ready.</div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <div class="ring" id="ring" style="--pct:0"></div>
      <div class="big" id="progressLabel">Preparing…</div>
      <div class="small" id="progressSub">Dialpad stats will be cached as we go.</div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const WORKER_BASE = "https://ve-dialpad-proxy.nick-north.workers.dev";
/* ========================= */

const $ = id => document.getElementById(id);
const fmtInt = n => Number(n||0).toLocaleString("en-GB");
const pad2 = n => String(n).padStart(2,"0");

function fmtSecMMSS(secs){
  secs = Math.round(secs||0);
  const m = Math.floor(secs/60);
  const s = secs%60;
  return `${m}:${pad2(s)}`;
}

function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
function dayISO(d){ return new Date(d).toISOString().slice(0,10); }
function daysBetween(from,to){
  const arr=[]; const a=new Date(from); a.setHours(0,0,0,0);
  const b=new Date(to); b.setHours(0,0,0,0);
  for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)) arr.push(dayISO(d));
  return arr;
}

function getRange(){
  const r = $("range").value;
  const now = new Date();
  let f,t;
  if(r==="today"){ f=t=dayISO(now); }
  else if(r==="yesterday"){ const y=new Date(now); y.setDate(y.getDate()-1); f=t=dayISO(y); }
  else if(r==="thisweek"){ f=dayISO(startOfWeek(now)); t=dayISO(endOfWeek(now)); }
  else if(r==="last7"){ const s=new Date(now); s.setDate(s.getDate()-6); f=dayISO(s); t=dayISO(now); }
  else if(r==="thismonth"){ const s=new Date(now.getFullYear(), now.getMonth(), 1); const e=new Date(now.getFullYear(), now.getMonth()+1, 0); f=dayISO(s); t=dayISO(e); }
  else { f=$("fromDate").value; t=$("toDate").value; }
  return { from:f, to:t };
}

function showCustomDates(){
  const isCustom = $("range").value === "custom";
  $("customDates").style.display = isCustom ? "flex" : "none";
}

function mergeAggs(dayAggs){
  const totals = { dials:0, inbound:0, outbound:0, answered:0, missed:0, sumDur:0 };
  const map = new Map();
  for(const d of dayAggs){
    const t=d.totals||{};
    totals.dials    += t.dials    || 0;
    totals.inbound  += t.inbound  || 0;
    totals.outbound += t.outbound || 0;
    totals.answered += t.answered || 0;
    totals.missed   += t.missed   || 0;
    totals.sumDur   += t.sumDur   || 0;
    for(const r of (d.rows||[])){
      if(!map.has(r.user)) map.set(r.user,{user:r.user,dials:0,inbound:0,outbound:0,answered:0,missed:0,duration:0,avg:0});
      const s = map.get(r.user);
      s.dials += r.dials||0; s.inbound += r.inbound||0; s.outbound += r.outbound||0;
      s.answered += r.answered||0; s.missed += r.missed||0; s.duration += r.duration||0;
    }
  }
  const rows = [...map.values()].map(s=>({...s, avg: s.answered ? s.duration/s.answered : 0}));
  return { totals, rows };
}

function render(merged){
  // cards
  $("k-dials").textContent = fmtInt(merged.totals.dials);
  $("k-in").textContent    = fmtInt(merged.totals.inbound);
  $("k-out").textContent   = fmtInt(merged.totals.outbound);
  $("k-ans").textContent   = fmtInt(merged.totals.answered);
  $("k-miss").textContent  = fmtInt(merged.totals.missed);
  const avg = merged.totals.answered ? merged.totals.sumDur / merged.totals.answered : 0;
  $("k-avg").textContent   = fmtSecMMSS(avg);

  // sort/filter
  const by  = $("sortBy").value;
  const dir = $("sortDir").value;
  const q   = $("filter").value.trim().toLowerCase();

  let rows = merged.rows.slice();
  rows = rows.filter(r => !q || (r.user||"").toLowerCase().includes(q));
  rows.sort((a,b)=>{
    const ka = by==="duration"?a.duration: by==="avg"?a.avg: a[by];
    const kb = by==="duration"?b.duration: by==="avg"?b.avg: b[by];
    return dir==="asc" ? (ka-kb) : (kb-ka);
  });

  const tbody = $("tbody"); tbody.innerHTML = "";
  if(!rows.length){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="8" class="muted" style="padding:20px">No matching users.</td>`;
    tbody.appendChild(tr);
    return;
  }

  for(const r of rows){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${r.user || "Unknown"}</td>
      <td class="num mono">${fmtInt(r.dials)}</td>
      <td class="num mono">${fmtInt(r.inbound)}</td>
      <td class="num mono">${fmtInt(r.outbound)}</td>
      <td class="num mono">${fmtInt(r.answered)}</td>
      <td class="num mono">${fmtInt(r.missed)}</td>
      <td class="num mono">${fmtSecMMSS(r.duration)}</td>
      <td class="num mono">${fmtSecMMSS(r.avg)}</td>
    `;
    tbody.appendChild(tr);
  }
}

async function fetchDay(iso, force){
  const u = new URL(WORKER_BASE + "/stats-leaderboard");
  u.searchParams.set("from", iso);
  u.searchParams.set("to",   iso);
  if (force) u.searchParams.set("force","true");
  const r = await fetch(u);
  if(!r.ok) throw new Error(`Leaderboard ${r.status}`);
  return r.json();
}

async function loadLeaderboard(){
  const { from, to } = getRange();
  if(!from || !to) { alert("Choose a valid date range."); return; }

  const days = daysBetween(from,to);
  const force = $("force").checked;

  // overlay
  $("overlay").classList.add("show");
  const ring  = $("ring");
  const label = $("progressLabel");
  const sub   = $("progressSub");

  const parts = [];
  for(let i=0;i<days.length;i++){
    const iso = days[i];
    const pct = Math.round(((i)/days.length)*100);
    ring.style.setProperty("--pct", pct);
    label.textContent = `Loading ${iso}`;
    sub.textContent   = `day ${i+1} of ${days.length}`;
    try{
      const d = await fetchDay(iso, force);
      parts.push(d);
    }catch(e){
      $("overlay").classList.remove("show");
      $("status").innerHTML = `<span class="error">Error: ${e.message || e}</span>`;
      return;
    }
  }
  ring.style.setProperty("--pct", 100);
  label.textContent = `Finishing…`;
  sub.textContent   = `days loaded: ${days.length}`;

  const merged = mergeAggs(parts);
  render(merged);
  $("status").textContent = `Loaded ${days.length} day(s). Cached on the worker for speed.`;

  setTimeout(()=> $("overlay").classList.remove("show"), 200);
}

/* wiring */
$("range").addEventListener("change", ()=>{ showCustomDates(); });
$("load").addEventListener("click", loadLeaderboard);
$("sortBy").addEventListener("change", ()=>{ $("load").click(); });
$("sortDir").addEventListener("change", ()=>{ $("load").click(); });
$("filter").addEventListener("input", ()=>{ $("load").click(); });
showCustomDates();
</script>
</body>
</html>









