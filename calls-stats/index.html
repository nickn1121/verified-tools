<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Call Leaderboard — Verified Electronics</title>
<style>
:root{--brand:#5d34d9;--ink:#1e1e1e;--muted:#667085;--bg:#f6f7fb;--card:#fff;--line:#e9e9ef}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(135deg,#ffffff 0%,#faf8ff 60%,#f4f1ff 100%);border:1px solid var(--line);border-radius:18px;padding:18px 20px;box-shadow:0 10px 40px rgba(93,52,217,.08)}
h1{margin:0;font-size:26px;font-weight:800} .sub{color:var(--muted)}
.badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #ece9ff;background:#f7f5ff;color:#4a33b6}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 30px rgba(93,52,217,.06);padding:16px;margin-top:14px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0}
.input,select{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff}
.btn{background:#5d34d9;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.secondary{background:#efeafd;color:#4a33b6}
.btn:disabled{opacity:.6;cursor:not-allowed}
.kpis{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;margin-top:12px}
@media(max-width:1024px){.kpis{grid-template-columns:repeat(3,1fr)}}
@media(max-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
.kpi .label{color:var(--muted);font-size:12px}.kpi .value{font-size:22px;font-weight:800;margin-top:6px}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:12px;background:#fff;border-top:1px solid var(--line);border-bottom:1px solid var(--line);text-align:left}
th:first-child,td:first-child{border-left:1px solid var(--line);border-top-left-radius:10px;border-bottom-left-radius:10px}
th:last-child,td:last-child{border-right:1px solid var(--line);border-top-right-radius:10px;border-bottom-right-radius:10px}
th.sortable{user-select:none;cursor:pointer} th.sortable:hover{background:#faf8ff}
.right{text-align:right} .small{font-size:12px;color:var(--muted)} .note{color:#4a33b6}
.loading-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(245,244,255,.75);backdrop-filter:blur(2px);z-index:1000}
.loading-overlay.show{display:grid}
.loading-box{display:flex;flex-direction:column;align-items:center;gap:10px;padding:18px 22px;background:#fff;border:1px solid #efeafd;border-radius:14px;box-shadow:0 12px 40px rgba(93,52,217,.15)}
.loader{width:56px;height:56px;border-radius:50%;border:4px solid #e6e2ff;border-top-color:#5d34d9;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}} .loading-text{font-weight:700;color:#5d34d9}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Call Leaderboard</h1>
      <div class="sub">Per-user call time (mm:ss), dials & outcomes — backed by cached hourly aggregates</div>
    </div>
    <span id="rangeInfo" class="badge">This week</span>
  </header>

  <div class="card">
    <div class="controls">
      <label>Range
        <select id="range" class="input">
          <option value="today">Today</option>
          <option value="week" selected>This week</option>
          <option value="month">This month</option>
          <option value="custom">Custom…</option>
        </select>
      </label>
      <input id="from" class="input" type="date" style="display:none">
      <input id="to" class="input" type="date" style="display:none">

      <label>Sort
        <select id="sortBy" class="input">
          <option value="duration" selected>Total Duration</option>
          <option value="avg">Avg Duration</option>
          <option value="dials">Dials</option>
          <option value="answered">Answered</option>
          <option value="missed">Missed</option>
          <option value="outbound">Outbound</option>
          <option value="inbound">Inbound</option>
        </select>
      </label>

      <input id="filterEmail" class="input" placeholder="Filter by user (email or name)">
      <label class="small note"><input type="checkbox" id="force"> Force refresh (bypass cache)</label>
      <button id="load" class="btn">Load</button>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="label">Total calls</div><div id="k_total" class="value">–</div></div>
      <div class="kpi"><div class="label">Inbound</div><div id="k_in" class="value">–</div></div>
      <div class="kpi"><div class="label">Outbound</div><div id="k_out" class="value">–</div></div>
      <div class="kpi"><div class="label">Answered</div><div id="k_ans" class="value">–</div></div>
      <div class="kpi"><div class="label">Missed</div><div id="k_miss" class="value">–</div></div>
      <div class="kpi"><div class="label">Avg duration</div><div id="k_avg" class="value">–</div></div>
    </div>
  </div>

  <div class="card">
    <strong>Leaderboard</strong>
    <table id="board">
      <thead>
        <tr>
          <th class="sortable" data-key="user">User</th>
          <th class="sortable right" data-key="dials">Dials</th>
          <th class="sortable right" data-key="inbound">Inbound</th>
          <th class="sortable right" data-key="outbound">Outbound</th>
          <th class="sortable right" data-key="answered">Answered</th>
          <th class="sortable right" data-key="missed">Missed</th>
          <th class="sortable right" data-key="duration">Total (mm:ss)</th>
          <th class="sortable right" data-key="avg">Avg (mm:ss)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small" id="meta"></div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading" class="loading-overlay" aria-live="polite" aria-busy="true">
  <div class="loading-box">
    <div class="loader" role="progressbar" aria-label="Loading"></div>
    <div id="loadingMsg" class="loading-text">Loading…</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const WORKER_BASE = "https://ve-dialpad-proxy.nick-north.workers.dev";

  const $ = id => document.getElementById(id);
  const setOverlay = (msg='Loading…') => { $('loadingMsg').textContent = msg; $('loading').classList.add('show'); };
  const clearOverlay = () => $('loading').classList.remove('show');

  const fmtMMSS = (seconds) => {
    const s = Math.round(Math.max(0, Number(seconds) || 0));
    const m = Math.floor(s / 60), r = s % 60;
    return `${m}:${String(r).padStart(2,'0')}`;
  };
  const startOfDay = d => { d=new Date(d); d.setHours(0,0,0,0); return d; };
  const endOfDay   = d => { d=new Date(d); d.setHours(23,59,59,999); return d; };
  const iso = d => new Date(d).toISOString().slice(0,10);

  function calcRange(){
    const now = new Date();
    const mode = $('range').value;
    if (mode === 'today'){ $('rangeInfo').textContent = 'Today'; return { from: startOfDay(now), to: endOfDay(now) }; }
    if (mode === 'week'){ const dow = now.getDay(), diff = (dow===0?6:dow-1); const from = startOfDay(new Date(now - diff*86400000)); $('rangeInfo').textContent='This week'; return {from, to:endOfDay(now)}; }
    if (mode === 'month'){ $('rangeInfo').textContent='This month'; return { from:new Date(now.getFullYear(), now.getMonth(), 1), to:endOfDay(now) }; }
    $('rangeInfo').textContent = 'Custom';
    const f = $('from').value, t = $('to').value;
    return { from: startOfDay(f), to: endOfDay(t) };
  }

  async function fetchLeaderboard(fromDateISO, toDateISO, force){
    const u = new URL(WORKER_BASE + "/leaderboard");
    u.searchParams.set('from', fromDateISO);
    u.searchParams.set('to',   toDateISO);
    if (force) u.searchParams.set('force', 'true');
    const r = await fetch(u.toString());
    if (!r.ok) throw new Error(`Leaderboard ${r.status}`);
    return r.json();
  }

  function renderKPIs(t){
    $('k_total').textContent = t.dials ?? 0;
    $('k_in').textContent    = t.inbound ?? 0;
    $('k_out').textContent   = t.outbound ?? 0;
    $('k_ans').textContent   = t.answered ?? 0;
    $('k_miss').textContent  = t.missed ?? 0;
    const avgAnswered = (t.answered && t.sumDur) ? (t.sumDur / t.answered) : 0;
    $('k_avg').textContent   = fmtMMSS(avgAnswered);
  }

  let sortKey = 'duration', sortAsc = false, rowsCache = [];

  function renderTable(rows){
    const q = ($('filterEmail').value || '').trim().toLowerCase();
    const filtered = q ? rows.filter(r => (r.user||'').toLowerCase().includes(q)) : rows;
    filtered.sort((a,b)=>{
      const A = a[sortKey], B = b[sortKey];
      const cmp = (typeof A === 'string') ? A.localeCompare(B) : (A - B);
      return sortAsc ? cmp : -cmp;
    });

    const tbody = document.querySelector('#board tbody');
    tbody.innerHTML = '';
    for (const r of filtered){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.user}</td>
        <td class="right">${r.dials}</td>
        <td class="right">${r.inbound}</td>
        <td class="right">${r.outbound}</td>
        <td class="right">${r.answered}</td>
        <td class="right">${r.missed}</td>
        <td class="right">${fmtMMSS(r.duration)}</td>
        <td class="right">${fmtMMSS(r.avg)}</td>`;
      tbody.appendChild(tr);
    }
  }

  async function load(){
    try{
      setOverlay('Loading leaderboard…');
      const { from, to } = calcRange();
      const fromISO = iso(from), toISO = iso(to);
      const force = $('force').checked;

      const data = await fetchLeaderboard(fromISO, toISO, force);
      rowsCache = data.rows || [];
      renderKPIs(data.totals || {});
      renderTable(rowsCache);

      $('meta').textContent = `Range: ${data.range?.from} → ${data.range?.to} · Pages scanned: ${data.pages ?? '—'}`;
    }catch(e){
      console.error(e);
      alert('Failed to load leaderboard. Check console for details.');
    }finally{
      clearOverlay();
    }
  }

  // UI events
  document.querySelectorAll('#board th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = (key==='user'); }
      renderTable(rowsCache);
    });
  });

  $('range').addEventListener('change', e=>{
    const c = e.target.value === 'custom';
    $('from').style.display = c ? '' : 'none';
    $('to').style.display   = c ? '' : 'none';
  });
  $('sortBy').addEventListener('change', ()=>{
    sortKey = $('sortBy').value; sortAsc = (sortKey === 'user'); renderTable(rowsCache);
  });
  $('filterEmail').addEventListener('input', ()=> renderTable(rowsCache));
  $('load').addEventListener('click', load);

  // First render
  load();
});
</script>
</body>
</html>






