<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Verified — Purchasing Board</title>
<style>
:root{--brand:#6f57e9;--ink:#1e2330;--muted:#6d7486;--bg:#f6f7fb;--card:#fff;--line:#e9e9ef;--chip:#f1f2f7}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:1280px;margin:0 auto;padding:18px}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}.dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0 0}
.tab{padding:7px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#6d7486;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
/* 3 columns: New RFQ | RFQs | Filters  */
.row{display:grid;grid-template-columns:340px 1fr 250px;gap:14px;margin-top:12px}
@media(max-width:1180px){.row{grid-template-columns:340px 1fr}}
@media(max-width:860px){.row{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.bd{padding:12px 14px}
label{display:block;font-size:12px;color:#6d7486;margin:6px 0 3px}
input,select,textarea{width:100%;padding:9px 11px;border:1px solid var(--line);border-radius:9px;background:#fff;font:inherit}
textarea{min-height:70px;resize:vertical}
button{appearance:none;border:0;border-radius:9px;padding:9px 12px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
button.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
button.danger{background:#fff;color:#b91c1c;border:1px solid #fca5a5}
button.icon{padding:6px 8px}
.muted{color:#6d7486}
/* RFQ list cards with verified purple border (compact) */
.rfq-list{display:grid;gap:10px}
.rfq{border:2px solid rgba(111,87,233,.35);border-radius:12px;background:#fff}
.rfq-hd{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:start;padding:10px 12px;border-bottom:1px solid var(--line)}
.rfq-title{font-weight:800}
.meta{display:flex;gap:6px;flex-wrap:wrap;color:#6d7486;font-size:12px}
.badge{padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
.status{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.status.open{background:#eef2ff;color:#3b2eca;border-color:#c7d2fe}
.status.ordered{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
.status.closed{background:#f3f4f6;color:#374151;border-color:#e5e7eb}
.priority{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.priority.low{background:#f3f4f6}
.priority.normal{background:#eef2ff;color:#3b2eca;border-color:#c7d2fe}
.priority.high{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
.priority.urgent{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
.offer-list{padding:8px 12px}
.chip{padding:3px 7px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#fff}
.conf[data-level="1"],.conf[data-level="2"]{background:#fee2e2;border-color:#fecaca;color:#b91c1c}
.conf[data-level="3"]{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
.conf[data-level="4"]{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
.conf[data-level="5"]{background:#e0f2fe;border-color:#bae6fd;color:#075985}
.coverage{height:6px;background:#f3f4f6;border-radius:999px;overflow:hidden}
.coverage>i{display:block;height:100%;background:linear-gradient(90deg,#a78bfa,#60a5fa);width:0%}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.actions .ghost,.actions .danger{padding:6px 8px;font-weight:600}
/* Board */
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.col{background:#fff;border:1px solid var(--line);border-radius:12px}
.col-hd{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line);font-weight:700}
.col-bd{padding:8px}.mini{border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px}.mini .meta{font-size:12px;color:#6d7486}
/* Drawer (read-only) */
dialog{border:0;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:900px;max-width:calc(100vw - 24px)}
dialog.side{width:900px;max-width:900px;margin:0 0 0 auto;height:100%;border-radius:0}
dialog::backdrop{background:rgba(0,0,0,.3)}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:7px 9px;text-align:left} thead th{font-size:12px;color:#6d7486}
tbody tr{background:#fff;border:1px solid var(--line)} tbody tr td:first-child{border-radius:10px 0 0 10px} tbody tr td:last-child{border-radius:0 10px 10px 0}
.toast{position:fixed;bottom:18px;right:18px;background:#111827;color:#fff;padding:10px 12px;border-radius:9px;opacity:0;transform:translateY(10px);transition:.2s}
.toast.show{opacity:1;transform:none}
.empty{padding:24px;border:1px dashed var(--line);border-radius:12px;color:#6d7486;text-align:center;background:#fff}
/* Filters sidebar */
.filters{position:sticky;top:18px}
.filters .bd{display:grid;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand"><span class="dot"></span> Verified — Purchasing Board</div>

  <div id="salesTabs" class="tabs"></div>

  <div class="row">
    <!-- New RFQ -->
    <div class="card">
      <div class="hd"><strong>New RFQ</strong><span class="muted">Sales → Purchasing</span></div>
      <div class="bd">
        <form id="rfqForm">
          <label>Salesperson <span class="muted">(manage list)</span></label>
          <div style="display:flex;gap:8px">
            <select id="salesperson" style="flex:1"></select>
            <button type="button" class="ghost" id="manageSales">✚</button>
          </div>
          <label>Customer</label>
          <input id="customer" placeholder="e.g., Acme Corp" required>
          <label>Part Number</label>
          <input id="partNumber" placeholder="e.g., IPF015N10N5ATMA1" required>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>Quantity</label><input id="quantity" type="number" min="1" step="1" placeholder="e.g., 500" required></div>
            <div><label>Target Price (optional)</label><input id="targetPrice" type="number" min="0" step="0.01" placeholder="e.g., 1.25"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>Priority</label><select id="priority">
              <option>normal</option><option>low</option><option>high</option><option>urgent</option></select></div>
            <div><label>Currency</label><select id="currency"><option>USD</option><option>GBP</option><option>EUR</option></select></div>
          </div>
          <label>Notes</label><textarea id="rfqNotes" placeholder="Any context to help purchasing…"></textarea>
          <div style="display:flex;gap:10px;align-items:center"><button type="submit">Create RFQ</button><span id="rfqHint" class="muted"></span></div>
        </form>
      </div>
    </div>

    <!-- RFQs -->
    <div class="card">
      <div class="hd"><strong id="listTitle">RFQs</strong><div class="muted" id="listMeta">—</div></div>
      <div class="bd">
        <div style="display:flex;gap:8px;margin-bottom:6px;align-items:center">
          <span class="muted">View:</span>
          <button class="ghost" id="viewList" aria-pressed="true">List</button>
          <button class="ghost" id="viewBoard" aria-pressed="false">Board</button>
        </div>
        <div id="rfqList" class="rfq-list"></div>
        <div id="board" class="board" style="display:none"></div>
        <div id="emptyState" class="empty" style="display:none">No RFQs yet for this tab. Create one on the left.</div>
      </div>
    </div>

    <!-- Filters sidebar -->
    <aside class="card filters">
      <div class="hd"><strong>Filters</strong></div>
      <div class="bd">
        <div>
          <label>Search</label>
          <input id="filterSearch" placeholder="Part or customer…"/>
        </div>
        <div>
          <label>Salesperson</label>
          <select id="filterSales"><option>All</option></select>
        </div>
        <div>
          <label>Status</label>
          <select id="filterStatus">
            <option value="all">All statuses</option>
            <option value="open">Open</option>
            <option value="ordered">Sent to Orders</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label>Sort</label>
          <select id="filterSort">
            <option value="created_desc">Newest</option>
            <option value="created_asc">Oldest</option>
            <option value="best_price">Best price</option>
            <option value="lead_time">Lead time</option>
            <option value="priority">Priority</option>
            <option value="coverage">Coverage</option>
          </select>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Read-only Drawer -->
<dialog id="rfqDrawer" class="side">
  <div class="hd"><strong id="drawerTitle">RFQ</strong><span id="drawerMeta" class="muted"></span>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="ghost" id="drawerSend">Send to Orders</button>
      <button class="ghost" id="drawerCloseBtn">Close</button>
    </div>
  </div>
  <div class="bd">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <div style="min-width:110px" class="muted">Coverage</div>
      <div class="coverage" style="flex:1"><i style="width:0%"></i></div>
      <div id="drawerCoverageText" class="muted" style="width:110px;text-align:right">0/0</div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 6px">
      <div><strong>Offers</strong></div>
      <div class="muted">Best price highlighted</div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Vendor</th><th>Loc</th><th>Price</th><th>Cur</th>
          <th>Qty</th><th>MOQ</th><th>LT(d)</th><th>Conf</th><th>Comments</th><th></th>
        </tr>
      </thead>
      <tbody id="offerRows"></tbody>
    </table>

    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
    <div style="display:flex;justify-content:space-between;align-items:center"><strong>Comments</strong><span class="muted" id="cCount"></span></div>
    <div id="comments" style="display:grid;gap:8px;margin-top:6px"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="cAuthor" placeholder="Your name" style="flex:0 0 150px">
      <input id="cText" placeholder="Write a comment…" style="flex:1">
      <button class="ghost" id="cAdd">Add</button>
    </div>
  </div>
</dialog>

<!-- Offer Modal (for Purchasing) -->
<dialog id="offerModal"><form id="offerForm">
  <div class="hd"><strong>Add Offer</strong></div>
  <div class="bd">
    <input type="hidden" id="offer_rfq_id">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Vendor</label><input id="vendor" required></div>
      <div><label>Location</label><input id="location"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Price</label><input id="price" type="number" min="0" step="0.0001" required></div>
      <div><label>Currency</label><select id="offer_currency"><option>USD</option><option>GBP</option><option>EUR</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Qty Offered</label><input id="qty_offer" type="number" min="0" step="1"></div>
      <div><label>MOQ</label><input id="moq" type="number" min="0" step="1"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Lead Time (days)</label><input id="lead_time" type="number" min="0" step="1"></div>
      <div><label>Confidence</label><select id="confidence"><option>5</option><option>4</option><option selected>3</option><option>2</option><option>1</option></select></div>
    </div>
    <div><label>Comments</label><textarea id="offerNotes"></textarea></div>
  </div>
  <div class="bd" style="display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--line)">
    <button type="button" class="ghost" id="offerCancel">Cancel</button>
    <button type="submit">Save Offer</button>
  </div>
</form></dialog>

<!-- toast element -->
<div id="toast" class="toast"></div>

<script>
/* ==== Local store (v9 — adds confirms + delete) ==== */
const K_RFQ='ve_rfqs_v9', K_OFF='ve_offers_v9', K_CMT='ve_comments_v1';
const DEFAULT_SALES = JSON.parse(localStorage.getItem('ve_salespeople')||'null') || ["Emir","Nick K","Dan","Jake","Alan","Howell","Maddy"];
const state={salespeople:[...DEFAULT_SALES], allRFQs:[], offersByRFQ:new Map(), tab:'All', view:'list', active:null};

/* DOM */
const $=s=>document.querySelector(s);
const tabsEl=$("#salesTabs"), rfqListEl=$("#rfqList"), boardEl=$("#board"), emptyEl=$("#emptyState");
const listTitle=$("#listTitle"), listMeta=$("#listMeta");
const fSearch=$("#filterSearch"), fSales=$("#filterSales"), fStatus=$("#filterStatus"), fSort=$("#filterSort");
const viewListBtn=$("#viewList"), viewBoardBtn=$("#viewBoard");
const rfqForm=$("#rfqForm"), salespersonEl=$("#salesperson"), manageSalesBtn=$("#manageSales");
const customerEl=$("#customer"), partEl=$("#partNumber"), qtyEl=$("#quantity"), targetEl=$("#targetPrice"),
      notesEl=$("#rfqNotes"), priorityEl=$("#priority"), currencyEl=$("#currency"), rfqHint=$("#rfqHint");
const offerModal=$("#offerModal"), offerForm=$("#offerForm"), offerCancel=$("#offerCancel");
const rfqDrawer=$("#rfqDrawer"), drawerTitle=$("#drawerTitle"), drawerMeta=$("#drawerMeta"), drawerSendBtn=$("#drawerSend"), drawerCloseBtn=$("#drawerCloseBtn");
const covBar=$("#rfqDrawer .coverage i"), covTxt=$("#drawerCoverageText"), offerRows=$("#offerRows");
const commentsEl=$("#comments"), cAuthorEl=$("#cAuthor"), cTextEl=$("#cText"), cAddBtn=$("#cAdd"), cCountEl=$("#cCount");

/* utils */
const read=k=>JSON.parse(localStorage.getItem(k)||'[]'), write=(k,v)=>localStorage.setItem(k,JSON.stringify(v)), nid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2);
const money=(v,cur)=>{try{return new Intl.NumberFormat(undefined,{style:'currency',currency:cur||'USD'}).format(Number(v))}catch(e){return (cur||'USD')+' '+Number(v).toFixed(2)}};
const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);
const best=os=>os && os.length?os[0]:null;
const coverage=(os,need)=>{const sum=(os||[]).reduce((t,o)=>t+(Number(o.qty_offer)||0),0);return{sum,pct:Math.max(0,Math.min(100,Math.round((sum/Math.max(need||0,1))*100)))}};
function esc(s){return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function onlyDate(iso){return new Date(iso).toLocaleDateString()}
function toast(msg){
  let t=document.getElementById('toast');
  if(!t){t=document.createElement('div');t.id='toast';t.className='toast';document.body.appendChild(t);}
  t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800);
}

/* load */
function loadAll(){
  state.allRFQs=read(K_RFQ).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  const allOff=read(K_OFF); state.offersByRFQ=new Map(state.allRFQs.map(r=>[r.id,[]]));
  allOff.forEach(o=>{const arr=state.offersByRFQ.get(o.rfq_id); if(arr) arr.push(o)});
  for(const arr of state.offersByRFQ.values()){arr.sort((a,b)=>(a.price-b.price)||(b.confidence-a.confidence))}
  render();
}

/* tabs + filters */
function buildSales(){
  const opts=state.salespeople.map(n=>`<option>${n}</option>`).join('');
  salespersonEl.innerHTML=opts; fSales.innerHTML='<option>All</option>'+opts;
}
function buildTabs(){
  tabsEl.innerHTML=''; const names=new Set(['All',...state.salespeople]); state.allRFQs.forEach(r=>names.add(r.salesperson));
  const counts={}; state.allRFQs.forEach(r=>counts[r.salesperson]=(counts[r.salesperson]||0)+1);
  [...names].forEach(n=>{const el=document.createElement('div'); el.className='tab'+(n===state.tab?' active':''); el.textContent=`${n}${n==='All'?` (${state.allRFQs.length})`:` (${counts[n]||0})`}`; el.onclick=()=>{state.tab=n; render()}; tabsEl.appendChild(el)});
}

/* render */
function render(){
  buildTabs(); buildSales();
  viewListBtn.setAttribute('aria-pressed',state.view==='list'); viewBoardBtn.setAttribute('aria-pressed',state.view==='board');
  rfqListEl.style.display=state.view==='list'?'grid':'none'; boardEl.style.display=state.view==='board'?'grid':'none';

  let rfqs=[...state.allRFQs];
  if(state.tab!=='All') rfqs=rfqs.filter(r=>r.salesperson===state.tab);
  if(fSales.value!=='All') rfqs=rfqs.filter(r=>r.salesperson===fSales.value);

  const q=(fSearch.value||'').toLowerCase().trim();
  if(q) rfqs=rfqs.filter(r=>r.part_number.toLowerCase().includes(q) || (r.customer||'').toLowerCase().includes(q));

  const st=fStatus.value; if(st!=='all') rfqs=rfqs.filter(r=>r.status===st);
  rfqs=rfqs.map(r=>({...r,offers:state.offersByRFQ.get(r.id)||[]}));

  const srt=fSort.value;
  if(srt==='created_desc') rfqs.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  if(srt==='created_asc') rfqs.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  if(srt==='best_price') rfqs.sort((a,b)=>((best(a.offers)||{price:Infinity}).price)-((best(b.offers)||{price:Infinity}).price));
  if(srt==='lead_time') rfqs.sort((a,b)=>((best(a.offers)||{lead_time:Infinity}).lead_time||Infinity)-((best(b.offers)||{lead_time:Infinity}).lead_time||Infinity));
  if(srt==='priority'){const sc=p=>({low:1,normal:2,high:3,urgent:4}[p]||0); rfqs.sort((a,b)=>sc(b.priority)-sc(a.priority))}
  if(srt==='coverage') rfqs.sort((a,b)=>coverage(b.offers,b.quantity).pct-coverage(a.offers,a.quantity).pct);

  listTitle.textContent=state.tab==='All'?'RFQs — All':`RFQs — ${state.tab}`; listMeta.textContent=`${rfqs.length} item(s)`;
  if(state.view==='list') renderList(rfqs); else renderBoard(rfqs);
}

function renderList(rfqs){
  rfqListEl.innerHTML=''; if(!rfqs.length){emptyEl.style.display='block'; return} emptyEl.style.display='none';
  rfqs.forEach(r=>{
    const os=r.offers, bo=best(os), cov=coverage(os,r.quantity);
    const el=document.createElement('div'); el.className='rfq'; el.dataset.id=r.id;
    el.innerHTML=`<div class="rfq-hd">
      <div>
        <div class="rfq-title">${r.part_number} <span class="muted">× ${r.quantity.toLocaleString()}</span></div>
        <div class="meta">
          <span class="badge">Customer: ${esc(r.customer||'—')}</span>
          <span class="badge">Sales: ${r.salesperson}</span>
          <span class="badge">Date: ${onlyDate(r.created_at)}</span>
          ${r.target_price?`<span class="badge">Target: ${money(r.target_price,r.currency||'USD')}</span>`:''}
          <span class="status ${r.status}">${r.status==='ordered'?'sent to orders':r.status}</span>
          <span class="priority ${r.priority}">Priority: ${cap(r.priority)}</span>
          <span class="badge">Offers: ${os.length}</span>
          ${bo?`<span class="badge">Best: ${money(bo.price,bo.currency)}</span>`:''}
        </div>
      </div>
      <div class="actions">
        <button class="ghost icon" data-act="view">View Offers</button>
        <button class="ghost icon" data-act="add">Add Offer</button>
        <button class="ghost icon" data-act="send">Send to Orders</button>
        <button class="ghost icon" data-act="close">Close</button>
        <button class="danger icon" data-act="delete">Delete</button>
      </div>
    </div>
    <div class="offer-list">
      <div style="display:flex;align-items:center;gap:8px;margin:4px 0 8px">
        <div style="min-width:110px" class="muted">Coverage</div>
        <div class="coverage" style="flex:1"><i style="width:${cov.pct}%"></i></div>
        <div class="muted" style="width:110px;text-align:right">${cov.sum}/${r.quantity}</div>
      </div>
      ${bo?`<div class="chip"><strong>${esc(bo.vendor)}</strong> • ${esc(bo.location||'—')} • ${money(bo.price,bo.currency)} • ${bo.qty_offer||'—'} pcs • ${bo.lead_time||'—'}d <span class="chip conf" data-level="${bo.confidence}">Conf ${bo.confidence}</span></div>`:`<div class="muted">No offers yet.</div>`}
    </div>`;
    rfqListEl.appendChild(el);
  });
}

/* Board view */
function renderBoard(rfqs){
  boardEl.innerHTML='';
  const g={need:[],partial:[],full:[],sent:[]};
  rfqs.forEach(r=>{const s=coverage(r.offers,r.quantity).sum; if(r.status==='ordered')g.sent.push(r); else if(!s)g.need.push(r); else if(s<r.quantity)g.partial.push(r); else g.full.push(r);});
  [['need','Needs Offers'],['partial','Partially Covered'],['full','Fully Covered'],['sent','Sent to Orders']].forEach(([k,label])=>{
    const col=document.createElement('div'); col.className='col';
    col.innerHTML=`<div class="col-hd">${label}<span class="muted">${g[k].length}</span></div><div class="col-bd"></div>`;
    const bd=col.querySelector('.col-bd');
    g[k].forEach(r=>{const bo=best(r.offers), c=coverage(r.offers,r.quantity); const m=document.createElement('div'); m.className='mini'; m.dataset.id=r.id;
      m.innerHTML=`<div style="font-weight:700">${r.part_number}</div><div class="meta">${esc(r.customer||'—')} • Qty ${r.quantity} • ${r.offers.length} offers${bo?` • Best ${money(bo.price,bo.currency)}`:''} • ${c.sum}/${r.quantity}</div><div style="display:flex;gap:6px;margin-top:6px"><button class="ghost icon" data-a="view">View</button><button class="ghost icon" data-a="add">Add</button><button class="ghost icon" data-a="send">Send</button><button class="ghost icon" data-a="close">Close</button><button class="danger icon" data-a="delete">Delete</button></div>`;
      bd.appendChild(m);
    });
    boardEl.appendChild(col);
  });
}

/* Helpers */
const getRFQ=id=>state.allRFQs.find(r=>String(r.id)===String(id));
function updateRFQ(id,patch){const arr=read(K_RFQ); const i=arr.findIndex(r=>r.id===id); if(i<0){alert('RFQ not found');return} arr[i]={...arr[i],...patch}; write(K_RFQ,arr); loadAll();}

/* Deletion */
function deleteRFQ(id){
  // remove rfq
  const rfqs=read(K_RFQ).filter(r=>r.id!==id); write(K_RFQ,rfqs);
  // cascade offers/comments
  const off=read(K_OFF).filter(o=>o.rfq_id!==id); write(K_OFF,off);
  const com=read(K_CMT).filter(c=>c.rfq_id!==id); write(K_CMT,com);
  if(state.active && state.active.id===id){ try{ rfqDrawer.close(); }catch(e){} state.active=null; }
  toast('RFQ deleted'); loadAll();
}
function deleteOffer(offerId){
  const off=read(K_OFF).filter(o=>o.id!==offerId); write(K_OFF,off);
  toast('Offer deleted');
  loadAll();
  if(state.active){ const r=getRFQ(state.active.id); if(r) openDrawer(r,true); }
}

/* Form submit */
rfqForm.addEventListener('submit',e=>{
  e.preventDefault();
  const rfq={ id:nid(), created_at:new Date().toISOString(), salesperson:salespersonEl.value,
    customer:customerEl.value.trim(), part_number:partEl.value.trim(), quantity:Number(qtyEl.value),
    target_price:targetEl.value?Number(targetEl.value):null, priority:priorityEl.value||'normal',
    currency:currencyEl.value||'USD', notes:notesEl.value||null, status:'open'
  };
  if(!rfq.salesperson||!rfq.customer||!rfq.part_number||!rfq.quantity){toast('Please fill required fields');return}
  rfqHint.textContent='Saving…'; const arr=read(K_RFQ); arr.push(rfq); write(K_RFQ,arr); rfqHint.textContent=''; toast('RFQ created'); rfqForm.reset(); state.tab=rfq.salesperson; loadAll();
});

manageSalesBtn.addEventListener('click',()=>{
  const val=prompt('Add salesperson (or edit list CSV):',state.salespeople.join(', ')); if(val==null)return;
  state.salespeople=val.split(',').map(s=>s.trim()).filter(Boolean); localStorage.setItem('ve_salespeople',JSON.stringify(state.salespeople)); buildSales(); buildTabs();
});

/* Filters & view */
['input','change'].forEach(ev=>{
  fSearch.addEventListener(ev,render); fSales.addEventListener(ev,render); fStatus.addEventListener(ev,render); fSort.addEventListener(ev,render);
});
viewListBtn.addEventListener('click',()=>{state.view='list';render()});
viewBoardBtn.addEventListener('click',()=>{state.view='board';render()});

/* Event delegation: list actions */
rfqListEl.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const card=e.target.closest('.rfq'); if(!card) return;
  const id=card.dataset.id; const rfq=getRFQ(id); if(!rfq) return;
  const act=btn.dataset.act;
  if(act==='view') openDrawer(rfq);
  if(act==='add') openOfferModal(id);
  if(act==='send'){ if(confirm('Send this RFQ to Orders?')){ updateRFQ(id,{status:'ordered',sent_to_orders_at:new Date().toISOString()}); toast('Sent to Orders'); } }
  if(act==='close'){ if(confirm('Close this RFQ?')){ updateRFQ(id,{status:'closed'}); toast('RFQ closed'); } }
  if(act==='delete'){ if(confirm('Delete this RFQ (and all its offers/comments)?')) deleteRFQ(id); }
});

/* Event delegation: board actions */
boardEl.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const card=e.target.closest('.mini'); if(!card) return;
  const id=card.dataset.id; const rfq=getRFQ(id); if(!rfq) return;
  const a=btn.dataset.a;
  if(a==='view') openDrawer(rfq);
  if(a==='add') openOfferModal(id);
  if(a==='send'){ if(confirm('Send this RFQ to Orders?')){ updateRFQ(id,{status:'ordered',sent_to_orders_at:new Date().toISOString()}); toast('Sent to Orders'); } }
  if(a==='close'){ if(confirm('Close this RFQ?')){ updateRFQ(id,{status:'closed'}); toast('RFQ closed'); } }
  if(a==='delete'){ if(confirm('Delete this RFQ (and all its offers/comments)?')) deleteRFQ(id); }
});

/* Drawer */
function openDrawer(r,keep){
  state.active=r; const os=state.offersByRFQ.get(r.id)||[]; const cov=coverage(os,r.quantity);
  drawerTitle.textContent=`${r.part_number} × ${r.quantity}`; drawerMeta.textContent=`Customer: ${esc(r.customer||'—')} • Sales: ${r.salesperson} • Priority: ${cap(r.priority)} • Date: ${onlyDate(r.created_at)}`;
  covBar.style.width=cov.pct+'%'; covTxt.textContent=`${cov.sum}/${r.quantity}`;
  renderOfferRows(os); renderComments(r.id); if(!keep) rfqDrawer.showModal();
}
drawerSendBtn.addEventListener('click',()=>{ if(!state.active) return; if(confirm('Send this RFQ to Orders?')){ updateRFQ(state.active.id,{status:'ordered',sent_to_orders_at:new Date().toISOString()}); toast('Sent to Orders'); }});
drawerCloseBtn.addEventListener('click',()=>rfqDrawer.close());

function renderOfferRows(os){
  offerRows.innerHTML=''; const bestO=best(os);
  os.forEach(o=>{
    const tr=document.createElement('tr');
    if(bestO && bestO.id===o.id) tr.style.outline='2px solid rgba(111,87,233,.35)';
    tr.innerHTML=`<td>${esc(o.vendor)}</td><td>${esc(o.location||'')}</td><td>${money(o.price,o.currency)}</td><td>${o.currency}</td><td>${o.qty_offer||''}</td><td>${o.moq||''}</td><td>${o.lead_time||''}</td><td><span class="chip conf" data-level="${o.confidence}">${o.confidence}</span></td><td>${esc(o.comments||'')}</td><td style="text-align:right"><button class="danger icon" data-offer-id="${o.id}">Delete</button></td>`;
    offerRows.appendChild(tr);
  });
}
offerRows.addEventListener('click',e=>{
  const btn=e.target.closest('button[data-offer-id]'); if(!btn) return;
  const id=btn.getAttribute('data-offer-id');
  if(confirm('Delete this offer?')) deleteOffer(id);
});

/* Offer modal (Purchasing) */
function openOfferModal(rfq_id){ $("#offer_rfq_id").value=rfq_id; offerForm.reset(); offerModal.showModal(); }
offerCancel.addEventListener('click',()=>offerModal.close());
offerForm.addEventListener('submit',e=>{
  e.preventDefault();
  const p={ id:nid(), created_at:new Date().toISOString(), rfq_id:$("#offer_rfq_id").value,
    vendor:$("#vendor").value.trim(), location:$("#location").value.trim()||null,
    price:Number($("#price").value), currency:$("#offer_currency").value,
    qty_offer:parseInt($("#qty_offer").value||"",10) || null,
    moq:parseInt($("#moq").value||"",10) || null,
    lead_time:parseInt($("#lead_time").value||"",10) || null,
    confidence:Number($("#confidence").value||3),
    comments:$("#offerNotes").value||null
  };
  if(!p.vendor||isNaN(p.price)){toast('Vendor + price required');return}
  const arr=read(K_OFF); arr.push(p); write(K_OFF,arr); toast('Offer saved'); offerModal.close(); loadAll(); if(state.active&&state.active.id===p.rfq_id) openDrawer(getRFQ(p.rfq_id),true);
});

/* Comments */
function renderComments(rid){
  commentsEl.innerHTML=''; const arr=read(K_CMT).filter(c=>c.rfq_id===rid).sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  cCountEl.textContent=arr.length;
  arr.forEach(c=>{const row=document.createElement('div');row.style.cssText='border:1px solid var(--line);border-radius:10px;padding:7px 9px';
    row.innerHTML=`<div style="display:flex;justify-content:space-between"><strong>${esc(c.author||'Anon')}</strong><span class="muted">${onlyDate(c.created_at)}</span></div><div>${esc(c.text||'')}</div>`;commentsEl.appendChild(row)});
}
cAddBtn.addEventListener('click',()=>{
  if(!state.active) return; const text=cTextEl.value.trim(); if(!text) return;
  const arr=read(K_CMT); arr.push({id:nid(),created_at:new Date().toISOString(),rfq_id:state.active.id,author:cAuthorEl.value.trim()||'Anon',text}); write(K_CMT,arr); cTextEl.value=''; renderComments(state.active.id);
});

/* init */
(function init(){ buildSales(); loadAll(); })();
</script>
</body>
</html>



